[{"filePath":"C:\\Users\\xiang\\senteng-frontend\\eslint.config.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\xiang\\senteng-frontend\\postcss.config.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\xiang\\senteng-frontend\\src\\App.jsx","messages":[{"ruleId":"no-unused-vars","severity":2,"message":"'Icon' is defined but never used. Allowed unused args must match /^_|^e$|^err$|^event$/u.","line":846,"column":41,"nodeType":"Identifier","messageId":"unusedVar","endLine":846,"endColumn":45,"suggestions":[{"messageId":"removeVar","data":{"varName":"Icon"},"fix":{"range":[30817,30829],"text":""},"desc":"Remove unused variable 'Icon'."}]},{"ruleId":"no-unused-vars","severity":2,"message":"'Icon' is defined but never used. Allowed unused args must match /^_|^e$|^err$|^event$/u.","line":877,"column":30,"nodeType":"Identifier","messageId":"unusedVar","endLine":877,"endColumn":34,"suggestions":[{"messageId":"removeVar","data":{"varName":"Icon"},"fix":{"range":[32327,32338],"text":""},"desc":"Remove unused variable 'Icon'."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState } from 'react';\nimport {\n  LayoutDashboard,\n  Users,\n  Briefcase,\n  Wallet,\n  HardHat,\n  Package,\n  Search,\n  Bell,\n  Calendar,\n  Plus,\n  MapPin,\n  Phone,\n  MoreHorizontal,\n  ArrowUpRight,\n  CheckCircle2,\n  Circle,\n  Star,\n  FileText,\n  FileSignature,\n  RefreshCw,\n  Receipt,\n  CreditCard,\n  Building2,\n  TrendingUp,\n  Settings,\n  Link2,\n  FolderOpen,\n  ChevronDown,\n  Calculator,\n  Ruler\n} from 'lucide-react';\n\n// Import P0 pages from design-system\nimport MaterialCalculator from './pages/MaterialCalculator';\nimport CostEstimator from './pages/CostEstimator';\nimport QuotationEditor from './pages/QuotationEditor';\nimport BimManagement from './pages/BimManagement';\n\n// Import shared components\nimport { Badge } from './components/common/Badge';\nimport { Card } from './components/common/Card';\n\n// --- MOCK DATA (From Prompt) ---\nconst MOCK_DATA = {\n  clients: [\n    {\n      id: \"c-1\",\n      name: \"林先生\",\n      status: \"已簽約\",\n      source: \"網路廣告\",\n      phone: \"0912-345-678\",\n      email: \"lin@example.com\",\n      address: \"台北市信義區信義路五段...\",\n      houseType: \"電梯大樓\",\n      condition: \"新成屋\",\n      size: \"35坪\",\n      budgetRange: \"300-500萬\",\n      style: \"現代簡約\",\n      family: \"夫妻+1子\",\n      note: \"喜歡大理石材質，主臥需有更衣室。預計明年三月入住。\"\n    },\n    {\n      id: \"c-2\",\n      name: \"陳小姐\",\n      status: \"提案/報價\",\n      source: \"朋友介紹\",\n      phone: \"0922-333-444\",\n      email: \"chen@example.com\",\n      address: \"台北市大安區和平東路...\",\n      houseType: \"電梯大樓\",\n      condition: \"新成屋\",\n      size: \"22坪\",\n      budgetRange: \"500-800萬\",\n      style: \"北歐風\",\n      family: \"單身貴族\",\n      note: \"有養兩隻貓，需貓跳台與耐磨地板，注重收納空間。\"\n    }\n  ],\n  projects: [\n    {\n      id: \"p-1\",\n      code: \"P-23001\",\n      name: \"信義區林公館\",\n      type: \"翻修\",\n      status: \"施工中\",\n      progress: 65,\n      dueDate: \"2025-03-15\",\n      clientName: \"林先生\",\n      budget: 350,\n      location: \"台北市信義區松高路\"\n    },\n    {\n      id: \"p-2\",\n      code: \"P-24002\",\n      name: \"大安森林公園景觀住宅\",\n      type: \"新建\",\n      status: \"設計中\",\n      progress: 30,\n      dueDate: \"2025-06-20\",\n      clientName: \"大安區公所\",\n      budget: 980,\n      location: \"台北市大安區新生南路\"\n    },\n    {\n      id: \"p-3\",\n      code: \"P-24003\",\n      name: \"南港軟體園區辦公室\",\n      type: \"商空\",\n      status: \"完工驗收\",\n      progress: 95,\n      dueDate: \"2025-02-28\",\n      clientName: \"科技股份有限公司\",\n      budget: 1280,\n      location: \"台北市南港區園區街\"\n    }\n  ],\n  accounts: [\n    {\n      id: \"a-1\",\n      name: \"玉山營運\",\n      bank: \"玉山銀行\",\n      number: \"808-1234-5678-9012\",\n      balance: 2360,\n      note: \"主要收支帳戶\"\n    },\n    {\n      id: \"a-2\",\n      name: \"公司零用金\",\n      bank: \"現金箱\",\n      number: \"-\",\n      balance: -2,\n      note: \"日常雜支\"\n    },\n    {\n      id: \"a-3\",\n      name: \"台新薪轉\",\n      bank: \"台新銀行\",\n      number: \"987-654-321\",\n      balance: 0,\n      note: \"薪轉專用\"\n    }\n  ],\n  transactions: [\n    {\n      id: \"t-1\",\n      date: \"2025-12-05\",\n      type: \"收入\",\n      amount: 800,\n      accountId: \"a-1\",\n      projectId: \"p-1\",\n      desc: \"信義林公館 - 第2期工程款\"\n    },\n    {\n      id: \"t-2\",\n      date: \"2025-12-08\",\n      type: \"支出\",\n      amount: 30,\n      accountId: \"a-1\",\n      projectId: \"p-1\",\n      desc: \"水電建材料件\"\n    },\n    {\n      id: \"t-3\",\n      date: \"2025-12-10\",\n      type: \"支出\",\n      amount: 2,\n      accountId: \"a-2\",\n      projectId: \"p-2\",\n      desc: \"辦公室文具\"\n    }\n  ],\n  vendors: [\n    {\n      id: \"v-1\",\n      name: \"大師兄精緻木工坊\",\n      category: \"工程工班\",\n      tradeType: \"木工\",\n      contactPerson: \"王大哥\",\n      phone: \"0912-345-678\",\n      address: \"新北市板橋區文化路一段...\",\n      status: \"長期合作\",\n      rating: 4.9,\n      lastProject: \"信義區林公館\",\n      tags: [\"配合度高\", \"手工細緻\"]\n    },\n    {\n      id: \"v-2\",\n      name: \"永亮專業水電\",\n      category: \"工程工班\",\n      tradeType: \"水電\",\n      contactPerson: \"張師傅\",\n      phone: \"0922-333-444\",\n      address: \"新店區中興路三段...\",\n      status: \"合作中\",\n      rating: 4.5,\n      lastProject: \"南港軟體園區辦公室\",\n      tags: [\"配線整齊\", \"配合度高\"]\n    }\n  ],\n  inventory: [\n    {\n      id: \"i-1\",\n      name: \"Panasonic 開關\",\n      spec: \"PN-001\",\n      quantity: 50,\n      unit: \"組\",\n      safeStock: 10,\n      location: \"A-01\"\n    },\n    {\n      id: \"i-2\",\n      name: \"得利乳膠漆 (白)\",\n      spec: \"PT-W01\",\n      quantity: 5,\n      unit: \"桶\",\n      safeStock: 10,\n      location: \"B-02\"\n    },\n    {\n      id: \"i-3\",\n      name: \"T5 層板燈\",\n      spec: \"LGT-T5\",\n      quantity: 100,\n      unit: \"支\",\n      safeStock: 20,\n      location: \"A-03\"\n    }\n  ],\n  todos: [\n    { id: \"todo-1\", text: \"確認信義區林公館磁磚樣品\", done: false },\n    { id: \"todo-2\", text: \"回覆陳小姐報價與圖面疑問\", done: true },\n    { id: \"todo-3\", text: \"預約下週三木工會議排程\", done: false }\n  ]\n};\n\n// --- HELPER COMPONENTS ---\n\nconst ProgressBar = ({ value }) => (\n  <div className=\"w-full bg-gray-100 rounded-full h-2\">\n    <div\n      className=\"bg-gray-800 h-2 rounded-full transition-all duration-500\"\n      style={{ width: `${value}%` }}\n    />\n  </div>\n);\n\nconst SectionTitle = ({ title, action }) => (\n  <div className=\"flex items-center justify-between mb-6\">\n    <h2 className=\"text-xl font-bold text-gray-800\">{title}</h2>\n    {action}\n  </div>\n);\n\n// --- VIEW COMPONENTS ---\n\nconst Dashboard = ({ data }) => {\n  const activeProjectsCount = data.projects.filter(p => [\"設計中\", \"施工中\"].includes(p.status)).length;\n  const constructionCount = data.projects.filter(p => p.status === \"施工中\").length;\n  const nearCompletionCount = data.projects.filter(p => p.progress >= 80).length;\n  const monthlyIncome = data.transactions\n    .filter(t => t.type === \"收入\")\n    .reduce((acc, curr) => acc + curr.amount, 0);\n\n  // Derived financials for Dashboard\n  const estimatedIncome = 1250; // Mock derived\n  const estimatedExpense = 420; // Mock derived\n\n  return (\n    <div className=\"space-y-8 animate-fade-in\">\n      {/* Greeting & Date */}\n      <div className=\"flex flex-col md:flex-row md:items-end justify-between gap-4\">\n        <div>\n          <h1 className=\"text-2xl font-bold text-gray-900\">早安，設計總監</h1>\n          <p className=\"text-gray-500 mt-1\">今天又是充滿創意與挑戰的一天，來看看今日行程吧。</p>\n        </div>\n        <div className=\"text-right hidden md:block\">\n          <p className=\"text-sm font-medium text-gray-500\">2025年 12月 07日</p>\n          <p className=\"text-xs text-gray-400\">星期日</p>\n        </div>\n      </div>\n\n      {/* Today's Schedule Card */}\n      <Card className=\"border-l-4 border-l-gray-800\">\n        <div className=\"flex justify-between items-start mb-4\">\n          <h3 className=\"font-bold text-lg flex items-center gap-2\">\n            <Calendar size={20} className=\"text-gray-700\" />\n            今日行程\n          </h3>\n          <div className=\"space-x-2\">\n            <button className=\"text-sm text-gray-600 hover:text-gray-900 font-medium px-3 py-1.5 border rounded-lg hover:bg-gray-50 transition-colors\">同步 Google</button>\n            <button className=\"text-sm text-white bg-gray-800 hover:bg-gray-900 font-medium px-3 py-1.5 rounded-lg transition-colors\">查看全部</button>\n          </div>\n        </div>\n        <div className=\"flex flex-col items-center justify-center py-8 text-gray-400 bg-gray-50 rounded-lg border border-dashed border-gray-200\">\n          <Calendar size={32} className=\"mb-2 opacity-50\" />\n          <span className=\"text-sm\">今天無安排，享受美好時光！</span>\n        </div>\n      </Card>\n\n      {/* KPI Cards */}\n      <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6\">\n        <Card className=\"flex flex-col justify-between h-32\">\n          <div className=\"flex justify-between items-start\">\n            <span className=\"text-gray-500 text-sm font-medium\">進行中專案</span>\n            <Briefcase size={18} className=\"text-blue-500\" />\n          </div>\n          <div className=\"flex items-end gap-2\">\n            <span className=\"text-3xl font-bold text-gray-900\">{activeProjectsCount}</span>\n            <span className=\"text-gray-400 text-sm mb-1\">個案場</span>\n          </div>\n        </Card>\n\n        <Card className=\"flex flex-col justify-between h-32\">\n          <div className=\"flex justify-between items-start\">\n            <span className=\"text-gray-500 text-sm font-medium\">本月實收</span>\n            <Wallet size={18} className=\"text-emerald-500\" />\n          </div>\n          <div>\n            <div className=\"flex items-end gap-2\">\n              <span className=\"text-3xl font-bold text-gray-900\">NT$ {monthlyIncome}</span>\n              <span className=\"text-gray-400 text-sm mb-1\">萬</span>\n            </div>\n            <span className=\"text-xs text-emerald-600 bg-emerald-50 px-1.5 py-0.5 rounded flex w-fit mt-1 items-center\">\n              <ArrowUpRight size={12} className=\"mr-0.5\" /> +15% 較上月\n            </span>\n          </div>\n        </Card>\n\n        <Card className=\"flex flex-col justify-between h-32\">\n          <div className=\"flex justify-between items-start\">\n            <span className=\"text-gray-500 text-sm font-medium\">施工中案場</span>\n            <HardHat size={18} className=\"text-orange-500\" />\n          </div>\n          <div className=\"flex items-end gap-2\">\n            <span className=\"text-3xl font-bold text-gray-900\">{constructionCount}</span>\n            <span className=\"text-gray-400 text-sm mb-1\">處</span>\n          </div>\n        </Card>\n\n        <Card className=\"flex flex-col justify-between h-32\">\n          <div className=\"flex justify-between items-start\">\n            <span className=\"text-gray-500 text-sm font-medium\">即將完工</span>\n            <CheckCircle2 size={18} className=\"text-purple-500\" />\n          </div>\n          <div className=\"flex items-end gap-2\">\n            <span className=\"text-3xl font-bold text-gray-900\">{nearCompletionCount}</span>\n            <span className=\"text-gray-400 text-sm mb-1\">個案場</span>\n          </div>\n        </Card>\n      </div>\n\n      <div className=\"grid grid-cols-1 lg:grid-cols-3 gap-8\">\n        {/* Recent Projects & Financial Overview */}\n        <div className=\"lg:col-span-2 space-y-8\">\n          <div>\n            <h3 className=\"text-lg font-bold text-gray-800 mb-4\">近期專案動態</h3>\n            <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n              {data.projects.slice(0, 2).map(project => (\n                <Card key={project.id} className=\"hover:shadow-md transition-shadow cursor-pointer\">\n                  <div className=\"flex justify-between items-start mb-3\">\n                    <div>\n                      <h4 className=\"font-bold text-gray-800\">{project.name}</h4>\n                      <p className=\"text-xs text-gray-500 mt-1\">{project.code}</p>\n                    </div>\n                    <Badge color={project.status === '施工中' ? 'orange' : 'blue'}>{project.status}</Badge>\n                  </div>\n                  <div className=\"space-y-2\">\n                    <div className=\"flex justify-between text-sm\">\n                      <span className=\"text-gray-500\">目前進度</span>\n                      <span className=\"font-bold text-gray-800\">{project.progress}%</span>\n                    </div>\n                    <ProgressBar value={project.progress} />\n                  </div>\n                </Card>\n              ))}\n            </div>\n          </div>\n\n          <div>\n            <h3 className=\"text-lg font-bold text-gray-800 mb-4\">財務概況</h3>\n            <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n              <Card className=\"bg-gradient-to-br from-emerald-50 to-white border-emerald-100\">\n                <p className=\"text-sm text-emerald-800 font-medium mb-1\">預計實收</p>\n                <p className=\"text-2xl font-bold text-emerald-900\">NT$ {estimatedIncome} 萬</p>\n              </Card>\n              <Card className=\"bg-gradient-to-br from-red-50 to-white border-red-100\">\n                <p className=\"text-sm text-red-800 font-medium mb-1\">預計支出</p>\n                <p className=\"text-2xl font-bold text-red-900\">NT$ {estimatedExpense} 萬</p>\n              </Card>\n            </div>\n          </div>\n        </div>\n\n        {/* Todos */}\n        <div>\n          <h3 className=\"text-lg font-bold text-gray-800 mb-4\">備忘錄</h3>\n          <Card className=\"h-full max-h-[400px] overflow-y-auto\">\n            <ul className=\"space-y-4\">\n              {data.todos.map(todo => (\n                <li key={todo.id} className=\"flex items-start gap-3 group\">\n                  {todo.done ? (\n                    <CheckCircle2 size={20} className=\"text-emerald-500 mt-0.5 shrink-0\" />\n                  ) : (\n                    <Circle size={20} className=\"text-gray-300 mt-0.5 shrink-0 group-hover:text-gray-400\" />\n                  )}\n                  <span className={`text-sm leading-relaxed ${todo.done ? 'text-gray-400 line-through' : 'text-gray-700'}`}>\n                    {todo.text}\n                  </span>\n                </li>\n              ))}\n            </ul>\n            <button className=\"w-full mt-6 py-2 text-sm text-gray-500 hover:text-gray-800 hover:bg-gray-50 rounded-lg transition-colors border border-dashed border-gray-200\">\n              + 新增備忘\n            </button>\n          </Card>\n        </div>\n      </div>\n    </div>\n  );\n};\n\nconst Clients = ({ data }) => {\n  return (\n    <div className=\"space-y-6 animate-fade-in\">\n      <SectionTitle\n        title=\"客戶名單\"\n        action={\n          <div className=\"flex gap-3\">\n            <div className=\"relative\">\n              <Search size={16} className=\"absolute left-3 top-1/2 -translate-y-1/2 text-gray-400\" />\n              <input\n                type=\"text\"\n                placeholder=\"搜尋姓名、電話、地址…\"\n                className=\"pl-9 pr-4 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-gray-200 w-64\"\n              />\n            </div>\n            <button className=\"bg-gray-800 hover:bg-gray-900 text-white px-4 py-2 rounded-lg text-sm font-medium flex items-center gap-2 transition-colors\">\n              <Plus size={16} /> 新增客戶\n            </button>\n          </div>\n        }\n      />\n\n      <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6\">\n        {data.clients.map(client => (\n          <Card key={client.id} className=\"hover:shadow-md transition-all\">\n            <div className=\"flex justify-between items-start mb-4\">\n              <div className=\"flex gap-3\">\n                <div className=\"w-12 h-12 rounded-full bg-gray-100 flex items-center justify-center text-lg font-bold text-gray-600\">\n                  {client.name[0]}\n                </div>\n                <div>\n                  <h3 className=\"font-bold text-gray-900\">{client.name}</h3>\n                  <Badge color={client.status === '已簽約' ? 'green' : 'blue'} className=\"mt-1 inline-block\">\n                    {client.status}\n                  </Badge>\n                </div>\n              </div>\n              <button className=\"text-gray-400 hover:text-gray-600\">\n                <MoreHorizontal size={20} />\n              </button>\n            </div>\n\n            <div className=\"space-y-3 text-sm text-gray-600 mb-6\">\n              <div className=\"flex items-center gap-2\">\n                <Phone size={14} className=\"text-gray-400\" />\n                {client.phone}\n              </div>\n              <div className=\"flex items-start gap-2\">\n                <MapPin size={14} className=\"text-gray-400 mt-0.5 shrink-0\" />\n                <span className=\"truncate\">{client.address}</span>\n              </div>\n              <div className=\"flex items-center gap-2 pt-2 border-t border-gray-50\">\n                <span className=\"text-gray-400\">類型:</span> {client.houseType} / {client.condition}\n              </div>\n              <div className=\"flex items-center gap-2\">\n                <span className=\"text-gray-400\">預算:</span> {client.budgetRange}\n              </div>\n            </div>\n\n            <div className=\"flex flex-wrap gap-2\">\n              <Badge color=\"gray\">#{client.style}</Badge>\n              <Badge color=\"gray\">#{client.family}</Badge>\n            </div>\n          </Card>\n        ))}\n      </div>\n    </div>\n  );\n};\n\nconst Projects = ({ data }) => {\n  const [filter, setFilter] = useState('全部');\n  const filters = ['全部', '翻修', '新建', '商空'];\n\n  const filteredProjects = filter === '全部'\n    ? data.projects\n    : data.projects.filter(p => p.type === filter);\n\n  const getStatusColor = (type) => {\n    if (type === '翻修') return 'orange';\n    if (type === '新建') return 'blue';\n    return 'purple';\n  }\n\n  return (\n    <div className=\"space-y-8 animate-fade-in\">\n      <div className=\"flex flex-col md:flex-row justify-between items-start md:items-center gap-4\">\n        <div>\n          <h2 className=\"text-xl font-bold text-gray-800 mb-4\">專案管理</h2>\n          <div className=\"flex gap-2\">\n            {filters.map(f => (\n              <button\n                key={f}\n                onClick={() => setFilter(f)}\n                className={`px-4 py-1.5 rounded-full text-sm font-medium transition-colors ${filter === f\n                  ? 'bg-gray-800 text-white'\n                  : 'bg-white text-gray-600 border border-gray-200 hover:bg-gray-50'\n                  }`}\n              >\n                {f}\n              </button>\n            ))}\n          </div>\n        </div>\n        <button className=\"bg-gray-800 hover:bg-gray-900 text-white px-4 py-2 rounded-lg text-sm font-medium flex items-center gap-2 transition-colors\">\n          <Plus size={16} /> 建立專案\n        </button>\n      </div>\n\n      {/* Project Cards */}\n      <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6\">\n        {filteredProjects.map(project => (\n          <Card key={project.id} className=\"relative overflow-hidden group hover:shadow-md transition-all\">\n            <div className=\"absolute top-0 left-0 w-1 h-full bg-gray-800 group-hover:bg-gray-900 transition-colors\" />\n            <div className=\"flex justify-between items-start mb-2\">\n              <Badge color={getStatusColor(project.type)} className=\"mb-2\">\n                {project.type === '翻修' ? '翻' : project.type === '新建' ? '新' : '商'}\n              </Badge>\n              <span className={`text-xs px-2 py-1 rounded ${project.status === '施工中' ? 'bg-orange-100 text-orange-700' : 'bg-gray-100 text-gray-600'}`}>\n                {project.status}\n              </span>\n            </div>\n\n            <h3 className=\"text-lg font-bold text-gray-900 mb-1\">{project.name}</h3>\n            <p className=\"text-sm text-gray-400 mb-4\">{project.code}</p>\n\n            <div className=\"space-y-2 text-sm text-gray-600 mb-6\">\n              <div className=\"flex justify-between border-b border-gray-50 pb-2\">\n                <span className=\"text-gray-400\">業主</span>\n                <span>{project.clientName}</span>\n              </div>\n              <div className=\"flex justify-between border-b border-gray-50 pb-2\">\n                <span className=\"text-gray-400\">總預算</span>\n                <span>NT$ {project.budget} 萬</span>\n              </div>\n              <div className=\"flex justify-between pb-2\">\n                <span className=\"text-gray-400\">完工日</span>\n                <span>{project.dueDate}</span>\n              </div>\n            </div>\n\n            <div className=\"bg-gray-50 p-3 rounded-lg\">\n              <div className=\"flex justify-between text-sm mb-2\">\n                <span className=\"text-gray-600 font-medium\">專案進度</span>\n                <span className=\"text-gray-900 font-bold\">{project.progress}%</span>\n              </div>\n              <ProgressBar value={project.progress} />\n            </div>\n          </Card>\n        ))}\n      </div>\n\n      {/* Engineering Progress Table */}\n      <div className=\"mt-8\">\n        <h3 className=\"text-lg font-bold text-gray-800 mb-4\">工程進度管理</h3>\n        <Card className=\"overflow-hidden p-0\">\n          <table className=\"w-full text-sm text-left\">\n            <thead className=\"bg-gray-50 text-gray-500 font-medium border-b border-gray-100\">\n              <tr>\n                <th className=\"px-6 py-4\">專案</th>\n                <th className=\"px-6 py-4\">摘要</th>\n                <th className=\"px-6 py-4 text-right\">狀態</th>\n              </tr>\n            </thead>\n            <tbody className=\"divide-y divide-gray-100\">\n              {data.projects.filter(p => ['設計中', '施工中'].includes(p.status)).map(project => (\n                <tr key={project.id} className=\"hover:bg-gray-50/50\">\n                  <td className=\"px-6 py-4 font-medium text-gray-900\">{project.name}</td>\n                  <td className=\"px-6 py-4 text-gray-600\">\n                    {project.status === '施工中' ? '泥作進場，水電配管完成' : '平面圖定稿，3D渲染中'}\n                  </td>\n                  <td className=\"px-6 py-4 text-right\">\n                    <span className={`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${project.status === '施工中' ? 'bg-orange-100 text-orange-800' : 'bg-blue-100 text-blue-800'\n                      }`}>\n                      {project.status}\n                    </span>\n                  </td>\n                </tr>\n              ))}\n            </tbody>\n          </table>\n        </Card>\n      </div>\n    </div>\n  );\n};\n\nconst Finance = ({ data }) => {\n  const totalIncome = data.transactions.filter(t => t.type === '收入').reduce((acc, c) => acc + c.amount, 0);\n  const totalExpense = data.transactions.filter(t => t.type === '支出').reduce((acc, c) => acc + c.amount, 0);\n\n  return (\n    <div className=\"space-y-6 animate-fade-in\">\n      <SectionTitle\n        title=\"財務收支\"\n        action={\n          <button className=\"bg-gray-800 hover:bg-gray-900 text-white px-4 py-2 rounded-lg text-sm font-medium flex items-center gap-2 transition-colors\">\n            <Plus size={16} /> 新增一筆\n          </button>\n        }\n      />\n\n      {/* Summary */}\n      <div className=\"grid grid-cols-1 md:grid-cols-3 gap-6\">\n        <Card className=\"bg-white\">\n          <p className=\"text-sm text-gray-500 mb-1\">本期收入</p>\n          <p className=\"text-3xl font-bold text-emerald-600\">+ NT$ {totalIncome} 萬</p>\n        </Card>\n        <Card className=\"bg-white\">\n          <p className=\"text-sm text-gray-500 mb-1\">本期支出</p>\n          <p className=\"text-3xl font-bold text-red-600\">- NT$ {totalExpense} 萬</p>\n        </Card>\n        <Card className=\"bg-gray-800 text-white border-none\">\n          <p className=\"text-sm text-gray-400 mb-1\">淨現金流</p>\n          <p className=\"text-3xl font-bold\">+ NT$ {totalIncome - totalExpense} 萬</p>\n        </Card>\n      </div>\n\n      {/* Accounts */}\n      <h3 className=\"text-lg font-bold text-gray-800 mt-8 mb-4\">帳戶概況</h3>\n      <div className=\"grid grid-cols-1 md:grid-cols-3 gap-6\">\n        {data.accounts.map(account => (\n          <div key={account.id} className=\"bg-white rounded-xl p-6 border border-gray-200 shadow-sm relative overflow-hidden\">\n            <div className=\"absolute top-0 right-0 p-4 opacity-10\">\n              <Wallet size={64} />\n            </div>\n            <h4 className=\"font-bold text-gray-900 text-lg mb-1\">{account.name}</h4>\n            <p className=\"text-sm text-gray-500 mb-6 font-mono\">{account.bank} · {account.number}</p>\n\n            <p className=\"text-xs text-gray-400 uppercase tracking-wider\">帳戶餘額</p>\n            <p className={`text-2xl font-bold ${account.balance < 0 ? 'text-red-600' : 'text-gray-900'}`}>\n              NT$ {account.balance} 萬\n            </p>\n          </div>\n        ))}\n      </div>\n\n      {/* Transactions Table */}\n      <h3 className=\"text-lg font-bold text-gray-800 mt-8 mb-4\">近期收支明細</h3>\n      <Card className=\"overflow-hidden p-0\">\n        <table className=\"w-full text-sm text-left\">\n          <thead className=\"bg-gray-50 text-gray-500 font-medium border-b border-gray-100\">\n            <tr>\n              <th className=\"px-6 py-4\">摘要</th>\n              <th className=\"px-6 py-4\">日期</th>\n              <th className=\"px-6 py-4\">帳戶 / 專案</th>\n              <th className=\"px-6 py-4 text-right\">金額</th>\n            </tr>\n          </thead>\n          <tbody className=\"divide-y divide-gray-100\">\n            {data.transactions.map(t => {\n              const accountName = data.accounts.find(a => a.id === t.accountId)?.name;\n              const projectName = data.projects.find(p => p.id === t.projectId)?.name || \"未指定專案\";\n              return (\n                <tr key={t.id} className=\"hover:bg-gray-50/50\">\n                  <td className=\"px-6 py-4 font-medium text-gray-900\">{t.desc}</td>\n                  <td className=\"px-6 py-4 text-gray-500 font-mono\">{t.date}</td>\n                  <td className=\"px-6 py-4\">\n                    <div className=\"text-gray-900\">{accountName}</div>\n                    <div className=\"text-xs text-gray-400\">{projectName}</div>\n                  </td>\n                  <td className={`px-6 py-4 text-right font-bold ${t.type === '收入' ? 'text-emerald-600' : 'text-red-600'}`}>\n                    {t.type === '收入' ? '+' : '-'} NT$ {t.amount} 萬\n                  </td>\n                </tr>\n              )\n            })}\n          </tbody>\n        </table>\n      </Card>\n    </div>\n  );\n};\n\nconst Vendors = ({ data }) => {\n  const [filter, setFilter] = useState('全部');\n  const filters = ['全部', '工程工班', '建材供應'];\n\n  const filteredVendors = filter === '全部' ? data.vendors : data.vendors.filter(v => v.category === filter);\n\n  return (\n    <div className=\"space-y-6 animate-fade-in\">\n      <div className=\"flex flex-col md:flex-row justify-between items-start md:items-center gap-4\">\n        <div>\n          <h2 className=\"text-xl font-bold text-gray-800 mb-4\">廠商管理</h2>\n          <div className=\"flex gap-2\">\n            {filters.map(f => (\n              <button\n                key={f}\n                onClick={() => setFilter(f)}\n                className={`px-4 py-1.5 rounded-full text-sm font-medium transition-colors ${filter === f\n                  ? 'bg-gray-800 text-white'\n                  : 'bg-white text-gray-600 border border-gray-200 hover:bg-gray-50'\n                  }`}\n              >\n                {f}\n              </button>\n            ))}\n          </div>\n        </div>\n        <button className=\"bg-gray-800 hover:bg-gray-900 text-white px-4 py-2 rounded-lg text-sm font-medium flex items-center gap-2 transition-colors\">\n          <Plus size={16} /> 新增廠商\n        </button>\n      </div>\n\n      <div className=\"grid grid-cols-1 md:grid-cols-2 lg-grid-cols-3 gap-6\">\n        {filteredVendors.map(vendor => (\n          <Card key={vendor.id} className=\"hover:shadow-md transition-all\">\n            <div className=\"flex justify-between items-start mb-2\">\n              <Badge color=\"blue\">{vendor.tradeType}</Badge>\n              <div className={`px-2 py-0.5 rounded text-xs font-medium ${vendor.status === '長期合作' ? 'bg-emerald-100 text-emerald-800' : 'bg-blue-100 text-blue-800'\n                }`}>\n                {vendor.status}\n              </div>\n            </div>\n\n            <h3 className=\"font-bold text-gray-900 text-lg mb-1\">{vendor.name}</h3>\n            <div className=\"flex items-center gap-1 text-orange-400 text-sm mb-4\">\n              <Star size={14} fill=\"currentColor\" />\n              <span className=\"font-bold text-gray-700\">{vendor.rating}</span>\n            </div>\n\n            <div className=\"bg-gray-50 rounded-lg p-3 mb-4 flex items-center gap-3\">\n              <div className=\"w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center text-xs font-bold text-gray-600\">\n                {vendor.contactPerson[0]}\n              </div>\n              <div className=\"text-sm\">\n                <div className=\"font-medium text-gray-900\">{vendor.contactPerson}</div>\n                <div className=\"text-gray-500 font-mono\">{vendor.phone}</div>\n              </div>\n            </div>\n\n            <div className=\"flex flex-wrap gap-2 mb-4\">\n              {vendor.tags.map(tag => (\n                <span key={tag} className=\"text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded\">#{tag}</span>\n              ))}\n            </div>\n\n            <div className=\"text-xs text-gray-400 pt-3 border-t border-gray-50\">\n              最近合作：{vendor.lastProject}\n            </div>\n          </Card>\n        ))}\n      </div>\n    </div>\n  );\n};\n\nconst Inventory = ({ data }) => {\n  const getStockStatus = (qty, safe) => {\n    if (qty <= 0) return { label: '缺貨', color: 'bg-red-100 text-red-700' };\n    if (qty <= safe) return { label: '庫存偏低', color: 'bg-orange-100 text-orange-700' };\n    return { label: '充足', color: 'bg-emerald-100 text-emerald-700' };\n  };\n\n  return (\n    <div className=\"space-y-6 animate-fade-in\">\n      <SectionTitle\n        title=\"庫存管理\"\n        action={\n          <button className=\"bg-gray-800 hover:bg-gray-900 text-white px-4 py-2 rounded-lg text-sm font-medium flex items-center gap-2 transition-colors\">\n            <Plus size={16} /> 新增品項\n          </button>\n        }\n      />\n\n      <Card className=\"overflow-hidden p-0\">\n        <table className=\"w-full text-sm text-left\">\n          <thead className=\"bg-gray-50 text-gray-500 font-medium border-b border-gray-100\">\n            <tr>\n              <th className=\"px-6 py-4\">品項資訊</th>\n              <th className=\"px-6 py-4\">規格 / 型號</th>\n              <th className=\"px-6 py-4\">庫存數量</th>\n              <th className=\"px-6 py-4\">狀態</th>\n              <th className=\"px-6 py-4\">存放位置</th>\n              <th className=\"px-6 py-4\">備註</th>\n            </tr>\n          </thead>\n          <tbody className=\"divide-y divide-gray-100\">\n            {data.inventory.map(item => {\n              const status = getStockStatus(item.quantity, item.safeStock);\n              return (\n                <tr key={item.id} className=\"hover:bg-gray-50/50\">\n                  <td className=\"px-6 py-4\">\n                    <div className=\"flex items-center gap-3\">\n                      <div className=\"p-2 bg-gray-100 rounded text-gray-500\">\n                        <Package size={18} />\n                      </div>\n                      <span className=\"font-medium text-gray-900\">{item.name}</span>\n                    </div>\n                  </td>\n                  <td className=\"px-6 py-4\">\n                    <span className=\"bg-gray-100 text-gray-600 px-2 py-1 rounded text-xs font-mono\">\n                      {item.spec}\n                    </span>\n                  </td>\n                  <td className=\"px-6 py-4 text-gray-900 font-medium\">\n                    {item.quantity} <span className=\"text-gray-400 text-xs font-normal\">{item.unit}</span>\n                  </td>\n                  <td className=\"px-6 py-4\">\n                    <span className={`px-2 py-1 rounded-full text-xs font-medium ${status.color}`}>\n                      {status.label}\n                    </span>\n                  </td>\n                  <td className=\"px-6 py-4 text-gray-600 font-mono\">\n                    {item.location}\n                  </td>\n                  <td className=\"px-6 py-4 text-gray-400\">\n                    -\n                  </td>\n                </tr>\n              )\n            })}\n          </tbody>\n        </table>\n      </Card>\n    </div>\n  );\n};\n\n// --- PLACEHOLDER PAGES ---\n\nconst PlaceholderPage = ({ title, icon: Icon }) => (\n  <div className=\"space-y-6 animate-fade-in\">\n    <div className=\"flex flex-col items-center justify-center py-20 bg-white rounded-xl border border-gray-100\">\n      <Icon size={48} className=\"text-gray-300 mb-4\" />\n      <h2 className=\"text-xl font-bold text-gray-800 mb-2\">{title}</h2>\n      <p className=\"text-gray-400\">此功能開發中，敬請期待</p>\n    </div>\n  </div>\n);\n\nconst Quotations = () => <PlaceholderPage title=\"報價單管理\" icon={FileText} />;\nconst Contracts = () => <PlaceholderPage title=\"合約管理\" icon={FileSignature} />;\nconst ChangeOrders = () => <PlaceholderPage title=\"變更單管理\" icon={RefreshCw} />;\nconst Invoices = () => <PlaceholderPage title=\"發票管理\" icon={Receipt} />;\nconst Payments = () => <PlaceholderPage title=\"付款管理\" icon={CreditCard} />;\nconst Construction = () => <PlaceholderPage title=\"工程管理\" icon={Building2} />;\nconst Events = () => <PlaceholderPage title=\"行事曆\" icon={Calendar} />;\nconst ProfitAnalysis = () => <PlaceholderPage title=\"利潤分析\" icon={TrendingUp} />;\nconst UserSettings = () => <PlaceholderPage title=\"使用者管理\" icon={Users} />;\nconst Integrations = () => <PlaceholderPage title=\"整合設定\" icon={Link2} />;\nconst Storage = () => <PlaceholderPage title=\"文件管理\" icon={FolderOpen} />;\n\n// --- MAIN LAYOUT & APP ---\n\nconst SidebarGroup = ({ label, children }) => (\n  <div className=\"mb-4\">\n    <div className=\"px-4 py-2 text-xs font-semibold text-gray-400 uppercase tracking-wider\">{label}</div>\n    <div className=\"space-y-1\">{children}</div>\n  </div>\n);\n\nconst SidebarItem = ({ icon: Icon, label, active, onClick }) => (\n  <button\n    onClick={onClick}\n    className={`w-full flex items-center gap-3 px-4 py-2.5 rounded-lg transition-all duration-200 group ${active\n      ? 'bg-gray-800 text-white shadow-md'\n      : 'text-gray-600 hover:bg-gray-100 hover:text-gray-900'\n      }`}\n  >\n    <Icon size={18} className={active ? 'text-white' : 'text-gray-400 group-hover:text-gray-600'} />\n    <span className=\"text-sm font-medium\">{label}</span>\n  </button>\n);\n\nconst App = () => {\n  const [activeTab, setActiveTab] = useState('dashboard');\n\n  const renderContent = () => {\n    switch (activeTab) {\n      case 'dashboard': return <Dashboard data={MOCK_DATA} />;\n      case 'clients': return <Clients data={MOCK_DATA} />;\n      case 'projects': return <Projects data={MOCK_DATA} />;\n      case 'construction': return <Construction />;\n      case 'events': return <Events />;\n      case 'quotations': return <Quotations />;\n      case 'contracts': return <Contracts />;\n      case 'change-orders': return <ChangeOrders />;\n      case 'invoices': return <Invoices />;\n      case 'payments': return <Payments />;\n      case 'finance': return <Finance data={MOCK_DATA} />;\n      case 'profit-analysis': return <ProfitAnalysis />;\n      case 'inventory': return <Inventory data={MOCK_DATA} />;\n      case 'vendors': return <Vendors data={MOCK_DATA} />;\n      case 'users': return <UserSettings />;\n      case 'integrations': return <Integrations />;\n      case 'storage': return <Storage />;\n      case 'material-calc': return <MaterialCalculator />;\n      case 'cost-est': return <CostEstimator />;\n      case 'quotation-edit': return <QuotationEditor />;\n      case 'bim': return <BimManagement />;\n      default: return <Dashboard data={MOCK_DATA} />;\n    }\n  };\n\n  const titles = {\n    dashboard: '儀表板',\n    clients: '客戶管理',\n    projects: '專案管理',\n    construction: '工程管理',\n    events: '行事曆',\n    quotations: '報價單',\n    contracts: '合約管理',\n    'change-orders': '變更單',\n    invoices: '發票管理',\n    payments: '付款管理',\n    finance: '財務管理',\n    'profit-analysis': '利潤分析',\n    inventory: '庫存管理',\n    vendors: '廠商管理',\n    users: '使用者管理',\n    integrations: '整合設定',\n    storage: '文件管理',\n    'material-calc': '材料估算',\n    'cost-est': '成本估算',\n    'quotation-edit': '報價編輯',\n    'bim': 'BIM 管理'\n  };\n  const getTitle = () => titles[activeTab] || '儀表板';\n\n  return (\n    <div className=\"flex h-screen bg-gray-50 font-sans text-gray-900 selection:bg-gray-200\">\n\n      {/* Sidebar */}\n      <aside className=\"fixed left-0 top-0 h-full w-64 bg-white border-r border-gray-100 z-10 flex flex-col\">\n        <div className=\"p-8\">\n          <h1 className=\"text-xl font-bold tracking-tight text-gray-900 flex items-center gap-2\">\n            <div className=\"w-8 h-8 bg-gray-900 rounded-lg flex items-center justify-center text-white font-serif\">森</div>\n            森騰室內設計\n          </h1>\n        </div>\n\n        <nav className=\"flex-1 px-3 overflow-y-auto\">\n          <div className=\"mb-2\">\n            <SidebarItem icon={LayoutDashboard} label=\"儀表板\" active={activeTab === 'dashboard'} onClick={() => setActiveTab('dashboard')} />\n          </div>\n\n          <SidebarGroup label=\"營運管理\">\n            <SidebarItem icon={Users} label=\"客戶管理\" active={activeTab === 'clients'} onClick={() => setActiveTab('clients')} />\n            <SidebarItem icon={Briefcase} label=\"專案管理\" active={activeTab === 'projects'} onClick={() => setActiveTab('projects')} />\n            <SidebarItem icon={Building2} label=\"工程管理\" active={activeTab === 'construction'} onClick={() => setActiveTab('construction')} />\n            <SidebarItem icon={Calendar} label=\"行事曆\" active={activeTab === 'events'} onClick={() => setActiveTab('events')} />\n          </SidebarGroup>\n\n          <SidebarGroup label=\"商務文件\">\n            <SidebarItem icon={FileText} label=\"報價單\" active={activeTab === 'quotations'} onClick={() => setActiveTab('quotations')} />\n            <SidebarItem icon={FileSignature} label=\"合約管理\" active={activeTab === 'contracts'} onClick={() => setActiveTab('contracts')} />\n            <SidebarItem icon={RefreshCw} label=\"變更單\" active={activeTab === 'change-orders'} onClick={() => setActiveTab('change-orders')} />\n            <SidebarItem icon={Receipt} label=\"發票管理\" active={activeTab === 'invoices'} onClick={() => setActiveTab('invoices')} />\n            <SidebarItem icon={CreditCard} label=\"付款管理\" active={activeTab === 'payments'} onClick={() => setActiveTab('payments')} />\n          </SidebarGroup>\n\n          <SidebarGroup label=\"財務庫存\">\n            <SidebarItem icon={Wallet} label=\"財務管理\" active={activeTab === 'finance'} onClick={() => setActiveTab('finance')} />\n            <SidebarItem icon={TrendingUp} label=\"利潤分析\" active={activeTab === 'profit-analysis'} onClick={() => setActiveTab('profit-analysis')} />\n            <SidebarItem icon={Package} label=\"庫存管理\" active={activeTab === 'inventory'} onClick={() => setActiveTab('inventory')} />\n            <SidebarItem icon={HardHat} label=\"廠商管理\" active={activeTab === 'vendors'} onClick={() => setActiveTab('vendors')} />\n          </SidebarGroup>\n\n          <SidebarGroup label=\"工程估算\">\n            <SidebarItem icon={Ruler} label=\"材料估算\" active={activeTab === 'material-calc'} onClick={() => setActiveTab('material-calc')} />\n            <SidebarItem icon={Calculator} label=\"成本估算\" active={activeTab === 'cost-est'} onClick={() => setActiveTab('cost-est')} />\n            <SidebarItem icon={FileText} label=\"報價編輯\" active={activeTab === 'quotation-edit'} onClick={() => setActiveTab('quotation-edit')} />\n            <SidebarItem icon={Building2} label=\"BIM 管理\" active={activeTab === 'bim'} onClick={() => setActiveTab('bim')} />\n          </SidebarGroup>\n\n          <SidebarGroup label=\"設定\">\n            <SidebarItem icon={Users} label=\"使用者管理\" active={activeTab === 'users'} onClick={() => setActiveTab('users')} />\n            <SidebarItem icon={Link2} label=\"整合設定\" active={activeTab === 'integrations'} onClick={() => setActiveTab('integrations')} />\n            <SidebarItem icon={FolderOpen} label=\"文件管理\" active={activeTab === 'storage'} onClick={() => setActiveTab('storage')} />\n          </SidebarGroup>\n        </nav>\n\n        <div className=\"p-4 border-t border-gray-50\">\n          <div className=\"bg-gray-50 rounded-xl p-4 flex items-center gap-3\">\n            <div className=\"w-10 h-10 rounded-full bg-gray-200 flex items-center justify-center font-bold text-gray-500\">\n              A\n            </div>\n            <div>\n              <p className=\"text-sm font-bold text-gray-900\">設計總監</p>\n              <p className=\"text-xs text-gray-400\">admin@senteng.tw</p>\n            </div>\n          </div>\n        </div>\n      </aside>\n\n      {/* Main Content */}\n      <main className=\"ml-64 flex-1 flex flex-col min-h-screen\">\n\n        {/* Top Header */}\n        <header className=\"sticky top-0 bg-white/80 backdrop-blur-md border-b border-gray-100 z-20 px-8 py-4 flex justify-between items-center\">\n          <h2 className=\"text-xl font-bold text-gray-800\">{getTitle()}</h2>\n\n          <div className=\"flex items-center gap-6\">\n            <div className=\"relative\">\n              <Bell size={20} className=\"text-gray-400 hover:text-gray-600 cursor-pointer transition-colors\" />\n              <span className=\"absolute -top-0.5 -right-0.5 w-2.5 h-2.5 bg-red-500 rounded-full border-2 border-white\"></span>\n            </div>\n            <div className=\"h-8 w-px bg-gray-200\"></div>\n            <div className=\"flex items-center gap-2\">\n              <div className=\"text-right\">\n                <p className=\"text-sm font-bold text-gray-900\">Alex Chen</p>\n                <p className=\"text-xs text-gray-400\">設計總監</p>\n              </div>\n              <div className=\"w-10 h-10 rounded-full bg-gray-800 text-white flex items-center justify-center font-bold shadow-lg shadow-gray-200\">\n                A\n              </div>\n            </div>\n          </div>\n        </header>\n\n        {/* Dynamic Content */}\n        <div className=\"p-8 max-w-7xl mx-auto w-full\">\n          {renderContent()}\n        </div>\n\n      </main>\n    </div>\n  );\n};\n\nexport default App;\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\xiang\\senteng-frontend\\src\\components\\HealthCheck.jsx","messages":[{"ruleId":"no-unused-vars","severity":2,"message":"'allowWrite' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]|^_/u.","line":17,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":17,"endColumn":20,"suggestions":[{"messageId":"removeVar","data":{"varName":"allowWrite"},"fix":{"range":[575,585],"text":""},"desc":"Remove unused variable 'allowWrite'."}]},{"ruleId":"no-unused-vars","severity":2,"message":"'setAllowWrite' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]|^_/u.","line":17,"column":22,"nodeType":"Identifier","messageId":"unusedVar","endLine":17,"endColumn":35,"suggestions":[{"messageId":"removeVar","data":{"varName":"setAllowWrite"},"fix":{"range":[585,600],"text":""},"desc":"Remove unused variable 'setAllowWrite'."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"﻿import React, { useMemo, useState } from \"react\";\nimport GoogleService from \"../services/googleService\";\n\nfunction pretty(obj) {\n  try { return JSON.stringify(obj, null, 2); } catch { return String(obj); }\n}\n\nexport default function HealthCheck() {\n  const env = useMemo(() => ({\n    spreadsheetId: import.meta.env.VITE_GOOGLE_SPREADSHEET_ID,\n    driveRootFolderId: import.meta.env.VITE_GOOGLE_DRIVE_ROOT_FOLDER_ID,\n  }), []);\n\n  const [busy, setBusy] = useState(false);\n  const [log, setLog] = useState(\"\");\n  const [sheetName, setSheetName] = useState(\"clients\");\n  const [allowWrite, setAllowWrite] = useState(false);\n\n  const appendLog = (line) => setLog((p) => (p ? `${p}\\n${line}` : line));\n\n  async function sheetsRead() {\n    if (!env.spreadsheetId) throw new Error(\"Missing env: VITE_GOOGLE_SPREADSHEET_ID\");\n    appendLog(\"== Sheets: READ START ==\");\n    const range = `${sheetName}!A1:C5`;\n    const res = await window.gapi.client.sheets.spreadsheets.values.get({\n      spreadsheetId: env.spreadsheetId,\n      range,\n    });\n    appendLog(`Sheets READ OK: ${range}`);\n    appendLog(pretty(res?.result));\n    appendLog(\"== Sheets: READ DONE ==\");\n  }\n\n  async function driveCreateFolder() {\n    appendLog(\"== Drive: CREATE FOLDER START ==\");\n    const name = `HealthCheck_${new Date().toISOString().replace(/[:.]/g, \"-\")}`;\n    const res = await GoogleService.createDriveFolder(name);\n    appendLog(`Drive folder created: ${res?.name || name}`);\n    appendLog(pretty(res));\n    appendLog(\"== Drive: CREATE FOLDER DONE ==\");\n  }\n\n  async function runAll() {\n    setBusy(true);\n    setLog(\"\");\n    try {\n      appendLog(`Origin: ${window.location.origin}`);\n      appendLog(`SpreadsheetId: ${env.spreadsheetId ? \"SET\" : \"MISSING\"}`);\n      appendLog(`DriveRootFolderId: ${env.driveRootFolderId ? \"SET\" : \"MISSING\"}`);\n      appendLog(\"\");\n      await sheetsRead();\n      appendLog(\"\");\n      await driveCreateFolder();\n    } finally {\n      setBusy(false);\n    }\n  }\n\n  return (\n    <section className=\"mt-6 border border-gray-200 rounded-xl bg-white shadow-sm\">\n      <div className=\"px-5 py-4 border-b border-gray-100 flex items-center justify-between gap-3 flex-wrap\">\n        <div>\n          <div className=\"text-sm font-semibold text-gray-800\">HealthCheck</div>\n          <div className=\"text-xs text-gray-500\">Sheets/Drive 最小驗證（先確保 build 過）</div>\n        </div>\n\n        <div className=\"flex items-center gap-3 flex-wrap\">\n          <label className=\"flex items-center gap-2 text-xs text-gray-700\">\n            <span>Sheet</span>\n            <input\n              className=\"border border-gray-200 rounded-lg px-2 py-1 text-xs w-40\"\n              value={sheetName}\n              onChange={(e) => setSheetName(e.target.value)}\n            />\n          </label>\n\n          <button\n            className=\"text-xs px-3 py-2 rounded-lg border border-gray-200 hover:bg-gray-50 disabled:opacity-60\"\n            disabled={busy}\n            onClick={runAll}\n          >\n            {busy ? \"執行中…\" : \"一鍵執行\"}\n          </button>\n        </div>\n      </div>\n\n      <div className=\"px-5 py-4\">\n        <pre className=\"text-xs whitespace-pre-wrap bg-gray-50 border border-gray-200 rounded-lg p-3 min-h-[120px]\">\n          {log || \"（尚未執行）\"}\n        </pre>\n      </div>\n    </section>\n  );\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\xiang\\senteng-frontend\\src\\components\\common\\Badge.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\xiang\\senteng-frontend\\src\\components\\common\\Card.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\xiang\\senteng-frontend\\src\\components\\common\\ContactsSection.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\xiang\\senteng-frontend\\src\\components\\common\\Indicators.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\xiang\\senteng-frontend\\src\\components\\common\\InputField.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\xiang\\senteng-frontend\\src\\components\\common\\LoadingButton.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\xiang\\senteng-frontend\\src\\components\\common\\LocationField.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\xiang\\senteng-frontend\\src\\components\\common\\Modal.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\xiang\\senteng-frontend\\src\\components\\common\\NotificationPanel.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\xiang\\senteng-frontend\\src\\components\\common\\SearchableSelect.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\xiang\\senteng-frontend\\src\\components\\common\\SyncStatusBadge.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\xiang\\senteng-frontend\\src\\components\\common\\Toast.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\xiang\\senteng-frontend\\src\\components\\common\\WidgetWrapper.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\xiang\\senteng-frontend\\src\\components\\finance\\AccountDetailsModal.jsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"The 'safeTransactions' conditional could make the dependencies of useMemo Hook (at line 23) change on every render. To fix this, wrap the initialization of 'safeTransactions' in its own useMemo() Hook.","line":16,"column":11,"nodeType":"VariableDeclarator","endLine":16,"endColumn":83},{"ruleId":"no-unused-vars","severity":2,"message":"'safeAccount' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]|^_/u.","line":17,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":17,"endColumn":22,"suggestions":[{"messageId":"removeVar","data":{"varName":"safeAccount"},"fix":{"range":[789,924],"text":""},"desc":"Remove unused variable 'safeAccount'."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useMemo } from 'react';\r\nimport { X, TrendingUp, TrendingDown, Calendar, Filter, Download } from 'lucide-react';\r\n\r\nexport const AccountDetailsModal = ({ isOpen, onClose, account, allTransactions = [] }) => {\r\n    const [filterType, setFilterType] = useState('all');\r\n    const [filterMonth, setFilterMonth] = useState('all');\r\n\r\n    // Extract primitive values FIRST to avoid object recreation\r\n    const accountId = account?.id || '';\r\n    const accountName = account?.name || '';\r\n    const accountBank = account?.bank || '';\r\n    const accountNumber = account?.number || '';\r\n    const accountBalance = account?.balance || 0;\r\n\r\n    // Safety check for allTransactions\r\n    const safeTransactions = Array.isArray(allTransactions) ? allTransactions : [];\r\n    const safeAccount = account || { id: accountId, name: accountName, bank: accountBank, number: accountNumber, balance: accountBalance };\r\n\r\n    // Filter transactions for this account (must be called before any conditional return)\r\n    const accountTransactions = useMemo(() => {\r\n        if (!accountId) return [];\r\n        return safeTransactions.filter(tx => tx.accountId === accountId);\r\n    }, [safeTransactions, accountId]);\r\n\r\n    // Apply filters\r\n    const filteredTransactions = useMemo(() => {\r\n        let filtered = [...accountTransactions];\r\n\r\n        if (filterType !== 'all') {\r\n            filtered = filtered.filter(tx => tx.type === filterType);\r\n        }\r\n\r\n        if (filterMonth !== 'all') {\r\n            filtered = filtered.filter(tx => tx.date && tx.date.startsWith(filterMonth));\r\n        }\r\n\r\n        return filtered.sort((a, b) => new Date(b.date) - new Date(a.date));\r\n    }, [accountTransactions, filterType, filterMonth]);\r\n\r\n    // Calculate statistics\r\n    const stats = useMemo(() => {\r\n        const income = accountTransactions\r\n            .filter(tx => tx.type === '收入')\r\n            .reduce((sum, tx) => sum + (tx.amount || 0), 0);\r\n        const expense = accountTransactions\r\n            .filter(tx => tx.type === '支出')\r\n            .reduce((sum, tx) => sum + (tx.amount || 0), 0);\r\n        const net = income - expense;\r\n\r\n        return { income, expense, net, count: accountTransactions.length };\r\n    }, [accountTransactions]);\r\n\r\n    // Get unique months from transactions\r\n    const availableMonths = useMemo(() => {\r\n        const months = new Set(accountTransactions.map(tx => tx.date.substring(0, 7)));\r\n        return Array.from(months).sort().reverse();\r\n    }, [accountTransactions]);\r\n\r\n    // DEBUG: Check what we're receiving\r\n    console.log('AccountDetailsModal render:', { isOpen, account, accountId, transactionCount: safeTransactions.length });\r\n\r\n    // NOW we can do conditional rendering - AFTER all hooks\r\n    if (!isOpen || !account) {\r\n        console.log('Modal not rendering because:', { isOpen, hasAccount: !!account });\r\n        return null;\r\n    }\r\n\r\n    return (\r\n        <div className=\"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-2 sm:p-4 overflow-y-auto\">\r\n            <div className=\"bg-white rounded-2xl shadow-2xl w-full max-w-4xl my-auto flex flex-col animate-slide-up max-h-[95vh]\">\r\n                {/* Header */}\r\n                <div className=\"flex justify-between items-start p-4 sm:p-6 border-b border-gray-100 flex-shrink-0\">\r\n                    <div>\r\n                        <h3 className=\"text-xl sm:text-2xl font-bold text-gray-800\">{accountName}</h3>\r\n                        <div className=\"flex items-center gap-2 sm:gap-4 mt-2 text-xs sm:text-sm text-gray-500 flex-wrap\">\r\n                            <span>{accountBank}</span>\r\n                            <span className=\"hidden sm:inline\">•</span>\r\n                            <span className=\"font-mono text-xs\">{accountNumber}</span>\r\n                        </div>\r\n                    </div>\r\n                    <button onClick={onClose} className=\"p-2 hover:bg-gray-100 rounded-lg transition-colors flex-shrink-0\">\r\n                        <X size={24} className=\"text-gray-400\" />\r\n                    </button>\r\n                </div>\r\n\r\n                {/* Statistics Cards */}\r\n                <div className=\"grid grid-cols-2 lg:grid-cols-4 gap-2 sm:gap-4 p-4 sm:p-6 bg-gray-50 flex-shrink-0\">\r\n                    <div className=\"bg-white rounded-xl p-3 sm:p-4 shadow-sm\">\r\n                        <div className=\"text-xs text-gray-500 mb-1\">當前餘額</div>\r\n                        <div className=\"text-lg sm:text-2xl font-bold text-gray-800\">${accountBalance.toLocaleString()}</div>\r\n                    </div>\r\n                    <div className=\"bg-white rounded-xl p-3 sm:p-4 shadow-sm\">\r\n                        <div className=\"text-xs text-gray-500 mb-1 flex items-center gap-1\">\r\n                            <TrendingUp size={12} className=\"text-green-500\" />\r\n                            總收入\r\n                        </div>\r\n                        <div className=\"text-lg sm:text-2xl font-bold text-green-600\">${stats.income.toLocaleString()}</div>\r\n                    </div>\r\n                    <div className=\"bg-white rounded-xl p-3 sm:p-4 shadow-sm\">\r\n                        <div className=\"text-xs text-gray-500 mb-1 flex items-center gap-1\">\r\n                            <TrendingDown size={12} className=\"text-red-500\" />\r\n                            總支出\r\n                        </div>\r\n                        <div className=\"text-lg sm:text-2xl font-bold text-red-600\">${stats.expense.toLocaleString()}</div>\r\n                    </div>\r\n                    <div className=\"bg-white rounded-xl p-3 sm:p-4 shadow-sm\">\r\n                        <div className=\"text-xs text-gray-500 mb-1\">淨額</div>\r\n                        <div className={`text-lg sm:text-2xl font-bold ${stats.net >= 0 ? 'text-green-600' : 'text-red-600'}`}>\r\n                            ${Math.abs(stats.net).toLocaleString()}\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n\r\n                {/* Filters */}\r\n                <div className=\"flex flex-col sm:flex-row items-start sm:items-center gap-3 sm:gap-4 px-4 sm:px-6 py-3 sm:py-4 border-b border-gray-100 flex-shrink-0\">\r\n                    <div className=\"flex items-center gap-2\">\r\n                        <Filter size={16} className=\"text-gray-400\" />\r\n                        <span className=\"text-sm font-medium text-gray-600\">篩選：</span>\r\n                    </div>\r\n\r\n                    {/* Type Filter */}\r\n                    <div className=\"flex gap-2 flex-wrap\">\r\n                        <button\r\n                            onClick={() => setFilterType('all')}\r\n                            className={`px-3 py-1 rounded-lg text-xs font-medium transition-colors ${filterType === 'all'\r\n                                ? 'bg-morandi-blue-500 text-white'\r\n                                : 'bg-gray-100 text-gray-600 hover:bg-gray-200'\r\n                                }`}\r\n                        >\r\n                            全部\r\n                        </button>\r\n                        <button\r\n                            onClick={() => setFilterType('收入')}\r\n                            className={`px-3 py-1 rounded-lg text-xs font-medium transition-colors ${filterType === '收入'\r\n                                ? 'bg-green-500 text-white'\r\n                                : 'bg-gray-100 text-gray-600 hover:bg-gray-200'\r\n                                }`}\r\n                        >\r\n                            收入\r\n                        </button>\r\n                        <button\r\n                            onClick={() => setFilterType('支出')}\r\n                            className={`px-3 py-1 rounded-lg text-xs font-medium transition-colors ${filterType === '支出'\r\n                                ? 'bg-red-500 text-white'\r\n                                : 'bg-gray-100 text-gray-600 hover:bg-gray-200'\r\n                                }`}\r\n                        >\r\n                            支出\r\n                        </button>\r\n                    </div>\r\n\r\n                    {/* Month Filter */}\r\n                    <select\r\n                        value={filterMonth}\r\n                        onChange={(e) => setFilterMonth(e.target.value)}\r\n                        className=\"px-3 py-1 text-xs border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-morandi-blue-500\"\r\n                    >\r\n                        <option value=\"all\">所有月份</option>\r\n                        {availableMonths.map(month => (\r\n                            <option key={month} value={month}>{month}</option>\r\n                        ))}\r\n                    </select>\r\n\r\n                    <div className=\"flex-1\" />\r\n\r\n                    <div className=\"text-xs text-gray-500\">\r\n                        共 {filteredTransactions.length} 筆交易\r\n                    </div>\r\n                </div>\r\n\r\n                {/* Transaction List */}\r\n                <div className=\"flex-1 overflow-y-auto px-6 py-4\">\r\n                    {filteredTransactions.length === 0 ? (\r\n                        <div className=\"text-center py-12 text-gray-400\">\r\n                            <Calendar size={48} className=\"mx-auto mb-3 opacity-30\" />\r\n                            <p>無交易記錄</p>\r\n                        </div>\r\n                    ) : (\r\n                        <div className=\"space-y-3\">\r\n                            {filteredTransactions.map((tx) => (\r\n                                <div\r\n                                    key={tx.id}\r\n                                    className=\"flex items-center justify-between p-4 bg-white rounded-xl border border-gray-100 hover:border-morandi-blue-200 hover:shadow-sm transition-all\"\r\n                                >\r\n                                    <div className=\"flex items-center gap-4\">\r\n                                        <div className={`w-10 h-10 rounded-full flex items-center justify-center ${tx.type === '收入' ? 'bg-green-50' : 'bg-red-50'\r\n                                            }`}>\r\n                                            {tx.type === '收入' ? (\r\n                                                <TrendingUp size={20} className=\"text-green-600\" />\r\n                                            ) : (\r\n                                                <TrendingDown size={20} className=\"text-red-600\" />\r\n                                            )}\r\n                                        </div>\r\n                                        <div>\r\n                                            <div className=\"font-medium text-gray-800\">{tx.desc}</div>\r\n                                            <div className=\"text-xs text-gray-500 flex items-center gap-2 mt-1\">\r\n                                                <span>{tx.date}</span>\r\n                                                {tx.category && (\r\n                                                    <>\r\n                                                        <span>•</span>\r\n                                                        <span className=\"px-2 py-0.5 bg-gray-100 rounded\">{tx.category}</span>\r\n                                                    </>\r\n                                                )}\r\n                                            </div>\r\n                                        </div>\r\n                                    </div>\r\n                                    <div className={`text-lg font-bold font-mono ${tx.type === '收入' ? 'text-green-600' : 'text-red-600'\r\n                                        }`}>\r\n                                        {tx.type === '收入' ? '+' : '-'} ${tx.amount.toLocaleString()}\r\n                                    </div>\r\n                                </div>\r\n                            ))}\r\n                        </div>\r\n                    )}\r\n                </div>\r\n\r\n                {/* Footer */}\r\n                <div className=\"flex justify-between items-center px-6 py-4 border-t border-gray-100 bg-gray-50\">\r\n                    <button className=\"text-sm text-gray-500 hover:text-gray-700 flex items-center gap-2\">\r\n                        <Download size={16} />\r\n                        匯出明細\r\n                    </button>\r\n                    <button\r\n                        onClick={onClose}\r\n                        className=\"px-6 py-2 bg-gray-800 hover:bg-gray-900 text-white rounded-lg transition-colors\"\r\n                    >\r\n                        關閉\r\n                    </button>\r\n                </div>\r\n            </div>\r\n        </div>\r\n    );\r\n};\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\xiang\\senteng-frontend\\src\\components\\finance\\FinanceExportModal.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\xiang\\senteng-frontend\\src\\components\\finance\\LoanAccountCard.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\xiang\\senteng-frontend\\src\\components\\finance\\LoanAccountModal.jsx","messages":[{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\n  29 |     useEffect(() => {\n  30 |         if (editingLoan) {\n> 31 |             setFormData({\n     |             ^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  32 |                 ...editingLoan,\n  33 |                 principalAmount: editingLoan.principalAmount?.toString() || '',\n  34 |                 interestRate: editingLoan.interestRate?.toString() || ''","line":31,"column":13,"nodeType":null,"endLine":31,"endColumn":24}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\r\nimport React, { useState, useEffect, useMemo } from 'react';\r\nimport { Modal } from '../common/Modal';\r\nimport { InputField } from '../common/InputField';\r\nimport { LoanCalculator, calculateEqualPayment, calculateEqualPrincipal } from './LoanCalculator';\r\nimport { Building2, Percent, Calendar, Calculator } from 'lucide-react';\r\n\r\n/**\r\n * 貸款帳戶新增/編輯 Modal\r\n */\r\n\r\nconst COMMON_TERMS = [12, 24, 36, 60, 84, 120, 180, 240, 360];\r\nconst PAYMENT_DAYS = Array.from({ length: 28 }, (_, i) => i + 1);\r\n\r\nexport const LoanAccountModal = ({ isOpen, onClose, onConfirm, editingLoan = null }) => {\r\n    const [formData, setFormData] = useState({\r\n        bankName: '',\r\n        principalAmount: '',\r\n        interestRate: '',\r\n        totalTerms: 240,\r\n        paidTerms: 0,\r\n        startDate: new Date().toISOString().split('T')[0],\r\n        paymentDay: 15,\r\n        paymentType: 'equalPayment',\r\n        status: 'active'\r\n    });\r\n\r\n    // 初始化編輯資料\r\n    useEffect(() => {\r\n        if (editingLoan) {\r\n            setFormData({\r\n                ...editingLoan,\r\n                principalAmount: editingLoan.principalAmount?.toString() || '',\r\n                interestRate: editingLoan.interestRate?.toString() || ''\r\n            });\r\n        } else {\r\n            setFormData({\r\n                bankName: '',\r\n                principalAmount: '',\r\n                interestRate: '',\r\n                totalTerms: 240,\r\n                paidTerms: 0,\r\n                startDate: new Date().toISOString().split('T')[0],\r\n                paymentDay: 15,\r\n                paymentType: 'equalPayment',\r\n                status: 'active'\r\n            });\r\n        }\r\n    }, [editingLoan, isOpen]);\r\n\r\n    // 即時試算\r\n    const calculation = useMemo(() => {\r\n        const principal = parseFloat(formData.principalAmount) || 0;\r\n        const rate = parseFloat(formData.interestRate) || 0;\r\n        const terms = parseInt(formData.totalTerms) || 0;\r\n\r\n        if (formData.paymentType === 'equalPayment') {\r\n            return calculateEqualPayment(principal, rate, terms);\r\n        } else {\r\n            return calculateEqualPrincipal(principal, rate, terms);\r\n        }\r\n    }, [formData.principalAmount, formData.interestRate, formData.totalTerms, formData.paymentType]);\r\n\r\n    const handleSubmit = () => {\r\n        // 驗證必填欄位\r\n        if (!formData.bankName || !formData.principalAmount || !formData.interestRate) {\r\n            return;\r\n        }\r\n\r\n        const principal = parseFloat(formData.principalAmount);\r\n        const rate = parseFloat(formData.interestRate);\r\n\r\n        // 計算剩餘本金\r\n        let remainingPrincipal = principal;\r\n        if (formData.paidTerms > 0 && calculation.schedule) {\r\n            const paidIndex = Math.min(formData.paidTerms, calculation.schedule.length) - 1;\r\n            if (paidIndex >= 0) {\r\n                remainingPrincipal = calculation.schedule[paidIndex]?.remainingPrincipal || principal;\r\n            }\r\n        }\r\n\r\n        const loanData = {\r\n            ...formData,\r\n            id: editingLoan?.id || `loan-${Date.now()}`,\r\n            principalAmount: principal,\r\n            interestRate: rate,\r\n            monthlyPayment: formData.paymentType === 'equalPayment'\r\n                ? calculation.monthlyPayment\r\n                : calculation.firstPayment,\r\n            remainingPrincipal,\r\n            totalInterest: calculation.totalInterest\r\n        };\r\n\r\n        onConfirm(loanData);\r\n    };\r\n\r\n    const updateField = (field, value) => {\r\n        setFormData(prev => ({ ...prev, [field]: value }));\r\n    };\r\n\r\n    return (\r\n        <Modal\r\n            isOpen={isOpen}\r\n            onClose={onClose}\r\n            title={editingLoan ? \"編輯貸款帳戶\" : \"新增貸款帳戶\"}\r\n            onConfirm={handleSubmit}\r\n            confirmText={editingLoan ? \"儲存變更\" : \"新增貸款\"}\r\n            size=\"lg\"\r\n        >\r\n            <div className=\"space-y-4\">\r\n                {/* 銀行名稱 */}\r\n                <InputField\r\n                    label=\"貸款銀行\"\r\n                    value={formData.bankName}\r\n                    onChange={e => updateField('bankName', e.target.value)}\r\n                    placeholder=\"例：台灣銀行房屋貸款\"\r\n                    icon={<Building2 size={16} />}\r\n                />\r\n\r\n                {/* 貸款金額與利率 */}\r\n                <div className=\"grid grid-cols-1 sm:grid-cols-2 gap-4\">\r\n                    <InputField\r\n                        label=\"貸款金額 (本金)\"\r\n                        type=\"number\"\r\n                        value={formData.principalAmount}\r\n                        onChange={e => updateField('principalAmount', e.target.value)}\r\n                        placeholder=\"例：5000000\"\r\n                    />\r\n                    <div>\r\n                        <label className=\"block text-sm font-medium text-gray-700 mb-2\">\r\n                            年利率 (%)\r\n                        </label>\r\n                        <div className=\"flex items-center gap-2\">\r\n                            <input\r\n                                type=\"range\"\r\n                                min=\"0.1\"\r\n                                max=\"15\"\r\n                                step=\"0.1\"\r\n                                value={formData.interestRate || 2.5}\r\n                                onChange={e => updateField('interestRate', e.target.value)}\r\n                                className=\"flex-1 accent-blue-600\"\r\n                            />\r\n                            <input\r\n                                type=\"number\"\r\n                                step=\"0.1\"\r\n                                value={formData.interestRate}\r\n                                onChange={e => updateField('interestRate', e.target.value)}\r\n                                className=\"w-20 px-2 py-1.5 border border-gray-200 rounded-lg text-center text-sm\"\r\n                                placeholder=\"2.5\"\r\n                            />\r\n                            <Percent size={14} className=\"text-gray-400\" />\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n\r\n                {/* 期數與還款日 */}\r\n                <div className=\"grid grid-cols-1 sm:grid-cols-3 gap-4\">\r\n                    <InputField\r\n                        label=\"還款期數 (月)\"\r\n                        type=\"select\"\r\n                        value={formData.totalTerms}\r\n                        onChange={e => updateField('totalTerms', parseInt(e.target.value))}\r\n                    >\r\n                        {COMMON_TERMS.map(term => (\r\n                            <option key={term} value={term}>\r\n                                {term} 期 ({Math.floor(term / 12)} 年 {term % 12 ? `${term % 12} 月` : ''})\r\n                            </option>\r\n                        ))}\r\n                        <option value=\"custom\">自訂期數</option>\r\n                    </InputField>\r\n\r\n                    <InputField\r\n                        label=\"每月還款日\"\r\n                        type=\"select\"\r\n                        value={formData.paymentDay}\r\n                        onChange={e => updateField('paymentDay', parseInt(e.target.value))}\r\n                    >\r\n                        {PAYMENT_DAYS.map(day => (\r\n                            <option key={day} value={day}>每月 {day} 日</option>\r\n                        ))}\r\n                    </InputField>\r\n\r\n                    <InputField\r\n                        label=\"起始日期\"\r\n                        type=\"date\"\r\n                        value={formData.startDate}\r\n                        onChange={e => updateField('startDate', e.target.value)}\r\n                    />\r\n                </div>\r\n\r\n                {/* 還款方式 */}\r\n                <div>\r\n                    <label className=\"block text-sm font-medium text-gray-700 mb-2\">還款方式</label>\r\n                    <div className=\"flex gap-2 bg-gray-50 p-1 rounded-xl\">\r\n                        <button\r\n                            type=\"button\"\r\n                            onClick={() => updateField('paymentType', 'equalPayment')}\r\n                            className={`flex-1 py-2 px-4 rounded-lg text-sm font-medium transition-all ${formData.paymentType === 'equalPayment'\r\n                                    ? 'bg-white text-blue-600 shadow-sm'\r\n                                    : 'text-gray-500 hover:text-gray-700'\r\n                                }`}\r\n                        >\r\n                            等額本息\r\n                            <div className=\"text-xs text-gray-400 mt-0.5\">每月固定金額</div>\r\n                        </button>\r\n                        <button\r\n                            type=\"button\"\r\n                            onClick={() => updateField('paymentType', 'equalPrincipal')}\r\n                            className={`flex-1 py-2 px-4 rounded-lg text-sm font-medium transition-all ${formData.paymentType === 'equalPrincipal'\r\n                                    ? 'bg-white text-blue-600 shadow-sm'\r\n                                    : 'text-gray-500 hover:text-gray-700'\r\n                                }`}\r\n                        >\r\n                            等額本金\r\n                            <div className=\"text-xs text-gray-400 mt-0.5\">每月遞減金額</div>\r\n                        </button>\r\n                    </div>\r\n                </div>\r\n\r\n                {/* 已還期數（編輯時顯示） */}\r\n                {editingLoan && (\r\n                    <div className=\"grid grid-cols-2 gap-4\">\r\n                        <InputField\r\n                            label=\"已還期數\"\r\n                            type=\"number\"\r\n                            min=\"0\"\r\n                            max={formData.totalTerms}\r\n                            value={formData.paidTerms}\r\n                            onChange={e => updateField('paidTerms', parseInt(e.target.value) || 0)}\r\n                        />\r\n                        <InputField\r\n                            label=\"狀態\"\r\n                            type=\"select\"\r\n                            value={formData.status}\r\n                            onChange={e => updateField('status', e.target.value)}\r\n                        >\r\n                            <option value=\"active\">還款中</option>\r\n                            <option value=\"completed\">已結清</option>\r\n                        </InputField>\r\n                    </div>\r\n                )}\r\n\r\n                {/* 即時試算結果 */}\r\n                {formData.principalAmount && formData.interestRate && (\r\n                    <LoanCalculator\r\n                        principal={parseFloat(formData.principalAmount) || 0}\r\n                        rate={parseFloat(formData.interestRate) || 0}\r\n                        terms={formData.totalTerms}\r\n                        paymentType={formData.paymentType}\r\n                        showSchedule={true}\r\n                        compact={false}\r\n                    />\r\n                )}\r\n            </div>\r\n        </Modal>\r\n    );\r\n};\r\n\r\nexport default LoanAccountModal;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\xiang\\senteng-frontend\\src\\components\\finance\\LoanCalculator.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\xiang\\senteng-frontend\\src\\components\\project\\AddInventoryModal.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\xiang\\senteng-frontend\\src\\components\\project\\AddVendorModal.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\xiang\\senteng-frontend\\src\\components\\quotation\\QuotationPdfExport.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\xiang\\senteng-frontend\\src\\components\\quotation\\TemplateItemsEditor.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\xiang\\senteng-frontend\\src\\components\\rbac\\RequirePermission.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\xiang\\senteng-frontend\\src\\components\\widgets\\ClientVendorWidgets.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\xiang\\senteng-frontend\\src\\components\\widgets\\DashboardWidgets.jsx","messages":[{"ruleId":"no-unused-vars","severity":2,"message":"'size' is defined but never used. Allowed unused args must match /^_|^e$|^err$|^event$/u.","line":130,"column":46,"nodeType":"Identifier","messageId":"unusedVar","endLine":130,"endColumn":50,"suggestions":[{"messageId":"removeVar","data":{"varName":"size"},"fix":{"range":[6310,6316],"text":""},"desc":"Remove unused variable 'size'."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\r\nimport React, { useState } from 'react';\r\nimport { Calendar as CalendarIcon, Wallet, StickyNote, Plus, Trash2, ArrowUpRight, ArrowDownRight, Briefcase, Users, Activity } from 'lucide-react';\r\nimport { Badge } from '../common/Badge';\r\n\r\nexport const WidgetDailySchedule = ({ events, size }) => {\r\n    const today = new Date().toISOString().split('T')[0];\r\n    const dailyEvents = events ? events.filter(e => e.date === \"2025-12-07\") : []; // Mock today \r\n\r\n    if (size === 'S') return (\r\n        <div className=\"h-full flex flex-col justify-between p-2\">\r\n            <div className=\"flex items-center gap-2 text-morandi-blue-600\">\r\n                <CalendarIcon size={20} />\r\n                <span className=\"font-bold text-sm\">今日行程</span>\r\n            </div>\r\n            <div className=\"text-3xl font-bold text-morandi-text-primary\">{dailyEvents.length}</div>\r\n            <div className=\"text-xs text-gray-500\">待辦事項</div>\r\n        </div>\r\n    );\r\n\r\n    return (\r\n        <div className=\"h-full flex flex-col\">\r\n            <div className=\"text-sm font-bold text-gray-500 mb-2\">{today} (模擬)</div>\r\n            <div className=\"flex-1 overflow-y-auto space-y-2 pr-1 custom-scrollbar\">\r\n                {dailyEvents.length === 0 ? <div className=\"text-gray-400 text-sm text-center py-4\">無行程</div> : dailyEvents.map(evt => (\r\n                    <div key={evt.id} className=\"flex gap-3 items-start p-2 rounded-lg hover:bg-gray-50 transition-colors border-l-2 border-morandi-blue-500 pl-2\">\r\n                        <div className=\"text-xs font-mono font-bold text-morandi-text-accent mt-0.5\">{evt.time}</div>\r\n                        <div className=\"text-sm text-gray-700\">{evt.title}</div>\r\n                    </div>\r\n                ))}\r\n            </div>\r\n        </div>\r\n    );\r\n};\r\n\r\nexport const WidgetMemo = ({ size }) => {\r\n    const [memos, setMemos] = useState([]);\r\n    const [newMemo, setNewMemo] = useState(\"\");\r\n\r\n    const addMemo = (e) => {\r\n        if (e.key === 'Enter' && newMemo.trim()) {\r\n            setMemos([...memos, newMemo.trim()]);\r\n            setNewMemo(\"\");\r\n        }\r\n    };\r\n\r\n    if (size === 'S') return (\r\n        <div className=\"h-full flex flex-col justify-between p-2 relative bg-yellow-50/50\">\r\n            <StickyNote className=\"text-yellow-500 absolute top-2 right-2 opacity-50\" size={24} />\r\n            <div className=\"font-bold text-gray-700\">備忘錄</div>\r\n            <div className=\"text-3xl font-bold text-gray-800\">{memos.length}</div>\r\n        </div>\r\n    );\r\n\r\n    return (\r\n        <div className=\"h-full flex flex-col bg-yellow-50/30 -m-4 p-4\">\r\n            <div className=\"flex-1 overflow-y-auto space-y-2 mb-2 custom-scrollbar\">\r\n                {memos.map((m, i) => (\r\n                    <div key={i} className=\"bg-white/80 p-2 shadow-sm rounded border border-yellow-100/50 flex justify-between group\">\r\n                        <span className=\"text-sm text-gray-700\">{m}</span>\r\n                        <button onClick={() => setMemos(memos.filter((_, idx) => idx !== i))} className=\"text-gray-300 hover:text-red-400 opacity-0 group-hover:opacity-100 transition-opacity\"><Trash2 size={14} /></button>\r\n                    </div>\r\n                ))}\r\n            </div>\r\n            <input\r\n                value={newMemo}\r\n                onChange={e => setNewMemo(e.target.value)}\r\n                onKeyDown={addMemo}\r\n                placeholder=\"+ 新增備忘...\"\r\n                className=\"w-full bg-white/60 border-none rounded-lg p-2 text-sm focus:ring-2 focus:ring-yellow-400 placeholder-yellow-600/50\"\r\n            />\r\n        </div>\r\n    );\r\n};\r\n\r\nexport const WidgetOverviewStats = ({ finance, projects, clients, size }) => {\r\n    // Finance Calculation\r\n    const totalBalance = finance?.accounts?.reduce((acc, c) => acc + c.balance, 0) || 0;\r\n    const monthlyIncome = finance?.transactions?.filter(t => t.type === '收入').reduce((acc, c) => acc + c.amount, 0) || 0;\r\n\r\n    // Projects Calculation\r\n    const activeProjects = projects?.filter(p => p.status === '施工中' || p.status === '進行中').length || 0;\r\n\r\n    // Clients\r\n    const newClients = clients?.filter(c => c.status === '洽談中').length || 0;\r\n\r\n    if (size === 'S') return (\r\n        <div className=\"h-full flex flex-col justify-between\">\r\n            <div className=\"flex items-center gap-2 text-morandi-green-600\">\r\n                <Wallet size={20} />\r\n                <span className=\"font-bold text-sm\">本月營收</span>\r\n            </div>\r\n            <div>\r\n                <div className=\"text-2xl font-bold text-gray-800\">${(monthlyIncome / 10000).toFixed(1)}萬</div>\r\n                <div className=\"text-xs text-gray-400\">本月統計</div>\r\n            </div>\r\n        </div>\r\n    );\r\n\r\n    return (\r\n        <div className=\"h-full flex flex-col justify-center gap-4\">\r\n            <div className=\"flex items-center justify-between p-3 bg-gray-50 rounded-xl\">\r\n                <div className=\"flex items-center gap-3\">\r\n                    <div className=\"p-2 bg-blue-100 text-blue-600 rounded-lg\"><Briefcase size={18} /></div>\r\n                    <div>\r\n                        <div className=\"text-xs text-gray-500\">進行中專案</div>\r\n                        <div className=\"text-lg font-bold text-gray-800\">{activeProjects} <span className=\"text-xs font-normal text-gray-400\">案</span></div>\r\n                    </div>\r\n                </div>\r\n                <div className=\"h-8 w-[1px] bg-gray-200\"></div>\r\n                <div className=\"flex items-center gap-3\">\r\n                    <div className=\"p-2 bg-green-100 text-green-600 rounded-lg\"><Wallet size={18} /></div>\r\n                    <div>\r\n                        <div className=\"text-xs text-gray-500\">總資產結餘</div>\r\n                        <div className=\"text-lg font-bold text-gray-800\">${(totalBalance / 10000).toFixed(1)}萬</div>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n            <div className=\"flex items-center justify-between px-3\">\r\n                <div className=\"flex items-center gap-2 text-gray-600\">\r\n                    <Users size={16} />\r\n                    <span className=\"text-sm\">新客戶洽談</span>\r\n                </div>\r\n                <Badge color=\"orange\">{newClients} 位</Badge>\r\n            </div>\r\n        </div>\r\n    );\r\n};\r\n\r\nexport const WidgetRecentActivity = ({ logs, size }) => {\r\n    // Use real logs if provided, otherwise show empty state\r\n    const activities = logs || [];\r\n\r\n    return (\r\n        <div className=\"h-full flex flex-col\">\r\n            <div className=\"flex items-center gap-2 mb-3 text-gray-500\">\r\n                <Activity size={16} />\r\n                <span className=\"text-xs font-bold uppercase tracking-wider\">最新動態</span>\r\n            </div>\r\n            <div className=\"flex-1 overflow-y-auto space-y-3 custom-scrollbar pr-2\">\r\n                {activities.length === 0 ? (\r\n                    <div className=\"text-center py-4 text-gray-400 text-sm\">暫無動態</div>\r\n                ) : activities.map(log => (\r\n                    <div key={log.id} className=\"flex gap-3 text-sm\">\r\n                        <div className=\"w-12 text-[10px] text-gray-400 text-right pt-0.5 shrink-0\">{log.time}</div>\r\n                        <div className=\"relative pl-3 border-l border-gray-100\">\r\n                            <div className={`absolute left-[-2.5px] top-1.5 w-1.5 h-1.5 rounded-full ${log.type === 'finance' ? 'bg-green-400' : 'bg-morandi-blue-400'}`}></div>\r\n                            <div className=\"text-gray-700 leading-snug\">{log.text}</div>\r\n                        </div>\r\n                    </div>\r\n                ))}\r\n            </div>\r\n        </div>\r\n    );\r\n};\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\xiang\\senteng-frontend\\src\\components\\widgets\\FinanceWidgets.jsx","messages":[{"ruleId":"no-unused-vars","severity":2,"message":"'size' is defined but never used. Allowed unused args must match /^_|^e$|^err$|^event$/u.","line":102,"column":38,"nodeType":"Identifier","messageId":"unusedVar","endLine":102,"endColumn":42,"suggestions":[{"messageId":"removeVar","data":{"varName":"size"},"fix":{"range":[5022,5027],"text":""},"desc":"Remove unused variable 'size'."}]},{"ruleId":"no-unused-vars","severity":2,"message":"'size' is defined but never used. Allowed unused args must match /^_|^e$|^err$|^event$/u.","line":121,"column":51,"nodeType":"Identifier","messageId":"unusedVar","endLine":121,"endColumn":55,"suggestions":[{"messageId":"removeVar","data":{"varName":"size"},"fix":{"range":[5830,5836],"text":""},"desc":"Remove unused variable 'size'."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\r\nimport React, { useState } from 'react';\r\nimport { Wallet, ChevronDown, ChevronUp, Plus, GripVertical } from 'lucide-react';\r\nimport { TrendChart } from './TrendChart'; // Helper needed\r\n\r\nconst AccountCard = ({ account, onEdit, onViewDetails, onDragStart, onDragOver, onDragEnd }) => {\r\n    const [expanded, setExpanded] = useState(false);\r\n\r\n    // Dynamic border color based on bank/custom\r\n    const borderColor = expanded ? \"border-morandi-blue-300\" : \"border-gray-100\";\r\n\r\n    return (\r\n        <div\r\n            draggable\r\n            onDragStart={onDragStart} onDragOver={onDragOver} onDragEnd={onDragEnd}\r\n            className={`bg-white rounded-2xl border ${borderColor} shadow-sm transition-all duration-300 mb-3 overflow-hidden cursor-default`}\r\n        >\r\n            <div\r\n                onClick={() => setExpanded(!expanded)}\r\n                className=\"p-3 sm:p-4 flex items-center justify-between cursor-pointer hover:bg-gray-50/50\"\r\n            >\r\n                <div className=\"flex items-center gap-2 sm:gap-3\">\r\n                    <div className=\"hidden sm:block text-gray-300 cursor-grab active:cursor-grabbing p-1\" onMouseDown={e => e.stopPropagation()}>\r\n                        <GripVertical size={16} />\r\n                    </div>\r\n                    <div>\r\n                        <div className=\"font-bold text-sm sm:text-base text-gray-800\">{account.name}</div>\r\n                        {!expanded && <div className=\"text-xs text-gray-400\">最新收支: -</div>}\r\n                    </div>\r\n                </div>\r\n                <div className=\"text-right\">\r\n                    <div className={`font-bold font-mono text-sm sm:text-base ${account.balance < 0 ? 'text-red-500' : 'text-gray-800'}`}>\r\n                        ${account.balance.toLocaleString()}\r\n                    </div>\r\n                    <div className=\"flex justify-end mt-1 text-gray-400\">\r\n                        {expanded ? <ChevronUp size={16} /> : <ChevronDown size={16} />}\r\n                    </div>\r\n                </div>\r\n            </div>\r\n\r\n            {/* Expanded Details */}\r\n            {expanded && (\r\n                <div className=\"px-3 sm:px-4 pb-3 sm:pb-4 bg-gray-50/30 border-t border-gray-100 animate-slide-up\">\r\n                    <div className=\"grid grid-cols-2 gap-3 sm:gap-4 text-sm mb-3 pt-3\">\r\n                        <div>\r\n                            <span className=\"block text-xs text-gray-500 mb-1\">銀行機構</span>\r\n                            <div className=\"font-medium text-sm\">{account.bank}</div>\r\n                        </div>\r\n                        <div>\r\n                            <span className=\"block text-xs text-gray-500 mb-1\">帳號</span>\r\n                            <div className=\"font-mono text-xs sm:text-sm text-gray-600 tracking-wide\">{account.number}</div>\r\n                        </div>\r\n                    </div>\r\n                    <div className=\"flex justify-end gap-2\">\r\n                        <button onClick={(e) => { e.stopPropagation(); onEdit(account); }} className=\"px-2 sm:px-3 py-1.5 text-xs bg-white border border-gray-200 rounded-lg hover:border-morandi-blue-300 text-gray-600 transition-colors\">\r\n                            編輯帳戶\r\n                        </button>\r\n                        <button onClick={(e) => { e.stopPropagation(); onViewDetails(account); }} className=\"px-2 sm:px-3 py-1.5 text-xs bg-morandi-text-accent text-white rounded-lg hover:bg-gray-800 transition-colors\">\r\n                            查看明細\r\n                        </button>\r\n                    </div>\r\n                </div>\r\n            )}\r\n        </div>\r\n    );\r\n};\r\n\r\nexport const WidgetFinanceAccounts = ({ data, size, onEdit, onViewDetails, ...dragProps }) => {\r\n    const accounts = data || [];\r\n    const total = accounts.reduce((acc, c) => acc + c.balance, 0);\r\n\r\n    if (size === 'S') return (\r\n        <div className=\"h-full flex flex-col justify-between p-2\">\r\n            <Wallet size={24} className=\"text-morandi-blue-500\" />\r\n            <div>\r\n                <div className=\"text-2xl font-bold text-gray-800\">${total.toLocaleString()}</div>\r\n                <div className=\"text-xs text-gray-500\">總資產</div>\r\n            </div>\r\n        </div>\r\n    );\r\n\r\n    return (\r\n        <div className=\"h-full flex flex-col\">\r\n            <div className=\"flex-1 overflow-y-auto pr-1\">\r\n                {accounts.map((acc, index) => (\r\n                    <AccountCard\r\n                        key={acc.id}\r\n                        account={acc}\r\n                        onEdit={onEdit}\r\n                        onViewDetails={onViewDetails}\r\n                        onDragStart={(e) => dragProps.onDragStartAccount(e, index)}\r\n                        onDragOver={(e) => dragProps.onDragOverAccount(e, index)}\r\n                        onDragEnd={dragProps.onDragEndAccount}\r\n                    />\r\n                ))}\r\n            </div>\r\n        </div>\r\n    );\r\n};\r\n\r\n// ... Transaction and Trend Implementation\r\nexport const WidgetFinanceTrend = ({ size, type = 'month' }) => {\r\n    // Enhanced Trend Logic\r\n    return (\r\n        <div className=\"h-full flex flex-col\">\r\n            <div className=\"flex justify-between items-center mb-2\">\r\n                <span className=\"font-bold text-gray-700 text-sm\">收支趨勢</span>\r\n                <div className=\"flex bg-gray-100 rounded-lg p-0.5\">\r\n                    {['週', '月', '年'].map(t => (\r\n                        <span key={t} className={`text-[10px] px-2 py-0.5 rounded cursor-pointer ${type === t ? 'bg-white shadow-sm font-bold' : 'text-gray-500'}`}>{t}</span>\r\n                    ))}\r\n                </div>\r\n            </div>\r\n            <div className=\"flex-1 relative\">\r\n                <TrendChart />\r\n            </div>\r\n        </div>\r\n    )\r\n}\r\n\r\nexport const WidgetFinanceTransactions = ({ data, size, onAddTx }) => {\r\n    // ... Reuse similar logic from react.txt but styled\r\n    return (\r\n        <div className=\"h-full flex flex-col\">\r\n            <div className=\"flex justify-between items-center mb-3\">\r\n                <h4 className=\"font-bold text-gray-700 text-xs\">近期紀錄</h4>\r\n                <button onClick={onAddTx} className=\"p-1 hover:bg-gray-100 rounded text-morandi-blue-600\"><Plus size={16} /></button>\r\n            </div>\r\n            <div className=\"flex-1 overflow-y-auto space-y-2\">\r\n                {data.map(t => (\r\n                    <div key={t.id} className=\"flex justify-between items-center text-sm p-2 hover:bg-gray-50 rounded-lg transition-colors\">\r\n                        <div>\r\n                            <div className=\"font-medium text-gray-800\">{t.desc}</div>\r\n                            <div className=\"text-[10px] text-gray-400\">{t.date}</div>\r\n                        </div>\r\n                        <div className={`font-mono font-bold ${t.type === '收入' ? 'text-morandi-green-600' : 'text-red-500'}`}>\r\n                            {t.type === '收入' ? '+' : '-'} {t.amount}\r\n                        </div>\r\n                    </div>\r\n                ))}\r\n            </div>\r\n        </div>\r\n    )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\xiang\\senteng-frontend\\src\\components\\widgets\\ProjectInventoryWidget.jsx","messages":[{"ruleId":"no-unused-vars","severity":2,"message":"'size' is defined but never used. Allowed unused args must match /^_|^e$|^err$|^event$/u.","line":4,"column":58,"nodeType":"Identifier","messageId":"unusedVar","endLine":4,"endColumn":62,"suggestions":[{"messageId":"removeVar","data":{"varName":"size"},"fix":{"range":[165,171],"text":""},"desc":"Remove unused variable 'size'."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React from 'react';\r\nimport { Plus, Package, TrendingDown, TrendingUp, Clock } from 'lucide-react';\r\n\r\nexport const WidgetProjectInventory = ({ inventory = [], size, onAddRecord }) => {\r\n    const getTypeIcon = (type) => {\r\n        return type === '出'\r\n            ? <TrendingDown size={14} className=\"text-red-500\" />\r\n            : <TrendingUp size={14} className=\"text-green-500\" />;\r\n    };\r\n\r\n    const getTypeColor = (type) => {\r\n        return type === '出'\r\n            ? 'bg-red-50 text-red-600 border-red-100'\r\n            : 'bg-green-50 text-green-600 border-green-100';\r\n    };\r\n\r\n    // 按日期分組\r\n    const groupedByDate = inventory.reduce((acc, item) => {\r\n        if (!acc[item.date]) {\r\n            acc[item.date] = [];\r\n        }\r\n        acc[item.date].push(item);\r\n        return acc;\r\n    }, {});\r\n\r\n    const sortedDates = Object.keys(groupedByDate).sort((a, b) => new Date(b) - new Date(a));\r\n\r\n    return (\r\n        <div className=\"flex flex-col h-full\">\r\n            <div className=\"flex justify-between items-center mb-3\">\r\n                <div className=\"flex items-center gap-2\">\r\n                    <Package size={16} className=\"text-gray-600\" />\r\n                    <h4 className=\"text-xs font-bold text-gray-600\">庫存物品進出</h4>\r\n                </div>\r\n                {onAddRecord && (\r\n                    <button\r\n                        onClick={onAddRecord}\r\n                        className=\"text-morandi-blue-600 hover:bg-morandi-blue-50 p-1.5 rounded-lg transition-colors\"\r\n                        title=\"新增記錄\"\r\n                    >\r\n                        <Plus size={14} />\r\n                    </button>\r\n                )}\r\n            </div>\r\n\r\n            <div className=\"flex-1 overflow-y-auto pr-1 custom-scrollbar\">\r\n                {inventory.length === 0 ? (\r\n                    <div className=\"text-center py-8 text-gray-400 text-xs\">\r\n                        <Package size={32} className=\"mx-auto mb-2 opacity-30\" />\r\n                        <p>尚無物品進出記錄</p>\r\n                    </div>\r\n                ) : (\r\n                    <div className=\"space-y-4\">\r\n                        {sortedDates.map(date => (\r\n                            <div key={date}>\r\n                                <div className=\"flex items-center gap-2 mb-2\">\r\n                                    <Clock size={12} className=\"text-gray-400\" />\r\n                                    <span className=\"text-xs text-gray-500 font-medium\">{date}</span>\r\n                                </div>\r\n                                <div className=\"space-y-2\">\r\n                                    {groupedByDate[date].map((item, idx) => (\r\n                                        <div\r\n                                            key={item.id || idx}\r\n                                            className=\"bg-gray-50 p-2.5 rounded-lg border border-gray-100 hover:border-gray-200 transition-colors\"\r\n                                        >\r\n                                            <div className=\"flex items-start justify-between mb-1\">\r\n                                                <div className=\"flex items-center gap-2\">\r\n                                                    <span className={`px-1.5 py-0.5 rounded text-xs border flex items-center gap-1 ${getTypeColor(item.type)}`}>\r\n                                                        {getTypeIcon(item.type)}\r\n                                                        {item.type}\r\n                                                    </span>\r\n                                                    <span className=\"font-medium text-xs text-gray-800\">{item.itemName}</span>\r\n                                                </div>\r\n                                                <span className=\"text-xs font-bold text-gray-600\">x{item.quantity}</span>\r\n                                            </div>\r\n\r\n                                            {item.note && (\r\n                                                <div className=\"text-xs text-gray-500 mt-1\">{item.note}</div>\r\n                                            )}\r\n\r\n                                            <div className=\"text-xs text-gray-400 mt-1\">\r\n                                                操作人：{item.operator}\r\n                                            </div>\r\n                                        </div>\r\n                                    ))}\r\n                                </div>\r\n                            </div>\r\n                        ))}\r\n                    </div>\r\n                )}\r\n            </div>\r\n        </div>\r\n    );\r\n};\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\xiang\\senteng-frontend\\src\\components\\widgets\\ProjectVendorsWidget.jsx","messages":[{"ruleId":"no-unused-vars","severity":2,"message":"'useState' is defined but never used. Allowed unused vars must match /^[A-Z_]|^_/u.","line":1,"column":17,"nodeType":"Identifier","messageId":"unusedVar","endLine":1,"endColumn":25,"suggestions":[{"messageId":"removeVar","data":{"varName":"useState"},"fix":{"range":[12,26],"text":""},"desc":"Remove unused variable 'useState'."}]},{"ruleId":"no-unused-vars","severity":2,"message":"'size' is defined but never used. Allowed unused args must match /^_|^e$|^err$|^event$/u.","line":4,"column":54,"nodeType":"Identifier","messageId":"unusedVar","endLine":4,"endColumn":58,"suggestions":[{"messageId":"removeVar","data":{"varName":"size"},"fix":{"range":[176,182],"text":""},"desc":"Remove unused variable 'size'."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState } from 'react';\r\nimport { Plus, X, Users, CheckCircle, Clock, AlertCircle } from 'lucide-react';\r\n\r\nexport const WidgetProjectVendors = ({ vendors = [], size, onAddVendor, onRemoveVendor }) => {\r\n    const getStatusIcon = (status) => {\r\n        switch (status) {\r\n            case '進行中': return <Clock size={14} className=\"text-blue-500\" />;\r\n            case '已完成': return <CheckCircle size={14} className=\"text-green-500\" />;\r\n            case '待開始': return <AlertCircle size={14} className=\"text-gray-400\" />;\r\n            default: return null;\r\n        }\r\n    };\r\n\r\n    const getStatusColor = (status) => {\r\n        switch (status) {\r\n            case '進行中': return 'bg-blue-50 text-blue-600 border-blue-100';\r\n            case '已完成': return 'bg-green-50 text-green-600 border-green-100';\r\n            case '待開始': return 'bg-gray-50 text-gray-600 border-gray-100';\r\n            default: return 'bg-gray-50 text-gray-600 border-gray-100';\r\n        }\r\n    };\r\n\r\n    return (\r\n        <div className=\"flex flex-col h-full\">\r\n            <div className=\"flex justify-between items-center mb-3\">\r\n                <div className=\"flex items-center gap-2\">\r\n                    <Users size={16} className=\"text-gray-600\" />\r\n                    <h4 className=\"text-xs font-bold text-gray-600\">參與廠商</h4>\r\n                </div>\r\n                {onAddVendor && (\r\n                    <button\r\n                        onClick={onAddVendor}\r\n                        className=\"text-morandi-blue-600 hover:bg-morandi-blue-50 p-1.5 rounded-lg transition-colors\"\r\n                        title=\"新增廠商\"\r\n                    >\r\n                        <Plus size={14} />\r\n                    </button>\r\n                )}\r\n            </div>\r\n\r\n            <div className=\"flex-1 overflow-y-auto space-y-2 pr-1 custom-scrollbar\">\r\n                {vendors.length === 0 ? (\r\n                    <div className=\"text-center py-8 text-gray-400 text-xs\">\r\n                        <Users size={32} className=\"mx-auto mb-2 opacity-30\" />\r\n                        <p>尚未新增廠商</p>\r\n                    </div>\r\n                ) : (\r\n                    vendors.map((vendor, idx) => (\r\n                        <div\r\n                            key={vendor.vendorId || idx}\r\n                            className=\"bg-gray-50 p-3 rounded-xl border border-gray-100 hover:border-morandi-blue-200 transition-all group\"\r\n                        >\r\n                            <div className=\"flex items-start justify-between mb-2\">\r\n                                <div className=\"flex-1\">\r\n                                    <div className=\"font-bold text-sm text-gray-800\">{vendor.name}</div>\r\n                                    <div className=\"text-xs text-gray-500\">{vendor.role}</div>\r\n                                </div>\r\n                                {onRemoveVendor && (\r\n                                    <button\r\n                                        onClick={() => onRemoveVendor(vendor.vendorId)}\r\n                                        className=\"opacity-0 group-hover:opacity-100 p-1 hover:bg-red-50 rounded transition-all\"\r\n                                        title=\"移除廠商\"\r\n                                    >\r\n                                        <X size={12} className=\"text-red-500\" />\r\n                                    </button>\r\n                                )}\r\n                            </div>\r\n\r\n                            <div className=\"flex items-center justify-between text-xs\">\r\n                                <span className=\"text-gray-400\">加入：{vendor.joinDate}</span>\r\n                                <span className={`px-2 py-0.5 rounded-full border flex items-center gap-1 ${getStatusColor(vendor.status)}`}>\r\n                                    {getStatusIcon(vendor.status)}\r\n                                    {vendor.status}\r\n                                </span>\r\n                            </div>\r\n                        </div>\r\n                    ))\r\n                )}\r\n            </div>\r\n        </div>\r\n    );\r\n};\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\xiang\\senteng-frontend\\src\\components\\widgets\\ProjectWidgets.jsx","messages":[{"ruleId":"no-unused-vars","severity":2,"message":"'size' is defined but never used. Allowed unused args must match /^_|^e$|^err$|^event$/u.","line":62,"column":46,"nodeType":"Identifier","messageId":"unusedVar","endLine":62,"endColumn":50,"suggestions":[{"messageId":"removeVar","data":{"varName":"size"},"fix":{"range":[4214,4220],"text":""},"desc":"Remove unused variable 'size'."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\r\nimport React from 'react';\r\nimport { Briefcase, Plus, FileText, Image as ImageIcon, Upload, Edit2, ChevronLeft } from 'lucide-react';\r\nimport { ProgressBar } from '../common/Indicators';\r\n\r\n// --- MAIN PROJECT LIST WIDGETS ---\r\nexport const WidgetProjectStats = ({ data, size }) => {\r\n    if (!Array.isArray(data)) return null;\r\n    const activeCount = data.filter(p => [\"設計中\", \"施工中\"].includes(p.status)).length;\r\n    if (size === 'S') return <div className=\"h-full flex flex-col justify-between\"><Briefcase size={24} className=\"text-morandi-blue-500\" /><div><div className=\"text-3xl font-bold text-morandi-text-primary\">{activeCount}</div><div className=\"text-xs text-gray-500\">進行中專案</div></div></div>;\r\n\r\n    const designCount = data.filter(p => p.status === \"設計中\").length;\r\n    const constructionCount = data.filter(p => p.status === \"施工中\").length;\r\n\r\n    return (\r\n        <div className=\"flex flex-col h-full justify-between\">\r\n            <div className=\"flex justify-between items-end\">\r\n                <div><div className=\"text-3xl font-bold text-morandi-text-primary\">{activeCount}</div><div className=\"text-xs text-gray-500\">總進行中</div></div>\r\n                <div className=\"space-y-1 text-right\">\r\n                    <div className=\"text-xs\"><span className=\"font-bold text-morandi-blue-600\">{designCount}</span> 設計中</div>\r\n                    <div className=\"text-xs\"><span className=\"font-bold text-morandi-orange-600\">{constructionCount}</span> 施工中</div>\r\n                </div>\r\n            </div>\r\n            {size === 'L' && (\r\n                <div className=\"mt-4 flex gap-1\">\r\n                    <div style={{ width: `${(designCount / activeCount || 0) * 100}%` }} className=\"bg-morandi-blue-500 h-2 rounded-l-full\"></div>\r\n                    <div style={{ width: `${(constructionCount / activeCount || 0) * 100}%` }} className=\"bg-morandi-orange-500 h-2 rounded-r-full\"></div>\r\n                </div>\r\n            )}\r\n        </div>\r\n    );\r\n};\r\n\r\nexport const WidgetProjectList = ({ data, size, onSelectProject, onAdd }) => {\r\n    if (!Array.isArray(data)) return null;\r\n    if (size === 'S') return <div className=\"h-full flex flex-col justify-center items-center gap-2\"><div className=\"w-12 h-12 rounded-full bg-gray-100 text-gray-600 flex items-center justify-center cursor-pointer hover:bg-gray-200 transition-colors\" onClick={onAdd}><Plus size={24} /></div><button className=\"text-xs font-bold text-gray-600 hover:text-morandi-blue-600\" onClick={onAdd}>新增專案</button></div>;\r\n\r\n    return (\r\n        <div className=\"flex flex-col h-full\">\r\n            <div className=\"flex justify-between mb-4 gap-2\">\r\n                <span className=\"font-bold text-gray-500 text-xs\">最近更新 ({data.length})</span>\r\n                {size === 'L' && <button onClick={onAdd} className=\"bg-morandi-text-accent text-white px-2 py-1 text-xs rounded-lg flex items-center gap-1 hover:bg-gray-700 transition-colors\"><Plus size={12} /> 新增</button>}\r\n            </div>\r\n            <div className={`overflow-y-auto pr-1 pb-2 custom-scrollbar ${size === 'L' ? 'grid grid-cols-2 gap-3' : 'space-y-3'}`}>\r\n                {data.map(p => (\r\n                    <div key={p.id} onClick={() => onSelectProject && onSelectProject(p)} className=\"bg-white border border-gray-100 rounded-xl p-4 hover:shadow-lg hover:border-morandi-blue-200 transition-all cursor-pointer group\">\r\n                        <div className=\"flex items-center gap-2 mb-2\">\r\n                            <span className={`w-2.5 h-2.5 rounded-full ${p.status === '施工中' ? 'bg-morandi-orange-500' : 'bg-morandi-blue-500'}`}></span>\r\n                            <h4 className=\"font-bold text-morandi-text-primary text-sm truncate\">{p.name}</h4>\r\n                        </div>\r\n                        <p className=\"text-xs text-gray-400 font-mono mb-4\">{p.code}</p>\r\n                        <div className=\"flex justify-between text-[10px] text-gray-500 mb-1\"><span>進度</span><span>{p.progress}%</span></div>\r\n                        <ProgressBar value={p.progress} />\r\n                    </div>\r\n                ))}\r\n            </div>\r\n        </div>\r\n    );\r\n};\r\n\r\n// --- PROJECT DETAIL WIDGETS ---\r\nexport const WidgetProjectInfo = ({ project, size }) => (\r\n    <div className=\"space-y-4\">\r\n        <div className=\"grid grid-cols-2 gap-4\">\r\n            <div className=\"bg-gray-50 p-3 rounded-xl\"><span className=\"text-xs text-gray-500 block mb-1\">業主</span><span className=\"font-bold text-gray-800\">{project.clientName}</span></div>\r\n            <div className=\"bg-gray-50 p-3 rounded-xl\"><span className=\"text-xs text-gray-500 block mb-1\">類型</span><span className=\"font-bold text-gray-800\">{project.type}</span></div>\r\n        </div>\r\n        <div>\r\n            <div className=\"flex justify-between text-xs text-gray-500 mb-1\"><span>專案進度</span><span>{project.progress}%</span></div>\r\n            <ProgressBar value={project.progress} />\r\n        </div>\r\n    </div>\r\n);\r\n\r\nexport const WidgetProjectFiles = ({ files, size, onUpload }) => {\r\n    if (size === 'S') return <div className=\"h-full flex flex-col justify-center items-center gap-2\"><div className=\"w-10 h-10 bg-morandi-orange-100 text-morandi-orange-600 rounded-full flex items-center justify-center cursor-pointer hover:bg-morandi-orange-500 hover:text-white transition-colors\" onClick={onUpload}><Upload size={18} /></div><span className=\"text-xs text-gray-500\">上傳檔案</span></div>;\r\n    return (\r\n        <div className=\"flex flex-col h-full\">\r\n            <div className=\"flex justify-between mb-3 items-center\"><h4 className=\"text-xs font-bold text-gray-600\">Drive 檔案</h4><button onClick={onUpload} className=\"text-morandi-orange-600 hover:bg-morandi-orange-100 p-1.5 rounded-lg transition-colors\"><Upload size={14} /></button></div>\r\n            <div className=\"flex-1 overflow-y-auto space-y-2 pr-1 custom-scrollbar\">\r\n                {files.map(f => (\r\n                    <div key={f.id} className=\"flex items-center gap-3 p-2.5 hover:bg-gray-50 rounded-xl border border-transparent hover:border-gray-100 cursor-pointer transition-colors\">\r\n                        <div className=\"w-8 h-8 rounded-lg bg-blue-50 flex items-center justify-center text-blue-500\"><FileText size={16} /></div>\r\n                        <div className=\"min-w-0 flex-1\">\r\n                            <div className=\"text-xs font-medium text-gray-700 truncate\">{f.name}</div>\r\n                            <div className=\"text-[10px] text-gray-400\">{f.size} · {f.date}</div>\r\n                        </div>\r\n                    </div>\r\n                ))}\r\n            </div>\r\n        </div>\r\n    );\r\n};\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\xiang\\senteng-frontend\\src\\components\\widgets\\TrendChart.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\xiang\\senteng-frontend\\src\\main.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\xiang\\senteng-frontend\\src\\pages\\BimManagement.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\xiang\\senteng-frontend\\src\\pages\\ChangeOrders.jsx","messages":[{"ruleId":"no-unused-vars","severity":2,"message":"'error' is defined but never used.","line":238,"column":18,"nodeType":"Identifier","messageId":"unusedVar","endLine":238,"endColumn":23},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'loadData'. Either include it or remove the dependency array.","line":464,"column":8,"nodeType":"ArrayExpression","endLine":464,"endColumn":21,"suggestions":[{"desc":"Update the dependencies array to be: [loadData, quotationId]","fix":{"range":[19789,19802],"text":"[loadData, quotationId]"}}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * 工程變更單頁面 (ChangeOrders.jsx)\r\n * 變更單列表與編輯器\r\n */\r\n\r\nimport React, { useState, useEffect } from 'react';\r\nimport {\r\n    ChangeOrderService,\r\n    CHANGE_ORDER_STATUS,\r\n    CHANGE_ORDER_STATUS_LABELS,\r\n    CHANGE_ORDER_STATUS_COLORS,\r\n    CHANGE_TYPES,\r\n    CHANGE_TYPE_LABELS,\r\n    CHANGE_TYPE_COLORS,\r\n    CHANGE_REASONS,\r\n    calculateChangeOrderTotals,\r\n} from '../services/ChangeOrderService';\r\nimport { QuotationService } from '../services/QuotationService';\r\n\r\n// ============================================\r\n// 格式化函數\r\n// ============================================\r\nconst formatCurrency = (amount) => {\r\n    return new Intl.NumberFormat('zh-TW', {\r\n        style: 'currency',\r\n        currency: 'TWD',\r\n        minimumFractionDigits: 0,\r\n        maximumFractionDigits: 0,\r\n    }).format(amount || 0);\r\n};\r\n\r\nconst formatDate = (dateString) => {\r\n    if (!dateString) return '-';\r\n    return new Date(dateString).toLocaleDateString('zh-TW');\r\n};\r\n\r\n// ============================================\r\n// 狀態徽章\r\n// ============================================\r\nconst StatusBadge = ({ status }) => (\r\n    <span className={`px-2 py-1 rounded-full text-xs font-medium ${CHANGE_ORDER_STATUS_COLORS[status]}`}>\r\n        {CHANGE_ORDER_STATUS_LABELS[status]}\r\n    </span>\r\n);\r\n\r\nconst ChangeTypeBadge = ({ type }) => (\r\n    <span className={`px-2 py-1 rounded-full text-xs font-medium ${CHANGE_TYPE_COLORS[type]}`}>\r\n        {CHANGE_TYPE_LABELS[type]}\r\n    </span>\r\n);\r\n\r\n// ============================================\r\n// 變更項目列\r\n// ============================================\r\nconst ChangeItemRow = ({ item, index, onUpdate, onDelete, disabled }) => {\r\n    const amount = (parseFloat(item.quantity) || 0) * (parseFloat(item.unitPrice) || 0);\r\n    const originalAmount = (item.originalQuantity || 0) * (item.originalUnitPrice || 0);\r\n    const diff = amount - originalAmount;\r\n\r\n    return (\r\n        <tr className=\"border-b border-gray-100 hover:bg-gray-50\">\r\n            <td className=\"py-3 px-4\">\r\n                <select\r\n                    value={item.changeType}\r\n                    onChange={(e) => onUpdate(index, 'changeType', e.target.value)}\r\n                    disabled={disabled}\r\n                    className=\"w-full px-2 py-1 border rounded text-sm\"\r\n                >\r\n                    {Object.entries(CHANGE_TYPE_LABELS).map(([key, label]) => (\r\n                        <option key={key} value={key}>{label}</option>\r\n                    ))}\r\n                </select>\r\n            </td>\r\n            <td className=\"py-3 px-4\">\r\n                <input\r\n                    type=\"text\"\r\n                    value={item.name}\r\n                    onChange={(e) => onUpdate(index, 'name', e.target.value)}\r\n                    disabled={disabled}\r\n                    placeholder=\"項目名稱\"\r\n                    className=\"w-full px-2 py-1 border rounded text-sm\"\r\n                />\r\n            </td>\r\n            <td className=\"py-3 px-4\">\r\n                <input\r\n                    type=\"text\"\r\n                    value={item.specification || ''}\r\n                    onChange={(e) => onUpdate(index, 'specification', e.target.value)}\r\n                    disabled={disabled}\r\n                    placeholder=\"規格\"\r\n                    className=\"w-full px-2 py-1 border rounded text-sm\"\r\n                />\r\n            </td>\r\n            <td className=\"py-3 px-4\">\r\n                <input\r\n                    type=\"text\"\r\n                    value={item.unit}\r\n                    onChange={(e) => onUpdate(index, 'unit', e.target.value)}\r\n                    disabled={disabled}\r\n                    className=\"w-20 px-2 py-1 border rounded text-sm text-center\"\r\n                />\r\n            </td>\r\n            <td className=\"py-3 px-4\">\r\n                <input\r\n                    type=\"number\"\r\n                    value={item.quantity}\r\n                    onChange={(e) => onUpdate(index, 'quantity', parseFloat(e.target.value) || 0)}\r\n                    disabled={disabled}\r\n                    className=\"w-20 px-2 py-1 border rounded text-sm text-right\"\r\n                />\r\n            </td>\r\n            <td className=\"py-3 px-4\">\r\n                <input\r\n                    type=\"number\"\r\n                    value={item.unitPrice}\r\n                    onChange={(e) => onUpdate(index, 'unitPrice', parseFloat(e.target.value) || 0)}\r\n                    disabled={disabled}\r\n                    className=\"w-24 px-2 py-1 border rounded text-sm text-right\"\r\n                />\r\n            </td>\r\n            <td className=\"py-3 px-4 text-right font-medium\">\r\n                {formatCurrency(amount)}\r\n            </td>\r\n            <td className=\"py-3 px-4 text-right\">\r\n                {item.changeType === CHANGE_TYPES.MODIFY && (\r\n                    <span className={diff >= 0 ? 'text-green-600' : 'text-red-600'}>\r\n                        {diff >= 0 ? '+' : ''}{formatCurrency(diff)}\r\n                    </span>\r\n                )}\r\n            </td>\r\n            <td className=\"py-3 px-4\">\r\n                {!disabled && (\r\n                    <button\r\n                        onClick={() => onDelete(index)}\r\n                        className=\"text-red-500 hover:text-red-700\"\r\n                    >\r\n                        🗑️\r\n                    </button>\r\n                )}\r\n            </td>\r\n        </tr>\r\n    );\r\n};\r\n\r\n// ============================================\r\n// 變更單編輯器\r\n// ============================================\r\nconst ChangeOrderEditor = ({ changeOrder, quotation, onSave, onBack, addToast }) => {\r\n    const [formData, setFormData] = useState({\r\n        title: changeOrder?.title || '',\r\n        description: changeOrder?.description || '',\r\n        reason: changeOrder?.reason || 'client_request',\r\n        items: changeOrder?.items || [],\r\n    });\r\n    const [isSaving, setIsSaving] = useState(false);\r\n    const [quotationItems, setQuotationItems] = useState([]);\r\n\r\n    useEffect(() => {\r\n        if (quotation?.items) {\r\n            setQuotationItems(quotation.items.filter(i => i.type === 'ITEM'));\r\n        }\r\n    }, [quotation]);\r\n\r\n    const isEditable = !changeOrder || changeOrder.status === CHANGE_ORDER_STATUS.DRAFT;\r\n\r\n    const totals = calculateChangeOrderTotals(formData.items);\r\n    const originalAmount = changeOrder?.originalContractAmount || quotation?.totalAmount || 0;\r\n    const newAmount = originalAmount + totals.netChange;\r\n\r\n    const handleAddItem = () => {\r\n        const newItem = ChangeOrderService.createNewChangeItem();\r\n        setFormData(prev => ({\r\n            ...prev,\r\n            items: [...prev.items, newItem],\r\n        }));\r\n    };\r\n\r\n    const handleAddFromQuotation = (quotationItem, changeType) => {\r\n        const newItem = ChangeOrderService.createChangeItemFromQuotation(quotationItem, changeType);\r\n        setFormData(prev => ({\r\n            ...prev,\r\n            items: [...prev.items, newItem],\r\n        }));\r\n    };\r\n\r\n    const handleUpdateItem = (index, field, value) => {\r\n        setFormData(prev => ({\r\n            ...prev,\r\n            items: prev.items.map((item, i) =>\r\n                i === index ? { ...item, [field]: value } : item\r\n            ),\r\n        }));\r\n    };\r\n\r\n    const handleDeleteItem = (index) => {\r\n        setFormData(prev => ({\r\n            ...prev,\r\n            items: prev.items.filter((_, i) => i !== index),\r\n        }));\r\n    };\r\n\r\n    const handleSave = async () => {\r\n        if (!formData.title.trim()) {\r\n            addToast?.('error', '請輸入變更單標題');\r\n            return;\r\n        }\r\n        if (formData.items.length === 0) {\r\n            addToast?.('error', '請新增至少一個變更項目');\r\n            return;\r\n        }\r\n\r\n        setIsSaving(true);\r\n        try {\r\n            if (changeOrder?.id) {\r\n                await ChangeOrderService.updateChangeOrder(changeOrder.id, formData);\r\n            } else {\r\n                await ChangeOrderService.createChangeOrder({\r\n                    ...formData,\r\n                    quotationId: quotation.id,\r\n                });\r\n            }\r\n            addToast?.('success', '儲存成功');\r\n            onSave?.();\r\n        } catch (error) {\r\n            console.error('Save error:', error);\r\n            addToast?.('error', '儲存失敗: ' + error.message);\r\n        } finally {\r\n            setIsSaving(false);\r\n        }\r\n    };\r\n\r\n    const handleSubmit = async () => {\r\n        await handleSave();\r\n        try {\r\n            await ChangeOrderService.submitForReview(changeOrder.id, 'current-user');\r\n            addToast?.('success', '已送出審核');\r\n            onSave?.();\r\n        } catch (error) {\r\n            addToast?.('error', '送出失敗');\r\n        }\r\n    };\r\n\r\n    return (\r\n        <div className=\"space-y-6\">\r\n            {/* 頂部導航 */}\r\n            <div className=\"flex items-center justify-between\">\r\n                <div className=\"flex items-center gap-4\">\r\n                    <button\r\n                        onClick={onBack}\r\n                        className=\"p-2 hover:bg-gray-100 rounded-lg\"\r\n                    >\r\n                        ← 返回\r\n                    </button>\r\n                    <div>\r\n                        <h2 className=\"text-xl font-bold\">\r\n                            {changeOrder?.changeOrderNo || '新增變更單'}\r\n                        </h2>\r\n                        <p className=\"text-sm text-gray-500\">\r\n                            {quotation?.quotationNo} - {quotation?.title}\r\n                        </p>\r\n                    </div>\r\n                    {changeOrder && <StatusBadge status={changeOrder.status} />}\r\n                </div>\r\n                <div className=\"flex gap-2\">\r\n                    {isEditable && (\r\n                        <>\r\n                            <button\r\n                                onClick={handleSave}\r\n                                disabled={isSaving}\r\n                                className=\"px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50\"\r\n                            >\r\n                                {isSaving ? '儲存中...' : '儲存'}\r\n                            </button>\r\n                            {changeOrder?.id && (\r\n                                <button\r\n                                    onClick={handleSubmit}\r\n                                    className=\"px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700\"\r\n                                >\r\n                                    送出審核\r\n                                </button>\r\n                            )}\r\n                        </>\r\n                    )}\r\n                </div>\r\n            </div>\r\n\r\n            {/* 基本資訊 */}\r\n            <div className=\"bg-white rounded-xl p-6 shadow-sm border border-gray-100\">\r\n                <h3 className=\"font-semibold mb-4\">基本資訊</h3>\r\n                <div className=\"grid grid-cols-3 gap-4\">\r\n                    <div>\r\n                        <label className=\"block text-sm text-gray-600 mb-1\">變更單標題</label>\r\n                        <input\r\n                            type=\"text\"\r\n                            value={formData.title}\r\n                            onChange={(e) => setFormData(prev => ({ ...prev, title: e.target.value }))}\r\n                            disabled={!isEditable}\r\n                            placeholder=\"例：追加隔間牆工程\"\r\n                            className=\"w-full px-3 py-2 border rounded-lg\"\r\n                        />\r\n                    </div>\r\n                    <div>\r\n                        <label className=\"block text-sm text-gray-600 mb-1\">變更原因</label>\r\n                        <select\r\n                            value={formData.reason}\r\n                            onChange={(e) => setFormData(prev => ({ ...prev, reason: e.target.value }))}\r\n                            disabled={!isEditable}\r\n                            className=\"w-full px-3 py-2 border rounded-lg\"\r\n                        >\r\n                            {CHANGE_REASONS.map(r => (\r\n                                <option key={r.id} value={r.id}>{r.icon} {r.label}</option>\r\n                            ))}\r\n                        </select>\r\n                    </div>\r\n                    <div>\r\n                        <label className=\"block text-sm text-gray-600 mb-1\">說明</label>\r\n                        <input\r\n                            type=\"text\"\r\n                            value={formData.description}\r\n                            onChange={(e) => setFormData(prev => ({ ...prev, description: e.target.value }))}\r\n                            disabled={!isEditable}\r\n                            placeholder=\"變更原因說明\"\r\n                            className=\"w-full px-3 py-2 border rounded-lg\"\r\n                        />\r\n                    </div>\r\n                </div>\r\n            </div>\r\n\r\n            {/* 變更項目 */}\r\n            <div className=\"bg-white rounded-xl p-6 shadow-sm border border-gray-100\">\r\n                <div className=\"flex justify-between items-center mb-4\">\r\n                    <h3 className=\"font-semibold\">變更項目</h3>\r\n                    {isEditable && (\r\n                        <div className=\"flex gap-2\">\r\n                            <button\r\n                                onClick={handleAddItem}\r\n                                className=\"px-3 py-1 bg-green-100 text-green-700 rounded-lg hover:bg-green-200 text-sm\"\r\n                            >\r\n                                ➕ 新增項目\r\n                            </button>\r\n                        </div>\r\n                    )}\r\n                </div>\r\n\r\n                {/* 從原估價單選取 */}\r\n                {isEditable && quotationItems.length > 0 && (\r\n                    <div className=\"mb-4 p-4 bg-gray-50 rounded-lg\">\r\n                        <p className=\"text-sm text-gray-600 mb-2\">從原估價單選取工項：</p>\r\n                        <div className=\"flex flex-wrap gap-2\">\r\n                            {quotationItems.slice(0, 10).map(item => (\r\n                                <div key={item.id} className=\"flex items-center gap-1 bg-white px-2 py-1 rounded border text-sm\">\r\n                                    <span>{item.name}</span>\r\n                                    <button\r\n                                        onClick={() => handleAddFromQuotation(item, CHANGE_TYPES.MODIFY)}\r\n                                        className=\"text-blue-500 hover:text-blue-700\"\r\n                                        title=\"變更\"\r\n                                    >\r\n                                        📝\r\n                                    </button>\r\n                                    <button\r\n                                        onClick={() => handleAddFromQuotation(item, CHANGE_TYPES.DEDUCT)}\r\n                                        className=\"text-red-500 hover:text-red-700\"\r\n                                        title=\"減項\"\r\n                                    >\r\n                                        ➖\r\n                                    </button>\r\n                                </div>\r\n                            ))}\r\n                        </div>\r\n                    </div>\r\n                )}\r\n\r\n                {/* 項目表格 */}\r\n                <div className=\"overflow-x-auto\">\r\n                    <table className=\"w-full\">\r\n                        <thead className=\"bg-gray-50\">\r\n                            <tr>\r\n                                <th className=\"py-3 px-4 text-left text-sm font-medium text-gray-600\">類型</th>\r\n                                <th className=\"py-3 px-4 text-left text-sm font-medium text-gray-600\">項目名稱</th>\r\n                                <th className=\"py-3 px-4 text-left text-sm font-medium text-gray-600\">規格</th>\r\n                                <th className=\"py-3 px-4 text-center text-sm font-medium text-gray-600\">單位</th>\r\n                                <th className=\"py-3 px-4 text-right text-sm font-medium text-gray-600\">數量</th>\r\n                                <th className=\"py-3 px-4 text-right text-sm font-medium text-gray-600\">單價</th>\r\n                                <th className=\"py-3 px-4 text-right text-sm font-medium text-gray-600\">金額</th>\r\n                                <th className=\"py-3 px-4 text-right text-sm font-medium text-gray-600\">差額</th>\r\n                                <th className=\"py-3 px-4 w-12\"></th>\r\n                            </tr>\r\n                        </thead>\r\n                        <tbody>\r\n                            {formData.items.map((item, index) => (\r\n                                <ChangeItemRow\r\n                                    key={item.id}\r\n                                    item={item}\r\n                                    index={index}\r\n                                    onUpdate={handleUpdateItem}\r\n                                    onDelete={handleDeleteItem}\r\n                                    disabled={!isEditable}\r\n                                />\r\n                            ))}\r\n                        </tbody>\r\n                    </table>\r\n                    {formData.items.length === 0 && (\r\n                        <div className=\"text-center py-8 text-gray-400\">\r\n                            尚無變更項目，請點擊「新增項目」或從原估價單選取\r\n                        </div>\r\n                    )}\r\n                </div>\r\n            </div>\r\n\r\n            {/* 金額摘要 */}\r\n            <div className=\"bg-white rounded-xl p-6 shadow-sm border border-gray-100\">\r\n                <h3 className=\"font-semibold mb-4\">金額摘要</h3>\r\n                <div className=\"grid grid-cols-4 gap-4\">\r\n                    <div className=\"p-4 bg-gray-50 rounded-lg text-center\">\r\n                        <p className=\"text-sm text-gray-500\">原合約金額</p>\r\n                        <p className=\"text-xl font-bold\">{formatCurrency(originalAmount)}</p>\r\n                    </div>\r\n                    <div className=\"p-4 bg-green-50 rounded-lg text-center\">\r\n                        <p className=\"text-sm text-green-600\">追加金額</p>\r\n                        <p className=\"text-xl font-bold text-green-600\">+{formatCurrency(totals.totalAdded)}</p>\r\n                    </div>\r\n                    <div className=\"p-4 bg-red-50 rounded-lg text-center\">\r\n                        <p className=\"text-sm text-red-600\">減項金額</p>\r\n                        <p className=\"text-xl font-bold text-red-600\">-{formatCurrency(totals.totalDeducted)}</p>\r\n                    </div>\r\n                    <div className=\"p-4 bg-blue-50 rounded-lg text-center\">\r\n                        <p className=\"text-sm text-blue-600\">變更後總價</p>\r\n                        <p className=\"text-xl font-bold text-blue-600\">{formatCurrency(newAmount)}</p>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n        </div>\r\n    );\r\n};\r\n\r\n// ============================================\r\n// 變更單列表\r\n// ============================================\r\nconst ChangeOrderList = ({ quotationId, onEdit, onBack, addToast }) => {\r\n    const [changeOrders, setChangeOrders] = useState([]);\r\n    const [quotation, setQuotation] = useState(null);\r\n    const [loading, setLoading] = useState(true);\r\n    const [cumulative, setCumulative] = useState({ totalAdded: 0, totalDeducted: 0, netChange: 0, count: 0 });\r\n\r\n    const loadData = async () => {\r\n        try {\r\n            const [orders, quo, cum] = await Promise.all([\r\n                ChangeOrderService.getChangeOrders(quotationId),\r\n                QuotationService.getQuotation(quotationId),\r\n                ChangeOrderService.getCumulativeChanges(quotationId),\r\n            ]);\r\n            setChangeOrders(orders);\r\n            setQuotation(quo);\r\n            setCumulative(cum);\r\n        } catch (error) {\r\n            console.error('Load error:', error);\r\n        } finally {\r\n            setLoading(false);\r\n        }\r\n    };\r\n\r\n    useEffect(() => {\r\n        loadData();\r\n    }, [quotationId]);\r\n\r\n    const handleCreate = async () => {\r\n        const newOrder = await ChangeOrderService.createChangeOrder({\r\n            quotationId,\r\n            title: `第 ${changeOrders.length + 1} 次變更`,\r\n        });\r\n        onEdit(newOrder, quotation);\r\n    };\r\n\r\n    const handleDelete = async (id) => {\r\n        if (!window.confirm('確定要刪除此變更單？')) return;\r\n        try {\r\n            await ChangeOrderService.deleteChangeOrder(id);\r\n            addToast?.('success', '已刪除');\r\n            loadData();\r\n        } catch (error) {\r\n            addToast?.('error', error.message);\r\n        }\r\n    };\r\n\r\n    if (loading) {\r\n        return <div className=\"text-center py-8\">載入中...</div>;\r\n    }\r\n\r\n    return (\r\n        <div className=\"space-y-6\">\r\n            {/* 頂部 */}\r\n            <div className=\"flex items-center justify-between\">\r\n                <div className=\"flex items-center gap-4\">\r\n                    <button onClick={onBack} className=\"p-2 hover:bg-gray-100 rounded-lg\">\r\n                        ← 返回\r\n                    </button>\r\n                    <div>\r\n                        <h2 className=\"text-xl font-bold\">工程變更單</h2>\r\n                        <p className=\"text-sm text-gray-500\">\r\n                            {quotation?.quotationNo} - {quotation?.title}\r\n                        </p>\r\n                    </div>\r\n                </div>\r\n                <button\r\n                    onClick={handleCreate}\r\n                    className=\"px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700\"\r\n                >\r\n                    ➕ 新增變更單\r\n                </button>\r\n            </div>\r\n\r\n            {/* 累計統計 */}\r\n            <div className=\"grid grid-cols-4 gap-4\">\r\n                <div className=\"bg-white rounded-xl p-4 shadow-sm border border-gray-100 text-center\">\r\n                    <p className=\"text-sm text-gray-500\">變更單數量</p>\r\n                    <p className=\"text-2xl font-bold\">{cumulative.count}</p>\r\n                </div>\r\n                <div className=\"bg-white rounded-xl p-4 shadow-sm border border-gray-100 text-center\">\r\n                    <p className=\"text-sm text-green-600\">累計追加</p>\r\n                    <p className=\"text-2xl font-bold text-green-600\">+{formatCurrency(cumulative.totalAdded)}</p>\r\n                </div>\r\n                <div className=\"bg-white rounded-xl p-4 shadow-sm border border-gray-100 text-center\">\r\n                    <p className=\"text-sm text-red-600\">累計減項</p>\r\n                    <p className=\"text-2xl font-bold text-red-600\">-{formatCurrency(cumulative.totalDeducted)}</p>\r\n                </div>\r\n                <div className=\"bg-white rounded-xl p-4 shadow-sm border border-gray-100 text-center\">\r\n                    <p className=\"text-sm text-blue-600\">淨變更</p>\r\n                    <p className={`text-2xl font-bold ${cumulative.netChange >= 0 ? 'text-green-600' : 'text-red-600'}`}>\r\n                        {cumulative.netChange >= 0 ? '+' : ''}{formatCurrency(cumulative.netChange)}\r\n                    </p>\r\n                </div>\r\n            </div>\r\n\r\n            {/* 變更單列表 */}\r\n            <div className=\"bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden\">\r\n                <table className=\"w-full\">\r\n                    <thead className=\"bg-gray-50\">\r\n                        <tr>\r\n                            <th className=\"py-3 px-4 text-left text-sm font-medium text-gray-600\">變更單號</th>\r\n                            <th className=\"py-3 px-4 text-left text-sm font-medium text-gray-600\">標題</th>\r\n                            <th className=\"py-3 px-4 text-left text-sm font-medium text-gray-600\">原因</th>\r\n                            <th className=\"py-3 px-4 text-center text-sm font-medium text-gray-600\">狀態</th>\r\n                            <th className=\"py-3 px-4 text-right text-sm font-medium text-gray-600\">淨變更</th>\r\n                            <th className=\"py-3 px-4 text-left text-sm font-medium text-gray-600\">建立日期</th>\r\n                            <th className=\"py-3 px-4 text-center text-sm font-medium text-gray-600\">操作</th>\r\n                        </tr>\r\n                    </thead>\r\n                    <tbody>\r\n                        {changeOrders.map(order => {\r\n                            const reason = CHANGE_REASONS.find(r => r.id === order.reason);\r\n                            return (\r\n                                <tr key={order.id} className=\"border-b border-gray-100 hover:bg-gray-50\">\r\n                                    <td className=\"py-3 px-4 font-medium\">{order.changeOrderNo}</td>\r\n                                    <td className=\"py-3 px-4\">{order.title}</td>\r\n                                    <td className=\"py-3 px-4 text-sm\">\r\n                                        {reason?.icon} {reason?.label}\r\n                                    </td>\r\n                                    <td className=\"py-3 px-4 text-center\">\r\n                                        <StatusBadge status={order.status} />\r\n                                    </td>\r\n                                    <td className={`py-3 px-4 text-right font-medium ${order.netChange >= 0 ? 'text-green-600' : 'text-red-600'}`}>\r\n                                        {order.netChange >= 0 ? '+' : ''}{formatCurrency(order.netChange)}\r\n                                    </td>\r\n                                    <td className=\"py-3 px-4 text-sm text-gray-500\">\r\n                                        {formatDate(order.createdAt)}\r\n                                    </td>\r\n                                    <td className=\"py-3 px-4 text-center\">\r\n                                        <div className=\"flex justify-center gap-2\">\r\n                                            <button\r\n                                                onClick={() => onEdit(order, quotation)}\r\n                                                className=\"px-2 py-1 text-sm text-blue-600 hover:bg-blue-50 rounded\"\r\n                                            >\r\n                                                {order.status === CHANGE_ORDER_STATUS.DRAFT ? '編輯' : '查看'}\r\n                                            </button>\r\n                                            {order.status === CHANGE_ORDER_STATUS.DRAFT && (\r\n                                                <button\r\n                                                    onClick={() => handleDelete(order.id)}\r\n                                                    className=\"px-2 py-1 text-sm text-red-600 hover:bg-red-50 rounded\"\r\n                                                >\r\n                                                    刪除\r\n                                                </button>\r\n                                            )}\r\n                                        </div>\r\n                                    </td>\r\n                                </tr>\r\n                            );\r\n                        })}\r\n                    </tbody>\r\n                </table>\r\n                {changeOrders.length === 0 && (\r\n                    <div className=\"text-center py-8 text-gray-400\">\r\n                        尚無變更單，請點擊「新增變更單」建立\r\n                    </div>\r\n                )}\r\n            </div>\r\n        </div>\r\n    );\r\n};\r\n\r\n// ============================================\r\n// 主元件\r\n// ============================================\r\nconst ChangeOrders = ({ quotationId, onBack, addToast }) => {\r\n    const [viewMode, setViewMode] = useState('list'); // list | editor\r\n    const [selectedOrder, setSelectedOrder] = useState(null);\r\n    const [selectedQuotation, setSelectedQuotation] = useState(null);\r\n\r\n    const handleEdit = (order, quotation) => {\r\n        setSelectedOrder(order);\r\n        setSelectedQuotation(quotation);\r\n        setViewMode('editor');\r\n    };\r\n\r\n    const handleBackToList = () => {\r\n        setSelectedOrder(null);\r\n        setViewMode('list');\r\n    };\r\n\r\n    if (viewMode === 'editor') {\r\n        return (\r\n            <ChangeOrderEditor\r\n                changeOrder={selectedOrder}\r\n                quotation={selectedQuotation}\r\n                onSave={handleBackToList}\r\n                onBack={handleBackToList}\r\n                addToast={addToast}\r\n            />\r\n        );\r\n    }\r\n\r\n    return (\r\n        <ChangeOrderList\r\n            quotationId={quotationId}\r\n            onEdit={handleEdit}\r\n            onBack={onBack}\r\n            addToast={addToast}\r\n        />\r\n    );\r\n};\r\n\r\nexport default ChangeOrders;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\xiang\\senteng-frontend\\src\\pages\\Clients.jsx","messages":[{"ruleId":"no-unused-vars","severity":2,"message":"'Icon' is defined but never used. Allowed unused args must match /^_|^e$|^err$|^event$/u.","line":28,"column":27,"nodeType":"Identifier","messageId":"unusedVar","endLine":28,"endColumn":31,"suggestions":[{"messageId":"removeVar","data":{"varName":"Icon"},"fix":{"range":[1352,1363],"text":""},"desc":"Remove unused variable 'Icon'."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\r\nimport React, { useState, useMemo } from 'react';\r\nimport { Modal } from '../components/common/Modal';\r\nimport { InputField, DynamicFieldEditor } from '../components/common/InputField';\r\nimport { LocationField } from '../components/common/LocationField';\r\nimport { Card } from '../components/common/Card';\r\nimport { Badge } from '../components/common/Badge';\r\nimport { SectionTitle, LoadingSkeleton } from '../components/common/Indicators';\r\nimport {\r\n    Phone, Mail, Folder, Edit2, Trash2, Cloud, ChevronLeft, Save, Plus,\r\n    Search, Filter, User, UserCheck, UserX, Clock, MessageCircle,\r\n    MapPin, Calendar, FileText, Star, X, ChevronRight, Briefcase, Database\r\n} from 'lucide-react';\r\nimport { clientsApi } from '../services/api';\r\nimport { GoogleService } from '../services/GoogleService';\r\nimport { ContactsSection } from '../components/common/ContactsSection';\r\n\r\n// 狀態配置\r\nconst STATUS_CONFIG = {\r\n    '洽談中': { color: 'blue', icon: Clock, bg: 'bg-blue-100 text-blue-700' },\r\n    '提案/報價': { color: 'yellow', icon: FileText, bg: 'bg-yellow-100 text-yellow-700' },\r\n    '已簽約': { color: 'green', icon: UserCheck, bg: 'bg-green-100 text-green-700' },\r\n    '已完工': { color: 'gray', icon: Star, bg: 'bg-gray-100 text-gray-700' },\r\n    '暫緩': { color: 'orange', icon: UserX, bg: 'bg-orange-100 text-orange-700' },\r\n};\r\n\r\n// 統計卡片\r\nconst StatCard = ({ icon: Icon, label, value, color = 'gray', onClick }) => (\r\n    <button\r\n        onClick={onClick}\r\n        className={`bg-white rounded-xl p-4 shadow-sm border border-gray-100 flex items-center gap-3 hover:shadow-md transition-all text-left w-full ${onClick ? 'cursor-pointer' : ''}`}\r\n    >\r\n        <div className={`w-10 h-10 rounded-full flex items-center justify-center ${color === 'blue' ? 'bg-blue-100 text-blue-600' :\r\n            color === 'green' ? 'bg-green-100 text-green-600' :\r\n                color === 'yellow' ? 'bg-yellow-100 text-yellow-600' :\r\n                    color === 'red' ? 'bg-red-100 text-red-600' :\r\n                        'bg-gray-100 text-gray-600'\r\n            }`}>\r\n            <Icon size={20} />\r\n        </div>\r\n        <div>\r\n            <div className=\"text-2xl font-bold text-gray-800\">{value}</div>\r\n            <div className=\"text-xs text-gray-500\">{label}</div>\r\n        </div>\r\n    </button>\r\n);\r\n\r\n// 客戶列表項目\r\nconst ClientRow = ({ client, onSelect, onDelete }) => {\r\n    const statusConfig = STATUS_CONFIG[client.status] || STATUS_CONFIG['洽談中'];\r\n\r\n    return (\r\n        <div\r\n            className=\"flex flex-col sm:flex-row sm:items-center justify-between p-3 sm:p-4 bg-white rounded-xl border border-gray-100 hover:shadow-md hover:border-gray-200 transition-all cursor-pointer group gap-2 sm:gap-0\"\r\n            onClick={() => onSelect(client)}\r\n        >\r\n            <div className=\"flex items-center gap-3 sm:gap-4 flex-1 min-w-0\">\r\n                <div className=\"w-10 h-10 sm:w-12 sm:h-12 rounded-full bg-gradient-to-br from-gray-200 to-gray-300 flex items-center justify-center text-base sm:text-lg font-bold text-gray-600 flex-shrink-0\">\r\n                    {client.name[0]}\r\n                </div>\r\n                <div className=\"min-w-0 flex-1\">\r\n                    <div className=\"font-bold text-gray-800 flex items-center gap-2 flex-wrap\">\r\n                        <span className=\"truncate\">{client.name}</span>\r\n                        <span className={`text-xs px-2 py-0.5 rounded-full whitespace-nowrap ${statusConfig.bg}`}>\r\n                            {client.status}\r\n                        </span>\r\n                    </div>\r\n                    <div className=\"text-xs sm:text-sm text-gray-500 flex items-center gap-2 sm:gap-3 mt-1 flex-wrap\">\r\n                        {client.phone && <span className=\"flex items-center gap-1\"><Phone size={12} /> {client.phone}</span>}\r\n                        {client.email && <span className=\"hidden sm:flex items-center gap-1\"><Mail size={12} /> <span className=\"truncate max-w-[150px]\">{client.email}</span></span>}\r\n                    </div>\r\n                </div>\r\n            </div>\r\n            <div className=\"flex items-center gap-2 self-end sm:self-auto\">\r\n                <button\r\n                    onClick={(e) => { e.stopPropagation(); onDelete(client.id); }}\r\n                    className=\"sm:opacity-0 sm:group-hover:opacity-100 p-2 text-red-400 hover:text-red-600 hover:bg-red-50 rounded-lg transition-all\"\r\n                >\r\n                    <Trash2 size={16} />\r\n                </button>\r\n                <ChevronRight size={20} className=\"text-gray-300\" />\r\n            </div>\r\n        </div>\r\n    );\r\n};\r\n\r\n// 聯絡記錄項目\r\nconst ContactLogItem = ({ log }) => (\r\n    <div className=\"flex gap-3 p-3 bg-gray-50 rounded-lg\">\r\n        <div className=\"w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center flex-shrink-0\">\r\n            <MessageCircle size={14} className=\"text-blue-600\" />\r\n        </div>\r\n        <div className=\"flex-1\">\r\n            <div className=\"text-sm font-medium text-gray-800\">{log.type}</div>\r\n            <div className=\"text-xs text-gray-500 mt-0.5\">{log.date} - {log.note}</div>\r\n        </div>\r\n    </div>\r\n);\r\n\r\nconst Clients = ({ data = [], loading, addToast, onUpdateClients, allProjects = [] }) => {\r\n    // 狀態管理\r\n    const [activeClient, setActiveClient] = useState(null);\r\n    const [isAddModalOpen, setIsAddModalOpen] = useState(false);\r\n    const [isEditing, setIsEditing] = useState(false);\r\n    const [editFormData, setEditFormData] = useState(null);\r\n    const [newClientData, setNewClientData] = useState({\r\n        name: \"\", phone: \"\", email: \"\", lineId: \"\", address: \"\", status: \"洽談中\",\r\n        customFields: [], contactLogs: [], source: \"\", budget: \"\", notes: \"\"\r\n    });\r\n    const [isSaving, setIsSaving] = useState(false);\r\n\r\n    // 搜尋與篩選\r\n    const [searchTerm, setSearchTerm] = useState('');\r\n    const [statusFilter, setStatusFilter] = useState('全部');\r\n\r\n    // 新增聯絡記錄 Modal\r\n    const [isContactLogModalOpen, setIsContactLogModalOpen] = useState(false);\r\n    const [newContactLog, setNewContactLog] = useState({ type: '電話聯繫', date: new Date().toISOString().split('T')[0], note: '' });\r\n\r\n    // 計算統計\r\n    const stats = useMemo(() => ({\r\n        total: data.length,\r\n        negotiating: data.filter(c => c.status === '洽談中').length,\r\n        signed: data.filter(c => c.status === '已簽約').length,\r\n        completed: data.filter(c => c.status === '已完工').length,\r\n    }), [data]);\r\n\r\n    // 篩選後的客戶列表\r\n    const filteredClients = useMemo(() => {\r\n        return data.filter(client => {\r\n            const matchesSearch = searchTerm === '' ||\r\n                client.name?.toLowerCase().includes(searchTerm.toLowerCase()) ||\r\n                client.phone?.includes(searchTerm) ||\r\n                client.email?.toLowerCase().includes(searchTerm.toLowerCase());\r\n            const matchesStatus = statusFilter === '全部' || client.status === statusFilter;\r\n            return matchesSearch && matchesStatus;\r\n        });\r\n    }, [data, searchTerm, statusFilter]);\r\n\r\n    // 操作函數\r\n    const handleOpenAdd = () => {\r\n        setNewClientData({\r\n            name: \"\", phone: \"\", email: \"\", address: \"\", status: \"洽談中\",\r\n            customFields: [{ label: \"備註\", value: \"\" }], contactLogs: [],\r\n            source: \"\", budget: \"\", notes: \"\"\r\n        });\r\n        setIsAddModalOpen(true);\r\n    };\r\n\r\n    const handleSaveNewClient = async () => {\r\n        if (!newClientData.name) return addToast(\"請輸入姓名\", \"error\");\r\n\r\n        setIsSaving(true);\r\n        try {\r\n            // Create Drive folder first (optional)\r\n            let driveFolder = null;\r\n            const driveResult = await GoogleService.createClientFolder(newClientData.name);\r\n            if (driveResult.success) {\r\n                driveFolder = driveResult.url;\r\n            }\r\n\r\n            const clientData = {\r\n                name: newClientData.name,\r\n                phone: newClientData.phone,\r\n                email: newClientData.email,\r\n                lineId: newClientData.lineId,\r\n                address: newClientData.address,\r\n                status: newClientData.status,\r\n                source: newClientData.source,\r\n                budget: newClientData.budget,\r\n                notes: newClientData.notes,\r\n                customFields: newClientData.customFields,\r\n                contactLogs: newClientData.contactLogs || [],\r\n                driveFolder,\r\n            };\r\n\r\n            const savedClient = await clientsApi.create(clientData);\r\n            const updatedList = [...data, savedClient];\r\n            onUpdateClients(updatedList);\r\n\r\n            addToast(\"客戶新增成功！\", \"success\", {\r\n                action: driveFolder ? { label: '開啟 Drive 資料夾', onClick: () => window.open(driveFolder, '_blank') } : null\r\n            });\r\n            setIsAddModalOpen(false);\r\n        } catch (error) {\r\n            console.error('Create client failed:', error);\r\n            addToast(`儲存失敗: ${error.message}`, 'error');\r\n        } finally {\r\n            setIsSaving(false);\r\n        }\r\n    };\r\n\r\n    const handleDeleteClient = async (id) => {\r\n        try {\r\n            await clientsApi.delete(id);\r\n            const updatedList = data.filter(c => c.id !== id);\r\n            onUpdateClients(updatedList);\r\n            addToast(\"客戶已刪除\", \"success\");\r\n            if (activeClient?.id === id) setActiveClient(null);\r\n        } catch (error) {\r\n            console.error('Delete client failed:', error);\r\n            addToast(`刪除失敗: ${error.message}`, 'error');\r\n        }\r\n    };\r\n\r\n    const startEdit = () => {\r\n        setEditFormData({ ...activeClient });\r\n        setIsEditing(true);\r\n    };\r\n\r\n    const handleSaveEdit = async () => {\r\n        setIsSaving(true);\r\n        try {\r\n            const clientData = {\r\n                name: editFormData.name,\r\n                phone: editFormData.phone,\r\n                email: editFormData.email,\r\n                lineId: editFormData.lineId,\r\n                address: editFormData.address,\r\n                status: editFormData.status,\r\n                source: editFormData.source,\r\n                budget: editFormData.budget,\r\n                notes: editFormData.notes,\r\n                customFields: editFormData.customFields,\r\n                contactLogs: editFormData.contactLogs,\r\n            };\r\n\r\n            const updatedClient = await clientsApi.update(editFormData.id, clientData);\r\n            const updatedList = data.map(c => c.id === updatedClient.id ? updatedClient : c);\r\n            onUpdateClients(updatedList);\r\n\r\n            setActiveClient(updatedClient);\r\n            setIsEditing(false);\r\n            addToast(\"資料已更新\", \"success\");\r\n        } catch (error) {\r\n            console.error('Update client failed:', error);\r\n            addToast(`更新失敗: ${error.message}`, 'error');\r\n        } finally {\r\n            setIsSaving(false);\r\n        }\r\n    };\r\n\r\n    // 新增聯絡記錄\r\n    const handleAddContactLog = async () => {\r\n        if (!newContactLog.note) return addToast(\"請輸入聯絡內容\", \"error\");\r\n\r\n        try {\r\n            const updatedLogs = [...(activeClient.contactLogs || []), { ...newContactLog, id: Date.now() }];\r\n\r\n            const updatedClient = await clientsApi.update(activeClient.id, {\r\n                contactLogs: updatedLogs\r\n            });\r\n\r\n            const updatedList = data.map(c => c.id === updatedClient.id ? updatedClient : c);\r\n            onUpdateClients(updatedList);\r\n            setActiveClient(updatedClient);\r\n\r\n            setIsContactLogModalOpen(false);\r\n            setNewContactLog({ type: '電話聯繫', date: new Date().toISOString().split('T')[0], note: '' });\r\n            addToast(\"聯絡記錄已新增\", \"success\");\r\n        } catch (error) {\r\n            console.error('Add contact log failed:', error);\r\n            addToast(`新增失敗: ${error.message}`, 'error');\r\n        }\r\n    };\r\n\r\n    // 客戶詳情頁\r\n    if (activeClient) {\r\n        const statusConfig = STATUS_CONFIG[activeClient.status] || STATUS_CONFIG['洽談中'];\r\n\r\n        return (\r\n            <div className=\"space-y-6 animate-fade-in\">\r\n                <button onClick={() => { setActiveClient(null); setIsEditing(false); }} className=\"text-sm text-gray-500 hover:text-gray-900 flex items-center gap-1\">\r\n                    <ChevronLeft size={16} /> 返回列表\r\n                </button>\r\n\r\n                {/* 客戶標題 */}\r\n                <div className=\"bg-white rounded-2xl p-6 shadow-sm border border-gray-100\">\r\n                    <div className=\"flex flex-col sm:flex-row justify-between items-start gap-4\">\r\n                        <div className=\"flex items-center gap-4\">\r\n                            <div className=\"w-16 h-16 rounded-full bg-gradient-to-br from-gray-200 to-gray-300 flex items-center justify-center text-2xl font-bold text-gray-600\">\r\n                                {activeClient.name[0]}\r\n                            </div>\r\n                            <div>\r\n                                {isEditing ? (\r\n                                    <input value={editFormData.name} onChange={e => setEditFormData({ ...editFormData, name: e.target.value })} className=\"text-2xl font-bold text-gray-900 border-b border-gray-300 focus:outline-none bg-transparent\" />\r\n                                ) : (\r\n                                    <h2 className=\"text-2xl font-bold text-gray-900 flex items-center gap-2 flex-wrap\">\r\n                                        {activeClient.name}\r\n                                        <span className={`text-sm px-3 py-1 rounded-full ${statusConfig.bg}`}>\r\n                                            {activeClient.status}\r\n                                        </span>\r\n                                    </h2>\r\n                                )}\r\n                                <div className=\"text-gray-500 text-sm flex flex-wrap items-center gap-3 mt-2\">\r\n                                    {isEditing ? (\r\n                                        <div className=\"flex flex-wrap gap-2\">\r\n                                            <input placeholder=\"電話\" value={editFormData.phone} onChange={e => setEditFormData({ ...editFormData, phone: e.target.value })} className=\"border rounded px-2 py-1 text-sm\" />\r\n                                            <input placeholder=\"Email\" value={editFormData.email} onChange={e => setEditFormData({ ...editFormData, email: e.target.value })} className=\"border rounded px-2 py-1 text-sm\" />\r\n                                        </div>\r\n                                    ) : (\r\n                                        <>\r\n                                            {activeClient.phone && <span className=\"flex items-center gap-1\"><Phone size={14} /> {activeClient.phone}</span>}\r\n                                            {activeClient.email && <span className=\"flex items-center gap-1\"><Mail size={14} /> {activeClient.email}</span>}\r\n                                        </>\r\n                                    )}\r\n                                </div>\r\n                            </div>\r\n                        </div>\r\n                        <div className=\"flex flex-wrap gap-2\">\r\n                            {isEditing ? (\r\n                                <>\r\n                                    <button onClick={() => setIsEditing(false)} className=\"bg-white border border-gray-200 px-3 py-1.5 rounded-lg text-sm text-gray-600\">取消</button>\r\n                                    <button onClick={handleSaveEdit} disabled={isSaving} className=\"bg-green-500 text-white px-3 py-1.5 rounded-lg text-sm flex items-center gap-1 hover:bg-green-600 disabled:opacity-50\">\r\n                                        <Save size={14} /> {isSaving ? '儲存中...' : '儲存'}\r\n                                    </button>\r\n                                </>\r\n                            ) : (\r\n                                <>\r\n                                    {activeClient.driveFolder && (\r\n                                        <a href={activeClient.driveFolder} target=\"_blank\" rel=\"noreferrer\" className=\"bg-blue-50 text-blue-600 px-3 py-1.5 rounded-lg text-sm flex items-center gap-2 hover:bg-blue-100 border border-blue-100\">\r\n                                            <Folder size={16} /> 雲端資料夾\r\n                                        </a>\r\n                                    )}\r\n                                    <button onClick={startEdit} className=\"bg-white border border-gray-200 px-3 py-1.5 rounded-lg text-sm text-gray-600 hover:bg-gray-50 flex items-center gap-2\">\r\n                                        <Edit2 size={14} /> 編輯\r\n                                    </button>\r\n                                    <button onClick={() => handleDeleteClient(activeClient.id)} className=\"bg-white border border-red-200 text-red-500 px-3 py-1.5 rounded-lg text-sm hover:bg-red-50 flex items-center gap-2\">\r\n                                        <Trash2 size={14} /> 刪除\r\n                                    </button>\r\n                                </>\r\n                            )}\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n\r\n                {/* 內容區 */}\r\n                <div className=\"grid grid-cols-1 lg:grid-cols-3 gap-6\">\r\n                    {/* 基本資料 */}\r\n                    <Card className=\"lg:col-span-2\">\r\n                        <h3 className=\"font-bold text-gray-800 mb-4 flex items-center gap-2\">\r\n                            <User size={18} /> 基本資料\r\n                        </h3>\r\n                        {isEditing ? (\r\n                            <div className=\"space-y-4\">\r\n                                <LocationField label=\"地址\" value={editFormData.address} onChange={e => setEditFormData({ ...editFormData, address: e.target.value })} />\r\n                                <div className=\"grid grid-cols-1 sm:grid-cols-2 gap-4\">\r\n                                    <div>\r\n                                        <label className=\"block text-sm text-gray-500 mb-1\">狀態</label>\r\n                                        <select value={editFormData.status} onChange={e => setEditFormData({ ...editFormData, status: e.target.value })} className=\"w-full border rounded-lg px-3 py-2 bg-white\">\r\n                                            {Object.keys(STATUS_CONFIG).map(s => <option key={s} value={s}>{s}</option>)}\r\n                                        </select>\r\n                                    </div>\r\n                                    <InputField label=\"預算範圍\" value={editFormData.budget || ''} onChange={e => setEditFormData({ ...editFormData, budget: e.target.value })} placeholder=\"例：200-300萬\" />\r\n                                </div>\r\n                                <InputField label=\"來源\" value={editFormData.source || ''} onChange={e => setEditFormData({ ...editFormData, source: e.target.value })} placeholder=\"例：朋友介紹、網路搜尋\" />\r\n                                <DynamicFieldEditor fields={editFormData.customFields || []} onChange={(newFields) => setEditFormData({ ...editFormData, customFields: newFields })} />\r\n                            </div>\r\n                        ) : (\r\n                            <div className=\"grid grid-cols-1 sm:grid-cols-2 gap-4 text-sm\">\r\n                                {activeClient.address && (\r\n                                    <div className=\"col-span-2\">\r\n                                        <span className=\"text-gray-500 block mb-1\"><MapPin size={14} className=\"inline mr-1\" />地址</span>\r\n                                        <span className=\"text-gray-900\">{activeClient.address}</span>\r\n                                    </div>\r\n                                )}\r\n                                {activeClient.source && (\r\n                                    <div>\r\n                                        <span className=\"text-gray-500 block mb-1\">來源</span>\r\n                                        <span className=\"text-gray-900\">{activeClient.source}</span>\r\n                                    </div>\r\n                                )}\r\n                                {activeClient.budget && (\r\n                                    <div>\r\n                                        <span className=\"text-gray-500 block mb-1\">預算</span>\r\n                                        <span className=\"text-gray-900\">{activeClient.budget}</span>\r\n                                    </div>\r\n                                )}\r\n                                {activeClient.lineId && (\r\n                                    <div>\r\n                                        <span className=\"text-gray-500 block mb-1\">LINE ID</span>\r\n                                        <span className=\"text-gray-900\">{activeClient.lineId}</span>\r\n                                    </div>\r\n                                )}\r\n                                {activeClient.customFields?.map((field, idx) => (\r\n                                    <div key={idx} className={field.value?.length > 20 ? \"col-span-2\" : \"\"}>\r\n                                        <span className=\"text-gray-500 block mb-1\">{field.label}</span>\r\n                                        <span className=\"text-gray-900\">{field.value}</span>\r\n                                    </div>\r\n                                ))}\r\n                            </div>\r\n                        )}\r\n                    </Card>\r\n\r\n                    {/* 聯絡記錄 */}\r\n                    <Card>\r\n                        <div className=\"flex justify-between items-center mb-4\">\r\n                            <h3 className=\"font-bold text-gray-800 flex items-center gap-2\">\r\n                                <MessageCircle size={18} /> 聯絡記錄\r\n                            </h3>\r\n                            <button\r\n                                onClick={() => setIsContactLogModalOpen(true)}\r\n                                className=\"text-sm text-blue-600 hover:text-blue-800 flex items-center gap-1\"\r\n                            >\r\n                                <Plus size={14} /> 新增\r\n                            </button>\r\n                        </div>\r\n                        <div className=\"space-y-2 max-h-80 overflow-y-auto\">\r\n                            {(activeClient.contactLogs || []).length > 0 ? (\r\n                                activeClient.contactLogs.slice().reverse().map((log, idx) => (\r\n                                    <ContactLogItem key={idx} log={log} />\r\n                                ))\r\n                            ) : (\r\n                                <div className=\"text-sm text-gray-400 text-center py-8\">\r\n                                    尚無聯絡記錄\r\n                                </div>\r\n                            )}\r\n                        </div>\r\n                    </Card>\r\n\r\n                    {/* 聯絡人 (Google Contacts 同步) */}\r\n                    <Card className=\"lg:col-span-3\">\r\n                        <ContactsSection\r\n                            contacts={activeClient.contacts || []}\r\n                            entityType=\"client\"\r\n                            entityId={activeClient.id}\r\n                            onRefresh={() => {\r\n                                // Refetch client data\r\n                                clientsApi.getById(activeClient.id).then(updated => {\r\n                                    const updatedList = data.map(c => c.id === updated.id ? updated : c);\r\n                                    onUpdateClients(updatedList);\r\n                                    setActiveClient(updated);\r\n                                }).catch(console.error);\r\n                            }}\r\n                            addToast={addToast}\r\n                        />\r\n                    </Card>\r\n\r\n                    {/* 關聯專案 */}\r\n                    <Card className=\"lg:col-span-3\">\r\n                        <h3 className=\"font-bold text-gray-800 mb-4 flex items-center gap-2\">\r\n                            <Briefcase size={18} /> 參與專案\r\n                        </h3>\r\n                        {(() => {\r\n                            const relatedProjects = allProjects.filter(p =>\r\n                                p.client === activeClient.name ||\r\n                                p.clientId === activeClient.id\r\n                            );\r\n                            return relatedProjects.length > 0 ? (\r\n                                <div className=\"space-y-2\">\r\n                                    {relatedProjects.map(project => (\r\n                                        <div key={project.id} className=\"flex items-center justify-between p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors\">\r\n                                            <div className=\"flex items-center gap-3\">\r\n                                                <div className=\"w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center\">\r\n                                                    <Briefcase size={14} className=\"text-blue-600\" />\r\n                                                </div>\r\n                                                <div>\r\n                                                    <div className=\"font-medium text-gray-800\">{project.name}</div>\r\n                                                    <div className=\"text-xs text-gray-500\">\r\n                                                        {project.status || '進行中'} • {project.startDate || '未設定'}\r\n                                                    </div>\r\n                                                </div>\r\n                                            </div>\r\n                                            {project.folderUrl && (\r\n                                                <a href={project.folderUrl} target=\"_blank\" rel=\"noreferrer\" className=\"text-blue-500 hover:text-blue-700\">\r\n                                                    <Folder size={16} />\r\n                                                </a>\r\n                                            )}\r\n                                        </div>\r\n                                    ))}\r\n                                </div>\r\n                            ) : (\r\n                                <div className=\"text-sm text-gray-400 text-center py-8\">\r\n                                    尚無關聯專案\r\n                                </div>\r\n                            );\r\n                        })()}\r\n                    </Card>\r\n                </div>\r\n\r\n                {/* 新增聯絡記錄 Modal */}\r\n                <Modal\r\n                    isOpen={isContactLogModalOpen}\r\n                    onClose={() => setIsContactLogModalOpen(false)}\r\n                    title=\"新增聯絡記錄\"\r\n                    onConfirm={handleAddContactLog}\r\n                >\r\n                    <div className=\"space-y-4\">\r\n                        <div className=\"grid grid-cols-2 gap-4\">\r\n                            <div>\r\n                                <label className=\"block text-sm text-gray-500 mb-1\">類型</label>\r\n                                <select\r\n                                    value={newContactLog.type}\r\n                                    onChange={e => setNewContactLog({ ...newContactLog, type: e.target.value })}\r\n                                    className=\"w-full border rounded-lg px-3 py-2 bg-white\"\r\n                                >\r\n                                    {['電話聯繫', '現場拜訪', 'LINE訊息', 'Email', '會議', '其他'].map(t => (\r\n                                        <option key={t} value={t}>{t}</option>\r\n                                    ))}\r\n                                </select>\r\n                            </div>\r\n                            <InputField\r\n                                label=\"日期\"\r\n                                type=\"date\"\r\n                                value={newContactLog.date}\r\n                                onChange={e => setNewContactLog({ ...newContactLog, date: e.target.value })}\r\n                            />\r\n                        </div>\r\n                        <div>\r\n                            <label className=\"block text-sm text-gray-500 mb-1\">內容</label>\r\n                            <textarea\r\n                                value={newContactLog.note}\r\n                                onChange={e => setNewContactLog({ ...newContactLog, note: e.target.value })}\r\n                                placeholder=\"記錄聯絡內容...\"\r\n                                className=\"w-full border rounded-lg px-3 py-2 min-h-[100px] resize-none\"\r\n                            />\r\n                        </div>\r\n                    </div>\r\n                </Modal>\r\n            </div>\r\n        );\r\n    }\r\n\r\n    // 客戶列表頁\r\n    return (\r\n        <div className=\"space-y-6 animate-fade-in\">\r\n            <SectionTitle title=\"客戶管理\" />\r\n\r\n            {loading ? <LoadingSkeleton /> : (\r\n                <>\r\n                    {/* 統計卡片 */}\r\n                    <div className=\"grid grid-cols-2 md:grid-cols-4 gap-3 sm:gap-4\">\r\n                        <StatCard icon={User} label=\"總客戶數\" value={stats.total} color=\"gray\" onClick={() => setStatusFilter('全部')} />\r\n                        <StatCard icon={Clock} label=\"洽談中\" value={stats.negotiating} color=\"blue\" onClick={() => setStatusFilter('洽談中')} />\r\n                        <StatCard icon={UserCheck} label=\"已簽約\" value={stats.signed} color=\"green\" onClick={() => setStatusFilter('已簽約')} />\r\n                        <StatCard icon={Star} label=\"已完工\" value={stats.completed} color=\"yellow\" onClick={() => setStatusFilter('已完工')} />\r\n                    </div>\r\n\r\n                    {/* 搜尋與篩選列 */}\r\n                    <div className=\"flex flex-wrap items-center gap-3\">\r\n                        <div className=\"relative flex-1 min-w-[200px]\">\r\n                            <Search size={18} className=\"absolute left-3 top-1/2 -translate-y-1/2 text-gray-400\" />\r\n                            <input\r\n                                type=\"text\"\r\n                                value={searchTerm}\r\n                                onChange={(e) => setSearchTerm(e.target.value)}\r\n                                placeholder=\"搜尋客戶姓名、電話、Email...\"\r\n                                className=\"w-full pl-10 pr-4 py-2.5 rounded-xl border border-gray-200 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 outline-none transition-all\"\r\n                            />\r\n                        </div>\r\n                        <select\r\n                            value={statusFilter}\r\n                            onChange={(e) => setStatusFilter(e.target.value)}\r\n                            className=\"px-4 py-2.5 rounded-xl border border-gray-200 bg-white focus:border-blue-500 outline-none\"\r\n                        >\r\n                            <option value=\"全部\">全部狀態</option>\r\n                            {Object.keys(STATUS_CONFIG).map(status => (\r\n                                <option key={status} value={status}>{status}</option>\r\n                            ))}\r\n                        </select>\r\n                        {(searchTerm || statusFilter !== '全部') && (\r\n                            <button\r\n                                onClick={() => { setSearchTerm(''); setStatusFilter('全部'); }}\r\n                                className=\"px-3 py-2.5 text-gray-500 hover:text-gray-700 flex items-center gap-1\"\r\n                            >\r\n                                <X size={16} /> 清除\r\n                            </button>\r\n                        )}\r\n                        <button\r\n                            onClick={handleOpenAdd}\r\n                            className=\"ml-auto bg-morandi-text-accent text-white px-4 py-2.5 rounded-xl text-sm font-medium hover:shadow-lg transition-all flex items-center gap-2\"\r\n                        >\r\n                            <Plus size={16} /> 新增客戶\r\n                        </button>\r\n                    </div>\r\n\r\n                    {/* 客戶列表 */}\r\n                    <div className=\"space-y-3\">\r\n                        {filteredClients.length > 0 ? (\r\n                            filteredClients.map(client => (\r\n                                <ClientRow\r\n                                    key={client.id}\r\n                                    client={client}\r\n                                    onSelect={setActiveClient}\r\n                                    onDelete={handleDeleteClient}\r\n                                />\r\n                            ))\r\n                        ) : (\r\n                            <div className=\"text-center py-12 text-gray-400\">\r\n                                {searchTerm || statusFilter !== '全部' ? '無符合條件的客戶' : '尚無客戶資料'}\r\n                            </div>\r\n                        )}\r\n                    </div>\r\n                </>\r\n            )}\r\n\r\n            {/* 新增客戶 Modal */}\r\n            <Modal\r\n                isOpen={isAddModalOpen}\r\n                onClose={() => { setIsAddModalOpen(false); setIsSaving(false); }}\r\n                title=\"新增客戶\"\r\n                onConfirm={handleSaveNewClient}\r\n                confirmDisabled={isSaving}\r\n                confirmText={isSaving ? '處理中...' : '確定'}\r\n            >\r\n                <InputField label=\"姓名\" value={newClientData.name} onChange={e => setNewClientData({ ...newClientData, name: e.target.value })} placeholder=\"必填\" />\r\n                <div className=\"grid grid-cols-1 sm:grid-cols-2 gap-4\">\r\n                    <InputField label=\"電話\" value={newClientData.phone} onChange={e => setNewClientData({ ...newClientData, phone: e.target.value })} placeholder=\"例：0912-345-678\" />\r\n                    <InputField label=\"Email\" value={newClientData.email} onChange={e => setNewClientData({ ...newClientData, email: e.target.value })} placeholder=\"例：test@email.com\" />\r\n                </div>\r\n                <LocationField label=\"地址\" value={newClientData.address} onChange={e => setNewClientData({ ...newClientData, address: e.target.value })} placeholder=\"例：台北市信義區松智路1號\" />\r\n                <div className=\"grid grid-cols-1 sm:grid-cols-2 gap-4\">\r\n                    <InputField label=\"來源\" value={newClientData.source} onChange={e => setNewClientData({ ...newClientData, source: e.target.value })} placeholder=\"例：朋友介紹\" />\r\n                    <InputField label=\"預算範圍\" value={newClientData.budget} onChange={e => setNewClientData({ ...newClientData, budget: e.target.value })} placeholder=\"例：200-300萬\" />\r\n                </div>\r\n                <InputField label=\"LINE ID\" value={newClientData.lineId} onChange={e => setNewClientData({ ...newClientData, lineId: e.target.value })} placeholder=\"例：@lineid 或 名稱\" />\r\n                <div className=\"border-t border-gray-100 pt-4 mt-4\">\r\n                    <h4 className=\"text-sm font-bold text-gray-700 mb-3\">自訂欄位</h4>\r\n                    <DynamicFieldEditor fields={newClientData.customFields} onChange={(newFields) => setNewClientData({ ...newClientData, customFields: newFields })} />\r\n                </div>\r\n                <div className=\"mt-4 p-3 bg-blue-50 text-blue-700 text-xs rounded-lg flex items-center gap-2\">\r\n                    <Cloud size={14} /> 系統將自動於 Google Drive 建立專屬資料夾\r\n                </div>\r\n            </Modal>\r\n        </div>\r\n    );\r\n};\r\n\r\nexport default Clients;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\xiang\\senteng-frontend\\src\\pages\\Contracts.jsx","messages":[{"ruleId":"no-unused-vars","severity":2,"message":"'Icon' is defined but never used. Allowed unused args must match /^_|^e$|^err$|^event$/u.","line":51,"column":27,"nodeType":"Identifier","messageId":"unusedVar","endLine":51,"endColumn":31,"suggestions":[{"messageId":"removeVar","data":{"varName":"Icon"},"fix":{"range":[1591,1602],"text":""},"desc":"Remove unused variable 'Icon'."}]},{"ruleId":"react-hooks/immutability","severity":2,"message":"Error: Cannot access variable before it is declared\n\n`loadQuotations` is accessed before it is declared, which prevents the earlier access from updating when this value changes over time.\n\n  80 |     useEffect(() => {\n  81 |         if (isOpen) {\n> 82 |             loadQuotations();\n     |             ^^^^^^^^^^^^^^ `loadQuotations` accessed before it is declared\n  83 |         }\n  84 |     }, [isOpen]);\n  85 |\n\n  84 |     }, [isOpen]);\n  85 |\n> 86 |     const loadQuotations = async () => {\n     |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 87 |         const data = await QuotationService.getQuotations();\n     | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 88 |         // 只顯示已核准但尚未成交的估價單\n     | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 89 |         const available = data.filter(q =>\n     | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 90 |             q.status === QUOTATION_STATUS.APPROVED ||\n     | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 91 |             q.status === QUOTATION_STATUS.SENT\n     | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 92 |         );\n     | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 93 |         setQuotations(available);\n     | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 94 |     };\n     | ^^^^^^^ `loadQuotations` is declared here\n  95 |\n  96 |     const handleSubmit = async () => {\n  97 |         if (!selectedQuotation) {","line":82,"column":13,"nodeType":null,"endLine":82,"endColumn":27},{"ruleId":"no-unused-vars","severity":2,"message":"'error' is defined but never used.","line":110,"column":18,"nodeType":"Identifier","messageId":"unusedVar","endLine":110,"endColumn":23},{"ruleId":"no-unused-vars","severity":2,"message":"'error' is defined but never used.","line":272,"column":22,"nodeType":"Identifier","messageId":"unusedVar","endLine":272,"endColumn":27},{"ruleId":"no-unused-vars","severity":2,"message":"'error' is defined but never used.","line":284,"column":22,"nodeType":"Identifier","messageId":"unusedVar","endLine":284,"endColumn":27},{"ruleId":"no-unused-vars","severity":2,"message":"'error' is defined but never used.","line":296,"column":22,"nodeType":"Identifier","messageId":"unusedVar","endLine":296,"endColumn":27}],"suppressedMessages":[],"errorCount":6,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * 合約管理頁面 (Contracts.jsx)\r\n * 合約列表與詳情\r\n */\r\n\r\nimport React, { useState, useEffect, useMemo } from 'react';\r\nimport {\r\n    FileText, Plus, Search, Eye, Edit2, Trash2, CheckCircle,\r\n    Clock, AlertCircle, Building2, Users, Calendar, DollarSign,\r\n    FileSignature, Shield, TrendingUp, ArrowRight\r\n} from 'lucide-react';\r\nimport { SectionTitle } from '../components/common/Indicators';\r\nimport ContractService, {\r\n    CONTRACT_STATUS,\r\n    CONTRACT_STATUS_LABELS,\r\n    CONTRACT_STATUS_COLORS,\r\n    CONTRACT_TYPES,\r\n    CONTRACT_TYPE_LABELS,\r\n    PAYMENT_TERM_TEMPLATES,\r\n} from '../services/ContractService';\r\nimport { QuotationService, QUOTATION_STATUS } from '../services/QuotationService';\r\n\r\n// ============================================\r\n// 格式化函數\r\n// ============================================\r\nconst formatCurrency = (amount) => {\r\n    return new Intl.NumberFormat('zh-TW', {\r\n        style: 'currency',\r\n        currency: 'TWD',\r\n        minimumFractionDigits: 0,\r\n    }).format(amount || 0);\r\n};\r\n\r\nconst formatDate = (dateString) => {\r\n    if (!dateString) return '-';\r\n    return new Date(dateString).toLocaleDateString('zh-TW');\r\n};\r\n\r\n// ============================================\r\n// 狀態徽章\r\n// ============================================\r\nconst StatusBadge = ({ status }) => (\r\n    <span className={`px-2 py-1 rounded-full text-xs font-medium ${CONTRACT_STATUS_COLORS[status]}`}>\r\n        {CONTRACT_STATUS_LABELS[status]}\r\n    </span>\r\n);\r\n\r\n// ============================================\r\n// 統計卡片\r\n// ============================================\r\nconst StatCard = ({ icon: Icon, label, value, color = 'gray' }) => (\r\n    <div className=\"bg-white rounded-xl p-4 border border-gray-100\">\r\n        <div className=\"flex items-center gap-3\">\r\n            <div className={`p-2 rounded-lg bg-${color}-100`}>\r\n                <Icon size={20} className={`text-${color}-600`} />\r\n            </div>\r\n            <div>\r\n                <p className=\"text-sm text-gray-500\">{label}</p>\r\n                <p className={`text-xl font-bold text-${color}-600`}>{value}</p>\r\n            </div>\r\n        </div>\r\n    </div>\r\n);\r\n\r\n// ============================================\r\n// 從估價單建立合約 Modal\r\n// ============================================\r\nconst CreateContractModal = ({ isOpen, onClose, onSubmit, addToast }) => {\r\n    const [quotations, setQuotations] = useState([]);\r\n    const [selectedQuotation, setSelectedQuotation] = useState(null);\r\n    const [formData, setFormData] = useState({\r\n        type: CONTRACT_TYPES.LUMP_SUM,\r\n        paymentTemplateId: 'standard-3',\r\n        warrantyMonths: 12,\r\n        retentionRate: 5,\r\n        startDate: '',\r\n        endDate: '',\r\n    });\r\n\r\n    useEffect(() => {\r\n        if (isOpen) {\r\n            loadQuotations();\r\n        }\r\n    }, [isOpen]);\r\n\r\n    const loadQuotations = async () => {\r\n        const data = await QuotationService.getQuotations();\r\n        // 只顯示已核准但尚未成交的估價單\r\n        const available = data.filter(q =>\r\n            q.status === QUOTATION_STATUS.APPROVED ||\r\n            q.status === QUOTATION_STATUS.SENT\r\n        );\r\n        setQuotations(available);\r\n    };\r\n\r\n    const handleSubmit = async () => {\r\n        if (!selectedQuotation) {\r\n            addToast?.('error', '請選擇估價單');\r\n            return;\r\n        }\r\n\r\n        const paymentTerms = PAYMENT_TERM_TEMPLATES.find(t => t.id === formData.paymentTemplateId)?.terms;\r\n\r\n        try {\r\n            await onSubmit(selectedQuotation.id, {\r\n                ...formData,\r\n                paymentTerms,\r\n            });\r\n            onClose();\r\n        } catch (error) {\r\n            addToast?.('error', '建立合約失敗');\r\n        }\r\n    };\r\n\r\n    if (!isOpen) return null;\r\n\r\n    return (\r\n        <div className=\"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4\">\r\n            <div className=\"bg-white rounded-2xl shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto\">\r\n                <div className=\"p-6 border-b border-gray-100\">\r\n                    <h2 className=\"text-xl font-bold text-gray-800\">從估價單建立合約</h2>\r\n                </div>\r\n\r\n                <div className=\"p-6 space-y-6\">\r\n                    {/* 選擇估價單 */}\r\n                    <div>\r\n                        <label className=\"block text-sm font-medium text-gray-700 mb-2\">\r\n                            選擇估價單 <span className=\"text-red-500\">*</span>\r\n                        </label>\r\n                        {quotations.length === 0 ? (\r\n                            <div className=\"p-4 bg-gray-50 rounded-lg text-center text-gray-500\">\r\n                                沒有可用的已核准估價單\r\n                            </div>\r\n                        ) : (\r\n                            <div className=\"space-y-2 max-h-48 overflow-y-auto\">\r\n                                {quotations.map(q => (\r\n                                    <button\r\n                                        key={q.id}\r\n                                        onClick={() => setSelectedQuotation(q)}\r\n                                        className={`w-full p-3 rounded-lg border-2 text-left transition-all ${selectedQuotation?.id === q.id\r\n                                                ? 'border-orange-500 bg-orange-50'\r\n                                                : 'border-gray-200 hover:border-gray-300'\r\n                                            }`}\r\n                                    >\r\n                                        <div className=\"flex justify-between items-start\">\r\n                                            <div>\r\n                                                <p className=\"font-medium text-gray-800\">{q.title}</p>\r\n                                                <p className=\"text-sm text-gray-500\">{q.quotationNo} · {q.customerName}</p>\r\n                                            </div>\r\n                                            <span className=\"text-lg font-bold text-orange-600\">\r\n                                                {formatCurrency(q.totalAmount)}\r\n                                            </span>\r\n                                        </div>\r\n                                    </button>\r\n                                ))}\r\n                            </div>\r\n                        )}\r\n                    </div>\r\n\r\n                    {/* 合約類型 */}\r\n                    <div className=\"grid grid-cols-2 gap-4\">\r\n                        <div>\r\n                            <label className=\"block text-sm font-medium text-gray-700 mb-1\">合約類型</label>\r\n                            <select\r\n                                value={formData.type}\r\n                                onChange={(e) => setFormData(prev => ({ ...prev, type: e.target.value }))}\r\n                                className=\"w-full px-3 py-2 border rounded-lg\"\r\n                            >\r\n                                {Object.entries(CONTRACT_TYPE_LABELS).map(([key, label]) => (\r\n                                    <option key={key} value={key}>{label}</option>\r\n                                ))}\r\n                            </select>\r\n                        </div>\r\n                        <div>\r\n                            <label className=\"block text-sm font-medium text-gray-700 mb-1\">付款條件</label>\r\n                            <select\r\n                                value={formData.paymentTemplateId}\r\n                                onChange={(e) => setFormData(prev => ({ ...prev, paymentTemplateId: e.target.value }))}\r\n                                className=\"w-full px-3 py-2 border rounded-lg\"\r\n                            >\r\n                                {PAYMENT_TERM_TEMPLATES.map(t => (\r\n                                    <option key={t.id} value={t.id}>{t.name}</option>\r\n                                ))}\r\n                            </select>\r\n                        </div>\r\n                    </div>\r\n\r\n                    {/* 其他設定 */}\r\n                    <div className=\"grid grid-cols-2 gap-4\">\r\n                        <div>\r\n                            <label className=\"block text-sm font-medium text-gray-700 mb-1\">保固期 (月)</label>\r\n                            <input\r\n                                type=\"number\"\r\n                                value={formData.warrantyMonths}\r\n                                onChange={(e) => setFormData(prev => ({ ...prev, warrantyMonths: parseInt(e.target.value) || 12 }))}\r\n                                className=\"w-full px-3 py-2 border rounded-lg\"\r\n                                min=\"0\"\r\n                            />\r\n                        </div>\r\n                        <div>\r\n                            <label className=\"block text-sm font-medium text-gray-700 mb-1\">保留款比例 (%)</label>\r\n                            <input\r\n                                type=\"number\"\r\n                                value={formData.retentionRate}\r\n                                onChange={(e) => setFormData(prev => ({ ...prev, retentionRate: parseFloat(e.target.value) || 5 }))}\r\n                                className=\"w-full px-3 py-2 border rounded-lg\"\r\n                                min=\"0\"\r\n                                max=\"20\"\r\n                            />\r\n                        </div>\r\n                    </div>\r\n\r\n                    {/* 日期 */}\r\n                    <div className=\"grid grid-cols-2 gap-4\">\r\n                        <div>\r\n                            <label className=\"block text-sm font-medium text-gray-700 mb-1\">預計開工日</label>\r\n                            <input\r\n                                type=\"date\"\r\n                                value={formData.startDate}\r\n                                onChange={(e) => setFormData(prev => ({ ...prev, startDate: e.target.value }))}\r\n                                className=\"w-full px-3 py-2 border rounded-lg\"\r\n                            />\r\n                        </div>\r\n                        <div>\r\n                            <label className=\"block text-sm font-medium text-gray-700 mb-1\">預計完工日</label>\r\n                            <input\r\n                                type=\"date\"\r\n                                value={formData.endDate}\r\n                                onChange={(e) => setFormData(prev => ({ ...prev, endDate: e.target.value }))}\r\n                                className=\"w-full px-3 py-2 border rounded-lg\"\r\n                            />\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n\r\n                {/* 按鈕 */}\r\n                <div className=\"p-6 border-t border-gray-100 flex justify-end gap-3\">\r\n                    <button\r\n                        onClick={onClose}\r\n                        className=\"px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg\"\r\n                    >\r\n                        取消\r\n                    </button>\r\n                    <button\r\n                        onClick={handleSubmit}\r\n                        disabled={!selectedQuotation}\r\n                        className=\"px-6 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600 disabled:opacity-50 flex items-center gap-2\"\r\n                    >\r\n                        <FileSignature size={18} />\r\n                        建立合約\r\n                    </button>\r\n                </div>\r\n            </div>\r\n        </div>\r\n    );\r\n};\r\n\r\n// ============================================\r\n// 合約詳情\r\n// ============================================\r\nconst ContractDetail = ({ contract, onBack, onRefresh, addToast }) => {\r\n    const progress = contract.currentAmount > 0\r\n        ? Math.round((contract.paidAmount / contract.currentAmount) * 100)\r\n        : 0;\r\n\r\n    const handleSign = async () => {\r\n        if (window.confirm('確定要簽約嗎？')) {\r\n            try {\r\n                await ContractService.sign(contract.id);\r\n                addToast?.('success', '合約已簽約');\r\n                onRefresh?.();\r\n            } catch (error) {\r\n                addToast?.('error', '簽約失敗');\r\n            }\r\n        }\r\n    };\r\n\r\n    const handleComplete = async () => {\r\n        if (window.confirm('確定要標記完工嗎？')) {\r\n            try {\r\n                await ContractService.complete(contract.id);\r\n                addToast?.('success', '已標記完工');\r\n                onRefresh?.();\r\n            } catch (error) {\r\n                addToast?.('error', '操作失敗');\r\n            }\r\n        }\r\n    };\r\n\r\n    const handleClose = async () => {\r\n        if (window.confirm('確定要結案嗎？')) {\r\n            try {\r\n                await ContractService.close(contract.id);\r\n                addToast?.('success', '已結案');\r\n                onRefresh?.();\r\n            } catch (error) {\r\n                addToast?.('error', '操作失敗');\r\n            }\r\n        }\r\n    };\r\n\r\n    return (\r\n        <div className=\"space-y-6\">\r\n            {/* 頂部 */}\r\n            <div className=\"flex items-center justify-between\">\r\n                <div className=\"flex items-center gap-4\">\r\n                    <button onClick={onBack} className=\"p-2 hover:bg-gray-100 rounded-lg\">\r\n                        ← 返回\r\n                    </button>\r\n                    <div>\r\n                        <div className=\"flex items-center gap-2\">\r\n                            <h2 className=\"text-xl font-bold\">{contract.contractNo}</h2>\r\n                            <StatusBadge status={contract.status} />\r\n                        </div>\r\n                        <p className=\"text-sm text-gray-500\">{contract.projectName}</p>\r\n                    </div>\r\n                </div>\r\n                <div className=\"flex gap-2\">\r\n                    {contract.status === CONTRACT_STATUS.DRAFT && (\r\n                        <button\r\n                            onClick={handleSign}\r\n                            className=\"px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700\"\r\n                        >\r\n                            簽約\r\n                        </button>\r\n                    )}\r\n                    {contract.status === CONTRACT_STATUS.ACTIVE && (\r\n                        <button\r\n                            onClick={handleComplete}\r\n                            className=\"px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700\"\r\n                        >\r\n                            標記完工\r\n                        </button>\r\n                    )}\r\n                    {contract.status === CONTRACT_STATUS.WARRANTY && (\r\n                        <button\r\n                            onClick={handleClose}\r\n                            className=\"px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700\"\r\n                        >\r\n                            結案\r\n                        </button>\r\n                    )}\r\n                </div>\r\n            </div>\r\n\r\n            {/* 金額概覽 */}\r\n            <div className=\"grid grid-cols-4 gap-4\">\r\n                <div className=\"bg-white rounded-xl p-4 border border-gray-100\">\r\n                    <p className=\"text-sm text-gray-500\">原始合約金額</p>\r\n                    <p className=\"text-xl font-bold\">{formatCurrency(contract.originalAmount)}</p>\r\n                </div>\r\n                <div className=\"bg-white rounded-xl p-4 border border-gray-100\">\r\n                    <p className=\"text-sm text-gray-500\">變更單金額</p>\r\n                    <p className={`text-xl font-bold ${contract.changeOrderTotal >= 0 ? 'text-green-600' : 'text-red-600'}`}>\r\n                        {contract.changeOrderTotal >= 0 ? '+' : ''}{formatCurrency(contract.changeOrderTotal)}\r\n                    </p>\r\n                </div>\r\n                <div className=\"bg-white rounded-xl p-4 border border-gray-100\">\r\n                    <p className=\"text-sm text-gray-500\">現行合約金額</p>\r\n                    <p className=\"text-xl font-bold text-blue-600\">{formatCurrency(contract.currentAmount)}</p>\r\n                </div>\r\n                <div className=\"bg-white rounded-xl p-4 border border-gray-100\">\r\n                    <p className=\"text-sm text-gray-500\">已請款金額</p>\r\n                    <p className=\"text-xl font-bold text-green-600\">{formatCurrency(contract.paidAmount)}</p>\r\n                </div>\r\n            </div>\r\n\r\n            {/* 請款進度 */}\r\n            <div className=\"bg-white rounded-xl p-6 border border-gray-100\">\r\n                <div className=\"flex justify-between items-center mb-2\">\r\n                    <h3 className=\"font-semibold\">請款進度</h3>\r\n                    <span className=\"text-lg font-bold text-orange-600\">{progress}%</span>\r\n                </div>\r\n                <div className=\"h-3 bg-gray-100 rounded-full overflow-hidden\">\r\n                    <div\r\n                        className=\"h-full bg-gradient-to-r from-orange-400 to-orange-600 rounded-full transition-all\"\r\n                        style={{ width: `${progress}%` }}\r\n                    />\r\n                </div>\r\n                <div className=\"flex justify-between text-sm text-gray-500 mt-2\">\r\n                    <span>已請 {formatCurrency(contract.paidAmount)}</span>\r\n                    <span>未請 {formatCurrency(contract.currentAmount - contract.paidAmount)}</span>\r\n                </div>\r\n            </div>\r\n\r\n            {/* 合約資訊 */}\r\n            <div className=\"grid grid-cols-2 gap-6\">\r\n                {/* 基本資訊 */}\r\n                <div className=\"bg-white rounded-xl p-6 border border-gray-100\">\r\n                    <h3 className=\"font-semibold mb-4\">基本資訊</h3>\r\n                    <div className=\"space-y-3 text-sm\">\r\n                        <div className=\"flex justify-between\">\r\n                            <span className=\"text-gray-500\">合約類型</span>\r\n                            <span>{CONTRACT_TYPE_LABELS[contract.type]}</span>\r\n                        </div>\r\n                        <div className=\"flex justify-between\">\r\n                            <span className=\"text-gray-500\">客戶</span>\r\n                            <span>{contract.customerName}</span>\r\n                        </div>\r\n                        <div className=\"flex justify-between\">\r\n                            <span className=\"text-gray-500\">來源估價單</span>\r\n                            <span>{contract.quotationNo}</span>\r\n                        </div>\r\n                        <div className=\"flex justify-between\">\r\n                            <span className=\"text-gray-500\">保留款比例</span>\r\n                            <span>{contract.retentionRate}%</span>\r\n                        </div>\r\n                        <div className=\"flex justify-between\">\r\n                            <span className=\"text-gray-500\">保固期</span>\r\n                            <span>{contract.warrantyMonths} 個月</span>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n\r\n                {/* 日期資訊 */}\r\n                <div className=\"bg-white rounded-xl p-6 border border-gray-100\">\r\n                    <h3 className=\"font-semibold mb-4\">日期資訊</h3>\r\n                    <div className=\"space-y-3 text-sm\">\r\n                        <div className=\"flex justify-between\">\r\n                            <span className=\"text-gray-500\">建立日期</span>\r\n                            <span>{formatDate(contract.createdAt)}</span>\r\n                        </div>\r\n                        <div className=\"flex justify-between\">\r\n                            <span className=\"text-gray-500\">簽約日期</span>\r\n                            <span>{formatDate(contract.signedDate)}</span>\r\n                        </div>\r\n                        <div className=\"flex justify-between\">\r\n                            <span className=\"text-gray-500\">預計開工</span>\r\n                            <span>{formatDate(contract.startDate)}</span>\r\n                        </div>\r\n                        <div className=\"flex justify-between\">\r\n                            <span className=\"text-gray-500\">預計完工</span>\r\n                            <span>{formatDate(contract.endDate)}</span>\r\n                        </div>\r\n                        <div className=\"flex justify-between\">\r\n                            <span className=\"text-gray-500\">保固到期</span>\r\n                            <span>{formatDate(contract.warrantyEndDate)}</span>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n\r\n            {/* 付款條件 */}\r\n            <div className=\"bg-white rounded-xl p-6 border border-gray-100\">\r\n                <h3 className=\"font-semibold mb-4\">付款條件</h3>\r\n                <div className=\"flex gap-2\">\r\n                    {contract.paymentTerms?.map((term, index) => (\r\n                        <div key={index} className=\"flex-1 p-3 bg-gray-50 rounded-lg text-center\">\r\n                            <p className=\"text-xs text-gray-500\">{term.name}</p>\r\n                            <p className=\"text-lg font-bold text-gray-800\">{term.percentage}%</p>\r\n                        </div>\r\n                    ))}\r\n                </div>\r\n            </div>\r\n        </div>\r\n    );\r\n};\r\n\r\n// ============================================\r\n// 合約列表\r\n// ============================================\r\nconst ContractList = ({ onView, addToast }) => {\r\n    const [contracts, setContracts] = useState([]);\r\n    const [loading, setLoading] = useState(true);\r\n    const [searchTerm, setSearchTerm] = useState('');\r\n    const [statusFilter, setStatusFilter] = useState('ALL');\r\n    const [showCreateModal, setShowCreateModal] = useState(false);\r\n\r\n    const loadContracts = async () => {\r\n        setLoading(true);\r\n        try {\r\n            const data = await ContractService.getContracts();\r\n            setContracts(data);\r\n        } catch (error) {\r\n            console.error('Load error:', error);\r\n        } finally {\r\n            setLoading(false);\r\n        }\r\n    };\r\n\r\n    useEffect(() => {\r\n        loadContracts();\r\n    }, []);\r\n\r\n    // 篩選\r\n    const filteredContracts = useMemo(() => {\r\n        return contracts.filter(c => {\r\n            if (statusFilter !== 'ALL' && c.status !== statusFilter) return false;\r\n            if (searchTerm) {\r\n                const term = searchTerm.toLowerCase();\r\n                return (\r\n                    c.contractNo?.toLowerCase().includes(term) ||\r\n                    c.projectName?.toLowerCase().includes(term) ||\r\n                    c.customerName?.toLowerCase().includes(term)\r\n                );\r\n            }\r\n            return true;\r\n        });\r\n    }, [contracts, statusFilter, searchTerm]);\r\n\r\n    // 統計\r\n    const stats = useMemo(() => ({\r\n        total: contracts.length,\r\n        active: contracts.filter(c => c.status === CONTRACT_STATUS.ACTIVE).length,\r\n        completed: contracts.filter(c => c.status === CONTRACT_STATUS.COMPLETED || c.status === CONTRACT_STATUS.WARRANTY).length,\r\n        totalAmount: contracts.reduce((sum, c) => sum + (c.currentAmount || 0), 0),\r\n    }), [contracts]);\r\n\r\n    const handleCreate = async (quotationId, data) => {\r\n        try {\r\n            await ContractService.createFromQuotation(quotationId, data);\r\n            addToast?.('success', '合約建立成功');\r\n            loadContracts();\r\n        } catch (error) {\r\n            addToast?.('error', '建立失敗: ' + error.message);\r\n        }\r\n    };\r\n\r\n    const handleDelete = async (id) => {\r\n        if (!window.confirm('確定要刪除此合約？')) return;\r\n        try {\r\n            await ContractService.deleteContract(id);\r\n            addToast?.('success', '已刪除');\r\n            loadContracts();\r\n        } catch (error) {\r\n            addToast?.('error', error.message);\r\n        }\r\n    };\r\n\r\n    return (\r\n        <div className=\"space-y-6\">\r\n            {/* 標題 */}\r\n            <div className=\"flex items-center justify-between\">\r\n                <SectionTitle\r\n                    icon={FileSignature}\r\n                    title=\"合約管理\"\r\n                    subtitle=\"管理專案合約與履約追蹤\"\r\n                />\r\n                <button\r\n                    onClick={() => setShowCreateModal(true)}\r\n                    className=\"px-4 py-2 bg-orange-500 text-white rounded-xl hover:bg-orange-600 flex items-center gap-2\"\r\n                >\r\n                    <Plus size={18} /> 建立合約\r\n                </button>\r\n            </div>\r\n\r\n            {/* 統計 */}\r\n            <div className=\"grid grid-cols-4 gap-4\">\r\n                <StatCard icon={FileText} label=\"全部合約\" value={stats.total} color=\"gray\" />\r\n                <StatCard icon={Clock} label=\"履約中\" value={stats.active} color=\"blue\" />\r\n                <StatCard icon={CheckCircle} label=\"已完工\" value={stats.completed} color=\"green\" />\r\n                <StatCard icon={DollarSign} label=\"合約總額\" value={formatCurrency(stats.totalAmount)} color=\"orange\" />\r\n            </div>\r\n\r\n            {/* 搜尋篩選 */}\r\n            <div className=\"flex gap-3\">\r\n                <div className=\"relative flex-1\">\r\n                    <Search size={18} className=\"absolute left-3 top-1/2 -translate-y-1/2 text-gray-400\" />\r\n                    <input\r\n                        type=\"text\"\r\n                        value={searchTerm}\r\n                        onChange={(e) => setSearchTerm(e.target.value)}\r\n                        placeholder=\"搜尋合約編號、專案、客戶...\"\r\n                        className=\"w-full pl-10 pr-4 py-2.5 border border-gray-200 rounded-xl\"\r\n                    />\r\n                </div>\r\n                <select\r\n                    value={statusFilter}\r\n                    onChange={(e) => setStatusFilter(e.target.value)}\r\n                    className=\"px-4 py-2.5 border border-gray-200 rounded-xl bg-white\"\r\n                >\r\n                    <option value=\"ALL\">全部狀態</option>\r\n                    {Object.entries(CONTRACT_STATUS_LABELS).map(([key, label]) => (\r\n                        <option key={key} value={key}>{label}</option>\r\n                    ))}\r\n                </select>\r\n            </div>\r\n\r\n            {/* 合約列表 */}\r\n            <div className=\"bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden\">\r\n                <table className=\"w-full\">\r\n                    <thead className=\"bg-gray-50\">\r\n                        <tr>\r\n                            <th className=\"py-3 px-4 text-left text-sm font-medium text-gray-600\">合約編號</th>\r\n                            <th className=\"py-3 px-4 text-left text-sm font-medium text-gray-600\">專案/客戶</th>\r\n                            <th className=\"py-3 px-4 text-center text-sm font-medium text-gray-600\">類型</th>\r\n                            <th className=\"py-3 px-4 text-center text-sm font-medium text-gray-600\">狀態</th>\r\n                            <th className=\"py-3 px-4 text-right text-sm font-medium text-gray-600\">合約金額</th>\r\n                            <th className=\"py-3 px-4 text-right text-sm font-medium text-gray-600\">已請款</th>\r\n                            <th className=\"py-3 px-4 text-center text-sm font-medium text-gray-600\">簽約日</th>\r\n                            <th className=\"py-3 px-4 text-center text-sm font-medium text-gray-600\">操作</th>\r\n                        </tr>\r\n                    </thead>\r\n                    <tbody>\r\n                        {filteredContracts.map(contract => (\r\n                            <tr key={contract.id} className=\"border-b border-gray-100 hover:bg-gray-50\">\r\n                                <td className=\"py-3 px-4 font-medium\">{contract.contractNo}</td>\r\n                                <td className=\"py-3 px-4\">\r\n                                    <div className=\"text-sm\">{contract.projectName}</div>\r\n                                    <div className=\"text-xs text-gray-400\">{contract.customerName}</div>\r\n                                </td>\r\n                                <td className=\"py-3 px-4 text-center text-sm\">\r\n                                    {CONTRACT_TYPE_LABELS[contract.type]}\r\n                                </td>\r\n                                <td className=\"py-3 px-4 text-center\">\r\n                                    <StatusBadge status={contract.status} />\r\n                                </td>\r\n                                <td className=\"py-3 px-4 text-right font-medium text-blue-600\">\r\n                                    {formatCurrency(contract.currentAmount)}\r\n                                </td>\r\n                                <td className=\"py-3 px-4 text-right font-medium text-green-600\">\r\n                                    {formatCurrency(contract.paidAmount)}\r\n                                </td>\r\n                                <td className=\"py-3 px-4 text-center text-sm text-gray-500\">\r\n                                    {formatDate(contract.signedDate)}\r\n                                </td>\r\n                                <td className=\"py-3 px-4 text-center\">\r\n                                    <div className=\"flex justify-center gap-2\">\r\n                                        <button\r\n                                            onClick={() => onView(contract)}\r\n                                            className=\"px-2 py-1 text-sm text-blue-600 hover:bg-blue-50 rounded\"\r\n                                        >\r\n                                            查看\r\n                                        </button>\r\n                                        {contract.status === CONTRACT_STATUS.DRAFT && (\r\n                                            <button\r\n                                                onClick={() => handleDelete(contract.id)}\r\n                                                className=\"px-2 py-1 text-sm text-red-600 hover:bg-red-50 rounded\"\r\n                                            >\r\n                                                刪除\r\n                                            </button>\r\n                                        )}\r\n                                    </div>\r\n                                </td>\r\n                            </tr>\r\n                        ))}\r\n                    </tbody>\r\n                </table>\r\n                {loading ? (\r\n                    <div className=\"text-center py-8 text-gray-400\">載入中...</div>\r\n                ) : filteredContracts.length === 0 && (\r\n                    <div className=\"text-center py-8 text-gray-400\">\r\n                        <FileSignature size={48} className=\"mx-auto mb-4 opacity-30\" />\r\n                        <p>尚無合約</p>\r\n                        <p className=\"text-sm\">請從已核准的估價單建立合約</p>\r\n                    </div>\r\n                )}\r\n            </div>\r\n\r\n            {/* 建立合約 Modal */}\r\n            <CreateContractModal\r\n                isOpen={showCreateModal}\r\n                onClose={() => setShowCreateModal(false)}\r\n                onSubmit={handleCreate}\r\n                addToast={addToast}\r\n            />\r\n        </div>\r\n    );\r\n};\r\n\r\n// ============================================\r\n// 主元件\r\n// ============================================\r\nconst Contracts = ({ addToast }) => {\r\n    const [viewMode, setViewMode] = useState('list');\r\n    const [selectedContract, setSelectedContract] = useState(null);\r\n\r\n    const handleView = (contract) => {\r\n        setSelectedContract(contract);\r\n        setViewMode('detail');\r\n    };\r\n\r\n    const handleBack = () => {\r\n        setSelectedContract(null);\r\n        setViewMode('list');\r\n    };\r\n\r\n    const handleRefresh = async () => {\r\n        if (selectedContract) {\r\n            const updated = await ContractService.getContract(selectedContract.id);\r\n            setSelectedContract(updated);\r\n        }\r\n    };\r\n\r\n    if (viewMode === 'detail' && selectedContract) {\r\n        return (\r\n            <ContractDetail\r\n                contract={selectedContract}\r\n                onBack={handleBack}\r\n                onRefresh={handleRefresh}\r\n                addToast={addToast}\r\n            />\r\n        );\r\n    }\r\n\r\n    return (\r\n        <ContractList\r\n            onView={handleView}\r\n            addToast={addToast}\r\n        />\r\n    );\r\n};\r\n\r\nexport default Contracts;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\xiang\\senteng-frontend\\src\\pages\\CostEntries.jsx","messages":[{"ruleId":"no-unused-vars","severity":2,"message":"'Icon' is defined but never used. Allowed unused args must match /^_|^e$|^err$|^event$/u.","line":30,"column":27,"nodeType":"Identifier","messageId":"unusedVar","endLine":30,"endColumn":31,"suggestions":[{"messageId":"removeVar","data":{"varName":"Icon"},"fix":{"range":[1238,1249],"text":""},"desc":"Remove unused variable 'Icon'."}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'loadData'. Either include it or remove the dependency array.","line":163,"column":8,"nodeType":"ArrayExpression","endLine":163,"endColumn":10,"suggestions":[{"desc":"Update the dependencies array to be: [loadData]","fix":{"range":[7251,7253],"text":"[loadData]"}}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect, useMemo } from 'react';\r\nimport {\r\n    DollarSign, Plus, Search, Filter, Calendar, Building2,\r\n    User, FileText, Check, Clock, AlertCircle, TrendingUp,\r\n    Edit, Trash2, X, Save, CreditCard, Download, RotateCcw\r\n} from 'lucide-react';\r\nimport { Modal } from '../components/common/Modal';\r\nimport { InputField } from '../components/common/InputField';\r\nimport { SectionTitle } from '../components/common/Indicators';\r\nimport { costEntriesApi, projectsApi, vendorsApi } from '../services/api';\r\n\r\n// 成本類別配置\r\nconst CATEGORY_CONFIG = {\r\n    'MATERIAL': { label: '材料費', icon: Building2, color: 'blue' },\r\n    'LABOR': { label: '工資', icon: User, color: 'orange' },\r\n    'EQUIPMENT': { label: '設備費', icon: Clock, color: 'purple' },\r\n    'SUBCONTRACT': { label: '外包費', icon: FileText, color: 'green' },\r\n    'OVERHEAD': { label: '管銷費', icon: TrendingUp, color: 'gray' },\r\n    'OTHER': { label: '其他', icon: DollarSign, color: 'red' },\r\n};\r\n\r\n// 付款狀態配置\r\nconst PAYMENT_STATUS = {\r\n    'UNPAID': { label: '未付款', color: 'red', icon: AlertCircle },\r\n    'PARTIAL': { label: '部分付款', color: 'yellow', icon: Clock },\r\n    'PAID': { label: '已付款', color: 'green', icon: Check },\r\n};\r\n\r\n// 統計卡片組件\r\nfunction StatCard({ icon: Icon, label, value, color = 'gray', subValue }) {\r\n    const colorClasses = {\r\n        blue: 'bg-blue-50 text-blue-600 border-blue-200',\r\n        green: 'bg-green-50 text-green-600 border-green-200',\r\n        red: 'bg-red-50 text-red-600 border-red-200',\r\n        orange: 'bg-orange-50 text-orange-600 border-orange-200',\r\n        purple: 'bg-purple-50 text-purple-600 border-purple-200',\r\n        gray: 'bg-gray-50 text-gray-600 border-gray-200',\r\n    };\r\n\r\n    return (\r\n        <div className={`p-4 rounded-xl border ${colorClasses[color]} transition-all hover:shadow-md`}>\r\n            <div className=\"flex items-center gap-3\">\r\n                <div className={`p-2 rounded-lg bg-white/60`}>\r\n                    <Icon className=\"w-5 h-5\" />\r\n                </div>\r\n                <div>\r\n                    <p className=\"text-sm opacity-80\">{label}</p>\r\n                    <p className=\"text-xl font-bold\">{value}</p>\r\n                    {subValue && <p className=\"text-xs opacity-60\">{subValue}</p>}\r\n                </div>\r\n            </div>\r\n        </div>\r\n    );\r\n}\r\n\r\n// 成本項目行組件\r\nfunction CostEntryRow({ entry, onEdit, onDelete, onMarkPaid }) {\r\n    const category = CATEGORY_CONFIG[entry.category] || CATEGORY_CONFIG.OTHER;\r\n    const status = PAYMENT_STATUS[entry.paymentStatus] || PAYMENT_STATUS.UNPAID;\r\n    const CategoryIcon = category.icon;\r\n    const StatusIcon = status.icon;\r\n\r\n    return (\r\n        <div className=\"p-4 bg-white rounded-lg border border-gray-200 hover:shadow-md transition-all\">\r\n            <div className=\"flex items-start justify-between gap-4\">\r\n                <div className=\"flex items-start gap-3 flex-1\">\r\n                    <div className={`p-2 rounded-lg bg-${category.color}-100`}>\r\n                        <CategoryIcon className={`w-5 h-5 text-${category.color}-600`} />\r\n                    </div>\r\n                    <div className=\"flex-1 min-w-0\">\r\n                        <h4 className=\"font-medium text-gray-900 truncate\">{entry.description}</h4>\r\n                        <div className=\"flex flex-wrap gap-2 mt-1 text-sm text-gray-500\">\r\n                            <span className=\"flex items-center gap-1\">\r\n                                <Calendar className=\"w-3 h-3\" />\r\n                                {entry.date}\r\n                            </span>\r\n                            {entry.vendorName && (\r\n                                <span className=\"flex items-center gap-1\">\r\n                                    <User className=\"w-3 h-3\" />\r\n                                    {entry.vendorName}\r\n                                </span>\r\n                            )}\r\n                            <span className={`px-2 py-0.5 rounded-full text-xs bg-${category.color}-100 text-${category.color}-700`}>\r\n                                {category.label}\r\n                            </span>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n                <div className=\"text-right\">\r\n                    <p className=\"text-lg font-bold text-gray-900\">\r\n                        ${entry.amount?.toLocaleString() || 0}\r\n                    </p>\r\n                    <div className={`flex items-center gap-1 text-xs mt-1 text-${status.color}-600`}>\r\n                        <StatusIcon className=\"w-3 h-3\" />\r\n                        {status.label}\r\n                    </div>\r\n                </div>\r\n            </div>\r\n            <div className=\"flex justify-end gap-2 mt-3 pt-3 border-t border-gray-100\">\r\n                {entry.paymentStatus !== 'PAID' && (\r\n                    <button\r\n                        onClick={() => onMarkPaid(entry)}\r\n                        className=\"px-3 py-1.5 text-xs rounded-lg bg-green-100 text-green-700 hover:bg-green-200 transition-colors flex items-center gap-1\"\r\n                    >\r\n                        <CreditCard className=\"w-3 h-3\" /> 標記已付\r\n                    </button>\r\n                )}\r\n                <button\r\n                    onClick={() => onEdit(entry)}\r\n                    className=\"px-3 py-1.5 text-xs rounded-lg bg-blue-100 text-blue-700 hover:bg-blue-200 transition-colors flex items-center gap-1\"\r\n                >\r\n                    <Edit className=\"w-3 h-3\" /> 編輯\r\n                </button>\r\n                <button\r\n                    onClick={() => onDelete(entry)}\r\n                    className=\"px-3 py-1.5 text-xs rounded-lg bg-red-100 text-red-700 hover:bg-red-200 transition-colors flex items-center gap-1\"\r\n                >\r\n                    <Trash2 className=\"w-3 h-3\" /> 刪除\r\n                </button>\r\n            </div>\r\n        </div>\r\n    );\r\n}\r\n\r\nexport default function CostEntries({ addToast }) {\r\n    // 狀態\r\n    const [entries, setEntries] = useState([]);\r\n    const [projects, setProjects] = useState([]);\r\n    const [vendors, setVendors] = useState([]);\r\n    const [loading, setLoading] = useState(true);\r\n    const [error, setError] = useState(null);\r\n\r\n    // 篩選狀態\r\n    const [searchTerm, setSearchTerm] = useState('');\r\n    const [filterProject, setFilterProject] = useState('');\r\n    const [filterCategory, setFilterCategory] = useState('');\r\n    const [filterStatus, setFilterStatus] = useState('');\r\n    const [filterDateFrom, setFilterDateFrom] = useState('');\r\n    const [filterDateTo, setFilterDateTo] = useState('');\r\n\r\n    // Modal 狀態\r\n    const [showAddModal, setShowAddModal] = useState(false);\r\n    const [showDeleteModal, setShowDeleteModal] = useState(false);\r\n    const [editingEntry, setEditingEntry] = useState(null);\r\n    const [entryToDelete, setEntryToDelete] = useState(null);\r\n\r\n    // 表單狀態\r\n    const [formData, setFormData] = useState({\r\n        projectId: '',\r\n        date: new Date().toISOString().split('T')[0],\r\n        category: 'MATERIAL',\r\n        description: '',\r\n        vendorId: '',\r\n        vendorName: '',\r\n        amount: '',\r\n        invoiceNo: '',\r\n        notes: '',\r\n    });\r\n\r\n    // 載入資料\r\n    useEffect(() => {\r\n        loadData();\r\n    }, []);\r\n\r\n    const loadData = async () => {\r\n        setLoading(true);\r\n        setError(null);\r\n        try {\r\n            const [entriesRes, projectsRes, vendorsRes] = await Promise.all([\r\n                costEntriesApi.getAll(),\r\n                projectsApi.getAll(),\r\n                vendorsApi.getAll(),\r\n            ]);\r\n\r\n            const entriesList = Array.isArray(entriesRes) ? entriesRes : (entriesRes.items || []);\r\n            const projectsList = Array.isArray(projectsRes) ? projectsRes : (projectsRes.items || []);\r\n            const vendorsList = Array.isArray(vendorsRes) ? vendorsRes : (vendorsRes.items || []);\r\n\r\n            setEntries(entriesList);\r\n            setProjects(projectsList);\r\n            setVendors(vendorsList);\r\n            console.log('✅ Cost entries loaded:', entriesList.length);\r\n        } catch (err) {\r\n            console.error('❌ Failed to load cost entries:', err);\r\n            setError(err.message);\r\n            addToast?.('載入成本資料失敗', 'error');\r\n        } finally {\r\n            setLoading(false);\r\n        }\r\n    };\r\n\r\n    // 篩選後的資料\r\n    const filteredEntries = useMemo(() => {\r\n        return entries.filter(entry => {\r\n            if (searchTerm && !entry.description?.toLowerCase().includes(searchTerm.toLowerCase())) {\r\n                return false;\r\n            }\r\n            if (filterProject && entry.projectId !== filterProject) {\r\n                return false;\r\n            }\r\n            if (filterCategory && entry.category !== filterCategory) {\r\n                return false;\r\n            }\r\n            if (filterStatus && entry.paymentStatus !== filterStatus) {\r\n                return false;\r\n            }\r\n            // Date range filter\r\n            if (filterDateFrom && entry.date < filterDateFrom) {\r\n                return false;\r\n            }\r\n            if (filterDateTo && entry.date > filterDateTo) {\r\n                return false;\r\n            }\r\n            return true;\r\n        });\r\n    }, [entries, searchTerm, filterProject, filterCategory, filterStatus, filterDateFrom, filterDateTo]);\r\n\r\n    // 統計資料\r\n    const stats = useMemo(() => {\r\n        const total = filteredEntries.reduce((sum, e) => sum + (e.amount || 0), 0);\r\n        const paid = filteredEntries.filter(e => e.paymentStatus === 'PAID').reduce((sum, e) => sum + (e.amount || 0), 0);\r\n        const unpaid = filteredEntries.filter(e => e.paymentStatus === 'UNPAID').reduce((sum, e) => sum + (e.amount || 0), 0);\r\n        const byCategory = {};\r\n        filteredEntries.forEach(e => {\r\n            byCategory[e.category] = (byCategory[e.category] || 0) + (e.amount || 0);\r\n        });\r\n        return { total, paid, unpaid, byCategory, count: filteredEntries.length };\r\n    }, [filteredEntries]);\r\n\r\n    // 開啟新增 Modal\r\n    const handleOpenAdd = () => {\r\n        setEditingEntry(null);\r\n        setFormData({\r\n            projectId: filterProject || '',\r\n            date: new Date().toISOString().split('T')[0],\r\n            category: 'MATERIAL',\r\n            description: '',\r\n            vendorId: '',\r\n            vendorName: '',\r\n            amount: '',\r\n            invoiceNo: '',\r\n            notes: '',\r\n        });\r\n        setShowAddModal(true);\r\n    };\r\n\r\n    // 開啟編輯 Modal\r\n    const handleEdit = (entry) => {\r\n        setEditingEntry(entry);\r\n        setFormData({\r\n            projectId: entry.projectId || '',\r\n            date: entry.date || new Date().toISOString().split('T')[0],\r\n            category: entry.category || 'MATERIAL',\r\n            description: entry.description || '',\r\n            vendorId: entry.vendorId || '',\r\n            vendorName: entry.vendorName || '',\r\n            amount: entry.amount?.toString() || '',\r\n            invoiceNo: entry.invoiceNo || '',\r\n            notes: entry.notes || '',\r\n        });\r\n        setShowAddModal(true);\r\n    };\r\n\r\n    // 儲存成本項目\r\n    const handleSave = async () => {\r\n        if (!formData.projectId || !formData.description || !formData.amount) {\r\n            addToast?.('請填寫必要欄位（專案、說明、金額）', 'error');\r\n            return;\r\n        }\r\n\r\n        try {\r\n            const payload = {\r\n                ...formData,\r\n                amount: parseFloat(formData.amount),\r\n            };\r\n\r\n            if (editingEntry) {\r\n                await costEntriesApi.update(editingEntry.id, payload);\r\n                addToast?.('成本項目已更新', 'success');\r\n            } else {\r\n                await costEntriesApi.create(payload);\r\n                addToast?.('成本項目已新增', 'success');\r\n            }\r\n\r\n            setShowAddModal(false);\r\n            loadData();\r\n        } catch (err) {\r\n            console.error('Failed to save cost entry:', err);\r\n            addToast?.(`儲存失敗: ${err.message}`, 'error');\r\n        }\r\n    };\r\n\r\n    // 刪除成本項目\r\n    const handleDelete = async () => {\r\n        if (!entryToDelete) return;\r\n\r\n        try {\r\n            await costEntriesApi.delete(entryToDelete.id);\r\n            addToast?.('成本項目已刪除', 'success');\r\n            setShowDeleteModal(false);\r\n            setEntryToDelete(null);\r\n            loadData();\r\n        } catch (err) {\r\n            console.error('Failed to delete cost entry:', err);\r\n            addToast?.(`刪除失敗: ${err.message}`, 'error');\r\n        }\r\n    };\r\n\r\n    // 標記已付款\r\n    const handleMarkPaid = async (entry) => {\r\n        try {\r\n            await costEntriesApi.markPaid(entry.id, { paidDate: new Date().toISOString() });\r\n            addToast?.('已標記為已付款', 'success');\r\n            loadData();\r\n        } catch (err) {\r\n            console.error('Failed to mark as paid:', err);\r\n            addToast?.(`標記失敗: ${err.message}`, 'error');\r\n        }\r\n    };\r\n\r\n    // 開啟刪除確認\r\n    const openDeleteModal = (entry) => {\r\n        setEntryToDelete(entry);\r\n        setShowDeleteModal(true);\r\n    };\r\n\r\n    // 清除所有篩選\r\n    const clearFilters = () => {\r\n        setSearchTerm('');\r\n        setFilterProject('');\r\n        setFilterCategory('');\r\n        setFilterStatus('');\r\n        setFilterDateFrom('');\r\n        setFilterDateTo('');\r\n    };\r\n\r\n    // 匯出 CSV\r\n    const exportToCSV = () => {\r\n        const headers = ['日期', '專案', '類別', '說明', '廠商', '金額', '發票號碼', '付款狀態', '備註'];\r\n        const rows = filteredEntries.map(entry => {\r\n            const project = projects.find(p => p.id === entry.projectId);\r\n            const category = CATEGORY_CONFIG[entry.category]?.label || entry.category;\r\n            const status = PAYMENT_STATUS[entry.paymentStatus]?.label || entry.paymentStatus;\r\n            return [\r\n                entry.date,\r\n                project?.name || '-',\r\n                category,\r\n                entry.description,\r\n                entry.vendorName || '-',\r\n                entry.amount,\r\n                entry.invoiceNo || '-',\r\n                status,\r\n                entry.notes || '-'\r\n            ];\r\n        });\r\n\r\n        const csvContent = [\r\n            headers.join(','),\r\n            ...rows.map(row => row.map(cell => `\"${String(cell).replace(/\"/g, '\"\"')}\"`).join(','))\r\n        ].join('\\n');\r\n\r\n        const blob = new Blob([`\\ufeff${csvContent}`], { type: 'text/csv;charset=utf-8;' });\r\n        const url = URL.createObjectURL(blob);\r\n        const link = document.createElement('a');\r\n        link.href = url;\r\n        link.download = `成本紀錄_${new Date().toISOString().split('T')[0]}.csv`;\r\n        link.click();\r\n        URL.revokeObjectURL(url);\r\n        addToast?.('CSV 匯出成功', 'success');\r\n    };\r\n\r\n    if (loading) {\r\n        return (\r\n            <div className=\"flex items-center justify-center h-64\">\r\n                <div className=\"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600\"></div>\r\n            </div>\r\n        );\r\n    }\r\n\r\n    return (\r\n        <div className=\"space-y-6\">\r\n            <div className=\"flex items-center justify-between\">\r\n                <SectionTitle icon={DollarSign} title=\"成本追蹤\" />\r\n                <div className=\"flex items-center gap-2\">\r\n                    <button\r\n                        onClick={exportToCSV}\r\n                        disabled={filteredEntries.length === 0}\r\n                        className=\"flex items-center gap-2 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed\"\r\n                    >\r\n                        <Download className=\"w-4 h-4\" />\r\n                        匯出\r\n                    </button>\r\n                    <button\r\n                        onClick={handleOpenAdd}\r\n                        className=\"flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors\"\r\n                    >\r\n                        <Plus className=\"w-4 h-4\" />\r\n                        新增成本\r\n                    </button>\r\n                </div>\r\n            </div>\r\n\r\n            {/* 統計卡片 */}\r\n            <div className=\"grid grid-cols-2 md:grid-cols-4 gap-4\">\r\n                <StatCard\r\n                    icon={DollarSign}\r\n                    label=\"總成本\"\r\n                    value={`$${stats.total.toLocaleString()}`}\r\n                    color=\"blue\"\r\n                    subValue={`${stats.count} 筆`}\r\n                />\r\n                <StatCard\r\n                    icon={Check}\r\n                    label=\"已付款\"\r\n                    value={`$${stats.paid.toLocaleString()}`}\r\n                    color=\"green\"\r\n                />\r\n                <StatCard\r\n                    icon={AlertCircle}\r\n                    label=\"未付款\"\r\n                    value={`$${stats.unpaid.toLocaleString()}`}\r\n                    color=\"red\"\r\n                />\r\n                <StatCard\r\n                    icon={TrendingUp}\r\n                    label=\"材料費佔比\"\r\n                    value={`${stats.total > 0 ? Math.round((stats.byCategory['MATERIAL'] || 0) / stats.total * 100) : 0}%`}\r\n                    color=\"purple\"\r\n                />\r\n            </div>\r\n\r\n            {/* 篩選區 */}\r\n            <div className=\"flex flex-wrap gap-3 p-4 bg-gray-50 rounded-xl\">\r\n                <div className=\"flex-1 min-w-[200px]\">\r\n                    <div className=\"relative\">\r\n                        <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400\" />\r\n                        <input\r\n                            type=\"text\"\r\n                            placeholder=\"搜尋說明...\"\r\n                            value={searchTerm}\r\n                            onChange={(e) => setSearchTerm(e.target.value)}\r\n                            className=\"w-full pl-10 pr-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent\"\r\n                        />\r\n                    </div>\r\n                </div>\r\n                <select\r\n                    value={filterProject}\r\n                    onChange={(e) => setFilterProject(e.target.value)}\r\n                    className=\"px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500\"\r\n                >\r\n                    <option value=\"\">所有專案</option>\r\n                    {projects.map(p => (\r\n                        <option key={p.id} value={p.id}>{p.name}</option>\r\n                    ))}\r\n                </select>\r\n                <select\r\n                    value={filterCategory}\r\n                    onChange={(e) => setFilterCategory(e.target.value)}\r\n                    className=\"px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500\"\r\n                >\r\n                    <option value=\"\">所有類別</option>\r\n                    {Object.entries(CATEGORY_CONFIG).map(([key, config]) => (\r\n                        <option key={key} value={key}>{config.label}</option>\r\n                    ))}\r\n                </select>\r\n                <select\r\n                    value={filterStatus}\r\n                    onChange={(e) => setFilterStatus(e.target.value)}\r\n                    className=\"px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500\"\r\n                >\r\n                    <option value=\"\">所有狀態</option>\r\n                    {Object.entries(PAYMENT_STATUS).map(([key, config]) => (\r\n                        <option key={key} value={key}>{config.label}</option>\r\n                    ))}\r\n                </select>\r\n                <div className=\"flex items-center gap-2\">\r\n                    <span className=\"text-sm text-gray-500\">期間:</span>\r\n                    <input\r\n                        type=\"date\"\r\n                        value={filterDateFrom}\r\n                        onChange={(e) => setFilterDateFrom(e.target.value)}\r\n                        className=\"px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 text-sm\"\r\n                    />\r\n                    <span className=\"text-gray-400\">~</span>\r\n                    <input\r\n                        type=\"date\"\r\n                        value={filterDateTo}\r\n                        onChange={(e) => setFilterDateTo(e.target.value)}\r\n                        className=\"px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 text-sm\"\r\n                    />\r\n                </div>\r\n                {(searchTerm || filterProject || filterCategory || filterStatus || filterDateFrom || filterDateTo) && (\r\n                    <button\r\n                        onClick={clearFilters}\r\n                        className=\"flex items-center gap-1 px-3 py-2 text-gray-600 hover:bg-gray-200 rounded-lg transition-colors text-sm\"\r\n                    >\r\n                        <RotateCcw className=\"w-4 h-4\" />\r\n                        清除篩選\r\n                    </button>\r\n                )}\r\n            </div>\r\n\r\n            {/* 成本列表 */}\r\n            {error ? (\r\n                <div className=\"p-8 text-center text-red-600 bg-red-50 rounded-xl\">\r\n                    <AlertCircle className=\"w-12 h-12 mx-auto mb-4\" />\r\n                    <p>載入失敗: {error}</p>\r\n                    <button onClick={loadData} className=\"mt-4 px-4 py-2 bg-red-600 text-white rounded-lg\">\r\n                        重試\r\n                    </button>\r\n                </div>\r\n            ) : filteredEntries.length === 0 ? (\r\n                <div className=\"p-12 text-center text-gray-500 bg-gray-50 rounded-xl\">\r\n                    <DollarSign className=\"w-16 h-16 mx-auto mb-4 opacity-30\" />\r\n                    <p className=\"text-lg\">尚無成本紀錄</p>\r\n                    <p className=\"text-sm mt-2\">點擊「新增成本」開始記錄專案支出</p>\r\n                </div>\r\n            ) : (\r\n                <div className=\"space-y-3\">\r\n                    {filteredEntries.map(entry => (\r\n                        <CostEntryRow\r\n                            key={entry.id}\r\n                            entry={entry}\r\n                            onEdit={handleEdit}\r\n                            onDelete={openDeleteModal}\r\n                            onMarkPaid={handleMarkPaid}\r\n                        />\r\n                    ))}\r\n                </div>\r\n            )}\r\n\r\n            {/* 新增/編輯 Modal */}\r\n            <Modal\r\n                isOpen={showAddModal}\r\n                onClose={() => setShowAddModal(false)}\r\n                title={editingEntry ? '編輯成本項目' : '新增成本項目'}\r\n                size=\"lg\"\r\n            >\r\n                <div className=\"space-y-4\">\r\n                    <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\r\n                        <div>\r\n                            <label className=\"block text-sm font-medium text-gray-700 mb-1\">專案 *</label>\r\n                            <select\r\n                                value={formData.projectId}\r\n                                onChange={(e) => setFormData(prev => ({ ...prev, projectId: e.target.value }))}\r\n                                className=\"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500\"\r\n                            >\r\n                                <option value=\"\">選擇專案</option>\r\n                                {projects.map(p => (\r\n                                    <option key={p.id} value={p.id}>{p.name}</option>\r\n                                ))}\r\n                            </select>\r\n                        </div>\r\n                        <InputField\r\n                            label=\"日期\"\r\n                            type=\"date\"\r\n                            value={formData.date}\r\n                            onChange={(e) => setFormData(prev => ({ ...prev, date: e.target.value }))}\r\n                        />\r\n                    </div>\r\n\r\n                    <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\r\n                        <div>\r\n                            <label className=\"block text-sm font-medium text-gray-700 mb-1\">類別</label>\r\n                            <select\r\n                                value={formData.category}\r\n                                onChange={(e) => setFormData(prev => ({ ...prev, category: e.target.value }))}\r\n                                className=\"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500\"\r\n                            >\r\n                                {Object.entries(CATEGORY_CONFIG).map(([key, config]) => (\r\n                                    <option key={key} value={key}>{config.label}</option>\r\n                                ))}\r\n                            </select>\r\n                        </div>\r\n                        <InputField\r\n                            label=\"金額 *\"\r\n                            type=\"number\"\r\n                            value={formData.amount}\r\n                            onChange={(e) => setFormData(prev => ({ ...prev, amount: e.target.value }))}\r\n                            placeholder=\"輸入金額\"\r\n                        />\r\n                    </div>\r\n\r\n                    <InputField\r\n                        label=\"說明 *\"\r\n                        value={formData.description}\r\n                        onChange={(e) => setFormData(prev => ({ ...prev, description: e.target.value }))}\r\n                        placeholder=\"成本項目說明\"\r\n                    />\r\n\r\n                    <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\r\n                        <div>\r\n                            <label className=\"block text-sm font-medium text-gray-700 mb-1\">廠商</label>\r\n                            <select\r\n                                value={formData.vendorId}\r\n                                onChange={(e) => {\r\n                                    const vendor = vendors.find(v => v.id === e.target.value);\r\n                                    setFormData(prev => ({\r\n                                        ...prev,\r\n                                        vendorId: e.target.value,\r\n                                        vendorName: vendor?.name || '',\r\n                                    }));\r\n                                }}\r\n                                className=\"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500\"\r\n                            >\r\n                                <option value=\"\">選擇廠商</option>\r\n                                {vendors.map(v => (\r\n                                    <option key={v.id} value={v.id}>{v.name}</option>\r\n                                ))}\r\n                            </select>\r\n                        </div>\r\n                        <InputField\r\n                            label=\"發票號碼\"\r\n                            value={formData.invoiceNo}\r\n                            onChange={(e) => setFormData(prev => ({ ...prev, invoiceNo: e.target.value }))}\r\n                            placeholder=\"選填\"\r\n                        />\r\n                    </div>\r\n\r\n                    <InputField\r\n                        label=\"備註\"\r\n                        value={formData.notes}\r\n                        onChange={(e) => setFormData(prev => ({ ...prev, notes: e.target.value }))}\r\n                        placeholder=\"其他備註\"\r\n                        multiline\r\n                    />\r\n\r\n                    <div className=\"flex justify-end gap-3 pt-4 border-t\">\r\n                        <button\r\n                            onClick={() => setShowAddModal(false)}\r\n                            className=\"px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg transition-colors\"\r\n                        >\r\n                            取消\r\n                        </button>\r\n                        <button\r\n                            onClick={handleSave}\r\n                            className=\"px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors flex items-center gap-2\"\r\n                        >\r\n                            <Save className=\"w-4 h-4\" />\r\n                            {editingEntry ? '更新' : '新增'}\r\n                        </button>\r\n                    </div>\r\n                </div>\r\n            </Modal>\r\n\r\n            {/* 刪除確認 Modal */}\r\n            <Modal\r\n                isOpen={showDeleteModal}\r\n                onClose={() => setShowDeleteModal(false)}\r\n                title=\"確認刪除\"\r\n                size=\"sm\"\r\n            >\r\n                <div className=\"space-y-4\">\r\n                    <p className=\"text-gray-600\">\r\n                        確定要刪除成本項目「{entryToDelete?.description}」嗎？此操作無法復原。\r\n                    </p>\r\n                    <div className=\"flex justify-end gap-3\">\r\n                        <button\r\n                            onClick={() => setShowDeleteModal(false)}\r\n                            className=\"px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg\"\r\n                        >\r\n                            取消\r\n                        </button>\r\n                        <button\r\n                            onClick={handleDelete}\r\n                            className=\"px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 flex items-center gap-2\"\r\n                        >\r\n                            <Trash2 className=\"w-4 h-4\" />\r\n                            確認刪除\r\n                        </button>\r\n                    </div>\r\n                </div>\r\n            </Modal>\r\n        </div>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\xiang\\senteng-frontend\\src\\pages\\CostEstimator.jsx","messages":[{"ruleId":"no-unused-vars","severity":2,"message":"'useEffect' is defined but never used. Allowed unused vars must match /^[A-Z_]|^_/u.","line":2,"column":27,"nodeType":"Identifier","messageId":"unusedVar","endLine":2,"endColumn":36,"suggestions":[{"messageId":"removeVar","data":{"varName":"useEffect"},"fix":{"range":[26,37],"text":""},"desc":"Remove unused variable 'useEffect'."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\r\nimport React, { useState, useEffect } from 'react';\r\nimport { Calculator, FolderPlus, RefreshCw, Plus, Trash2, Save, DollarSign, Package, Paintbrush, Hammer, Wrench, Layers, GlassWater, Info, Edit2, X, Check, FileSpreadsheet, ExternalLink } from 'lucide-react';\r\nimport { SectionTitle } from '../components/common/Indicators';\r\nimport { GoogleService } from '../services/GoogleService';\r\n\r\n// 預設物料資料（離線時使用）\r\nconst DEFAULT_MATERIALS = {\r\n    '油漆': [\r\n        { id: 1, name: '乳膠漆', spec: '5加侖桶', unit: '加侖', price: 1200, note: '每坪用量約0.5加侖' },\r\n        { id: 2, name: '防水漆', spec: '5加侖桶', unit: '加侖', price: 1800, note: '浴室/屋頂用' },\r\n        { id: 3, name: '油性漆', spec: '加侖', unit: '加侖', price: 600, note: '金屬/木作' },\r\n    ],\r\n    '木作': [\r\n        { id: 4, name: '木芯板', spec: '4x8呎', unit: '片', price: 800, note: '36才/片' },\r\n        { id: 5, name: '夾板', spec: '4x8呎', unit: '片', price: 450, note: '18mm厚' },\r\n        { id: 6, name: '角材', spec: '1.2x1.2寸', unit: '支', price: 35, note: '12尺長' },\r\n        { id: 7, name: '系統櫃', spec: '含五金', unit: '尺', price: 3500, note: '連工帶料' },\r\n    ],\r\n    '泥作': [\r\n        { id: 8, name: '水泥', spec: '50kg/包', unit: '包', price: 180, note: '台泥' },\r\n        { id: 9, name: '砂', spec: '立方', unit: '立方', price: 1200, note: '河砂' },\r\n        { id: 10, name: '磁磚', spec: '60x60cm', unit: '坪', price: 2500, note: '含工資' },\r\n        { id: 11, name: '拋光石英磚', spec: '80x80cm', unit: '坪', price: 4500, note: '含工資' },\r\n    ],\r\n    '水電': [\r\n        { id: 12, name: '電線', spec: '2.0mm', unit: '尺', price: 8, note: '單芯線' },\r\n        { id: 13, name: 'PVC管', spec: '3/4吋', unit: '支', price: 45, note: '4米長' },\r\n        { id: 14, name: '開關插座', spec: '國際牌', unit: '組', price: 150, note: '含安裝' },\r\n        { id: 15, name: '馬桶', spec: '二段式', unit: '組', price: 8000, note: '含安裝' },\r\n    ],\r\n    '玻璃': [\r\n        { id: 16, name: '清玻璃', spec: '5mm', unit: '才', price: 35, note: '一般隔間' },\r\n        { id: 17, name: '強化玻璃', spec: '10mm', unit: '才', price: 85, note: '淋浴間' },\r\n        { id: 18, name: '膠合玻璃', spec: '5+5mm', unit: '才', price: 120, note: '安全玻璃' },\r\n    ],\r\n    '地板': [\r\n        { id: 19, name: '超耐磨地板', spec: '卡扣式', unit: '坪', price: 3500, note: '含安裝' },\r\n        { id: 20, name: 'SPC地板', spec: '卡扣式', unit: '坪', price: 2800, note: '防水' },\r\n        { id: 21, name: '實木地板', spec: '海島型', unit: '坪', price: 6500, note: '含安裝' },\r\n    ],\r\n};\r\n\r\n// 類別圖示映射\r\nconst CATEGORY_ICONS = {\r\n    '油漆': Paintbrush,\r\n    '木作': Hammer,\r\n    '泥作': Layers,\r\n    '水電': Wrench,\r\n    '玻璃': GlassWater,\r\n    '地板': Package,\r\n};\r\n\r\n// 格式化金額\r\nconst formatCurrency = (amount) => {\r\n    return new Intl.NumberFormat('zh-TW', {\r\n        style: 'currency',\r\n        currency: 'TWD',\r\n        minimumFractionDigits: 0,\r\n        maximumFractionDigits: 0\r\n    }).format(amount);\r\n};\r\n\r\nexport const CostEstimator = ({ addToast }) => {\r\n    // 狀態\r\n    const [materials, setMaterials] = useState(DEFAULT_MATERIALS);\r\n    const [selectedCategory, setSelectedCategory] = useState('油漆');\r\n    const [estimateItems, setEstimateItems] = useState([]);\r\n    const [isLoading, setIsLoading] = useState(false);\r\n    const [driveFolder, setDriveFolder] = useState(null);\r\n    const [isInitializing, setIsInitializing] = useState(false);\r\n    const [isExporting, setIsExporting] = useState(false);\r\n    const [exportedSheet, setExportedSheet] = useState(null);\r\n    const [estimateName, setEstimateName] = useState('');\r\n\r\n    // 編輯物料狀態\r\n    const [editingMaterial, setEditingMaterial] = useState(null);\r\n    const [editForm, setEditForm] = useState({ name: '', spec: '', unit: '', price: 0, note: '' });\r\n\r\n    // 計算總價\r\n    const totalCost = estimateItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);\r\n\r\n    // 新增估算項目\r\n    const addEstimateItem = (material) => {\r\n        const existing = estimateItems.find(item => item.id === material.id);\r\n        if (existing) {\r\n            setEstimateItems(items =>\r\n                items.map(item =>\r\n                    item.id === material.id\r\n                        ? { ...item, quantity: item.quantity + 1 }\r\n                        : item\r\n                )\r\n            );\r\n        } else {\r\n            setEstimateItems([...estimateItems, { ...material, quantity: 1 }]);\r\n        }\r\n        addToast?.(`已加入 ${material.name}`, 'success');\r\n    };\r\n\r\n    // 更新數量\r\n    const updateQuantity = (id, quantity) => {\r\n        if (quantity <= 0) {\r\n            setEstimateItems(items => items.filter(item => item.id !== id));\r\n        } else {\r\n            setEstimateItems(items =>\r\n                items.map(item =>\r\n                    item.id === id ? { ...item, quantity } : item\r\n                )\r\n            );\r\n        }\r\n    };\r\n\r\n    // 移除項目\r\n    const removeItem = (id) => {\r\n        setEstimateItems(items => items.filter(item => item.id !== id));\r\n    };\r\n\r\n    // 清空估算\r\n    const clearEstimate = () => {\r\n        setEstimateItems([]);\r\n        addToast?.('已清空估算清單', 'info');\r\n    };\r\n\r\n    // 初始化 Drive 資料夾\r\n    const initializeDriveFolder = async () => {\r\n        setIsInitializing(true);\r\n        try {\r\n            const result = await GoogleService.createCostEstimatorFolder();\r\n            if (result.success) {\r\n                setDriveFolder(result);\r\n                addToast?.('已建立 Drive 資料夾及資料庫', 'success');\r\n            } else {\r\n                addToast?.(result.error || '建立失敗', 'error');\r\n            }\r\n        } catch (error) {\r\n            console.error('Initialize folder error:', error);\r\n            addToast?.('初始化失敗：' + error.message, 'error');\r\n        } finally {\r\n            setIsInitializing(false);\r\n        }\r\n    };\r\n\r\n    // 從 Drive 載入物料資料\r\n    const loadMaterialsFromDrive = async () => {\r\n        setIsLoading(true);\r\n        try {\r\n            const result = await GoogleService.getMaterialPrices();\r\n            if (result.success && result.data?.materials) {\r\n                setMaterials(result.data.materials);\r\n                addToast?.('已從 Drive 載入物料資料', 'success');\r\n            } else {\r\n                // 使用預設資料\r\n                addToast?.('使用本機預設資料', 'info');\r\n            }\r\n        } catch (error) {\r\n            console.error('Load materials error:', error);\r\n            addToast?.('載入失敗，使用本機資料', 'warning');\r\n        } finally {\r\n            setIsLoading(false);\r\n        }\r\n    };\r\n\r\n    // 開始編輯物料\r\n    const startEditMaterial = (material) => {\r\n        setEditingMaterial(material.id);\r\n        setEditForm({ ...material });\r\n    };\r\n\r\n    // 儲存編輯\r\n    const saveEditMaterial = async () => {\r\n        setMaterials(prev => ({\r\n            ...prev,\r\n            [selectedCategory]: prev[selectedCategory].map(m =>\r\n                m.id === editingMaterial ? { ...m, ...editForm, price: parseFloat(editForm.price) } : m\r\n            )\r\n        }));\r\n        setEditingMaterial(null);\r\n        addToast?.('已更新物料價格', 'success');\r\n\r\n        // 同步到 Drive（背景執行）\r\n        GoogleService.updateMaterialPrice(selectedCategory, editForm).catch(console.error);\r\n    };\r\n\r\n    // 取消編輯\r\n    const cancelEdit = () => {\r\n        setEditingMaterial(null);\r\n        setEditForm({ name: '', spec: '', unit: '', price: 0, note: '' });\r\n    };\r\n\r\n    // 匯出估算清單到 Google Sheet\r\n    const exportToSheet = async () => {\r\n        if (estimateItems.length === 0) {\r\n            addToast?.('請先加入估算項目', 'warning');\r\n            return;\r\n        }\r\n\r\n        const name = estimateName.trim() || `估算清單_${new Date().toLocaleDateString('zh-TW').replace(/\\//g, '-')}`;\r\n\r\n        setIsExporting(true);\r\n        try {\r\n            // 為每個項目添加類別資訊\r\n            const itemsWithCategory = estimateItems.map(item => {\r\n                // 找出這個物料屬於哪個類別\r\n                let itemCategory = '未分類';\r\n                for (const [cat, mats] of Object.entries(materials)) {\r\n                    if (mats.some(m => m.id === item.id)) {\r\n                        itemCategory = cat;\r\n                        break;\r\n                    }\r\n                }\r\n                return { ...item, category: itemCategory };\r\n            });\r\n\r\n            const result = await GoogleService.exportEstimateToSheet(name, itemsWithCategory, totalCost);\r\n\r\n            if (result.success) {\r\n                setExportedSheet(result);\r\n                addToast?.('已匯出到 Google Sheet！', 'success', {\r\n                    action: {\r\n                        label: '開啟 Sheet',\r\n                        onClick: () => window.open(result.sheetUrl, '_blank')\r\n                    }\r\n                });\r\n            } else {\r\n                addToast?.(result.error || '匯出失敗', 'error');\r\n            }\r\n        } catch (error) {\r\n            console.error('Export error:', error);\r\n            addToast?.('匯出失敗：' + error.message, 'error');\r\n        } finally {\r\n            setIsExporting(false);\r\n        }\r\n    };\r\n\r\n    const categories = Object.keys(materials);\r\n    const currentMaterials = materials[selectedCategory] || [];\r\n\r\n    return (\r\n        <div className=\"space-y-6 animate-fade-in\">\r\n            <SectionTitle title=\"營建物料成本快速估算\" />\r\n\r\n            {/* 說明區 */}\r\n            <div className=\"bg-orange-50 border border-orange-200 rounded-2xl p-4 flex gap-3\">\r\n                <Info size={20} className=\"text-orange-500 flex-shrink-0 mt-0.5\" />\r\n                <div className=\"text-sm text-orange-800\">\r\n                    <p className=\"font-medium mb-1\">快速估算材料成本</p>\r\n                    <p className=\"text-orange-600\">選擇物料類別，點擊加入估算清單，系統將自動計算總價。可連結 Google Drive 同步物料資料庫。</p>\r\n                </div>\r\n            </div>\r\n\r\n            <div className=\"grid grid-cols-1 lg:grid-cols-3 gap-6\">\r\n                {/* 左側：類別選擇與物料列表 */}\r\n                <div className=\"lg:col-span-2 space-y-4\">\r\n                    {/* 類別選擇 */}\r\n                    <div className=\"bg-white rounded-2xl p-5 shadow-sm border border-gray-100\">\r\n                        <div className=\"flex justify-between items-center mb-4\">\r\n                            <label className=\"text-sm font-medium text-gray-700\">物料類別</label>\r\n                            <div className=\"flex gap-2\">\r\n                                <button\r\n                                    onClick={loadMaterialsFromDrive}\r\n                                    disabled={isLoading}\r\n                                    className=\"flex items-center gap-1 px-3 py-1.5 text-xs bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors disabled:opacity-50\"\r\n                                >\r\n                                    <RefreshCw size={14} className={isLoading ? 'animate-spin' : ''} />\r\n                                    同步\r\n                                </button>\r\n                                <button\r\n                                    onClick={initializeDriveFolder}\r\n                                    disabled={isInitializing}\r\n                                    className=\"flex items-center gap-1 px-3 py-1.5 text-xs bg-orange-100 text-orange-700 hover:bg-orange-200 rounded-lg transition-colors disabled:opacity-50\"\r\n                                >\r\n                                    <FolderPlus size={14} />\r\n                                    {isInitializing ? '建立中...' : '初始化資料庫'}\r\n                                </button>\r\n                            </div>\r\n                        </div>\r\n\r\n                        <div className=\"grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-6 gap-2\">\r\n                            {categories.map(category => {\r\n                                const Icon = CATEGORY_ICONS[category] || Package;\r\n                                return (\r\n                                    <button\r\n                                        key={category}\r\n                                        onClick={() => setSelectedCategory(category)}\r\n                                        className={`p-3 rounded-xl border-2 transition-all flex flex-col items-center gap-1 ${selectedCategory === category\r\n                                            ? 'border-orange-500 bg-orange-50 text-orange-700'\r\n                                            : 'border-gray-200 hover:border-gray-300'\r\n                                            }`}\r\n                                    >\r\n                                        <Icon size={20} />\r\n                                        <span className=\"font-medium text-xs\">{category}</span>\r\n                                    </button>\r\n                                );\r\n                            })}\r\n                        </div>\r\n                    </div>\r\n\r\n                    {/* 物料列表 */}\r\n                    <div className=\"bg-white rounded-2xl p-5 shadow-sm border border-gray-100\">\r\n                        <h4 className=\"font-bold text-gray-800 mb-4 flex items-center gap-2\">\r\n                            {React.createElement(CATEGORY_ICONS[selectedCategory] || Package, { size: 20 })}\r\n                            {selectedCategory}物料價格表\r\n                        </h4>\r\n\r\n                        <div className=\"overflow-x-auto\">\r\n                            <table className=\"w-full text-sm\">\r\n                                <thead>\r\n                                    <tr className=\"border-b border-gray-200\">\r\n                                        <th className=\"text-left py-2 px-2 font-medium text-gray-600\">名稱</th>\r\n                                        <th className=\"text-left py-2 px-2 font-medium text-gray-600\">規格</th>\r\n                                        <th className=\"text-right py-2 px-2 font-medium text-gray-600\">單位</th>\r\n                                        <th className=\"text-right py-2 px-2 font-medium text-gray-600\">單價</th>\r\n                                        <th className=\"text-center py-2 px-2 font-medium text-gray-600\">操作</th>\r\n                                    </tr>\r\n                                </thead>\r\n                                <tbody>\r\n                                    {currentMaterials.map(material => (\r\n                                        <tr key={material.id} className=\"border-b border-gray-100 hover:bg-gray-50\">\r\n                                            {editingMaterial === material.id ? (\r\n                                                <>\r\n                                                    <td className=\"py-2 px-2\">\r\n                                                        <input\r\n                                                            type=\"text\"\r\n                                                            value={editForm.name}\r\n                                                            onChange={(e) => setEditForm({ ...editForm, name: e.target.value })}\r\n                                                            className=\"w-full px-2 py-1 border rounded text-sm\"\r\n                                                        />\r\n                                                    </td>\r\n                                                    <td className=\"py-2 px-2\">\r\n                                                        <input\r\n                                                            type=\"text\"\r\n                                                            value={editForm.spec}\r\n                                                            onChange={(e) => setEditForm({ ...editForm, spec: e.target.value })}\r\n                                                            className=\"w-full px-2 py-1 border rounded text-sm\"\r\n                                                        />\r\n                                                    </td>\r\n                                                    <td className=\"py-2 px-2 text-right\">\r\n                                                        <input\r\n                                                            type=\"text\"\r\n                                                            value={editForm.unit}\r\n                                                            onChange={(e) => setEditForm({ ...editForm, unit: e.target.value })}\r\n                                                            className=\"w-16 px-2 py-1 border rounded text-sm text-right\"\r\n                                                        />\r\n                                                    </td>\r\n                                                    <td className=\"py-2 px-2 text-right\">\r\n                                                        <input\r\n                                                            type=\"number\"\r\n                                                            value={editForm.price}\r\n                                                            onChange={(e) => setEditForm({ ...editForm, price: e.target.value })}\r\n                                                            className=\"w-20 px-2 py-1 border rounded text-sm text-right\"\r\n                                                        />\r\n                                                    </td>\r\n                                                    <td className=\"py-2 px-2 text-center\">\r\n                                                        <div className=\"flex justify-center gap-1\">\r\n                                                            <button onClick={saveEditMaterial} className=\"p-1 text-green-600 hover:bg-green-100 rounded\">\r\n                                                                <Check size={16} />\r\n                                                            </button>\r\n                                                            <button onClick={cancelEdit} className=\"p-1 text-red-600 hover:bg-red-100 rounded\">\r\n                                                                <X size={16} />\r\n                                                            </button>\r\n                                                        </div>\r\n                                                    </td>\r\n                                                </>\r\n                                            ) : (\r\n                                                <>\r\n                                                    <td className=\"py-2 px-2 font-medium\">{material.name}</td>\r\n                                                    <td className=\"py-2 px-2 text-gray-500\">{material.spec}</td>\r\n                                                    <td className=\"py-2 px-2 text-right text-gray-500\">{material.unit}</td>\r\n                                                    <td className=\"py-2 px-2 text-right font-bold text-orange-600\">\r\n                                                        {formatCurrency(material.price)}\r\n                                                    </td>\r\n                                                    <td className=\"py-2 px-2 text-center\">\r\n                                                        <div className=\"flex justify-center gap-1\">\r\n                                                            <button\r\n                                                                onClick={() => addEstimateItem(material)}\r\n                                                                className=\"p-1.5 bg-orange-100 text-orange-600 hover:bg-orange-200 rounded-lg transition-colors\"\r\n                                                                title=\"加入估算\"\r\n                                                            >\r\n                                                                <Plus size={16} />\r\n                                                            </button>\r\n                                                            <button\r\n                                                                onClick={() => startEditMaterial(material)}\r\n                                                                className=\"p-1.5 bg-gray-100 text-gray-600 hover:bg-gray-200 rounded-lg transition-colors\"\r\n                                                                title=\"編輯價格\"\r\n                                                            >\r\n                                                                <Edit2 size={16} />\r\n                                                            </button>\r\n                                                        </div>\r\n                                                    </td>\r\n                                                </>\r\n                                            )}\r\n                                        </tr>\r\n                                    ))}\r\n                                </tbody>\r\n                            </table>\r\n                        </div>\r\n\r\n                        {currentMaterials.length > 0 && currentMaterials[0].note && (\r\n                            <div className=\"mt-3 p-3 bg-gray-50 rounded-lg text-xs text-gray-500\">\r\n                                <strong>備註：</strong>\r\n                                {currentMaterials.map((m, i) => (\r\n                                    <span key={m.id}>\r\n                                        {m.name}: {m.note}{i < currentMaterials.length - 1 ? ' | ' : ''}\r\n                                    </span>\r\n                                ))}\r\n                            </div>\r\n                        )}\r\n                    </div>\r\n                </div>\r\n\r\n                {/* 右側：估算清單與總計 */}\r\n                <div className=\"space-y-4\">\r\n                    {/* 估算清單 */}\r\n                    <div className=\"bg-gradient-to-br from-orange-600 to-orange-800 rounded-2xl p-5 text-white\">\r\n                        <div className=\"flex justify-between items-center mb-4\">\r\n                            <span className=\"font-bold flex items-center gap-2\">\r\n                                <Calculator size={20} />\r\n                                估算清單\r\n                            </span>\r\n                            {estimateItems.length > 0 && (\r\n                                <button\r\n                                    onClick={clearEstimate}\r\n                                    className=\"text-xs bg-white/20 hover:bg-white/30 px-2 py-1 rounded transition-colors\"\r\n                                >\r\n                                    清空\r\n                                </button>\r\n                            )}\r\n                        </div>\r\n\r\n                        {estimateItems.length === 0 ? (\r\n                            <div className=\"text-center py-8 text-orange-200\">\r\n                                <Package size={40} className=\"mx-auto mb-2 opacity-50\" />\r\n                                <p className=\"text-sm\">點擊物料 + 加入估算</p>\r\n                            </div>\r\n                        ) : (\r\n                            <div className=\"space-y-2 max-h-[400px] overflow-y-auto\">\r\n                                {estimateItems.map(item => (\r\n                                    <div key={item.id} className=\"flex items-center justify-between py-2 border-b border-white/20 last:border-0\">\r\n                                        <div className=\"flex-1\">\r\n                                            <div className=\"font-medium text-sm\">{item.name}</div>\r\n                                            <div className=\"text-xs text-orange-200\">\r\n                                                {formatCurrency(item.price)} / {item.unit}\r\n                                            </div>\r\n                                        </div>\r\n                                        <div className=\"flex items-center gap-2\">\r\n                                            <button\r\n                                                onClick={() => updateQuantity(item.id, item.quantity - 1)}\r\n                                                className=\"w-6 h-6 bg-white/20 hover:bg-white/30 rounded text-sm\"\r\n                                            >\r\n                                                -\r\n                                            </button>\r\n                                            <input\r\n                                                type=\"number\"\r\n                                                value={item.quantity}\r\n                                                onChange={(e) => updateQuantity(item.id, parseFloat(e.target.value) || 0)}\r\n                                                className=\"w-14 text-center bg-white/20 rounded py-1 text-sm\"\r\n                                            />\r\n                                            <button\r\n                                                onClick={() => updateQuantity(item.id, item.quantity + 1)}\r\n                                                className=\"w-6 h-6 bg-white/20 hover:bg-white/30 rounded text-sm\"\r\n                                            >\r\n                                                +\r\n                                            </button>\r\n                                            <button\r\n                                                onClick={() => removeItem(item.id)}\r\n                                                className=\"p-1 hover:bg-white/20 rounded text-red-300\"\r\n                                            >\r\n                                                <Trash2 size={14} />\r\n                                            </button>\r\n                                        </div>\r\n                                    </div>\r\n                                ))}\r\n                            </div>\r\n                        )}\r\n\r\n                        {/* 小計 */}\r\n                        {estimateItems.length > 0 && (\r\n                            <div className=\"mt-4 pt-4 border-t border-white/30\">\r\n                                {estimateItems.map(item => (\r\n                                    <div key={item.id} className=\"flex justify-between text-sm text-orange-100 mb-1\">\r\n                                        <span>{item.name} × {item.quantity}</span>\r\n                                        <span>{formatCurrency(item.price * item.quantity)}</span>\r\n                                    </div>\r\n                                ))}\r\n                            </div>\r\n                        )}\r\n                    </div>\r\n\r\n                    {/* 總計 */}\r\n                    <div className=\"bg-white rounded-2xl p-5 shadow-sm border border-gray-100\">\r\n                        <div className=\"flex justify-between items-center mb-2\">\r\n                            <span className=\"text-gray-600\">材料總計</span>\r\n                            <span className=\"text-3xl font-bold text-orange-600\">\r\n                                {formatCurrency(totalCost)}\r\n                            </span>\r\n                        </div>\r\n                        <div className=\"text-xs text-gray-400 text-right\">\r\n                            共 {estimateItems.length} 項材料\r\n                        </div>\r\n\r\n                        {/* 快速估算 */}\r\n                        <div className=\"mt-4 pt-4 border-t border-gray-100\">\r\n                            <div className=\"text-sm font-medium text-gray-700 mb-2\">快速估算（含工資）</div>\r\n                            <div className=\"space-y-1 text-sm text-gray-600\">\r\n                                <div className=\"flex justify-between\">\r\n                                    <span>+工資（約30%）</span>\r\n                                    <span>{formatCurrency(totalCost * 0.3)}</span>\r\n                                </div>\r\n                                <div className=\"flex justify-between\">\r\n                                    <span>+管理費（約10%）</span>\r\n                                    <span>{formatCurrency(totalCost * 0.1)}</span>\r\n                                </div>\r\n                                <div className=\"flex justify-between font-bold text-gray-800 pt-2 border-t\">\r\n                                    <span>預估總價</span>\r\n                                    <span className=\"text-orange-600\">{formatCurrency(totalCost * 1.4)}</span>\r\n                                </div>\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n\r\n                    {/* Drive 資料夾連結 */}\r\n                    {driveFolder && (\r\n                        <div className=\"bg-green-50 border border-green-200 rounded-xl p-4\">\r\n                            <div className=\"text-sm font-medium text-green-800 mb-1\">資料庫已同步</div>\r\n                            <a\r\n                                href={driveFolder.url}\r\n                                target=\"_blank\"\r\n                                rel=\"noopener noreferrer\"\r\n                                className=\"text-xs text-green-600 hover:underline\"\r\n                            >\r\n                                開啟 Google Drive 資料夾 →\r\n                            </a>\r\n                        </div>\r\n                    )}\r\n\r\n                    {/* 匯出到 Google Sheet */}\r\n                    {estimateItems.length > 0 && (\r\n                        <div className=\"bg-blue-50 border border-blue-200 rounded-2xl p-4\">\r\n                            <div className=\"flex items-center gap-2 mb-3\">\r\n                                <FileSpreadsheet size={18} className=\"text-blue-600\" />\r\n                                <span className=\"font-medium text-blue-800\">匯出估算清單到 Google Sheet</span>\r\n                            </div>\r\n                            <div className=\"space-y-3\">\r\n                                <input\r\n                                    type=\"text\"\r\n                                    value={estimateName}\r\n                                    onChange={(e) => setEstimateName(e.target.value)}\r\n                                    placeholder=\"輸入估算清單名稱（選填）\"\r\n                                    className=\"w-full px-3 py-2 rounded-lg border border-blue-200 text-sm focus:outline-none focus:ring-2 focus:ring-blue-300\"\r\n                                />\r\n                                <button\r\n                                    onClick={exportToSheet}\r\n                                    disabled={isExporting}\r\n                                    className=\"w-full bg-blue-600 hover:bg-blue-700 text-white py-2.5 rounded-lg text-sm font-medium transition-colors flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed\"\r\n                                >\r\n                                    {isExporting ? (\r\n                                        <>\r\n                                            <RefreshCw size={16} className=\"animate-spin\" />\r\n                                            匯出中...\r\n                                        </>\r\n                                    ) : (\r\n                                        <>\r\n                                            <FileSpreadsheet size={16} />\r\n                                            匯出到 Google Sheet\r\n                                        </>\r\n                                    )}\r\n                                </button>\r\n                            </div>\r\n\r\n                            {/* 已匯出的 Sheet 連結 */}\r\n                            {exportedSheet && (\r\n                                <div className=\"mt-3 pt-3 border-t border-blue-200\">\r\n                                    <a\r\n                                        href={exportedSheet.sheetUrl}\r\n                                        target=\"_blank\"\r\n                                        rel=\"noopener noreferrer\"\r\n                                        className=\"text-sm text-blue-600 hover:text-blue-800 flex items-center gap-1\"\r\n                                    >\r\n                                        <ExternalLink size={14} />\r\n                                        開啟已匯出的 Sheet\r\n                                    </a>\r\n                                </div>\r\n                            )}\r\n                        </div>\r\n                    )}\r\n                </div>\r\n            </div>\r\n\r\n            {/* 估算公式說明 */}\r\n            <div className=\"bg-gray-50 rounded-2xl p-5\">\r\n                <h4 className=\"font-bold text-gray-800 mb-3\">常用估算公式</h4>\r\n                <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4 text-sm\">\r\n                    <div className=\"bg-white p-3 rounded-xl\">\r\n                        <div className=\"font-medium text-gray-700 mb-1\">🎨 油漆用量</div>\r\n                        <div className=\"text-gray-500\">面積(坪) × 0.5 = 用量(加侖)</div>\r\n                    </div>\r\n                    <div className=\"bg-white p-3 rounded-xl\">\r\n                        <div className=\"font-medium text-gray-700 mb-1\">🪵 木作板材</div>\r\n                        <div className=\"text-gray-500\">面積(才) ÷ 36 = 需要片數</div>\r\n                    </div>\r\n                    <div className=\"bg-white p-3 rounded-xl\">\r\n                        <div className=\"font-medium text-gray-700 mb-1\">🧱 磁磚損耗</div>\r\n                        <div className=\"text-gray-500\">面積(坪) × 1.1 = 含損耗量</div>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n        </div>\r\n    );\r\n};\r\n\r\nexport default CostEstimator;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\xiang\\senteng-frontend\\src\\pages\\Dashboard.jsx","messages":[{"ruleId":"no-unused-vars","severity":2,"message":"'i' is defined but never used. Allowed unused args must match /^_|^e$|^err$|^event$/u.","line":22,"column":33,"nodeType":"Identifier","messageId":"unusedVar","endLine":22,"endColumn":34,"suggestions":[{"messageId":"removeVar","data":{"varName":"i"},"fix":{"range":[1136,1139],"text":""},"desc":"Remove unused variable 'i'."}]},{"ruleId":"no-unused-vars","severity":2,"message":"'i' is defined but never used. Allowed unused args must match /^_|^e$|^err$|^event$/u.","line":23,"column":33,"nodeType":"Identifier","messageId":"unusedVar","endLine":23,"endColumn":34,"suggestions":[{"messageId":"removeVar","data":{"varName":"i"},"fix":{"range":[1180,1183],"text":""},"desc":"Remove unused variable 'i'."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\r\nimport React, { useState } from 'react';\r\nimport { WidgetWrapper } from '../components/common/WidgetWrapper';\r\nimport { WidgetDailySchedule, WidgetMemo, WidgetOverviewStats, WidgetRecentActivity } from '../components/widgets/DashboardWidgets';\r\n\r\nconst Dashboard = ({ events, finance, projects, clients }) => {\r\n    // Check if user has name, otherwise default\r\n    const userName = \"打工人\";\r\n    const dateStr = new Date().toLocaleDateString('zh-TW', { year: 'numeric', month: 'long', day: 'numeric' });\r\n\r\n    const [widgets, setWidgets] = useState([\r\n        { id: 'wd-stats', type: 'stats', title: '營運總覽', size: 'L' },\r\n        { id: 'wd-schedule', type: 'schedule', title: '今日行程', size: 'M' },\r\n        { id: 'wd-activity', type: 'activity', title: '最新動態', size: 'M' },\r\n        { id: 'wd-memo', type: 'memo', title: '便利貼', size: 'S' },\r\n        { id: 'wd-income', type: 'income_stat', title: '本月營收', size: 'S' } // Additional small stat\r\n    ]);\r\n\r\n    const handleResize = (id, size) => setWidgets(prev => prev.map(w => w.id === id ? { ...w, size } : w));\r\n\r\n    // Drag and drop logic placeholder\r\n    const handleDragStart = (e, i) => { };\r\n    const handleDragEnter = (e, i) => { };\r\n    const handleDragEnd = () => { };\r\n\r\n    return (\r\n        <div className=\"space-y-4 sm:space-y-6 animate-fade-in relative z-0\">\r\n            <div className=\"mb-6 sm:mb-8 flex justify-between items-end\">\r\n                <div>\r\n                    <h1 className=\"text-2xl sm:text-3xl font-bold text-morandi-text-primary\">早安，{userName}</h1>\r\n                    <p className=\"text-sm sm:text-base text-morandi-text-secondary\">今天是 {dateStr}</p>\r\n                </div>\r\n                {/* Optional: Add a quick action button here if needed */}\r\n            </div>\r\n\r\n            <div className=\"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 sm:gap-6 auto-rows-auto\">\r\n                {widgets.map((w, i) => (\r\n                    <WidgetWrapper key={w.id} widget={w} onResize={handleResize}\r\n                        onDragStart={(e) => handleDragStart(e, i)}\r\n                        onDragEnter={(e) => handleDragEnter(e, i)}\r\n                        onDragEnd={handleDragEnd}\r\n                    >\r\n                        {w.type === 'schedule' && <WidgetDailySchedule events={events} size={w.size} />}\r\n                        {w.type === 'memo' && <WidgetMemo size={w.size} />}\r\n                        {w.type === 'stats' && <WidgetOverviewStats finance={finance} projects={projects} clients={clients} size={w.size} />}\r\n                        {w.type === 'income_stat' && <WidgetOverviewStats finance={finance} projects={projects} clients={clients} size=\"S\" />}\r\n                        {w.type === 'activity' && <WidgetRecentActivity size={w.size} />}\r\n                    </WidgetWrapper>\r\n                ))}\r\n            </div>\r\n        </div>\r\n    );\r\n};\r\nexport default Dashboard;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\xiang\\senteng-frontend\\src\\pages\\Finance.jsx","messages":[{"ruleId":"no-unused-vars","severity":2,"message":"'loading' is defined but never used. Allowed unused args must match /^_|^e$|^err$|^event$/u.","line":21,"column":26,"nodeType":"Identifier","messageId":"unusedVar","endLine":21,"endColumn":33,"suggestions":[{"messageId":"removeVar","data":{"varName":"loading"},"fix":{"range":[1053,1062],"text":""},"desc":"Remove unused variable 'loading'."}]},{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\n  25 |     // Sync accounts when data.accounts changes (from API/Sheet)\n  26 |     useEffect(() => {\n> 27 |         setAccounts(data.accounts || []);\n     |         ^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  28 |     }, [data.accounts]);\n  29 |\n  30 |     // Keep ref in sync with state for drag-drop","line":27,"column":9,"nodeType":null,"endLine":27,"endColumn":20},{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\n  48 |     // Sync loans when data.loans changes\n  49 |     useEffect(() => {\n> 50 |         setLoans(data.loans || []);\n     |         ^^^^^^^^ Avoid calling setState() directly within an effect\n  51 |     }, [data.loans]);\n  52 |\n  53 |     // Transaction Modal State","line":50,"column":9,"nodeType":null,"endLine":50,"endColumn":17},{"ruleId":"no-unused-vars","severity":2,"message":"'searchResults' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]|^_/u.","line":72,"column":12,"nodeType":"Identifier","messageId":"unusedVar","endLine":72,"endColumn":25,"suggestions":[{"messageId":"removeVar","data":{"varName":"searchResults"},"fix":{"range":[3310,3323],"text":""},"desc":"Remove unused variable 'searchResults'."}]},{"ruleId":"no-unused-vars","severity":2,"message":"'isSearching' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]|^_/u.","line":73,"column":12,"nodeType":"Identifier","messageId":"unusedVar","endLine":73,"endColumn":23,"suggestions":[{"messageId":"removeVar","data":{"varName":"isSearching"},"fix":{"range":[3371,3382],"text":""},"desc":"Remove unused variable 'isSearching'."}]},{"ruleId":"no-unused-vars","severity":2,"message":"'handleDeleteLoan' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]|^_/u.","line":195,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":195,"endColumn":27,"suggestions":[{"messageId":"removeVar","data":{"varName":"handleDeleteLoan"},"fix":{"range":[7849,7966],"text":""},"desc":"Remove unused variable 'handleDeleteLoan'."}]},{"ruleId":"no-unused-vars","severity":2,"message":"'handleSearchFinance' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]|^_/u.","line":249,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":249,"endColumn":30,"suggestions":[{"messageId":"removeVar","data":{"varName":"handleSearchFinance"},"fix":{"range":[9861,10294],"text":""},"desc":"Remove unused variable 'handleSearchFinance'."}]},{"ruleId":"no-case-declarations","severity":2,"message":"Unexpected lexical declaration in case block.","line":323,"column":17,"nodeType":"VariableDeclaration","messageId":"unexpected","endLine":323,"endColumn":125,"suggestions":[{"messageId":"addBrackets","fix":{"range":[13118,15246],"text":"{ const totalLoanAmount = loans.reduce((sum, l) => sum + (l.remainingPrincipal || l.principalAmount || 0), 0);\r\n                return (\r\n                    <div className=\"h-full flex flex-col\">\r\n                        <div className=\"flex justify-between items-center mb-3\">\r\n                            <div className=\"flex items-center gap-2\">\r\n                                <Building2 size={16} className=\"text-blue-600\" />\r\n                                <span className=\"text-sm text-gray-500\">\r\n                                    總貸款餘額: <span className=\"font-bold text-gray-800\">${totalLoanAmount.toLocaleString()}</span>\r\n                                </span>\r\n                            </div>\r\n                            <button onClick={openAddLoan} className=\"text-xs text-blue-600 hover:underline flex items-center gap-1\">\r\n                                <Plus size={12} /> 新增貸款\r\n                            </button>\r\n                        </div>\r\n                        <div className=\"flex-1 overflow-y-auto pr-1\">\r\n                            {loans.length === 0 ? (\r\n                                <div className=\"flex flex-col items-center justify-center h-32 text-gray-400\">\r\n                                    <Building2 size={32} className=\"mb-2 opacity-50\" />\r\n                                    <p className=\"text-sm\">尚無貸款帳戶</p>\r\n                                    <button onClick={openAddLoan} className=\"mt-2 text-xs text-blue-600 hover:underline\">新增貸款</button>\r\n                                </div>\r\n                            ) : (\r\n                                loans.map(loan => (\r\n                                    <LoanAccountCard\r\n                                        key={loan.id}\r\n                                        loan={loan}\r\n                                        onEdit={openEditLoan}\r\n                                        onRecordPayment={handleRecordLoanPayment}\r\n                                    />\r\n                                ))\r\n                            )}\r\n                        </div>\r\n                    </div>\r\n                ); }"},"desc":"Add {} brackets around the case block."}]}],"suppressedMessages":[],"errorCount":8,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\r\nimport React, { useState, useRef, useEffect } from 'react';\r\nimport { WidgetWrapper } from '../components/common/WidgetWrapper';\r\nimport { WidgetFinanceAccounts, WidgetFinanceTrend, WidgetFinanceTransactions } from '../components/widgets/FinanceWidgets';\r\nimport { AccountDetailsModal } from '../components/finance/AccountDetailsModal';\r\nimport { FinanceExportModal, FinanceSearchBar } from '../components/finance/FinanceExportModal';\r\nimport { LoanAccountCard } from '../components/finance/LoanAccountCard';\r\nimport { LoanAccountModal } from '../components/finance/LoanAccountModal';\r\nimport { Modal } from '../components/common/Modal';\r\nimport { InputField } from '../components/common/InputField';\r\nimport { SectionTitle } from '../components/common/Indicators';\r\nimport { Plus, Download, Search, Building2 } from 'lucide-react';\r\nimport { GoogleService } from '../services/GoogleService';\r\n\r\n// 收支類別選項\r\nconst TX_CATEGORIES = {\r\n    '收入': ['工程款', '設計費', '顧問費', '其他收入'],\r\n    '支出': ['材料費', '人工費', '設備費', '運輸費', '其他支出']\r\n};\r\n\r\nconst Finance = ({ data, loading, addToast, onAddTx, onUpdateAccounts, onUpdateLoans, allProjects = [] }) => {\r\n    const [accounts, setAccounts] = useState(data.accounts || []);\r\n    const accountsRef = useRef(accounts);\r\n\r\n    // Sync accounts when data.accounts changes (from API/Sheet)\r\n    useEffect(() => {\r\n        setAccounts(data.accounts || []);\r\n    }, [data.accounts]);\r\n\r\n    // Keep ref in sync with state for drag-drop\r\n    useEffect(() => {\r\n        accountsRef.current = accounts;\r\n    }, [accounts]);\r\n    const [widgets, setWidgets] = useState([\r\n        { id: 'wf-acc', type: 'finance-acc', title: '資金帳戶', size: 'L' },\r\n        { id: 'wf-loans', type: 'finance-loans', title: '貸款帳戶', size: 'L' },\r\n        { id: 'wf-trend', type: 'finance-trend', title: '收支趨勢', size: 'M' },\r\n        { id: 'wf-tx', type: 'finance-tx', title: '收支明細', size: 'L' }\r\n    ]);\r\n\r\n    // Loan State\r\n    const [loans, setLoans] = useState(data.loans || []);\r\n    const [isLoanModalOpen, setIsLoanModalOpen] = useState(false);\r\n    const [editingLoan, setEditingLoan] = useState(null);\r\n    const [isDeleteLoanModalOpen, setIsDeleteLoanModalOpen] = useState(false);\r\n    const [deletingLoan, setDeletingLoan] = useState(null);\r\n\r\n    // Sync loans when data.loans changes\r\n    useEffect(() => {\r\n        setLoans(data.loans || []);\r\n    }, [data.loans]);\r\n\r\n    // Transaction Modal State\r\n    const [isTxModalOpen, setIsTxModalOpen] = useState(false);\r\n    const [newTx, setNewTx] = useState({ type: \"支出\", amount: \"\", date: \"\", desc: \"\", accountId: \"\", projectId: \"\", category: \"\" });\r\n\r\n    // Account Modal State\r\n    const [isAccModalOpen, setIsAccModalOpen] = useState(false);\r\n    const [editingAcc, setEditingAcc] = useState(null);\r\n    const [newAcc, setNewAcc] = useState({ name: \"\", bank: \"\", number: \"\", balance: 0 });\r\n\r\n    // Delete Account State\r\n    const [isDeleteAccModalOpen, setIsDeleteAccModalOpen] = useState(false);\r\n    const [deletingAcc, setDeletingAcc] = useState(null);\r\n\r\n    // Account Details State\r\n    const [isDetailsModalOpen, setIsDetailsModalOpen] = useState(false);\r\n    const [selectedAccount, setSelectedAccount] = useState(null);\r\n\r\n    // Export Modal State\r\n    const [isExportModalOpen, setIsExportModalOpen] = useState(false);\r\n    const [searchResults, setSearchResults] = useState([]);\r\n    const [isSearching, setIsSearching] = useState(false);\r\n\r\n    // Drag Refs\r\n    const dragItem = useRef(null);\r\n    const dragOverItem = useRef(null);\r\n\r\n    const handleResize = (id, size) => setWidgets(prev => prev.map(w => w.id === id ? { ...w, size } : w));\r\n\r\n    // Widget Drag Sorting\r\n    const handleDragStart = (e, idx) => { dragItem.current = idx; };\r\n    const handleDragEnter = (e, idx) => {\r\n        dragOverItem.current = idx;\r\n        const copy = [...widgets]; const dragContent = copy[dragItem.current];\r\n        copy.splice(dragItem.current, 1); copy.splice(dragOverItem.current, 0, dragContent);\r\n        dragItem.current = idx; setWidgets(copy);\r\n    };\r\n    const handleDragEnd = () => { dragItem.current = null; dragOverItem.current = null; };\r\n\r\n    // Account Drag Sorting\r\n    const handleDragStartAccount = (e, idx) => { dragItem.current = idx; };\r\n    const handleDragOverAccount = (e, idx) => {\r\n        e.preventDefault();\r\n        dragOverItem.current = idx;\r\n        const copy = [...accounts]; const item = copy[dragItem.current];\r\n        copy.splice(dragItem.current, 1); copy.splice(dragOverItem.current, 0, item);\r\n        dragItem.current = idx;\r\n        setAccounts(copy);\r\n    };\r\n    const handleDragEndAccount = () => {\r\n        dragItem.current = null; dragOverItem.current = null;\r\n        onUpdateAccounts(accounts);\r\n        // GoogleService.syncToSheet('accounts', accounts); // TODO: Implement sync\r\n    };\r\n\r\n    // Account CRUD\r\n    const openAddAcc = () => { setEditingAcc(null); setNewAcc({ name: \"\", bank: \"\", number: \"\", balance: 0 }); setIsAccModalOpen(true); };\r\n    const openEditAcc = (acc) => { setEditingAcc(acc); setNewAcc(acc); setIsAccModalOpen(true); };\r\n\r\n    const handleSaveAccount = async () => {\r\n        // 確保 balance 是數字類型\r\n        const accountData = {\r\n            ...newAcc,\r\n            balance: Number(newAcc.balance) || 0\r\n        };\r\n\r\n        const updatedAccounts = editingAcc\r\n            ? accounts.map(a => a.id === editingAcc.id ? { ...a, ...accountData } : a)\r\n            : [...accounts, { ...accountData, id: `a-${Date.now()}` }];\r\n\r\n        setAccounts(updatedAccounts);\r\n        onUpdateAccounts(updatedAccounts); // Update App State\r\n\r\n        // 同步帳戶到 Google Sheets\r\n        const syncResult = await GoogleService.syncToSheet('accounts', updatedAccounts);\r\n        if (!syncResult.success) {\r\n            console.error('帳戶同步失敗:', syncResult.error);\r\n        }\r\n\r\n        addToast(editingAcc ? \"帳戶更新成功！\" : \"新帳戶建立成功！\", 'success');\r\n        setIsAccModalOpen(false);\r\n        setEditingAcc(null);\r\n        setNewAcc({ name: \"\", bank: \"\", number: \"\", balance: 0 }); // 重置表單\r\n    };\r\n\r\n    // Delete Account Handler\r\n    const handleDeleteAccount = (acc) => {\r\n        setDeletingAcc(acc);\r\n        setIsDeleteAccModalOpen(true);\r\n    };\r\n\r\n    const confirmDeleteAccount = async () => {\r\n        const updatedAccounts = accounts.filter(a => a.id !== deletingAcc.id);\r\n        setAccounts(updatedAccounts);\r\n        onUpdateAccounts(updatedAccounts);\r\n\r\n        // 同步帳戶刪除到 Google Sheets\r\n        const syncResult = await GoogleService.syncToSheet('accounts', updatedAccounts);\r\n        if (!syncResult.success) {\r\n            console.error('帳戶刪除同步失敗:', syncResult.error);\r\n        }\r\n\r\n        addToast(`帳戶「${deletingAcc.name}」已刪除`, 'success');\r\n        setIsDeleteAccModalOpen(false);\r\n        setDeletingAcc(null);\r\n    };\r\n\r\n    // Account Details Handler\r\n    const handleViewDetails = (acc) => {\r\n        setSelectedAccount(acc);\r\n        setIsDetailsModalOpen(true);\r\n    };\r\n\r\n    // Loan CRUD Handlers\r\n    const openAddLoan = () => {\r\n        setEditingLoan(null);\r\n        setIsLoanModalOpen(true);\r\n    };\r\n\r\n    const openEditLoan = (loan) => {\r\n        setEditingLoan(loan);\r\n        setIsLoanModalOpen(true);\r\n    };\r\n\r\n    const handleSaveLoan = async (loanData) => {\r\n        const updatedLoans = editingLoan\r\n            ? loans.map(l => l.id === editingLoan.id ? loanData : l)\r\n            : [...loans, loanData];\r\n\r\n        setLoans(updatedLoans);\r\n        if (onUpdateLoans) onUpdateLoans(updatedLoans);\r\n\r\n        // 同步貸款到 Google Sheets\r\n        const syncResult = await GoogleService.syncToSheet('loans', updatedLoans);\r\n        if (!syncResult.success) {\r\n            console.error('貸款同步失敗:', syncResult.error);\r\n        }\r\n\r\n        addToast(editingLoan ? '貸款帳戶已更新！' : '貸款帳戶已新增！', 'success');\r\n        setIsLoanModalOpen(false);\r\n        setEditingLoan(null);\r\n    };\r\n\r\n    const handleDeleteLoan = (loan) => {\r\n        setDeletingLoan(loan);\r\n        setIsDeleteLoanModalOpen(true);\r\n    };\r\n\r\n    const confirmDeleteLoan = async () => {\r\n        const updatedLoans = loans.filter(l => l.id !== deletingLoan.id);\r\n        setLoans(updatedLoans);\r\n        if (onUpdateLoans) onUpdateLoans(updatedLoans);\r\n\r\n        // 同步貸款刪除到 Google Sheets\r\n        const syncResult = await GoogleService.syncToSheet('loans', updatedLoans);\r\n        if (!syncResult.success) {\r\n            console.error('貸款刪除同步失敗:', syncResult.error);\r\n        }\r\n\r\n        addToast(`貸款帳戶「${deletingLoan.bankName}」已刪除`, 'success');\r\n        setIsDeleteLoanModalOpen(false);\r\n        setDeletingLoan(null);\r\n    };\r\n\r\n    const handleRecordLoanPayment = async (loan) => {\r\n        // 記錄還款 - 更新已還期數\r\n        const updatedLoan = {\r\n            ...loan,\r\n            paidTerms: loan.paidTerms + 1,\r\n            status: loan.paidTerms + 1 >= loan.totalTerms ? 'completed' : 'active'\r\n        };\r\n        const updatedLoans = loans.map(l => l.id === loan.id ? updatedLoan : l);\r\n        setLoans(updatedLoans);\r\n        if (onUpdateLoans) onUpdateLoans(updatedLoans);\r\n\r\n        // 同步還款記錄到 Google Sheets\r\n        const syncResult = await GoogleService.syncToSheet('loans', updatedLoans);\r\n        if (!syncResult.success) {\r\n            console.error('還款記錄同步失敗:', syncResult.error);\r\n        }\r\n\r\n        addToast(`已記錄第 ${updatedLoan.paidTerms} 期還款`, 'success');\r\n    };\r\n\r\n    // Finance Export Handler\r\n    const handleExportFinance = async (transactions, options) => {\r\n        const result = await GoogleService.exportFinanceReport(transactions, options);\r\n        if (result.success) {\r\n            addToast(`財務報表已匯出！${result.isNewSheet ? '(新建月份Sheet)' : ''}`, 'success', {\r\n                action: { label: '開啟報表', onClick: () => window.open(result.sheetUrl, '_blank') }\r\n            });\r\n        } else {\r\n            addToast(`匯出失敗：${result.error}`, 'error');\r\n        }\r\n    };\r\n\r\n    // Finance Search Handler\r\n    const handleSearchFinance = async (query, options) => {\r\n        setIsSearching(true);\r\n        const result = await GoogleService.searchFinanceRecords(query, options);\r\n        setIsSearching(false);\r\n        if (result.success) {\r\n            setSearchResults(result.results);\r\n            addToast(`搜尋完成，找到 ${result.count} 筆記錄`, 'info');\r\n        } else {\r\n            addToast(`搜尋失敗：${result.error}`, 'error');\r\n        }\r\n    };\r\n\r\n    const handleConfirmTx = async () => {\r\n        // Validation\r\n        if (!newTx.accountId || !newTx.amount || parseFloat(newTx.amount) <= 0) {\r\n            addToast('請填寫完整資料並確認金額大於0', 'error');\r\n            return;\r\n        }\r\n\r\n        const txWithNumber = { ...newTx, amount: parseFloat(newTx.amount) };\r\n\r\n        // 若選擇了專案，同步到專案收支 Sheet\r\n        if (newTx.projectId) {\r\n            const selectedProject = allProjects.find(p => p.id === newTx.projectId);\r\n            if (selectedProject?.folderId) {\r\n                try {\r\n                    await GoogleService.syncTransactionToProjectSheet(\r\n                        selectedProject.folderId,\r\n                        selectedProject.name,\r\n                        {\r\n                            date: newTx.date,\r\n                            type: newTx.type,\r\n                            category: newTx.category,\r\n                            amount: parseFloat(newTx.amount),\r\n                            target: '', // 可以之後擴展\r\n                            account: accounts.find(a => a.id === newTx.accountId)?.name || '',\r\n                            invoiceNo: '',\r\n                            note: newTx.desc\r\n                        }\r\n                    );\r\n                    addToast(`已同步到專案「${selectedProject.name}」`, 'info');\r\n                } catch (err) {\r\n                    console.error('Sync to project failed:', err);\r\n                }\r\n            }\r\n        }\r\n\r\n        onAddTx(txWithNumber); // Handles App State update and Toast inside App.jsx\r\n        setIsTxModalOpen(false);\r\n        setNewTx({ type: \"支出\", amount: \"\", date: \"\", desc: \"\", accountId: \"\", projectId: \"\", category: \"\" });\r\n    };\r\n\r\n    const renderWidget = (w) => {\r\n        switch (w.type) {\r\n            case 'finance-acc':\r\n                return (\r\n                    <div className=\"h-full flex flex-col\">\r\n                        <div className=\"flex justify-end mb-2\">\r\n                            <button onClick={openAddAcc} className=\"text-xs text-morandi-blue-600 hover:underline flex items-center gap-1\"><Plus size={12} /> 新增帳戶</button>\r\n                        </div>\r\n                        <WidgetFinanceAccounts\r\n                            data={accounts}\r\n                            size={w.size}\r\n                            onEdit={openEditAcc}\r\n                            onDelete={handleDeleteAccount}\r\n                            onViewDetails={handleViewDetails}\r\n                            onDragStartAccount={handleDragStartAccount}\r\n                            onDragOverAccount={handleDragOverAccount}\r\n                            onDragEndAccount={handleDragEndAccount}\r\n                        />\r\n                    </div>\r\n                );\r\n            case 'finance-loans':\r\n                // 計算貸款總額\r\n                const totalLoanAmount = loans.reduce((sum, l) => sum + (l.remainingPrincipal || l.principalAmount || 0), 0);\r\n                return (\r\n                    <div className=\"h-full flex flex-col\">\r\n                        <div className=\"flex justify-between items-center mb-3\">\r\n                            <div className=\"flex items-center gap-2\">\r\n                                <Building2 size={16} className=\"text-blue-600\" />\r\n                                <span className=\"text-sm text-gray-500\">\r\n                                    總貸款餘額: <span className=\"font-bold text-gray-800\">${totalLoanAmount.toLocaleString()}</span>\r\n                                </span>\r\n                            </div>\r\n                            <button onClick={openAddLoan} className=\"text-xs text-blue-600 hover:underline flex items-center gap-1\">\r\n                                <Plus size={12} /> 新增貸款\r\n                            </button>\r\n                        </div>\r\n                        <div className=\"flex-1 overflow-y-auto pr-1\">\r\n                            {loans.length === 0 ? (\r\n                                <div className=\"flex flex-col items-center justify-center h-32 text-gray-400\">\r\n                                    <Building2 size={32} className=\"mb-2 opacity-50\" />\r\n                                    <p className=\"text-sm\">尚無貸款帳戶</p>\r\n                                    <button onClick={openAddLoan} className=\"mt-2 text-xs text-blue-600 hover:underline\">新增貸款</button>\r\n                                </div>\r\n                            ) : (\r\n                                loans.map(loan => (\r\n                                    <LoanAccountCard\r\n                                        key={loan.id}\r\n                                        loan={loan}\r\n                                        onEdit={openEditLoan}\r\n                                        onRecordPayment={handleRecordLoanPayment}\r\n                                    />\r\n                                ))\r\n                            )}\r\n                        </div>\r\n                    </div>\r\n                );\r\n            case 'finance-trend': return <WidgetFinanceTrend size={w.size} />;\r\n            case 'finance-tx': return <WidgetFinanceTransactions data={data.transactions} size={w.size} onAddTx={() => setIsTxModalOpen(true)} />;\r\n            default: return null;\r\n        }\r\n    }\r\n\r\n    return (\r\n        <div className=\"space-y-6 animate-fade-in\">\r\n            <div className=\"flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4\">\r\n                <SectionTitle title=\"財務管理\" />\r\n                <button\r\n                    onClick={() => setIsExportModalOpen(true)}\r\n                    className=\"flex items-center gap-2 px-4 py-2.5 bg-green-600 text-white rounded-xl font-medium hover:bg-green-700 transition-all shadow-sm\"\r\n                >\r\n                    <Download size={18} />\r\n                    匯出報表\r\n                </button>\r\n            </div>\r\n\r\n            <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6 auto-rows-auto\">\r\n                {widgets.map((w, i) => (\r\n                    <WidgetWrapper key={w.id} widget={w} onResize={handleResize} onDragStart={(e) => handleDragStart(e, i)} onDragEnter={(e) => handleDragEnter(e, i)} onDragEnd={handleDragEnd}>\r\n                        {renderWidget(w)}\r\n                    </WidgetWrapper>\r\n                ))}\r\n            </div>\r\n\r\n            {/* Transaction Modal */}\r\n            <Modal isOpen={isTxModalOpen} onClose={() => setIsTxModalOpen(false)} title=\"新增收支紀錄\" onConfirm={handleConfirmTx}>\r\n                <div className=\"flex gap-4 mb-6 bg-gray-50 p-1 rounded-xl\">\r\n                    <button onClick={() => setNewTx({ ...newTx, type: '收入', category: '' })} className={`flex-1 py-2 rounded-lg text-sm font-bold transition-all ${newTx.type === '收入' ? 'bg-white text-green-600 shadow-sm' : 'text-gray-400'}`}>收入</button>\r\n                    <button onClick={() => setNewTx({ ...newTx, type: '支出', category: '' })} className={`flex-1 py-2 rounded-lg text-sm font-bold transition-all ${newTx.type === '支出' ? 'bg-white text-red-600 shadow-sm' : 'text-gray-400'}`}>支出</button>\r\n                </div>\r\n                <div className=\"grid grid-cols-1 sm:grid-cols-2 gap-4\">\r\n                    <InputField label=\"金額\" type=\"number\" value={newTx.amount} onChange={e => setNewTx({ ...newTx, amount: e.target.value })} placeholder=\"請輸入金額\" />\r\n                    <InputField label=\"日期\" type=\"date\" value={newTx.date} onChange={e => setNewTx({ ...newTx, date: e.target.value })} />\r\n                </div>\r\n                <div className=\"grid grid-cols-1 sm:grid-cols-2 gap-4\">\r\n                    <InputField label=\"類別\" type=\"select\" value={newTx.category} onChange={e => setNewTx({ ...newTx, category: e.target.value })}>\r\n                        <option value=\"\">請選擇類別</option>\r\n                        {TX_CATEGORIES[newTx.type]?.map(cat => (\r\n                            <option key={cat} value={cat}>{cat}</option>\r\n                        ))}\r\n                    </InputField>\r\n                    <InputField label=\"帳戶\" type=\"select\" value={newTx.accountId} onChange={e => setNewTx({ ...newTx, accountId: e.target.value })}>\r\n                        <option value=\"\" disabled>請選擇帳戶</option>\r\n                        {accounts.map(acc => (\r\n                            <option key={acc.id} value={acc.id}>{acc.name}</option>\r\n                        ))}\r\n                    </InputField>\r\n                </div>\r\n                <InputField label=\"關聯專案 (選填)\" type=\"select\" value={newTx.projectId} onChange={e => setNewTx({ ...newTx, projectId: e.target.value })}>\r\n                    <option value=\"\">無關聯專案</option>\r\n                    {allProjects.map(p => (\r\n                        <option key={p.id} value={p.id}>{p.name}</option>\r\n                    ))}\r\n                </InputField>\r\n                <InputField label=\"摘要\" value={newTx.desc} onChange={e => setNewTx({ ...newTx, desc: e.target.value })} placeholder=\"例：油漆補料\" />\r\n            </Modal>\r\n\r\n            {/* Account Modal */}\r\n            <Modal isOpen={isAccModalOpen} onClose={() => setIsAccModalOpen(false)} title={editingAcc ? \"編輯帳戶\" : \"新增帳戶\"} onConfirm={handleSaveAccount}>\r\n                <InputField label=\"帳戶名稱\" value={newAcc.name} onChange={e => setNewAcc({ ...newAcc, name: e.target.value })} placeholder=\"例：公司零用金\" />\r\n                <div className=\"grid grid-cols-2 gap-4\">\r\n                    <InputField label=\"銀行/機構\" value={newAcc.bank} onChange={e => setNewAcc({ ...newAcc, bank: e.target.value })} />\r\n                    <InputField label=\"帳號 (選填)\" value={newAcc.number} onChange={e => setNewAcc({ ...newAcc, number: e.target.value })} />\r\n                </div>\r\n                <InputField label=\"初始餘額\" type=\"number\" value={newAcc.balance} onChange={e => setNewAcc({ ...newAcc, balance: Number(e.target.value) })} />\r\n\r\n                {/* Delete Button - Only show when editing */}\r\n                {editingAcc && (\r\n                    <div className=\"mt-6 pt-4 border-t border-gray-200\">\r\n                        <button\r\n                            onClick={() => {\r\n                                setIsAccModalOpen(false);\r\n                                handleDeleteAccount(editingAcc);\r\n                            }}\r\n                            className=\"w-full py-2.5 px-4 bg-red-50 text-red-600 rounded-lg font-medium hover:bg-red-100 transition-all flex items-center justify-center gap-2\"\r\n                        >\r\n                            <span>🗑️</span>\r\n                            刪除此帳戶\r\n                        </button>\r\n                    </div>\r\n                )}\r\n            </Modal>\r\n\r\n            {/* Delete Account Modal */}\r\n            <Modal\r\n                isOpen={isDeleteAccModalOpen}\r\n                onClose={() => setIsDeleteAccModalOpen(false)}\r\n                title=\"確認刪除帳戶\"\r\n                onConfirm={confirmDeleteAccount}\r\n                confirmText=\"確定刪除\"\r\n            >\r\n                <div className=\"space-y-4\">\r\n                    <div className=\"bg-red-50 border border-red-100 rounded-lg p-4\">\r\n                        <p className=\"text-red-800 font-medium\">⚠️ 警告：此操作無法復原</p>\r\n                    </div>\r\n                    <p className=\"text-gray-700\">\r\n                        您確定要刪除帳戶「<span className=\"font-bold\">{deletingAcc?.name}</span>」嗎？\r\n                    </p>\r\n                    <p className=\"text-sm text-gray-500\">\r\n                        刪除後，該帳戶的所有交易記錄仍會保留，但帳戶資訊將無法恢復。\r\n                    </p>\r\n                </div>\r\n            </Modal>\r\n\r\n            {/* Account Details Modal */}\r\n            <AccountDetailsModal\r\n                isOpen={isDetailsModalOpen}\r\n                onClose={() => setIsDetailsModalOpen(false)}\r\n                account={selectedAccount}\r\n                allTransactions={data.transactions || []}\r\n            />\r\n\r\n            {/* Finance Export Modal */}\r\n            <FinanceExportModal\r\n                isOpen={isExportModalOpen}\r\n                onClose={() => setIsExportModalOpen(false)}\r\n                transactions={data.transactions || []}\r\n                accounts={accounts}\r\n                projects={allProjects}\r\n                onExport={handleExportFinance}\r\n            />\r\n\r\n            {/* Loan Account Modal */}\r\n            <LoanAccountModal\r\n                isOpen={isLoanModalOpen}\r\n                onClose={() => { setIsLoanModalOpen(false); setEditingLoan(null); }}\r\n                onConfirm={handleSaveLoan}\r\n                editingLoan={editingLoan}\r\n            />\r\n\r\n            {/* Delete Loan Modal */}\r\n            <Modal\r\n                isOpen={isDeleteLoanModalOpen}\r\n                onClose={() => setIsDeleteLoanModalOpen(false)}\r\n                title=\"確認刪除貸款帳戶\"\r\n                onConfirm={confirmDeleteLoan}\r\n                confirmText=\"確定刪除\"\r\n            >\r\n                <div className=\"space-y-4\">\r\n                    <div className=\"bg-red-50 border border-red-100 rounded-lg p-4\">\r\n                        <p className=\"text-red-800 font-medium\">⚠️ 警告：此操作無法復原</p>\r\n                    </div>\r\n                    <p className=\"text-gray-700\">\r\n                        您確定要刪除貸款帳戶「<span className=\"font-bold\">{deletingLoan?.bankName}</span>」嗎？\r\n                    </p>\r\n                    <p className=\"text-sm text-gray-500\">\r\n                        貸款金額：${deletingLoan?.principalAmount?.toLocaleString() || 0}\r\n                    </p>\r\n                </div>\r\n            </Modal>\r\n        </div>\r\n    );\r\n};\r\nexport default Finance;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\xiang\\senteng-frontend\\src\\pages\\IntegrationsPage.jsx","messages":[{"ruleId":"no-unused-vars","severity":2,"message":"'canAccessPage' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]|^_/u.","line":31,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":31,"endColumn":26,"suggestions":[{"messageId":"removeVar","data":{"varName":"canAccessPage"},"fix":{"range":[965,979],"text":""},"desc":"Remove unused variable 'canAccessPage'."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * IntegrationsPage.jsx\r\n * \r\n * Google 整合設定頁面\r\n * 路由：/settings/integrations\r\n */\r\n\r\nimport React, { useEffect, useState, useCallback } from 'react';\r\nimport { useAuth } from '../context/AuthContext';\r\nimport { integrationsApi } from '../services/integrationsApi';\r\nimport { SyncStatusBadge } from '../components/common/SyncStatusBadge';\r\nimport { Card } from '../components/common/Card';\r\n\r\n// Card with title helper\r\nconst TitledCard = ({ title, children }) => (\r\n    <Card>\r\n        <h3 className=\"text-lg font-semibold text-gray-800 mb-4\">{title}</h3>\r\n        {children}\r\n    </Card>\r\n);\r\n\r\n// 狀態列\r\nconst StatusRow = ({ label, value }) => (\r\n    <div className=\"flex items-center py-2 border-b border-gray-100 last:border-0\">\r\n        <span className=\"w-40 text-sm text-gray-500\">{label}</span>\r\n        <span className=\"text-sm text-gray-800\">{value || '-'}</span>\r\n    </div>\r\n);\r\n\r\nexport default function IntegrationsPage({ addToast }) {\r\n    const { canAccessPage, hasAction } = useAuth();\r\n\r\n    const [status, setStatus] = useState(null);\r\n    const [loading, setLoading] = useState(true);\r\n    const [saving, setSaving] = useState(false);\r\n\r\n    // 表單狀態\r\n    const [calendarId, setCalendarId] = useState('');\r\n    const [contactsLabel, setContactsLabel] = useState('Senteng ERP');\r\n    const [autoSyncEvents, setAutoSyncEvents] = useState(true);\r\n    const [autoSyncContacts, setAutoSyncContacts] = useState(true);\r\n\r\n    // 取得狀態\r\n    const fetchStatus = useCallback(async () => {\r\n        try {\r\n            setLoading(true);\r\n            const data = await integrationsApi.getStatus();\r\n            setStatus(data);\r\n            setCalendarId(data.calendarId || '');\r\n            setContactsLabel(data.contactsLabel || 'Senteng ERP');\r\n            setAutoSyncEvents(data.autoSyncEvents ?? true);\r\n            setAutoSyncContacts(data.autoSyncContacts ?? true);\r\n        } catch (error) {\r\n            console.error('Failed to fetch integration status:', error);\r\n            addToast?.('無法取得整合狀態', 'error');\r\n        } finally {\r\n            setLoading(false);\r\n        }\r\n    }, [addToast]);\r\n\r\n    useEffect(() => {\r\n        fetchStatus();\r\n    }, [fetchStatus]);\r\n\r\n    // 連結 Google\r\n    const handleConnect = async () => {\r\n        try {\r\n            const { authUrl } = await integrationsApi.connect();\r\n            window.location.href = authUrl;\r\n        } catch (error) {\r\n            console.error('Failed to connect:', error);\r\n            addToast?.('連結失敗', 'error');\r\n        }\r\n    };\r\n\r\n    // 斷開連結\r\n    const handleDisconnect = async () => {\r\n        if (!window.confirm('確定要斷開 Google 連結嗎？')) return;\r\n\r\n        try {\r\n            await integrationsApi.disconnect();\r\n            await fetchStatus();\r\n            addToast?.('已斷開連結', 'success');\r\n        } catch (error) {\r\n            console.error('Failed to disconnect:', error);\r\n            addToast?.('斷開失敗', 'error');\r\n        }\r\n    };\r\n\r\n    // 儲存設定\r\n    const handleSave = async () => {\r\n        try {\r\n            setSaving(true);\r\n            await integrationsApi.configure({\r\n                calendarId: calendarId.trim() || null,\r\n                contactsLabel: contactsLabel.trim() || null,\r\n                autoSyncEvents,\r\n                autoSyncContacts,\r\n            });\r\n            await fetchStatus();\r\n            addToast?.('設定已儲存', 'success');\r\n        } catch (error) {\r\n            console.error('Failed to save:', error);\r\n            addToast?.('儲存失敗', 'error');\r\n        } finally {\r\n            setSaving(false);\r\n        }\r\n    };\r\n\r\n    // 權限檢查 helper（暫時用 roleLevel 判斷）\r\n    const canConnect = hasAction?.('integrations.google', 'connect') ?? true;\r\n    const canDisconnect = hasAction?.('integrations.google', 'disconnect') ?? true;\r\n    const canConfigure = hasAction?.('integrations.google', 'configure') ?? true;\r\n    const canSetCalendar = hasAction?.('integrations.google.calendar', 'set_target_calendar') ?? true;\r\n    const canSetLabel = hasAction?.('integrations.google.contacts', 'set_label') ?? true;\r\n\r\n    if (loading) {\r\n        return (\r\n            <div className=\"p-6\">\r\n                <div className=\"animate-pulse\">\r\n                    <div className=\"h-8 w-48 bg-gray-200 rounded mb-4\"></div>\r\n                    <div className=\"h-64 bg-gray-100 rounded-xl\"></div>\r\n                </div>\r\n            </div>\r\n        );\r\n    }\r\n\r\n    return (\r\n        <div className=\"p-6 max-w-4xl\">\r\n            {/* Header */}\r\n            <div className=\"mb-6\">\r\n                <h1 className=\"text-2xl font-bold text-gray-800\">Integrations</h1>\r\n                <p className=\"text-gray-500 mt-1\">\r\n                    將 ERP 的行事曆與聯絡人同步至 Google，方便手機查看\r\n                </p>\r\n            </div>\r\n\r\n            <div className=\"space-y-6\">\r\n                {/* Google Connection Card */}\r\n                <TitledCard title=\"Google 連結狀態\">\r\n                    <div className=\"space-y-1\">\r\n                        <StatusRow label=\"連結狀態\" value={\r\n                            <span className={`font-medium ${status?.connected ? 'text-green-600' : 'text-gray-400'}`}>\r\n                                {status?.connected ? '✓ 已連結' : '未連結'}\r\n                            </span>\r\n                        } />\r\n                        <StatusRow label=\"Google 帳號\" value={status?.googleAccountEmail} />\r\n                        <StatusRow label=\"最後同步\" value={status?.lastSyncedAt} />\r\n                        <StatusRow label=\"錯誤訊息\" value={\r\n                            status?.lastSyncError && (\r\n                                <span className=\"text-red-600 text-xs\">{status.lastSyncError}</span>\r\n                            )\r\n                        } />\r\n                    </div>\r\n\r\n                    <div className=\"flex gap-3 mt-6\">\r\n                        {canConnect && (\r\n                            <button\r\n                                onClick={handleConnect}\r\n                                disabled={status?.connected}\r\n                                className=\"px-4 py-2 bg-gray-800 text-white rounded-lg hover:bg-gray-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors\"\r\n                            >\r\n                                連結 Google\r\n                            </button>\r\n                        )}\r\n                        {canDisconnect && status?.connected && (\r\n                            <button\r\n                                onClick={handleDisconnect}\r\n                                className=\"px-4 py-2 border border-red-300 text-red-600 rounded-lg hover:bg-red-50 transition-colors\"\r\n                            >\r\n                                斷開連結\r\n                            </button>\r\n                        )}\r\n                        <button\r\n                            onClick={fetchStatus}\r\n                            className=\"px-4 py-2 border border-gray-300 text-gray-600 rounded-lg hover:bg-gray-50 transition-colors\"\r\n                        >\r\n                            重新整理\r\n                        </button>\r\n                    </div>\r\n                </TitledCard>\r\n\r\n                {/* Calendar Sync Card */}\r\n                <TitledCard title=\"行事曆同步設定\">\r\n                    {canSetCalendar && (\r\n                        <div className=\"mb-4\">\r\n                            <label className=\"block text-sm text-gray-600 mb-2\">\r\n                                目標日曆 ID\r\n                            </label>\r\n                            <input\r\n                                type=\"text\"\r\n                                value={calendarId}\r\n                                onChange={(e) => setCalendarId(e.target.value)}\r\n                                placeholder=\"primary 或指定 calendarId\"\r\n                                className=\"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gray-500 focus:border-transparent\"\r\n                            />\r\n                            <p className=\"text-xs text-gray-400 mt-1\">\r\n                                留空表示使用主日曆 (primary)\r\n                            </p>\r\n                        </div>\r\n                    )}\r\n\r\n                    <label className=\"flex items-center gap-3 cursor-pointer\">\r\n                        <input\r\n                            type=\"checkbox\"\r\n                            checked={autoSyncEvents}\r\n                            onChange={(e) => setAutoSyncEvents(e.target.checked)}\r\n                            disabled={!status?.connected}\r\n                            className=\"w-4 h-4 text-gray-800 rounded focus:ring-gray-500\"\r\n                        />\r\n                        <span className=\"text-sm text-gray-700\">自動同步事件</span>\r\n                    </label>\r\n                </TitledCard>\r\n\r\n                {/* Contacts Sync Card */}\r\n                <TitledCard title=\"聯絡人同步設定\">\r\n                    {canSetLabel && (\r\n                        <div className=\"mb-4\">\r\n                            <label className=\"block text-sm text-gray-600 mb-2\">\r\n                                聯絡人標籤\r\n                            </label>\r\n                            <input\r\n                                type=\"text\"\r\n                                value={contactsLabel}\r\n                                onChange={(e) => setContactsLabel(e.target.value)}\r\n                                placeholder=\"Senteng ERP\"\r\n                                className=\"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gray-500 focus:border-transparent\"\r\n                            />\r\n                            <p className=\"text-xs text-gray-400 mt-1\">\r\n                                同步至 Google 聯絡人時使用的分類標籤\r\n                            </p>\r\n                        </div>\r\n                    )}\r\n\r\n                    <label className=\"flex items-center gap-3 cursor-pointer\">\r\n                        <input\r\n                            type=\"checkbox\"\r\n                            checked={autoSyncContacts}\r\n                            onChange={(e) => setAutoSyncContacts(e.target.checked)}\r\n                            disabled={!status?.connected}\r\n                            className=\"w-4 h-4 text-gray-800 rounded focus:ring-gray-500\"\r\n                        />\r\n                        <span className=\"text-sm text-gray-700\">自動同步聯絡人</span>\r\n                    </label>\r\n                </TitledCard>\r\n\r\n                {/* Save Button */}\r\n                {canConfigure && (\r\n                    <div className=\"pt-2\">\r\n                        <button\r\n                            onClick={handleSave}\r\n                            disabled={!status?.connected || saving}\r\n                            className=\"px-6 py-2.5 bg-gray-800 text-white rounded-lg hover:bg-gray-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors\"\r\n                        >\r\n                            {saving ? '儲存中...' : '儲存設定'}\r\n                        </button>\r\n                    </div>\r\n                )}\r\n            </div>\r\n        </div>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\xiang\\senteng-frontend\\src\\pages\\Inventory.jsx","messages":[{"ruleId":"no-unused-vars","severity":2,"message":"'Icon' is defined but never used. Allowed unused args must match /^_|^e$|^err$|^event$/u.","line":73,"column":27,"nodeType":"Identifier","messageId":"unusedVar","endLine":73,"endColumn":31,"suggestions":[{"messageId":"removeVar","data":{"varName":"Icon"},"fix":{"range":[2126,2137],"text":""},"desc":"Remove unused variable 'Icon'."}]},{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\n   99 |             // 若舊資料沒有 mainCategory，根據 category 推算\n  100 |             const mainCat = item.mainCategory || getMainCategory(item.category);\n> 101 |             setForm({ ...item, mainCategory: mainCat });\n      |             ^^^^^^^ Avoid calling setState() directly within an effect\n  102 |         } else {\n  103 |             setForm({\n  104 |                 name: '', spec: '', mainCategory: '消耗品', category: '黏著劑', quantity: 0,","line":101,"column":13,"nodeType":null,"endLine":101,"endColumn":20},{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\n  210 |\n  211 |     useEffect(() => {\n> 212 |         setQuantity(1);\n      |         ^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  213 |         setNote('');\n  214 |     }, [isOpen]);\n  215 |","line":212,"column":9,"nodeType":null,"endLine":212,"endColumn":20},{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\n  309 |     // 初始化\n  310 |     useEffect(() => {\n> 311 |         if (data) setItems(data);\n      |                   ^^^^^^^^ Avoid calling setState() directly within an effect\n  312 |     }, [data]);\n  313 |\n  314 |     // 當 inventorySheet 變更時儲存到 localStorage","line":311,"column":19,"nodeType":null,"endLine":311,"endColumn":27}],"suppressedMessages":[],"errorCount":4,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\r\nimport React, { useState, useEffect, useMemo } from 'react';\r\nimport {\r\n    Package, Plus, Search, Filter, Edit2, Trash2,\r\n    ArrowDownCircle, ArrowUpCircle, AlertTriangle,\r\n    CheckCircle, XCircle, X, Save, History, MapPin,\r\n    BarChart3, TrendingDown, TrendingUp, Box,\r\n    FileSpreadsheet, ExternalLink, RefreshCw\r\n} from 'lucide-react';\r\nimport { Badge } from '../components/common/Badge';\r\nimport { Modal } from '../components/common/Modal';\r\nimport { InputField } from '../components/common/InputField';\r\nimport { SectionTitle } from '../components/common/Indicators';\r\nimport { GoogleService } from '../services/GoogleService';\r\n\r\n// 庫存類別 - 兩層結構\r\nconst CATEGORY_TREE = {\r\n    '結構板材': ['木料', '板材', '防火板', '輕鋼架'],\r\n    '裝飾建材': ['地面材料', '牆面材料', '天花材料', '塗料油漆'],\r\n    '機電設備': ['電氣電線', '燈具照明', '開關插座', '弱電設備', '水管衛浴'],\r\n    '五金配件': ['門窗五金', '櫃體五金', '結構五金', '裝飾五金'],\r\n    '消耗品': ['黏著劑', '填縫材料', '防護用品', '清潔用品']\r\n};\r\n\r\n// 主類別列表（含「全部」選項）\r\nconst MAIN_CATEGORIES = ['全部', ...Object.keys(CATEGORY_TREE)];\r\n\r\n// 所有子類別的扁平列表\r\nconst ALL_SUB_CATEGORIES = Object.values(CATEGORY_TREE).flat();\r\n\r\n// 根據主類別獲取子類別\r\nconst getSubCategories = (mainCategory) => {\r\n    if (mainCategory === '全部' || !mainCategory) return ALL_SUB_CATEGORIES;\r\n    return CATEGORY_TREE[mainCategory] || [];\r\n};\r\n\r\n// 根據子類別找主類別\r\nconst getMainCategory = (subCategory) => {\r\n    for (const [main, subs] of Object.entries(CATEGORY_TREE)) {\r\n        if (subs.includes(subCategory)) return main;\r\n    }\r\n    return '消耗品'; // 預設\r\n};\r\n\r\n// 狀態選項\r\nconst STATUS_OPTIONS = ['全部', '充足', '庫存偏低', '缺貨'];\r\n\r\n\r\n// 狀態顏色\r\nconst getStatusColor = (status) => {\r\n    switch (status) {\r\n        case '缺貨': return 'red';\r\n        case '庫存偏低': return 'orange';\r\n        case '充足': return 'green';\r\n        default: return 'gray';\r\n    }\r\n};\r\n\r\n// 計算狀態\r\nconst calculateStatus = (quantity, safeStock) => {\r\n    if (quantity <= 0) return '缺貨';\r\n    if (quantity < safeStock) return '庫存偏低';\r\n    return '充足';\r\n};\r\n\r\n// 格式化日期\r\nconst formatDate = (dateStr) => {\r\n    if (!dateStr) return '-';\r\n    return new Date(dateStr).toLocaleDateString('zh-TW');\r\n};\r\n\r\n// 統計卡片組件\r\nconst StatCard = ({ icon: Icon, label, value, color = 'gray', onClick }) => (\r\n    <div\r\n        onClick={onClick}\r\n        className={`bg-white rounded-xl p-4 border border-gray-100 shadow-sm cursor-pointer hover:shadow-md transition-all ${onClick ? 'cursor-pointer' : ''}`}\r\n    >\r\n        <div className=\"flex items-center justify-between\">\r\n            <div className={`w-10 h-10 rounded-lg bg-${color}-100 flex items-center justify-center`}>\r\n                <Icon size={20} className={`text-${color}-600`} />\r\n            </div>\r\n            <div className=\"text-right\">\r\n                <div className={`text-2xl font-bold text-${color}-600`}>{value}</div>\r\n                <div className=\"text-xs text-gray-500\">{label}</div>\r\n            </div>\r\n        </div>\r\n    </div>\r\n);\r\n\r\n// 新增/編輯品項 Modal\r\nconst ItemModal = ({ isOpen, onClose, item, onSave, isEdit }) => {\r\n    const [form, setForm] = useState({\r\n        name: '', spec: '', mainCategory: '消耗品', category: '黏著劑', quantity: 0,\r\n        unit: '個', safeStock: 10, location: '', status: '充足'\r\n    });\r\n\r\n    useEffect(() => {\r\n        if (item) {\r\n            // 若舊資料沒有 mainCategory，根據 category 推算\r\n            const mainCat = item.mainCategory || getMainCategory(item.category);\r\n            setForm({ ...item, mainCategory: mainCat });\r\n        } else {\r\n            setForm({\r\n                name: '', spec: '', mainCategory: '消耗品', category: '黏著劑', quantity: 0,\r\n                unit: '個', safeStock: 10, location: '', status: '充足'\r\n            });\r\n        }\r\n    }, [item, isOpen]);\r\n\r\n    const handleMainCategoryChange = (newMain) => {\r\n        const subCats = CATEGORY_TREE[newMain] || [];\r\n        setForm({\r\n            ...form,\r\n            mainCategory: newMain,\r\n            category: subCats[0] || '' // 預設選第一個子類別\r\n        });\r\n    };\r\n\r\n    const handleSave = () => {\r\n        const status = calculateStatus(parseInt(form.quantity), parseInt(form.safeStock));\r\n        onSave({ ...form, quantity: parseInt(form.quantity), safeStock: parseInt(form.safeStock), status });\r\n    };\r\n\r\n    const availableSubCategories = CATEGORY_TREE[form.mainCategory] || [];\r\n\r\n    return (\r\n        <Modal\r\n            isOpen={isOpen}\r\n            onClose={onClose}\r\n            title={isEdit ? '編輯庫存品項' : '新增庫存品項'}\r\n            onConfirm={handleSave}\r\n        >\r\n            <div className=\"space-y-4\">\r\n                <InputField\r\n                    label=\"品項名稱\"\r\n                    value={form.name}\r\n                    onChange={e => setForm({ ...form, name: e.target.value })}\r\n                    placeholder=\"例：Panasonic 開關\"\r\n                />\r\n                <div className=\"grid grid-cols-2 gap-4\">\r\n                    <InputField\r\n                        label=\"規格/型號\"\r\n                        value={form.spec}\r\n                        onChange={e => setForm({ ...form, spec: e.target.value })}\r\n                        placeholder=\"例：PN-001\"\r\n                    />\r\n                    <div>\r\n                        <label className=\"block text-sm font-medium text-gray-700 mb-1\">主類別</label>\r\n                        <select\r\n                            value={form.mainCategory}\r\n                            onChange={e => handleMainCategoryChange(e.target.value)}\r\n                            className=\"w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500\"\r\n                        >\r\n                            {Object.keys(CATEGORY_TREE).map(cat => (\r\n                                <option key={cat} value={cat}>{cat}</option>\r\n                            ))}\r\n                        </select>\r\n                    </div>\r\n                </div>\r\n                <div className=\"grid grid-cols-2 gap-4\">\r\n                    <div>\r\n                        <label className=\"block text-sm font-medium text-gray-700 mb-1\">子類別</label>\r\n                        <select\r\n                            value={form.category}\r\n                            onChange={e => setForm({ ...form, category: e.target.value })}\r\n                            className=\"w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500\"\r\n                        >\r\n                            {availableSubCategories.map(cat => (\r\n                                <option key={cat} value={cat}>{cat}</option>\r\n                            ))}\r\n                        </select>\r\n                    </div>\r\n                    <InputField\r\n                        label=\"單位\"\r\n                        value={form.unit}\r\n                        onChange={e => setForm({ ...form, unit: e.target.value })}\r\n                        placeholder=\"個、組、箱\"\r\n                    />\r\n                </div>\r\n                <div className=\"grid grid-cols-3 gap-4\">\r\n                    <InputField\r\n                        label=\"數量\"\r\n                        type=\"number\"\r\n                        value={form.quantity}\r\n                        onChange={e => setForm({ ...form, quantity: e.target.value })}\r\n                    />\r\n                    <InputField\r\n                        label=\"安全庫存\"\r\n                        type=\"number\"\r\n                        value={form.safeStock}\r\n                        onChange={e => setForm({ ...form, safeStock: e.target.value })}\r\n                    />\r\n                    <InputField\r\n                        label=\"存放位置\"\r\n                        value={form.location}\r\n                        onChange={e => setForm({ ...form, location: e.target.value })}\r\n                        placeholder=\"A-01\"\r\n                    />\r\n                </div>\r\n            </div>\r\n        </Modal>\r\n    );\r\n};\r\n\r\n\r\n// 出入庫 Modal\r\nconst StockMovementModal = ({ isOpen, onClose, item, type, onConfirm }) => {\r\n    const [quantity, setQuantity] = useState(1);\r\n    const [note, setNote] = useState('');\r\n\r\n    useEffect(() => {\r\n        setQuantity(1);\r\n        setNote('');\r\n    }, [isOpen]);\r\n\r\n    const handleConfirm = () => {\r\n        onConfirm({\r\n            itemId: item.id,\r\n            itemName: item.name,\r\n            type: type,\r\n            quantity: parseInt(quantity),\r\n            date: new Date().toISOString().split('T')[0],\r\n            operator: 'Admin',\r\n            note\r\n        });\r\n    };\r\n\r\n    return (\r\n        <Modal\r\n            isOpen={isOpen}\r\n            onClose={onClose}\r\n            title={type === '入' ? '入庫登記' : '出庫登記'}\r\n            onConfirm={handleConfirm}\r\n        >\r\n            <div className=\"space-y-4\">\r\n                <div className=\"bg-gray-50 rounded-lg p-3\">\r\n                    <div className=\"text-sm text-gray-500\">品項</div>\r\n                    <div className=\"font-bold text-gray-800\">{item?.name}</div>\r\n                    <div className=\"text-xs text-gray-400\">{item?.spec}</div>\r\n                    <div className=\"mt-2 text-sm\">\r\n                        當前數量: <span className=\"font-bold\">{item?.quantity}</span> {item?.unit}\r\n                    </div>\r\n                </div>\r\n                <InputField\r\n                    label={`${type === '入' ? '入庫' : '出庫'}數量`}\r\n                    type=\"number\"\r\n                    value={quantity}\r\n                    onChange={e => setQuantity(e.target.value)}\r\n                    min={1}\r\n                />\r\n                <InputField\r\n                    label=\"備註\"\r\n                    value={note}\r\n                    onChange={e => setNote(e.target.value)}\r\n                    placeholder={type === '入' ? '例：批量採購' : '例：出貨至林公館'}\r\n                />\r\n                {type === '出' && parseInt(quantity) > (item?.quantity || 0) && (\r\n                    <div className=\"text-red-500 text-sm flex items-center gap-1\">\r\n                        <AlertTriangle size={14} />\r\n                        出庫數量超過庫存！\r\n                    </div>\r\n                )}\r\n            </div>\r\n        </Modal>\r\n    );\r\n};\r\n\r\n// 刪除確認 Modal\r\nconst DeleteConfirmModal = ({ isOpen, onClose, item, onConfirm }) => (\r\n    <Modal isOpen={isOpen} onClose={onClose} title=\"確認刪除\" onConfirm={onConfirm}>\r\n        <div className=\"text-center py-4\">\r\n            <div className=\"w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4\">\r\n                <Trash2 size={32} className=\"text-red-500\" />\r\n            </div>\r\n            <p className=\"text-gray-600\">確定要刪除以下品項嗎？</p>\r\n            <p className=\"font-bold text-gray-800 mt-2\">{item?.name}</p>\r\n            <p className=\"text-sm text-gray-500\">{item?.spec}</p>\r\n            <p className=\"text-sm text-red-500 mt-4\">此操作無法還原</p>\r\n        </div>\r\n    </Modal>\r\n);\r\n\r\n// 主組件\r\nconst Inventory = ({ data, addToast, onUpdateInventory }) => {\r\n    const [items, setItems] = useState(data || []);\r\n    const [movements, setMovements] = useState([]);\r\n    const [searchTerm, setSearchTerm] = useState('');\r\n    const [mainCategoryFilter, setMainCategoryFilter] = useState('全部');\r\n    const [subCategoryFilter, setSubCategoryFilter] = useState('全部');\r\n    const [statusFilter, setStatusFilter] = useState('全部');\r\n\r\n    // Modal 狀態\r\n    const [isAddModalOpen, setIsAddModalOpen] = useState(false);\r\n    const [isEditModalOpen, setIsEditModalOpen] = useState(false);\r\n    const [isDeleteModalOpen, setIsDeleteModalOpen] = useState(false);\r\n    const [isMovementModalOpen, setIsMovementModalOpen] = useState(false);\r\n    const [selectedItem, setSelectedItem] = useState(null);\r\n    const [movementType, setMovementType] = useState('入');\r\n\r\n    // 庫存 Sheet 狀態\r\n    const [inventorySheet, setInventorySheet] = useState(() => {\r\n        // 從 localStorage 載入已儲存的 Sheet 資訊\r\n        const saved = localStorage.getItem('inventorySheet');\r\n        return saved ? JSON.parse(saved) : null;\r\n    });\r\n    const [isInitializing, setIsInitializing] = useState(false);\r\n    const [isSyncing, setIsSyncing] = useState(false);\r\n\r\n    // 初始化\r\n    useEffect(() => {\r\n        if (data) setItems(data);\r\n    }, [data]);\r\n\r\n    // 當 inventorySheet 變更時儲存到 localStorage\r\n    useEffect(() => {\r\n        if (inventorySheet) {\r\n            localStorage.setItem('inventorySheet', JSON.stringify(inventorySheet));\r\n        }\r\n    }, [inventorySheet]);\r\n\r\n    // 篩選邏輯\r\n    const filteredItems = useMemo(() => {\r\n        return items.filter(item => {\r\n            const matchSearch = !searchTerm ||\r\n                item.name.toLowerCase().includes(searchTerm.toLowerCase()) ||\r\n                item.spec?.toLowerCase().includes(searchTerm.toLowerCase());\r\n\r\n            // 主類別篩選\r\n            const itemMainCat = item.mainCategory || getMainCategory(item.category);\r\n            const matchMainCategory = mainCategoryFilter === '全部' || itemMainCat === mainCategoryFilter;\r\n\r\n            // 子類別篩選\r\n            const matchSubCategory = subCategoryFilter === '全部' || item.category === subCategoryFilter;\r\n\r\n            const matchStatus = statusFilter === '全部' || item.status === statusFilter;\r\n            return matchSearch && matchMainCategory && matchSubCategory && matchStatus;\r\n        });\r\n    }, [items, searchTerm, mainCategoryFilter, subCategoryFilter, statusFilter]);\r\n\r\n    // 統計數據\r\n    const stats = useMemo(() => {\r\n        const total = items.length;\r\n        const lowStock = items.filter(i => i.status === '庫存偏低').length;\r\n        const outOfStock = items.filter(i => i.status === '缺貨').length;\r\n        const thisMonth = movements.filter(m => {\r\n            const moveDate = new Date(m.date);\r\n            const now = new Date();\r\n            return moveDate.getMonth() === now.getMonth() && moveDate.getFullYear() === now.getFullYear();\r\n        });\r\n        const monthIn = thisMonth.filter(m => m.type === '入').reduce((sum, m) => sum + m.quantity, 0);\r\n        const monthOut = thisMonth.filter(m => m.type === '出').reduce((sum, m) => sum + m.quantity, 0);\r\n        return { total, lowStock, outOfStock, monthIn, monthOut };\r\n    }, [items, movements]);\r\n\r\n    // 新增品項\r\n    const handleAddItem = async (newItem) => {\r\n        const itemToAdd = { ...newItem, id: `i-${Date.now()}` };\r\n        const newItems = [...items, itemToAdd];\r\n        setItems(newItems);\r\n        if (onUpdateInventory) onUpdateInventory(newItems);\r\n        await GoogleService.syncToSheet('inventory', newItems);\r\n        addToast('品項新增成功！', 'success');\r\n        setIsAddModalOpen(false);\r\n    };\r\n\r\n    // 編輯品項\r\n    const handleEditItem = async (updatedItem) => {\r\n        const newItems = items.map(i => i.id === updatedItem.id ? updatedItem : i);\r\n        setItems(newItems);\r\n        if (onUpdateInventory) onUpdateInventory(newItems);\r\n        await GoogleService.syncToSheet('inventory', newItems);\r\n        addToast('品項更新成功！', 'success');\r\n        setIsEditModalOpen(false);\r\n        setSelectedItem(null);\r\n    };\r\n\r\n    // 刪除品項\r\n    const handleDeleteItem = async () => {\r\n        const newItems = items.filter(i => i.id !== selectedItem.id);\r\n        setItems(newItems);\r\n        if (onUpdateInventory) onUpdateInventory(newItems);\r\n        await GoogleService.syncToSheet('inventory', newItems);\r\n        addToast('品項已刪除', 'info');\r\n        setIsDeleteModalOpen(false);\r\n        setSelectedItem(null);\r\n    };\r\n\r\n    // 出入庫\r\n    const handleStockMovement = async (movement) => {\r\n        // 更新庫存數量\r\n        const delta = movement.type === '入' ? movement.quantity : -movement.quantity;\r\n        const newItems = items.map(i => {\r\n            if (i.id === movement.itemId) {\r\n                const newQty = Math.max(0, i.quantity + delta);\r\n                return { ...i, quantity: newQty, status: calculateStatus(newQty, i.safeStock) };\r\n            }\r\n            return i;\r\n        });\r\n\r\n        // 記錄出入庫\r\n        const newMovement = { ...movement, id: `sm-${Date.now()}` };\r\n        const newMovements = [...movements, newMovement];\r\n\r\n        setItems(newItems);\r\n        setMovements(newMovements);\r\n        if (onUpdateInventory) onUpdateInventory(newItems);\r\n        await GoogleService.syncToSheet('inventory', newItems);\r\n        addToast(`${movement.type === '入' ? '入庫' : '出庫'}成功！`, 'success');\r\n        setIsMovementModalOpen(false);\r\n        setSelectedItem(null);\r\n    };\r\n\r\n    // 開啟編輯\r\n    const openEdit = (item) => {\r\n        setSelectedItem(item);\r\n        setIsEditModalOpen(true);\r\n    };\r\n\r\n    // 開啟刪除確認\r\n    const openDelete = (item) => {\r\n        setSelectedItem(item);\r\n        setIsDeleteModalOpen(true);\r\n    };\r\n\r\n    // 開啟出入庫\r\n    const openMovement = (item, type) => {\r\n        setSelectedItem(item);\r\n        setMovementType(type);\r\n        setIsMovementModalOpen(true);\r\n    };\r\n\r\n    // 初始化庫存 Sheet\r\n    const initSheet = async () => {\r\n        setIsInitializing(true);\r\n        try {\r\n            const result = await GoogleService.initInventorySheet();\r\n            if (result.success) {\r\n                setInventorySheet({\r\n                    sheetId: result.sheetId,\r\n                    sheetUrl: result.sheetUrl,\r\n                    folderUrl: result.folderUrl\r\n                });\r\n                addToast('庫存 Sheet 建立成功！', 'success');\r\n            } else {\r\n                addToast('建立失敗：' + result.error, 'error');\r\n            }\r\n        } catch (err) {\r\n            addToast('建立失敗：' + err.message, 'error');\r\n        }\r\n        setIsInitializing(false);\r\n    };\r\n\r\n    // 同步到 Sheet\r\n    const syncToSheet = async () => {\r\n        if (!inventorySheet?.sheetId) {\r\n            addToast('請先建立庫存 Sheet', 'warning');\r\n            return;\r\n        }\r\n        setIsSyncing(true);\r\n        try {\r\n            const result = await GoogleService.syncInventoryToSheet(inventorySheet.sheetId, items);\r\n            if (result.success) {\r\n                addToast('同步成功！', 'success');\r\n            } else {\r\n                addToast('同步失敗：' + result.error, 'error');\r\n            }\r\n        } catch (err) {\r\n            addToast('同步失敗：' + err.message, 'error');\r\n        }\r\n        setIsSyncing(false);\r\n    };\r\n\r\n    // 重置 Sheet 連結\r\n    const resetSheet = () => {\r\n        localStorage.removeItem('inventorySheet');\r\n        setInventorySheet(null);\r\n        addToast('已清除 Sheet 連結，請重新建立', 'info');\r\n    };\r\n\r\n    return (\r\n        <div className=\"space-y-6 animate-fade-in\">\r\n            <div className=\"flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4\">\r\n                <SectionTitle title=\"庫存管理\" />\r\n                <div className=\"flex flex-wrap items-center gap-2\">\r\n                    {/* Sheet 管理按鈕 */}\r\n                    {!inventorySheet ? (\r\n                        <button\r\n                            onClick={initSheet}\r\n                            disabled={isInitializing}\r\n                            className=\"flex items-center gap-2 px-3 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors disabled:opacity-50 text-sm\"\r\n                        >\r\n                            {isInitializing ? (\r\n                                <RefreshCw size={16} className=\"animate-spin\" />\r\n                            ) : (\r\n                                <FileSpreadsheet size={16} />\r\n                            )}\r\n                            建立 Sheet\r\n                        </button>\r\n                    ) : (\r\n                        <>\r\n                            <button\r\n                                onClick={syncToSheet}\r\n                                disabled={isSyncing}\r\n                                className=\"flex items-center gap-2 px-3 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 transition-colors disabled:opacity-50 text-sm\"\r\n                            >\r\n                                {isSyncing ? (\r\n                                    <RefreshCw size={16} className=\"animate-spin\" />\r\n                                ) : (\r\n                                    <RefreshCw size={16} />\r\n                                )}\r\n                                同步到 Sheet\r\n                            </button>\r\n                            <a\r\n                                href={inventorySheet.sheetUrl}\r\n                                target=\"_blank\"\r\n                                rel=\"noopener noreferrer\"\r\n                                className=\"flex items-center gap-2 px-3 py-2 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 transition-colors text-sm\"\r\n                            >\r\n                                <ExternalLink size={16} />\r\n                                開啟 Sheet\r\n                            </a>\r\n                            <button\r\n                                onClick={resetSheet}\r\n                                className=\"flex items-center gap-1 px-2 py-2 text-gray-400 hover:text-red-500 hover:bg-red-50 rounded-lg transition-colors text-sm\"\r\n                                title=\"重置 Sheet 連結\"\r\n                            >\r\n                                <X size={16} />\r\n                            </button>\r\n                        </>\r\n                    )}\r\n                    <button\r\n                        onClick={() => setIsAddModalOpen(true)}\r\n                        className=\"flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors\"\r\n                    >\r\n                        <Plus size={18} />\r\n                        新增品項\r\n                    </button>\r\n                </div>\r\n            </div>\r\n\r\n            {/* 統計卡片 */}\r\n            <div className=\"grid grid-cols-2 md:grid-cols-4 gap-3 sm:gap-4\">\r\n                <StatCard\r\n                    icon={Box}\r\n                    label=\"總品項數\"\r\n                    value={stats.total}\r\n                    color=\"blue\"\r\n                />\r\n                <StatCard\r\n                    icon={AlertTriangle}\r\n                    label=\"庫存偏低\"\r\n                    value={stats.lowStock}\r\n                    color=\"orange\"\r\n                    onClick={() => setStatusFilter('庫存偏低')}\r\n                />\r\n                <StatCard\r\n                    icon={XCircle}\r\n                    label=\"缺貨\"\r\n                    value={stats.outOfStock}\r\n                    color=\"red\"\r\n                    onClick={() => setStatusFilter('缺貨')}\r\n                />\r\n                <StatCard\r\n                    icon={TrendingDown}\r\n                    label=\"本月出庫\"\r\n                    value={stats.monthOut}\r\n                    color=\"purple\"\r\n                />\r\n            </div>\r\n\r\n            {/* 搜尋與篩選 */}\r\n            <div className=\"bg-white rounded-xl p-4 shadow-sm border border-gray-100\">\r\n                <div className=\"flex flex-col md:flex-row gap-4\">\r\n                    {/* 搜尋框 */}\r\n                    <div className=\"flex-1 relative\">\r\n                        <Search size={18} className=\"absolute left-3 top-1/2 -translate-y-1/2 text-gray-400\" />\r\n                        <input\r\n                            type=\"text\"\r\n                            value={searchTerm}\r\n                            onChange={(e) => setSearchTerm(e.target.value)}\r\n                            placeholder=\"搜尋品名或規格...\"\r\n                            className=\"w-full pl-10 pr-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent\"\r\n                        />\r\n                    </div>\r\n\r\n                    {/* 主類別篩選 */}\r\n                    <select\r\n                        value={mainCategoryFilter}\r\n                        onChange={(e) => {\r\n                            setMainCategoryFilter(e.target.value);\r\n                            setSubCategoryFilter('全部'); // 重置子類別\r\n                        }}\r\n                        className=\"px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 bg-white\"\r\n                    >\r\n                        {MAIN_CATEGORIES.map(cat => (\r\n                            <option key={cat} value={cat}>{cat === '全部' ? '所有主類別' : cat}</option>\r\n                        ))}\r\n                    </select>\r\n\r\n                    {/* 子類別篩選 */}\r\n                    <select\r\n                        value={subCategoryFilter}\r\n                        onChange={(e) => setSubCategoryFilter(e.target.value)}\r\n                        className=\"px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 bg-white\"\r\n                    >\r\n                        <option value=\"全部\">所有子類別</option>\r\n                        {getSubCategories(mainCategoryFilter).map(cat => (\r\n                            <option key={cat} value={cat}>{cat}</option>\r\n                        ))}\r\n                    </select>\r\n\r\n                    {/* 狀態篩選 */}\r\n                    <select\r\n                        value={statusFilter}\r\n                        onChange={(e) => setStatusFilter(e.target.value)}\r\n                        className=\"px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 bg-white\"\r\n                    >\r\n                        {STATUS_OPTIONS.map(status => (\r\n                            <option key={status} value={status}>{status === '全部' ? '所有狀態' : status}</option>\r\n                        ))}\r\n                    </select>\r\n\r\n                    {/* 清除篩選 */}\r\n                    {(searchTerm || mainCategoryFilter !== '全部' || subCategoryFilter !== '全部' || statusFilter !== '全部') && (\r\n                        <button\r\n                            onClick={() => {\r\n                                setSearchTerm('');\r\n                                setMainCategoryFilter('全部');\r\n                                setSubCategoryFilter('全部');\r\n                                setStatusFilter('全部');\r\n                            }}\r\n                            className=\"px-4 py-2 text-gray-500 hover:text-gray-700 flex items-center gap-1\"\r\n                        >\r\n                            <X size={16} />\r\n                            清除\r\n                        </button>\r\n                    )}\r\n                </div>\r\n            </div>\r\n\r\n            {/* 庫存列表 */}\r\n            <div className=\"bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden\">\r\n                <div className=\"overflow-x-auto\">\r\n                    <table className=\"w-full text-sm\">\r\n                        <thead className=\"bg-gray-50 text-gray-600\">\r\n                            <tr>\r\n                                <th className=\"text-left p-4 font-medium\">品名</th>\r\n                                <th className=\"text-left p-4 font-medium\">規格</th>\r\n                                <th className=\"text-left p-4 font-medium\">類別</th>\r\n                                <th className=\"text-center p-4 font-medium\">數量</th>\r\n                                <th className=\"text-center p-4 font-medium\">安全存量</th>\r\n                                <th className=\"text-left p-4 font-medium\">位置</th>\r\n                                <th className=\"text-center p-4 font-medium\">狀態</th>\r\n                                <th className=\"text-center p-4 font-medium\">操作</th>\r\n                            </tr>\r\n                        </thead>\r\n                        <tbody>\r\n                            {filteredItems.length === 0 ? (\r\n                                <tr>\r\n                                    <td colSpan={8} className=\"text-center py-12 text-gray-400\">\r\n                                        <Package size={48} className=\"mx-auto mb-2 opacity-50\" />\r\n                                        <p>沒有找到符合條件的品項</p>\r\n                                    </td>\r\n                                </tr>\r\n                            ) : (\r\n                                filteredItems.map(item => (\r\n                                    <tr key={item.id} className=\"border-t border-gray-100 hover:bg-gray-50 transition-colors\">\r\n                                        <td className=\"p-4\">\r\n                                            <div className=\"font-medium text-gray-800\">{item.name}</div>\r\n                                        </td>\r\n                                        <td className=\"p-4 text-gray-500\">{item.spec || '-'}</td>\r\n                                        <td className=\"p-4\">\r\n                                            <div className=\"flex flex-col gap-0.5\">\r\n                                                <span className=\"text-xs text-gray-400\">{item.mainCategory || getMainCategory(item.category)}</span>\r\n                                                <span className=\"px-2 py-1 bg-gray-100 text-gray-600 rounded text-xs inline-block w-fit\">\r\n                                                    {item.category || '其他'}\r\n                                                </span>\r\n                                            </div>\r\n                                        </td>\r\n                                        <td className=\"p-4 text-center\">\r\n                                            <span className=\"font-mono font-bold text-gray-800\">{item.quantity}</span>\r\n                                            <span className=\"text-gray-400 ml-1\">{item.unit}</span>\r\n                                        </td>\r\n                                        <td className=\"p-4 text-center text-gray-500\">{item.safeStock}</td>\r\n                                        <td className=\"p-4\">\r\n                                            {item.location ? (\r\n                                                <span className=\"flex items-center gap-1 text-gray-600\">\r\n                                                    <MapPin size={14} />\r\n                                                    {item.location}\r\n                                                </span>\r\n                                            ) : '-'}\r\n                                        </td>\r\n                                        <td className=\"p-4 text-center\">\r\n                                            <Badge color={getStatusColor(item.status)}>{item.status}</Badge>\r\n                                        </td>\r\n                                        <td className=\"p-4\">\r\n                                            <div className=\"flex items-center justify-center gap-1\">\r\n                                                <button\r\n                                                    onClick={() => openMovement(item, '入')}\r\n                                                    className=\"p-1.5 text-green-600 hover:bg-green-50 rounded-lg transition-colors\"\r\n                                                    title=\"入庫\"\r\n                                                >\r\n                                                    <ArrowDownCircle size={18} />\r\n                                                </button>\r\n                                                <button\r\n                                                    onClick={() => openMovement(item, '出')}\r\n                                                    className=\"p-1.5 text-purple-600 hover:bg-purple-50 rounded-lg transition-colors\"\r\n                                                    title=\"出庫\"\r\n                                                >\r\n                                                    <ArrowUpCircle size={18} />\r\n                                                </button>\r\n                                                <button\r\n                                                    onClick={() => openEdit(item)}\r\n                                                    className=\"p-1.5 text-blue-600 hover:bg-blue-50 rounded-lg transition-colors\"\r\n                                                    title=\"編輯\"\r\n                                                >\r\n                                                    <Edit2 size={18} />\r\n                                                </button>\r\n                                                <button\r\n                                                    onClick={() => openDelete(item)}\r\n                                                    className=\"p-1.5 text-red-600 hover:bg-red-50 rounded-lg transition-colors\"\r\n                                                    title=\"刪除\"\r\n                                                >\r\n                                                    <Trash2 size={18} />\r\n                                                </button>\r\n                                            </div>\r\n                                        </td>\r\n                                    </tr>\r\n                                ))\r\n                            )}\r\n                        </tbody>\r\n                    </table>\r\n                </div>\r\n\r\n                {/* 列表底部資訊 */}\r\n                <div className=\"px-4 py-3 bg-gray-50 border-t border-gray-100 text-sm text-gray-500\">\r\n                    顯示 {filteredItems.length} / {items.length} 筆資料\r\n                </div>\r\n            </div>\r\n\r\n            {/* 最近出入庫記錄 */}\r\n            {movements.length > 0 && (\r\n                <div className=\"bg-white rounded-xl p-4 shadow-sm border border-gray-100\">\r\n                    <h4 className=\"font-bold text-gray-700 mb-3 flex items-center gap-2\">\r\n                        <History size={18} />\r\n                        最近出入庫記錄\r\n                    </h4>\r\n                    <div className=\"space-y-2\">\r\n                        {movements.slice(-5).reverse().map(m => (\r\n                            <div key={m.id} className=\"flex items-center justify-between py-2 border-b border-gray-100 last:border-0\">\r\n                                <div className=\"flex items-center gap-3\">\r\n                                    {m.type === '入' ? (\r\n                                        <ArrowDownCircle size={18} className=\"text-green-500\" />\r\n                                    ) : (\r\n                                        <ArrowUpCircle size={18} className=\"text-purple-500\" />\r\n                                    )}\r\n                                    <div>\r\n                                        <div className=\"font-medium text-gray-700\">{m.itemName}</div>\r\n                                        <div className=\"text-xs text-gray-400\">{m.note || '-'}</div>\r\n                                    </div>\r\n                                </div>\r\n                                <div className=\"text-right\">\r\n                                    <div className={`font-bold ${m.type === '入' ? 'text-green-600' : 'text-purple-600'}`}>\r\n                                        {m.type === '入' ? '+' : '-'}{m.quantity}\r\n                                    </div>\r\n                                    <div className=\"text-xs text-gray-400\">{formatDate(m.date)}</div>\r\n                                </div>\r\n                            </div>\r\n                        ))}\r\n                    </div>\r\n                </div>\r\n            )}\r\n\r\n            {/* Modals */}\r\n            <ItemModal\r\n                isOpen={isAddModalOpen}\r\n                onClose={() => setIsAddModalOpen(false)}\r\n                item={null}\r\n                onSave={handleAddItem}\r\n                isEdit={false}\r\n            />\r\n            <ItemModal\r\n                isOpen={isEditModalOpen}\r\n                onClose={() => { setIsEditModalOpen(false); setSelectedItem(null); }}\r\n                item={selectedItem}\r\n                onSave={handleEditItem}\r\n                isEdit={true}\r\n            />\r\n            <DeleteConfirmModal\r\n                isOpen={isDeleteModalOpen}\r\n                onClose={() => { setIsDeleteModalOpen(false); setSelectedItem(null); }}\r\n                item={selectedItem}\r\n                onConfirm={handleDeleteItem}\r\n            />\r\n            <StockMovementModal\r\n                isOpen={isMovementModalOpen}\r\n                onClose={() => { setIsMovementModalOpen(false); setSelectedItem(null); }}\r\n                item={selectedItem}\r\n                type={movementType}\r\n                onConfirm={handleStockMovement}\r\n            />\r\n        </div>\r\n    );\r\n};\r\n\r\nexport default Inventory;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\xiang\\senteng-frontend\\src\\pages\\InvoiceHelper.jsx","messages":[{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\n  112 |         if (taxType === 'exempt' || taxType === 'zeroRate') {\n  113 |             // 免稅或零稅率\n> 114 |             setSalesAmount(num);\n      |             ^^^^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  115 |             setTaxAmount(0);\n  116 |             setTotalAmount(num);\n  117 |         } else {","line":114,"column":13,"nodeType":null,"endLine":114,"endColumn":27},{"ruleId":"no-unused-vars","severity":2,"message":"'color' is defined but never used. Allowed unused args must match /^_|^e$|^err$|^event$/u.","line":264,"column":49,"nodeType":"Identifier","messageId":"unusedVar","endLine":264,"endColumn":54,"suggestions":[{"messageId":"removeVar","data":{"varName":"color"},"fix":{"range":[10986,10993],"text":""},"desc":"Remove unused variable 'color'."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\r\nimport React, { useState, useEffect } from 'react';\r\nimport { FileText, Calculator, Building2, User, Copy, RotateCcw, Check, AlertCircle, Info } from 'lucide-react';\r\nimport { SectionTitle } from '../components/common/Indicators';\r\n\r\n// 數字轉中文大寫（正確處理萬、億單位）\r\nconst numberToChinese = (num) => {\r\n    if (num === 0) return '零';\r\n\r\n    const digits = ['零', '壹', '貳', '參', '肆', '伍', '陸', '柒', '捌', '玖'];\r\n    const smallUnits = ['', '拾', '佰', '仟'];\r\n\r\n    // 將數字分解為億、萬、個位數組\r\n    const n = Math.floor(num);\r\n    const yi = Math.floor(n / 100000000); // 億\r\n    const wan = Math.floor((n % 100000000) / 10000); // 萬\r\n    const ge = n % 10000; // 個位到仟位\r\n\r\n    // 轉換四位數為中文\r\n    const fourDigitToChinese = (n, addZeroPrefix = false) => {\r\n        if (n === 0) return '';\r\n\r\n        let result = '';\r\n        const arr = [\r\n            Math.floor(n / 1000),      // 仟位\r\n            Math.floor((n % 1000) / 100), // 佰位\r\n            Math.floor((n % 100) / 10),   // 拾位\r\n            n % 10                        // 個位\r\n        ];\r\n\r\n        let hasValue = false;\r\n        let needZero = addZeroPrefix && n < 1000;\r\n\r\n        for (let i = 0; i < 4; i++) {\r\n            if (arr[i] !== 0) {\r\n                if (needZero) {\r\n                    result += '零';\r\n                    needZero = false;\r\n                }\r\n                result += digits[arr[i]] + smallUnits[3 - i];\r\n                hasValue = true;\r\n            } else if (hasValue) {\r\n                needZero = true;\r\n            }\r\n        }\r\n\r\n        return result;\r\n    };\r\n\r\n    let result = '';\r\n\r\n    // 處理億\r\n    if (yi > 0) {\r\n        result += fourDigitToChinese(yi) + '億';\r\n    }\r\n\r\n    // 處理萬\r\n    if (wan > 0) {\r\n        result += fourDigitToChinese(wan, yi > 0) + '萬';\r\n    } else if (yi > 0 && ge > 0) {\r\n        // 億有值但萬沒有，個有值時需要補零\r\n    }\r\n\r\n    // 處理個位到仟位\r\n    if (ge > 0) {\r\n        const needZero = (yi > 0 || wan > 0) && ge < 1000;\r\n        result += fourDigitToChinese(ge, needZero);\r\n    }\r\n\r\n    return result || '零';\r\n};\r\n\r\n// 格式化金額顯示\r\nconst formatCurrency = (num) => {\r\n    if (!num) return '0';\r\n    return Math.round(num).toLocaleString('zh-TW');\r\n};\r\n\r\nexport const InvoiceHelper = ({ addToast }) => {\r\n    // 發票類型：triple (三聯式) / double (二聯式)\r\n    const [invoiceType, setInvoiceType] = useState('triple');\r\n\r\n    // 稅率類型\r\n    const [taxType, setTaxType] = useState('taxable'); // taxable, zeroRate, exempt\r\n\r\n    // 輸入模式：含稅價 / 未稅價\r\n    const [inputMode, setInputMode] = useState('withTax');\r\n\r\n    // 金額\r\n    const [amount, setAmount] = useState('');\r\n    const [salesAmount, setSalesAmount] = useState(0); // 銷售額（未稅）\r\n    const [taxAmount, setTaxAmount] = useState(0); // 營業稅額\r\n    const [totalAmount, setTotalAmount] = useState(0); // 總計（含稅）\r\n\r\n    // 買受人資訊\r\n    const [buyerTaxId, setBuyerTaxId] = useState('');\r\n    const [buyerName, setBuyerName] = useState('');\r\n\r\n    // 品名\r\n    const [itemName, setItemName] = useState('');\r\n\r\n    // 日期\r\n    const [invoiceDate, setInvoiceDate] = useState(new Date().toISOString().split('T')[0]);\r\n\r\n    // 複製狀態\r\n    const [copied, setCopied] = useState('');\r\n\r\n    // 計算稅額\r\n    useEffect(() => {\r\n        const num = parseFloat(amount) || 0;\r\n\r\n        if (taxType === 'exempt' || taxType === 'zeroRate') {\r\n            // 免稅或零稅率\r\n            setSalesAmount(num);\r\n            setTaxAmount(0);\r\n            setTotalAmount(num);\r\n        } else {\r\n            // 應稅 5%\r\n            if (inputMode === 'withTax') {\r\n                // 輸入含稅價\r\n                const sales = Math.round(num / 1.05);\r\n                const tax = num - sales;\r\n                setSalesAmount(sales);\r\n                setTaxAmount(tax);\r\n                setTotalAmount(num);\r\n            } else {\r\n                // 輸入未稅價\r\n                const tax = Math.round(num * 0.05);\r\n                const total = num + tax;\r\n                setSalesAmount(num);\r\n                setTaxAmount(tax);\r\n                setTotalAmount(total);\r\n            }\r\n        }\r\n    }, [amount, inputMode, taxType]);\r\n\r\n    // 重設表單\r\n    const handleReset = () => {\r\n        setAmount('');\r\n        setBuyerTaxId('');\r\n        setBuyerName('');\r\n        setItemName('');\r\n        setInvoiceDate(new Date().toISOString().split('T')[0]);\r\n        addToast?.('表單已重設', 'info');\r\n    };\r\n\r\n    // 複製到剪貼簿\r\n    const handleCopy = (value, label) => {\r\n        navigator.clipboard.writeText(value.toString());\r\n        setCopied(label);\r\n        setTimeout(() => setCopied(''), 2000);\r\n        addToast?.(`已複製 ${label}`, 'success');\r\n    };\r\n\r\n    // 獲取稅率百分比\r\n    const getTaxRate = () => {\r\n        switch (taxType) {\r\n            case 'zeroRate': return '0%';\r\n            case 'exempt': return '免稅';\r\n            default: return '5%';\r\n        }\r\n    };\r\n\r\n    return (\r\n        <div className=\"space-y-6 animate-fade-in\">\r\n            <SectionTitle title=\"發票小幫手\" />\r\n\r\n            {/* 說明區 */}\r\n            <div className=\"bg-blue-50 border border-blue-200 rounded-2xl p-4 flex gap-3\">\r\n                <Info size={20} className=\"text-blue-500 flex-shrink-0 mt-0.5\" />\r\n                <div className=\"text-sm text-blue-800\">\r\n                    <p className=\"font-medium mb-1\">手開發票輔助工具</p>\r\n                    <p className=\"text-blue-600\">輸入金額後，系統會自動計算稅額並顯示發票填寫示意圖，幫助您正確填寫手開發票。</p>\r\n                </div>\r\n            </div>\r\n\r\n            <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6\">\r\n                {/* 左側：輸入區 */}\r\n                <div className=\"space-y-4\">\r\n                    {/* 發票類型選擇 */}\r\n                    <div className=\"bg-white rounded-2xl p-5 shadow-sm border border-gray-100\">\r\n                        <label className=\"block text-sm font-medium text-gray-700 mb-3\">發票類型</label>\r\n                        <div className=\"grid grid-cols-2 gap-3\">\r\n                            <button\r\n                                onClick={() => setInvoiceType('triple')}\r\n                                className={`p-4 rounded-xl border-2 transition-all flex flex-col items-center gap-2 ${invoiceType === 'triple'\r\n                                    ? 'border-blue-500 bg-blue-50 text-blue-700'\r\n                                    : 'border-gray-200 hover:border-gray-300'\r\n                                    }`}\r\n                            >\r\n                                <Building2 size={24} />\r\n                                <span className=\"font-bold\">三聯式發票</span>\r\n                                <span className=\"text-xs text-gray-500\">開給公司行號</span>\r\n                            </button>\r\n                            <button\r\n                                onClick={() => setInvoiceType('double')}\r\n                                className={`p-4 rounded-xl border-2 transition-all flex flex-col items-center gap-2 ${invoiceType === 'double'\r\n                                    ? 'border-green-500 bg-green-50 text-green-700'\r\n                                    : 'border-gray-200 hover:border-gray-300'\r\n                                    }`}\r\n                            >\r\n                                <User size={24} />\r\n                                <span className=\"font-bold\">二聯式發票</span>\r\n                                <span className=\"text-xs text-gray-500\">開給個人消費者</span>\r\n                            </button>\r\n                        </div>\r\n                    </div>\r\n\r\n                    {/* 買受人資訊（三聯式才顯示） */}\r\n                    {invoiceType === 'triple' && (\r\n                        <div className=\"bg-white rounded-2xl p-5 shadow-sm border border-gray-100\">\r\n                            <label className=\"block text-sm font-medium text-gray-700 mb-3\">買受人資訊</label>\r\n                            <div className=\"space-y-3\">\r\n                                <div>\r\n                                    <label className=\"block text-xs text-gray-500 mb-1\">統一編號</label>\r\n                                    <input\r\n                                        type=\"text\"\r\n                                        value={buyerTaxId}\r\n                                        onChange={(e) => setBuyerTaxId(e.target.value.replace(/\\D/g, '').slice(0, 8))}\r\n                                        placeholder=\"請輸入8位數統編\"\r\n                                        maxLength={8}\r\n                                        className=\"w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 outline-none transition-all font-mono text-lg tracking-widest\"\r\n                                    />\r\n                                    {buyerTaxId && buyerTaxId.length !== 8 && (\r\n                                        <p className=\"text-xs text-orange-500 mt-1 flex items-center gap-1\">\r\n                                            <AlertCircle size={12} /> 統一編號應為8位數\r\n                                        </p>\r\n                                    )}\r\n                                </div>\r\n                                <div>\r\n                                    <label className=\"block text-xs text-gray-500 mb-1\">公司抬頭</label>\r\n                                    <input\r\n                                        type=\"text\"\r\n                                        value={buyerName}\r\n                                        onChange={(e) => setBuyerName(e.target.value)}\r\n                                        placeholder=\"請輸入公司名稱\"\r\n                                        className=\"w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 outline-none transition-all\"\r\n                                    />\r\n                                </div>\r\n                            </div>\r\n                        </div>\r\n                    )}\r\n\r\n                    {/* 品名 */}\r\n                    <div className=\"bg-white rounded-2xl p-5 shadow-sm border border-gray-100\">\r\n                        <label className=\"block text-sm font-medium text-gray-700 mb-3\">品名</label>\r\n                        <input\r\n                            type=\"text\"\r\n                            value={itemName}\r\n                            onChange={(e) => setItemName(e.target.value)}\r\n                            placeholder=\"例：室內設計服務費\"\r\n                            className=\"w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 outline-none transition-all\"\r\n                        />\r\n                    </div>\r\n\r\n                    {/* 稅率與金額 */}\r\n                    <div className=\"bg-white rounded-2xl p-5 shadow-sm border border-gray-100\">\r\n                        <label className=\"block text-sm font-medium text-gray-700 mb-3\">稅率類型</label>\r\n                        <div className=\"flex gap-2 mb-4\">\r\n                            {[\r\n                                { id: 'taxable', label: '應稅 5%', color: 'blue' },\r\n                                { id: 'zeroRate', label: '零稅率', color: 'gray' },\r\n                                { id: 'exempt', label: '免稅', color: 'gray' }\r\n                            ].map(({ id, label, color }) => (\r\n                                <button\r\n                                    key={id}\r\n                                    onClick={() => setTaxType(id)}\r\n                                    className={`flex-1 py-2 px-3 rounded-lg text-sm font-medium transition-all ${taxType === id\r\n                                        ? 'bg-blue-600 text-white'\r\n                                        : 'bg-gray-100 text-gray-600 hover:bg-gray-200'\r\n                                        }`}\r\n                                >\r\n                                    {label}\r\n                                </button>\r\n                            ))}\r\n                        </div>\r\n\r\n                        <label className=\"block text-sm font-medium text-gray-700 mb-3\">輸入金額</label>\r\n                        <div className=\"flex gap-2 mb-3\">\r\n                            <button\r\n                                onClick={() => setInputMode('withTax')}\r\n                                className={`flex-1 py-2 px-3 rounded-lg text-sm transition-all ${inputMode === 'withTax'\r\n                                    ? 'bg-gray-800 text-white'\r\n                                    : 'bg-gray-100 text-gray-600 hover:bg-gray-200'\r\n                                    }`}\r\n                            >\r\n                                含稅價\r\n                            </button>\r\n                            <button\r\n                                onClick={() => setInputMode('withoutTax')}\r\n                                className={`flex-1 py-2 px-3 rounded-lg text-sm transition-all ${inputMode === 'withoutTax'\r\n                                    ? 'bg-gray-800 text-white'\r\n                                    : 'bg-gray-100 text-gray-600 hover:bg-gray-200'\r\n                                    }`}\r\n                            >\r\n                                未稅價\r\n                            </button>\r\n                        </div>\r\n\r\n                        <div className=\"relative\">\r\n                            <span className=\"absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 font-medium\">NT$</span>\r\n                            <input\r\n                                type=\"number\"\r\n                                value={amount}\r\n                                onChange={(e) => setAmount(e.target.value)}\r\n                                placeholder=\"0\"\r\n                                className=\"w-full pl-14 pr-4 py-4 rounded-xl border border-gray-200 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 outline-none transition-all text-2xl font-bold text-right\"\r\n                            />\r\n                        </div>\r\n                    </div>\r\n\r\n                    {/* 計算結果 */}\r\n                    <div className=\"bg-gradient-to-br from-gray-800 to-gray-900 rounded-2xl p-5 text-white\">\r\n                        <div className=\"flex justify-between items-center mb-4\">\r\n                            <span className=\"text-gray-400\">計算結果</span>\r\n                            <span className=\"text-xs bg-white/10 px-2 py-1 rounded\">稅率: {getTaxRate()}</span>\r\n                        </div>\r\n\r\n                        <div className=\"space-y-3\">\r\n                            <div className=\"flex justify-between items-center\">\r\n                                <span className=\"text-gray-400\">銷售額（未稅）</span>\r\n                                <button\r\n                                    onClick={() => handleCopy(salesAmount, '銷售額')}\r\n                                    className=\"flex items-center gap-2 hover:bg-white/10 px-3 py-1 rounded-lg transition-colors\"\r\n                                >\r\n                                    <span className=\"text-xl font-bold\">${formatCurrency(salesAmount)}</span>\r\n                                    {copied === '銷售額' ? <Check size={16} className=\"text-green-400\" /> : <Copy size={14} />}\r\n                                </button>\r\n                            </div>\r\n                            <div className=\"flex justify-between items-center\">\r\n                                <span className=\"text-gray-400\">營業稅額</span>\r\n                                <button\r\n                                    onClick={() => handleCopy(taxAmount, '稅額')}\r\n                                    className=\"flex items-center gap-2 hover:bg-white/10 px-3 py-1 rounded-lg transition-colors\"\r\n                                >\r\n                                    <span className=\"text-xl font-bold\">${formatCurrency(taxAmount)}</span>\r\n                                    {copied === '稅額' ? <Check size={16} className=\"text-green-400\" /> : <Copy size={14} />}\r\n                                </button>\r\n                            </div>\r\n                            <div className=\"border-t border-white/20 pt-3 flex justify-between items-center\">\r\n                                <span className=\"text-white font-medium\">總計（含稅）</span>\r\n                                <button\r\n                                    onClick={() => handleCopy(totalAmount, '總計')}\r\n                                    className=\"flex items-center gap-2 hover:bg-white/10 px-3 py-1 rounded-lg transition-colors\"\r\n                                >\r\n                                    <span className=\"text-2xl font-bold text-yellow-400\">${formatCurrency(totalAmount)}</span>\r\n                                    {copied === '總計' ? <Check size={16} className=\"text-green-400\" /> : <Copy size={14} />}\r\n                                </button>\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n\r\n                    {/* 操作按鈕 */}\r\n                    <button\r\n                        onClick={handleReset}\r\n                        className=\"w-full flex items-center justify-center gap-2 py-3 rounded-xl border border-gray-300 text-gray-600 hover:bg-gray-50 transition-colors\"\r\n                    >\r\n                        <RotateCcw size={18} />\r\n                        重設表單\r\n                    </button>\r\n                </div>\r\n\r\n                {/* 右側：發票預覽 */}\r\n                <div className=\"space-y-4\">\r\n                    <div className={`rounded-2xl p-6 shadow-lg border-2 ${invoiceType === 'triple'\r\n                        ? 'bg-blue-50 border-blue-300'\r\n                        : 'bg-green-50 border-green-300'\r\n                        }`}>\r\n                        <div className=\"flex justify-between items-start mb-4\">\r\n                            <div>\r\n                                <h3 className={`text-lg font-bold ${invoiceType === 'triple' ? 'text-blue-800' : 'text-green-800'}`}>\r\n                                    {invoiceType === 'triple' ? '三聯式統一發票' : '二聯式統一發票'}\r\n                                </h3>\r\n                                <p className=\"text-xs text-gray-500 mt-1\">\r\n                                    {invoiceType === 'triple' ? '收執聯・交付買受人作為記帳憑證' : '收執聯・交付買受人'}\r\n                                </p>\r\n                            </div>\r\n                            <div className=\"text-right\">\r\n                                <div className=\"text-xs text-gray-500\">發票日期</div>\r\n                                <input\r\n                                    type=\"date\"\r\n                                    value={invoiceDate}\r\n                                    onChange={(e) => setInvoiceDate(e.target.value)}\r\n                                    className=\"bg-transparent text-sm font-mono\"\r\n                                />\r\n                            </div>\r\n                        </div>\r\n\r\n                        {/* 發票內容預覽 */}\r\n                        <div className=\"bg-white rounded-xl p-4 space-y-4 font-mono text-sm\">\r\n                            {/* 買受人區 */}\r\n                            {invoiceType === 'triple' && (\r\n                                <div className=\"grid grid-cols-2 gap-4 pb-3 border-b border-dashed border-gray-300\">\r\n                                    <div>\r\n                                        <div className=\"text-xs text-gray-400 mb-1\">統一編號</div>\r\n                                        <div className=\"text-lg font-bold tracking-widest\">\r\n                                            {buyerTaxId || '________'}\r\n                                        </div>\r\n                                    </div>\r\n                                    <div>\r\n                                        <div className=\"text-xs text-gray-400 mb-1\">買受人</div>\r\n                                        <div className=\"font-bold truncate\">\r\n                                            {buyerName || '________________'}\r\n                                        </div>\r\n                                    </div>\r\n                                </div>\r\n                            )}\r\n\r\n                            {/* 品名區 */}\r\n                            <div className=\"pb-3 border-b border-dashed border-gray-300\">\r\n                                <div className=\"text-xs text-gray-400 mb-1\">品名</div>\r\n                                <div className=\"font-medium\">\r\n                                    {itemName || '________________________'}\r\n                                </div>\r\n                            </div>\r\n\r\n                            {/* 金額區 */}\r\n                            <div className=\"space-y-2\">\r\n                                {invoiceType === 'triple' ? (\r\n                                    <>\r\n                                        <div className=\"flex justify-between\">\r\n                                            <span className=\"text-gray-500\">銷售額（未稅）</span>\r\n                                            <span className=\"font-bold\">${formatCurrency(salesAmount)}</span>\r\n                                        </div>\r\n                                        <div className=\"flex justify-between\">\r\n                                            <span className=\"text-gray-500\">\r\n                                                營業稅額\r\n                                                <span className=\"ml-2 text-xs\">\r\n                                                    {taxType === 'taxable' && '☑應稅'}\r\n                                                    {taxType === 'zeroRate' && '☑零稅率'}\r\n                                                    {taxType === 'exempt' && '☑免稅'}\r\n                                                </span>\r\n                                            </span>\r\n                                            <span className=\"font-bold\">${formatCurrency(taxAmount)}</span>\r\n                                        </div>\r\n                                    </>\r\n                                ) : null}\r\n                                <div className={`flex justify-between pt-2 ${invoiceType === 'triple' ? 'border-t border-gray-200' : ''}`}>\r\n                                    <span className=\"font-medium\">總計</span>\r\n                                    <span className=\"font-bold text-lg\">${formatCurrency(totalAmount)}</span>\r\n                                </div>\r\n                            </div>\r\n\r\n                            {/* 中文大寫金額 */}\r\n                            <div className=\"pt-3 border-t border-dashed border-gray-300\">\r\n                                <div className=\"text-xs text-gray-400 mb-1\">總計（中文大寫）</div>\r\n                                <div className=\"text-lg font-bold tracking-wide text-red-700\">\r\n                                    新台幣 {totalAmount > 0 ? numberToChinese(totalAmount) : '零'} 元整\r\n                                </div>\r\n                            </div>\r\n                        </div>\r\n\r\n                        {/* 發票章區 */}\r\n                        <div className=\"mt-4 flex justify-end\">\r\n                            <div className=\"border-2 border-red-400 rounded-lg p-3 text-center bg-white/50\">\r\n                                <div className=\"text-xs text-red-500 mb-1\">統一發票專用章</div>\r\n                                <div className=\"text-red-600 font-bold\">森騰室內設計</div>\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n\r\n                    {/* 填寫提示 */}\r\n                    <div className=\"bg-yellow-50 border border-yellow-200 rounded-2xl p-4\">\r\n                        <h4 className=\"font-bold text-yellow-800 mb-2 flex items-center gap-2\">\r\n                            <AlertCircle size={18} />\r\n                            填寫注意事項\r\n                        </h4>\r\n                        <ul className=\"text-sm text-yellow-700 space-y-1\">\r\n                            {invoiceType === 'triple' ? (\r\n                                <>\r\n                                    <li>• 三聯式發票開給有統編的公司行號</li>\r\n                                    <li>• 買受人可用扣抵聯申報進項稅額扣抵</li>\r\n                                    <li>• 金額需分開填寫未稅價與稅額</li>\r\n                                    <li>• 三聯都需蓋統一發票專用章</li>\r\n                                </>\r\n                            ) : (\r\n                                <>\r\n                                    <li>• 二聯式發票開給個人消費者</li>\r\n                                    <li>• 金額為含稅價，稅金已內含</li>\r\n                                    <li>• 買受人欄位可不填或填姓名</li>\r\n                                    <li>• 若填統編則不可對獎</li>\r\n                                </>\r\n                            )}\r\n                            <li>• 總金額請用中文大寫填寫</li>\r\n                            <li>• 發票依日期順序開立，不可跳開或倒開</li>\r\n                        </ul>\r\n                    </div>\r\n\r\n                    {/* 快速參考 */}\r\n                    <div className=\"bg-white rounded-2xl p-4 shadow-sm border border-gray-100\">\r\n                        <h4 className=\"font-bold text-gray-800 mb-3\">中文大寫數字對照</h4>\r\n                        <div className=\"grid grid-cols-5 gap-1 sm:gap-2 text-center text-xs sm:text-sm\">\r\n                            {['零', '壹', '貳', '參', '肆', '伍', '陸', '柒', '捌', '玖'].map((char, i) => (\r\n                                <div key={i} className=\"bg-gray-50 rounded-lg py-2\">\r\n                                    <div className=\"text-gray-400 text-xs\">{i}</div>\r\n                                    <div className=\"font-bold text-lg\">{char}</div>\r\n                                </div>\r\n                            ))}\r\n                        </div>\r\n                        <div className=\"mt-3 grid grid-cols-4 gap-2 text-center text-sm\">\r\n                            {[['拾', '10'], ['佰', '100'], ['仟', '1000'], ['萬', '10000']].map(([char, num]) => (\r\n                                <div key={num} className=\"bg-gray-50 rounded-lg py-2\">\r\n                                    <div className=\"text-gray-400 text-xs\">{num}</div>\r\n                                    <div className=\"font-bold text-lg\">{char}</div>\r\n                                </div>\r\n                            ))}\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n        </div>\r\n    );\r\n};\r\n\r\nexport default InvoiceHelper;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\xiang\\senteng-frontend\\src\\pages\\LoginPage.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\xiang\\senteng-frontend\\src\\pages\\MaterialCalculator.jsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook React.useEffect has missing dependencies: 'onChange', 'subtotal', and 'vendors'. Either include them or remove the dependency array. If 'onChange' changes too often, find the parent component that defines it and wrap that definition in useCallback.","line":288,"column":8,"nodeType":"ArrayExpression","endLine":288,"endColumn":53,"suggestions":[{"desc":"Update the dependencies array to be: [selectedVendor, spec, price, note, quantity, onChange, vendors, subtotal]","fix":{"range":[11526,11571],"text":"[selectedVendor, spec, price, note, quantity, onChange, vendors, subtotal]"}}]},{"ruleId":"no-unused-vars","severity":2,"message":"'setCustomTileL' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]|^_/u.","line":1601,"column":25,"nodeType":"Identifier","messageId":"unusedVar","endLine":1601,"endColumn":39,"suggestions":[{"messageId":"removeVar","data":{"varName":"setCustomTileL"},"fix":{"range":[89726,89742],"text":""},"desc":"Remove unused variable 'setCustomTileL'."}]},{"ruleId":"no-unused-vars","severity":2,"message":"'setCustomTileW' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]|^_/u.","line":1602,"column":25,"nodeType":"Identifier","messageId":"unusedVar","endLine":1602,"endColumn":39,"suggestions":[{"messageId":"removeVar","data":{"varName":"setCustomTileW"},"fix":{"range":[89785,89801],"text":""},"desc":"Remove unused variable 'setCustomTileW'."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\r\nimport React, { useState } from 'react';\r\nimport {\r\n    Calculator, Building2, Layers, Grid3X3, Paintbrush, BarChart3,\r\n    Info, RotateCcw, Settings2, ChevronDown, ChevronUp, Copy, Check,\r\n    FileSpreadsheet, Plus, Trash2, ExternalLink, RefreshCw\r\n} from 'lucide-react';\r\nimport { SectionTitle } from '../components/common/Indicators';\r\nimport { GoogleService } from '../services/GoogleService';\r\n\r\n// ============================================\r\n// 計算公式與常數定義\r\n// ============================================\r\n\r\n// 預設損耗率 (%)\r\nconst DEFAULT_WASTAGE = {\r\n    concrete: 3,\r\n    rebar: 5,\r\n    formwork: 10,\r\n    cement: 10,\r\n    sand: 10,\r\n    brick: 5,\r\n    tile: 5,\r\n    grout: 15,\r\n    adhesive: 10,\r\n    paint: 10,\r\n    putty: 10,\r\n};\r\n\r\n// 紅磚用量對照表 (塊/m²)\r\nconst BRICK_PER_SQM = {\r\n    '12': { label: '12牆 (12cm)', count: 64 },\r\n    '18': { label: '18牆 (18cm)', count: 96 },\r\n    '24': { label: '24牆 (24cm)', count: 128 },\r\n    '37': { label: '37牆 (37cm)', count: 192 },\r\n};\r\n\r\n// 磁磚尺寸選項\r\nconst TILE_SIZES = [\r\n    { label: '30×30 cm', l: 30, w: 30 },\r\n    { label: '30×60 cm', l: 30, w: 60 },\r\n    { label: '45×45 cm', l: 45, w: 45 },\r\n    { label: '60×60 cm', l: 60, w: 60 },\r\n    { label: '60×120 cm', l: 60, w: 120 },\r\n    { label: '80×80 cm', l: 80, w: 80 },\r\n    { label: '自訂', l: 0, w: 0 },\r\n];\r\n\r\n// 磁磚施工方法分類\r\nconst TILE_METHODS = [\r\n    { value: 'none', label: '未選擇' },\r\n    { value: 'wet', label: '濕式工法(軟底)' },\r\n    { value: 'dry', label: '乾式工法(硬底)' },\r\n    { value: 'semi', label: '半乾濕式(騷底)' },\r\n    { value: 'hang', label: '乾掛式工法' },\r\n];\r\n\r\n// 粉光配比對照表\r\nconst PLASTER_RATIOS = {\r\n    '1:2': { label: '1:2 粉光 (細)', cementPerM3: 650, sandPerM3: 800, desc: '細緻粉光面' },\r\n    '1:3': { label: '1:3 打底 (粗)', cementPerM3: 450, sandPerM3: 950, desc: '一般打底用' },\r\n};\r\n\r\n// 牆壁厚度選項\r\nconst WALL_THICKNESS_OPTIONS = [\r\n    { value: 'all', label: '全部厚度' },\r\n    { value: 15, label: '15 cm' },\r\n    { value: 18, label: '18 cm' },\r\n    { value: 20, label: '20 cm' },\r\n    { value: 24, label: '24 cm (1B磚)' },\r\n    { value: 25, label: '25 cm' },\r\n    { value: 30, label: '30 cm' },\r\n];\r\n\r\n// 建築類型概估指標 (擴充版 - 含牆壁厚度與加強磚造)\r\nconst BUILDING_TYPES = [\r\n    // RC 鋼筋混凝土結構\r\n    { label: '多層砌體住宅', rebar: 30, concrete: 0.315, formwork: 2.0, sand: 0.5, structure: 'RC', wallThickness: 20 },\r\n    { label: '多層框架結構', rebar: 40, concrete: 0.34, formwork: 2.2, sand: 0.55, structure: 'RC', wallThickness: 20 },\r\n    { label: '小高層 (11-12F)', rebar: 51, concrete: 0.35, formwork: 2.3, sand: 0.6, structure: 'RC', wallThickness: 20 },\r\n    { label: '高層 (17-18F)', rebar: 57, concrete: 0.36, formwork: 2.4, sand: 0.65, structure: 'RC', wallThickness: 25 },\r\n    { label: '高層 (30F)', rebar: 70, concrete: 0.445, formwork: 2.6, sand: 0.75, structure: 'RC', wallThickness: 30 },\r\n    { label: '別墅', rebar: 40, concrete: 0.33, formwork: 2.0, sand: 0.5, structure: 'RC', wallThickness: 18 },\r\n    { label: '公寓 (5-6F)', rebar: 38, concrete: 0.32, formwork: 2.1, sand: 0.52, structure: 'RC', wallThickness: 18 },\r\n    { label: '辦公大樓', rebar: 55, concrete: 0.38, formwork: 2.5, sand: 0.68, structure: 'RC/SRC', wallThickness: 25 },\r\n    { label: 'RC透天 (2-3F)', rebar: 35, concrete: 0.28, formwork: 1.8, sand: 0.48, structure: 'RC', wallThickness: 15 },\r\n    { label: 'RC透天 (4-5F)', rebar: 42, concrete: 0.32, formwork: 2.0, sand: 0.52, structure: 'RC', wallThickness: 18 },\r\n    { label: '工業廠房', rebar: 25, concrete: 0.25, formwork: 1.5, sand: 0.4, structure: 'SC', wallThickness: 15 },\r\n    { label: '地下室 (1層)', rebar: 80, concrete: 0.5, formwork: 3.0, sand: 0.85, structure: 'RC', wallThickness: 30 },\r\n    // RB 加強磚造結構\r\n    { label: '透天厝 (3F)', rebar: 18, concrete: 0.18, formwork: 1.2, sand: 0.65, structure: 'RB', wallThickness: 24 },\r\n    { label: '農舍/倉庫', rebar: 15, concrete: 0.15, formwork: 1.0, sand: 0.6, structure: 'RB', wallThickness: 24 },\r\n    { label: '加強磚造公寓', rebar: 20, concrete: 0.20, formwork: 1.4, sand: 0.7, structure: 'RB', wallThickness: 24 },\r\n];\r\n\r\n// 鋼筋規格表 (含工程常用號數)\r\nconst REBAR_SPECS = [\r\n    { label: '#3 D10 (9.53mm)', d: 9.53, weight: 0.56 },\r\n    { label: '#4 D13 (12.7mm)', d: 12.7, weight: 0.99 },\r\n    { label: '#5 D16 (15.9mm)', d: 15.9, weight: 1.56 },\r\n    { label: '#6 D19 (19.1mm)', d: 19.1, weight: 2.25 },\r\n    { label: '#7 D22 (22.2mm)', d: 22.2, weight: 3.04 },\r\n    { label: '#8 D25 (25.4mm)', d: 25.4, weight: 3.98 },\r\n    { label: '#9 D29 (28.7mm)', d: 28.7, weight: 5.08 },\r\n    { label: '#10 D32 (32.2mm)', d: 32.2, weight: 6.39 },\r\n];\r\n\r\n// 各部位鋼筋用量概算指標 (kg/m²) - 營造經驗數據\r\nconst REBAR_USAGE_BY_COMPONENT = {\r\n    wall: [\r\n        { label: 'RC牆 15cm', thickness: 15, usage: 23, desc: '主筋@20+箍筋' },\r\n        { label: 'RC牆 18cm', thickness: 18, usage: 29, desc: '主筋@15+箍筋' },\r\n        { label: 'RC牆 20cm', thickness: 20, usage: 34, desc: '雙層主筋+箍筋' },\r\n        { label: 'RC牆 25cm', thickness: 25, usage: 47, desc: '雙層主筋+加強箍筋' },\r\n        { label: 'RC牆 30cm', thickness: 30, usage: 58, desc: '雙層主筋+密箍' },\r\n    ],\r\n    floor: [\r\n        { label: '樓板 12cm', thickness: 12, usage: 13, desc: '單層雙向配筋' },\r\n        { label: '樓板 15cm', thickness: 15, usage: 17, desc: '單層雙向配筋' },\r\n        { label: '加厚板 18cm', thickness: 18, usage: 25, desc: '雙層雙向配筋' },\r\n        { label: '屋頂板', thickness: 12, usage: 16, desc: '含隔熱層配筋' },\r\n    ],\r\n    stair: [\r\n        { label: '直跑樓梯', usage: 40, desc: '踏板+斜版' },\r\n        { label: '迴轉樓梯', usage: 50, desc: '含中間平台' },\r\n        { label: '懸臂樓梯', usage: 62, desc: '高配筋' },\r\n    ],\r\n    beam: [\r\n        { label: '一般大梁', usage: 85, desc: '主筋+箍筋 (kg/m³)' },\r\n        { label: '框架梁', usage: 100, desc: '高配筋 (kg/m³)' },\r\n    ],\r\n    column: [\r\n        { label: '一般柱', usage: 120, desc: '主筋+箍筋 (kg/m³)' },\r\n        { label: '框架柱', usage: 150, desc: '高配筋 (kg/m³)' },\r\n    ],\r\n};\r\n\r\n// ============================================\r\n// 工具函數\r\n// ============================================\r\n\r\nconst formatNumber = (num, decimals = 2) => {\r\n    if (isNaN(num) || num === null) return '-';\r\n    return Number(num).toLocaleString('zh-TW', {\r\n        minimumFractionDigits: 0,\r\n        maximumFractionDigits: decimals\r\n    });\r\n};\r\n\r\nconst applyWastage = (value, wastagePercent) => {\r\n    return value * (1 + wastagePercent / 100);\r\n};\r\n\r\n// ============================================\r\n// 子組件\r\n// ============================================\r\n\r\n// 輸入欄位組件\r\nconst InputField = ({ label, value, onChange, unit, placeholder, type = 'number', min = 0, step = 'any' }) => (\r\n    <div className=\"flex-1\">\r\n        <label className=\"block text-xs text-gray-500 mb-1\">{label}</label>\r\n        <div className=\"relative\">\r\n            <input\r\n                type={type}\r\n                value={value}\r\n                onChange={(e) => onChange(e.target.value)}\r\n                placeholder={placeholder}\r\n                min={min}\r\n                step={step}\r\n                className=\"w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent text-sm\"\r\n            />\r\n            {unit && (\r\n                <span className=\"absolute right-3 top-1/2 -translate-y-1/2 text-xs text-gray-400\">{unit}</span>\r\n            )}\r\n        </div>\r\n    </div>\r\n);\r\n\r\n// 下拉選單組件\r\nconst SelectField = ({ label, value, onChange, options }) => (\r\n    <div className=\"flex-1\">\r\n        <label className=\"block text-xs text-gray-500 mb-1\">{label}</label>\r\n        <select\r\n            value={value}\r\n            onChange={(e) => onChange(e.target.value)}\r\n            className=\"w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent text-sm bg-white\"\r\n        >\r\n            {options.map((opt, i) => (\r\n                <option key={i} value={typeof opt === 'object' ? opt.value : opt}>\r\n                    {typeof opt === 'object' ? opt.label : opt}\r\n                </option>\r\n            ))}\r\n        </select>\r\n    </div>\r\n);\r\n\r\n// 損耗率控制組件\r\nconst WastageControl = ({ wastage, setWastage, defaultValue, useCustom, setUseCustom }) => (\r\n    <div className=\"flex items-center gap-2 bg-gray-50 rounded-lg p-2\">\r\n        <span className=\"text-xs text-gray-500\">損耗率:</span>\r\n        <button\r\n            onClick={() => setUseCustom(false)}\r\n            className={`px-2 py-1 text-xs rounded ${!useCustom ? 'bg-orange-500 text-white' : 'bg-white border'}`}\r\n        >\r\n            預設 {defaultValue}%\r\n        </button>\r\n        <button\r\n            onClick={() => setUseCustom(true)}\r\n            className={`px-2 py-1 text-xs rounded ${useCustom ? 'bg-orange-500 text-white' : 'bg-white border'}`}\r\n        >\r\n            自訂\r\n        </button>\r\n        {useCustom && (\r\n            <input\r\n                type=\"number\"\r\n                value={wastage}\r\n                onChange={(e) => setWastage(parseFloat(e.target.value) || 0)}\r\n                className=\"w-16 px-2 py-1 border rounded text-xs text-center\"\r\n                min=\"0\"\r\n                max=\"100\"\r\n            />\r\n        )}\r\n        {useCustom && <span className=\"text-xs text-gray-500\">%</span>}\r\n    </div>\r\n);\r\n\r\n// 結果顯示組件\r\nconst ResultDisplay = ({ label, value, unit, wastageValue, showWastage = true, onAddRecord, subType = '' }) => {\r\n    const [copied, setCopied] = useState(false);\r\n\r\n    const copyValue = () => {\r\n        navigator.clipboard.writeText(wastageValue || value);\r\n        setCopied(true);\r\n        setTimeout(() => setCopied(false), 1500);\r\n    };\r\n\r\n    const handleAddRecord = () => {\r\n        if (onAddRecord && value > 0) {\r\n            onAddRecord(subType, label, value, unit, wastageValue || value);\r\n        }\r\n    };\r\n\r\n    return (\r\n        <div className=\"bg-gradient-to-r from-orange-500 to-orange-600 rounded-xl p-4 text-white\">\r\n            <div className=\"text-xs opacity-80 mb-1\">{label}</div>\r\n            <div className=\"flex items-end gap-2\">\r\n                <span className=\"text-2xl font-bold\">{formatNumber(value)}</span>\r\n                <span className=\"text-sm opacity-80 mb-1\">{unit}</span>\r\n                <div className=\"ml-auto flex gap-1\">\r\n                    {onAddRecord && value > 0 && (\r\n                        <button onClick={handleAddRecord} className=\"p-1 hover:bg-white/20 rounded\" title=\"加入記錄\">\r\n                            <Plus size={16} />\r\n                        </button>\r\n                    )}\r\n                    <button onClick={copyValue} className=\"p-1 hover:bg-white/20 rounded\" title=\"複製\">\r\n                        {copied ? <Check size={16} /> : <Copy size={16} />}\r\n                    </button>\r\n                </div>\r\n            </div>\r\n            {showWastage && wastageValue && wastageValue !== value && (\r\n                <div className=\"mt-2 pt-2 border-t border-white/30 text-sm\">\r\n                    含損耗: <span className=\"font-bold\">{formatNumber(wastageValue)}</span> {unit}\r\n                </div>\r\n            )}\r\n        </div>\r\n    );\r\n};\r\n\r\n// 成本輸入組件\r\nconst CostInput = ({ label, quantity, unit, unitLabel, vendors = [], onChange, placeholder = {} }) => {\r\n    const [selectedVendor, setSelectedVendor] = useState('');\r\n    const [spec, setSpec] = useState('');\r\n    const [price, setPrice] = useState('');\r\n    const [note, setNote] = useState('');\r\n\r\n    const subtotal = (parseFloat(price) || 0) * (parseFloat(quantity) || 0);\r\n\r\n    // 當數值變更時通知父組件\r\n    React.useEffect(() => {\r\n        onChange?.({\r\n            vendor: vendors.find(v => v.id === selectedVendor)?.name || '',\r\n            vendorId: selectedVendor,\r\n            spec,\r\n            price: parseFloat(price) || 0,\r\n            subtotal,\r\n            note\r\n        });\r\n    }, [selectedVendor, spec, price, note, quantity]);\r\n\r\n    return (\r\n        <div className=\"bg-orange-50 rounded-lg p-3 space-y-3 border border-orange-100 mt-2\">\r\n            <div className=\"flex items-center gap-2 text-sm font-medium text-orange-800\">\r\n                <span className=\"bg-orange-200 text-orange-700 p-1 rounded\">\r\n                    <Calculator size={14} />\r\n                </span>\r\n                {label}成本估算\r\n            </div>\r\n            <div className=\"grid grid-cols-1 sm:grid-cols-2 gap-3\">\r\n                <div className=\"flex-1\">\r\n                    <label className=\"block text-xs text-gray-500 mb-1\">廠商選擇</label>\r\n                    <select\r\n                        value={selectedVendor}\r\n                        onChange={(e) => setSelectedVendor(e.target.value)}\r\n                        className=\"w-full px-2 py-1.5 border border-gray-200 rounded text-sm bg-white\"\r\n                    >\r\n                        <option value=\"\">選擇廠商...</option>\r\n                        {vendors.map(v => (\r\n                            <option key={v.id} value={v.id}>{v.name}</option>\r\n                        ))}\r\n                    </select>\r\n                </div>\r\n                <div className=\"flex-1\">\r\n                    <label className=\"block text-xs text-gray-500 mb-1\">規格/種類</label>\r\n                    <input\r\n                        type=\"text\"\r\n                        value={spec}\r\n                        onChange={(e) => setSpec(e.target.value)}\r\n                        placeholder={placeholder.spec || \"例：3000psi\"}\r\n                        className=\"w-full px-2 py-1.5 border border-gray-200 rounded text-sm\"\r\n                    />\r\n                </div>\r\n                <div className=\"flex-1\">\r\n                    <label className=\"block text-xs text-gray-500 mb-1\">單價 ({unitLabel || (unit ? `元/${unit}` : '元')})</label>\r\n                    <input\r\n                        type=\"number\"\r\n                        value={price}\r\n                        onChange={(e) => setPrice(e.target.value)}\r\n                        placeholder=\"0\"\r\n                        className=\"w-full px-2 py-1.5 border border-gray-200 rounded text-sm\"\r\n                    />\r\n                </div>\r\n                <div className=\"flex-1\">\r\n                    <label className=\"block text-xs text-gray-500 mb-1\">備註</label>\r\n                    <input\r\n                        type=\"text\"\r\n                        value={note}\r\n                        onChange={(e) => setNote(e.target.value)}\r\n                        placeholder=\"備註說明\"\r\n                        className=\"w-full px-2 py-1.5 border border-gray-200 rounded text-sm\"\r\n                    />\r\n                </div>\r\n            </div>\r\n            <div className=\"flex justify-between items-center pt-2 border-t border-orange-200/50\">\r\n                <div className=\"text-xs text-orange-600\">\r\n                    數量: {formatNumber(quantity)} {unit}\r\n                </div>\r\n                <div className=\"text-sm font-bold text-orange-700\">\r\n                    小計: $ {formatNumber(subtotal, 0)}\r\n                </div>\r\n            </div>\r\n        </div>\r\n    );\r\n};\r\n\r\n\r\n// 1️⃣ 結構工程計算器 (支援多列輸入)\r\nconst StructureCalculator = ({ onAddRecord, vendors = [] }) => {\r\n    const [calcType, setCalcType] = useState('concrete');\r\n\r\n    // 混凝土計算 - 多列支援\r\n    const [concreteRows, setConcreteRows] = useState([\r\n        { id: 1, name: '', length: '', width: '', height: '' }\r\n    ]);\r\n    const [concreteWastage, setConcreteWastage] = useState(DEFAULT_WASTAGE.concrete);\r\n    const [concreteCustomWastage, setConcreteCustomWastage] = useState(false);\r\n    const [concreteCost, setConcreteCost] = useState(null);\r\n\r\n    // 泵浦車記錄\r\n    const [pumpTruckCount, setPumpTruckCount] = useState('');\r\n    const [pumpTruckTrips, setPumpTruckTrips] = useState('');\r\n    const [pumpTruckNote, setPumpTruckNote] = useState('');\r\n    const [pumpTruckCost, setPumpTruckCost] = useState(null);\r\n\r\n    // 鋼筋計算\r\n    const [rebarSpec, setRebarSpec] = useState(0);\r\n    const [rebarLength, setRebarLength] = useState('');\r\n    const [rebarCount, setRebarCount] = useState('');\r\n    const [rebarWastage, setRebarWastage] = useState(DEFAULT_WASTAGE.rebar);\r\n    const [rebarCustomWastage, setRebarCustomWastage] = useState(false);\r\n    const [rebarCost, setRebarCost] = useState(null);\r\n\r\n    // 鋼筋概算模式\r\n    const [rebarMode, setRebarMode] = useState('exact'); // 'exact' | 'estimate'\r\n    const [rebarEstimate, setRebarEstimate] = useState({\r\n        wallType: 0,\r\n        wallArea: '',\r\n        floorType: 0,\r\n        floorArea: '',\r\n        stairType: 0,\r\n        stairArea: '',\r\n    });\r\n\r\n    // 鋼筋概算結果計算\r\n    const rebarEstimateResults = {\r\n        wall: (parseFloat(rebarEstimate.wallArea) || 0) * REBAR_USAGE_BY_COMPONENT.wall[rebarEstimate.wallType]?.usage,\r\n        floor: (parseFloat(rebarEstimate.floorArea) || 0) * REBAR_USAGE_BY_COMPONENT.floor[rebarEstimate.floorType]?.usage,\r\n        stair: (parseFloat(rebarEstimate.stairArea) || 0) * REBAR_USAGE_BY_COMPONENT.stair[rebarEstimate.stairType]?.usage,\r\n        get total() { return this.wall + this.floor + this.stair; }\r\n    };\r\n\r\n    // 模板計算\r\n    const [formworkArea, setFormworkArea] = useState('');\r\n    const [formworkRatio, setFormworkRatio] = useState('2.2');\r\n    const [formworkWastage, setFormworkWastage] = useState(DEFAULT_WASTAGE.formwork);\r\n    const [formworkCustomWastage, setFormworkCustomWastage] = useState(false);\r\n    const [formworkCost, setFormworkCost] = useState(null);\r\n\r\n    // 計算每列混凝土體積\r\n    const concreteRowResults = concreteRows.map(row => {\r\n        const volume = (parseFloat(row.length) || 0) * (parseFloat(row.width) || 0) * (parseFloat(row.height) || 0);\r\n        return { ...row, volume };\r\n    });\r\n\r\n    // 總計混凝土體積\r\n    const totalConcreteVolume = concreteRowResults.reduce((sum, row) => sum + row.volume, 0);\r\n    const totalConcreteWithWastage = applyWastage(totalConcreteVolume, concreteCustomWastage ? concreteWastage : DEFAULT_WASTAGE.concrete);\r\n\r\n    // 新增混凝土列\r\n    const addConcreteRow = () => {\r\n        const newId = Math.max(...concreteRows.map(r => r.id), 0) + 1;\r\n        setConcreteRows([...concreteRows, { id: newId, name: '', length: '', width: '', height: '' }]);\r\n    };\r\n\r\n    // 刪除混凝土列\r\n    const removeConcreteRow = (id) => {\r\n        if (concreteRows.length <= 1) return;\r\n        setConcreteRows(concreteRows.filter(row => row.id !== id));\r\n    };\r\n\r\n    // 更新混凝土列\r\n    const updateConcreteRow = (id, field, value) => {\r\n        setConcreteRows(concreteRows.map(row =>\r\n            row.id === id ? { ...row, [field]: value } : row\r\n        ));\r\n    };\r\n\r\n    // 清空所有列\r\n    const clearConcreteRows = () => {\r\n        setConcreteRows([{ id: 1, name: '', length: '', width: '', height: '' }]);\r\n    };\r\n\r\n    // 鋼筋計算結果\r\n    const selectedRebar = REBAR_SPECS[rebarSpec];\r\n    const rebarWeight = selectedRebar.weight * (parseFloat(rebarLength) || 0) * (parseFloat(rebarCount) || 0);\r\n    const rebarWithWastage = applyWastage(rebarWeight, rebarCustomWastage ? rebarWastage : DEFAULT_WASTAGE.rebar);\r\n\r\n    // 模板計算結果\r\n    const formworkResult = (parseFloat(formworkArea) || 0) * parseFloat(formworkRatio);\r\n    const formworkWithWastage = applyWastage(formworkResult, formworkCustomWastage ? formworkWastage : DEFAULT_WASTAGE.formwork);\r\n\r\n    return (\r\n        <div className=\"space-y-4\">\r\n            {/* 子項目選擇 */}\r\n            <div className=\"flex gap-2 flex-wrap\">\r\n                {[\r\n                    { id: 'concrete', label: '混凝土用量' },\r\n                    { id: 'rebar', label: '鋼筋重量' },\r\n                    { id: 'formwork', label: '模板面積' },\r\n                ].map(item => (\r\n                    <button\r\n                        key={item.id}\r\n                        onClick={() => setCalcType(item.id)}\r\n                        className={`px-4 py-2 rounded-lg text-sm font-medium transition-all ${calcType === item.id\r\n                            ? 'bg-orange-500 text-white'\r\n                            : 'bg-gray-100 hover:bg-gray-200'\r\n                            }`}\r\n                    >\r\n                        {item.label}\r\n                    </button>\r\n                ))}\r\n            </div>\r\n\r\n            {/* 混凝土計算 - 多列模式 */}\r\n            {calcType === 'concrete' && (\r\n                <div className=\"bg-white rounded-xl p-4 border border-gray-100 space-y-4\">\r\n                    <div className=\"flex items-center justify-between\">\r\n                        <div className=\"flex items-center gap-2 text-sm text-gray-600\">\r\n                            <Info size={16} />\r\n                            公式: 體積(m³) = 長 × 寬 × 高\r\n                        </div>\r\n                        <div className=\"flex items-center gap-2\">\r\n                            <span className=\"text-xs text-gray-500\">{concreteRows.length} 列</span>\r\n                            <button\r\n                                onClick={() => concreteRows.length > 1 && removeConcreteRow(concreteRows[concreteRows.length - 1].id)}\r\n                                disabled={concreteRows.length <= 1}\r\n                                className=\"w-7 h-7 rounded-lg bg-red-100 text-red-600 flex items-center justify-center hover:bg-red-200 disabled:opacity-50 disabled:cursor-not-allowed transition-colors\"\r\n                                title=\"減少一列\"\r\n                            >\r\n                                <span className=\"text-lg font-bold leading-none\">−</span>\r\n                            </button>\r\n                            <button\r\n                                onClick={addConcreteRow}\r\n                                className=\"w-7 h-7 rounded-lg bg-green-100 text-green-600 flex items-center justify-center hover:bg-green-200 transition-colors\"\r\n                                title=\"新增一列\"\r\n                            >\r\n                                <Plus size={16} />\r\n                            </button>\r\n                            {concreteRows.length > 1 && (\r\n                                <button\r\n                                    onClick={clearConcreteRows}\r\n                                    className=\"text-xs text-gray-500 hover:text-gray-700 ml-1\"\r\n                                >\r\n                                    清空\r\n                                </button>\r\n                            )}\r\n                        </div>\r\n                    </div>\r\n\r\n                    {/* 混凝土規格說明 */}\r\n                    <div className=\"bg-blue-50 rounded-lg p-3 border border-blue-100\">\r\n                        <div className=\"font-medium text-blue-800 text-sm mb-2 flex items-center gap-2\">\r\n                            <Info size={14} />\r\n                            混凝土規格與用途說明\r\n                        </div>\r\n                        <div className=\"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-2 text-xs\">\r\n                            <div className=\"p-2 rounded-lg bg-white border border-gray-200\">\r\n                                <div className=\"font-bold text-gray-800 mb-1\">2000 psi (140 kgf/cm²)</div>\r\n                                <div className=\"text-gray-600\">\r\n                                    <span className=\"text-blue-700 font-medium\">一般用途：</span>\r\n                                    地坪、車道、人行道\r\n                                </div>\r\n                            </div>\r\n                            <div className=\"p-2 rounded-lg bg-white border border-gray-200\">\r\n                                <div className=\"font-bold text-gray-800 mb-1\">3000 psi (210 kgf/cm²)</div>\r\n                                <div className=\"text-gray-600\">\r\n                                    <span className=\"text-blue-700 font-medium\">標準結構：</span>\r\n                                    樓板、梁柱、牆體\r\n                                </div>\r\n                            </div>\r\n                            <div className=\"p-2 rounded-lg bg-white border border-gray-200\">\r\n                                <div className=\"font-bold text-gray-800 mb-1\">4000 psi (280 kgf/cm²)</div>\r\n                                <div className=\"text-gray-600\">\r\n                                    <span className=\"text-blue-700 font-medium\">高強度：</span>\r\n                                    高樓主結構、地下室\r\n                                </div>\r\n                            </div>\r\n                            <div className=\"p-2 rounded-lg bg-white border border-gray-200\">\r\n                                <div className=\"font-bold text-gray-800 mb-1\">5000+ psi (350 kgf/cm²)</div>\r\n                                <div className=\"text-gray-600\">\r\n                                    <span className=\"text-blue-700 font-medium\">特殊工程：</span>\r\n                                    橋梁、預力構件\r\n                                </div>\r\n                            </div>\r\n                        </div>\r\n                        <div className=\"mt-2 text-xs text-gray-500 flex items-start gap-1\">\r\n                            <span className=\"text-blue-500\">💡</span>\r\n                            <span>混凝土用量需考慮損耗率（通常 3~5%）。預拌混凝土以立方公尺(m³)計價，建議多備料避免不足。</span>\r\n                        </div>\r\n                    </div>\r\n\r\n                    {/* 多列輸入區 */}\r\n                    <div className=\"space-y-2 max-h-[400px] overflow-y-auto\">\r\n                        {concreteRows.map((row, index) => (\r\n                            <div key={row.id} className=\"bg-gray-50 rounded-lg p-3 border border-gray-100\">\r\n                                <div className=\"grid grid-cols-12 gap-2 items-end\">\r\n                                    {/* 項目名稱 */}\r\n                                    <div className=\"col-span-12 sm:col-span-2\">\r\n                                        <label className=\"block text-xs text-gray-500 mb-1\">名稱</label>\r\n                                        <input\r\n                                            type=\"text\"\r\n                                            value={row.name}\r\n                                            onChange={(e) => updateConcreteRow(row.id, 'name', e.target.value)}\r\n                                            placeholder={`項目 ${index + 1}`}\r\n                                            className=\"w-full px-2 py-1.5 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-orange-500 focus:border-transparent\"\r\n                                        />\r\n                                    </div>\r\n                                    {/* 長度 */}\r\n                                    <div className=\"col-span-4 sm:col-span-2\">\r\n                                        <label className=\"block text-xs text-gray-500 mb-1\">長度</label>\r\n                                        <div className=\"relative\">\r\n                                            <input\r\n                                                type=\"number\"\r\n                                                value={row.length}\r\n                                                onChange={(e) => updateConcreteRow(row.id, 'length', e.target.value)}\r\n                                                placeholder=\"0\"\r\n                                                min=\"0\"\r\n                                                className=\"w-full px-2 py-1.5 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-orange-500 focus:border-transparent pr-7\"\r\n                                            />\r\n                                            <span className=\"absolute right-2 top-1/2 -translate-y-1/2 text-xs text-gray-400\">m</span>\r\n                                        </div>\r\n                                    </div>\r\n                                    {/* 寬度 */}\r\n                                    <div className=\"col-span-4 sm:col-span-2\">\r\n                                        <label className=\"block text-xs text-gray-500 mb-1\">寬度</label>\r\n                                        <div className=\"relative\">\r\n                                            <input\r\n                                                type=\"number\"\r\n                                                value={row.width}\r\n                                                onChange={(e) => updateConcreteRow(row.id, 'width', e.target.value)}\r\n                                                placeholder=\"0\"\r\n                                                min=\"0\"\r\n                                                className=\"w-full px-2 py-1.5 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-orange-500 focus:border-transparent pr-7\"\r\n                                            />\r\n                                            <span className=\"absolute right-2 top-1/2 -translate-y-1/2 text-xs text-gray-400\">m</span>\r\n                                        </div>\r\n                                    </div>\r\n                                    {/* 高度/厚度 */}\r\n                                    <div className=\"col-span-4 sm:col-span-2\">\r\n                                        <label className=\"block text-xs text-gray-500 mb-1\">高度/厚度</label>\r\n                                        <div className=\"relative\">\r\n                                            <input\r\n                                                type=\"number\"\r\n                                                value={row.height}\r\n                                                onChange={(e) => updateConcreteRow(row.id, 'height', e.target.value)}\r\n                                                placeholder=\"0\"\r\n                                                min=\"0\"\r\n                                                className=\"w-full px-2 py-1.5 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-orange-500 focus:border-transparent pr-7\"\r\n                                            />\r\n                                            <span className=\"absolute right-2 top-1/2 -translate-y-1/2 text-xs text-gray-400\">m</span>\r\n                                        </div>\r\n                                    </div>\r\n                                    {/* 計算結果 */}\r\n                                    <div className=\"col-span-10 sm:col-span-3 flex items-center\">\r\n                                        <div className=\"flex-1\">\r\n                                            <label className=\"block text-xs text-gray-500 mb-1\">體積</label>\r\n                                            <div className=\"text-sm font-bold text-orange-600\">\r\n                                                {concreteRowResults[index].volume > 0\r\n                                                    ? `${formatNumber(concreteRowResults[index].volume, 4)} m³`\r\n                                                    : '--'}\r\n                                            </div>\r\n                                        </div>\r\n                                    </div>\r\n                                    {/* 刪除按鈕 */}\r\n                                    <div className=\"col-span-2 sm:col-span-1 flex justify-end\">\r\n                                        <button\r\n                                            onClick={() => removeConcreteRow(row.id)}\r\n                                            disabled={concreteRows.length <= 1}\r\n                                            className=\"p-1.5 text-red-400 hover:text-red-600 hover:bg-red-50 rounded-lg transition-colors disabled:opacity-30 disabled:cursor-not-allowed\"\r\n                                        >\r\n                                            <Trash2 size={14} />\r\n                                        </button>\r\n                                    </div>\r\n                                </div>\r\n                            </div>\r\n                        ))}\r\n                    </div>\r\n\r\n                    {/* 快速新增按鈕 */}\r\n                    <button\r\n                        onClick={addConcreteRow}\r\n                        className=\"w-full py-2 border-2 border-dashed border-gray-200 rounded-xl text-gray-400 hover:border-orange-300 hover:text-orange-500 transition-colors flex items-center justify-center gap-2 text-sm\"\r\n                    >\r\n                        <Plus size={16} />\r\n                        +增加新欄位\r\n                    </button>\r\n\r\n                    <WastageControl\r\n                        wastage={concreteWastage}\r\n                        setWastage={setConcreteWastage}\r\n                        defaultValue={DEFAULT_WASTAGE.concrete}\r\n                        useCustom={concreteCustomWastage}\r\n                        setUseCustom={setConcreteCustomWastage}\r\n                    />\r\n\r\n                    {/* 總計結果 */}\r\n                    <ResultDisplay\r\n                        label={`混凝土用量 (共 ${concreteRowResults.filter(r => r.volume > 0).length} 項)`}\r\n                        value={totalConcreteVolume}\r\n                        unit=\"m³\"\r\n                        wastageValue={totalConcreteWithWastage}\r\n                        onAddRecord={(subType, label, value, unit, wastageValue) =>\r\n                            onAddRecord(subType, label, value, unit, wastageValue, concreteCost)}\r\n                        subType=\"混凝土\"\r\n                    />\r\n\r\n                    {/* 混凝土成本計算 */}\r\n                    <CostInput\r\n                        label=\"混凝土\"\r\n                        quantity={totalConcreteWithWastage}\r\n                        unit=\"m³\"\r\n                        vendors={vendors.filter(v => v.category === '建材供應' || v.tradeType?.includes('混凝土'))}\r\n                        onChange={setConcreteCost}\r\n                        placeholder={{ spec: '例：3000psi' }}\r\n                    />\r\n\r\n                    {/* 泵浦車欄位 */}\r\n                    <div className=\"bg-gray-50 rounded-lg p-3 border border-gray-100 space-y-3 mt-4\">\r\n                        <div className=\"flex items-center gap-2 text-sm font-medium text-gray-700\">\r\n                            <span className=\"bg-orange-100 text-orange-600 p-1 rounded\">\r\n                                <Building2 size={16} />\r\n                            </span>\r\n                            混凝土泵浦車紀錄 (非必填)\r\n                        </div>\r\n                        <div className=\"grid grid-cols-1 sm:grid-cols-2 gap-3\">\r\n                            <div className=\"grid grid-cols-2 gap-2\">\r\n                                <InputField label=\"車輛數\" value={pumpTruckCount} onChange={setPumpTruckCount} unit=\"輛\" placeholder=\"0\" />\r\n                                <InputField label=\"總車次\" value={pumpTruckTrips} onChange={setPumpTruckTrips} unit=\"車次\" placeholder=\"0\" />\r\n                            </div>\r\n                            <InputField label=\"備註說明\" value={pumpTruckNote} onChange={setPumpTruckNote} placeholder=\"例：45米泵浦車\" type=\"text\" />\r\n                        </div>\r\n\r\n                        {/* 泵浦車成本計算 */}\r\n                        <CostInput\r\n                            label=\"泵浦車\"\r\n                            quantity={parseFloat(pumpTruckTrips) || parseFloat(pumpTruckCount) || 0}\r\n                            unit=\"車次\"\r\n                            vendors={vendors.filter(v => v.category === '工程工班' || v.tradeType?.includes('泵浦'))}\r\n                            onChange={setPumpTruckCost}\r\n                            placeholder={{ spec: '例：45米' }}\r\n                        />\r\n\r\n                        {(pumpTruckCount || pumpTruckTrips) && (\r\n                            <div className=\"flex justify-end\">\r\n                                <button\r\n                                    onClick={() => onAddRecord?.('結構工程', '泵浦車',\r\n                                        `泵浦車 ${pumpTruckCount ? pumpTruckCount + '輛' : ''} ${pumpTruckTrips ? pumpTruckTrips + '車次' : ''} ${pumpTruckNote ? '(' + pumpTruckNote + ')' : ''}`,\r\n                                        parseFloat(pumpTruckTrips) || parseFloat(pumpTruckCount) || 0, '車次', 0, pumpTruckCost)}\r\n                                    className=\"px-3 py-1.5 bg-orange-100 text-orange-600 rounded text-xs hover:bg-orange-200 transition-colors flex items-center gap-1\"\r\n                                >\r\n                                    <Plus size={12} /> 加入記錄\r\n                                </button>\r\n                            </div>\r\n                        )}\r\n                    </div>\r\n\r\n                    {/* 各列明細 */}\r\n                    {concreteRowResults.filter(r => r.volume > 0).length > 1 && (\r\n                        <div className=\"bg-gray-50 rounded-lg p-3 text-xs\">\r\n                            <div className=\"font-medium text-gray-700 mb-2\">各項明細:</div>\r\n                            <div className=\"space-y-1\">\r\n                                {concreteRowResults.filter(r => r.volume > 0).map((row, idx) => (\r\n                                    <div key={row.id} className=\"flex justify-between text-gray-600\">\r\n                                        <span>{row.name || `項目 ${idx + 1}`} ({row.length}×{row.width}×{row.height})</span>\r\n                                        <span className=\"font-medium\">{formatNumber(row.volume, 4)} m³</span>\r\n                                    </div>\r\n                                ))}\r\n                            </div>\r\n                        </div>\r\n                    )}\r\n                </div>\r\n            )}\r\n\r\n            {/* 鋼筋計算 */}\r\n            {calcType === 'rebar' && (\r\n                <div className=\"bg-white rounded-xl p-4 border border-gray-100 space-y-4\">\r\n                    {/* 子分頁切換 */}\r\n                    <div className=\"flex gap-2 border-b border-gray-100 pb-3\">\r\n                        <button\r\n                            onClick={() => setRebarMode('exact')}\r\n                            className={`px-3 py-1.5 rounded-lg text-sm transition-all ${rebarMode === 'exact'\r\n                                ? 'bg-orange-100 text-orange-700 font-medium'\r\n                                : 'text-gray-500 hover:bg-gray-100'}`}\r\n                        >\r\n                            精確計算\r\n                        </button>\r\n                        <button\r\n                            onClick={() => setRebarMode('estimate')}\r\n                            className={`px-3 py-1.5 rounded-lg text-sm transition-all ${rebarMode === 'estimate'\r\n                                ? 'bg-orange-100 text-orange-700 font-medium'\r\n                                : 'text-gray-500 hover:bg-gray-100'}`}\r\n                        >\r\n                            部位概算\r\n                        </button>\r\n                    </div>\r\n\r\n                    {/* 精確計算模式 */}\r\n                    {rebarMode === 'exact' && (\r\n                        <>\r\n                            <div className=\"flex items-center gap-2 text-sm text-gray-600\">\r\n                                <Info size={16} />\r\n                                公式: 重量(kg) = 單位重量 × 長度 × 數量\r\n                            </div>\r\n                            <div className=\"grid grid-cols-1 sm:grid-cols-3 gap-3\">\r\n                                <SelectField\r\n                                    label=\"鋼筋規格\"\r\n                                    value={rebarSpec}\r\n                                    onChange={(v) => setRebarSpec(parseInt(v))}\r\n                                    options={REBAR_SPECS.map((r, i) => ({ value: i, label: `${r.label} (${r.weight}kg/m)` }))}\r\n                                />\r\n                                <InputField label=\"單根長度\" value={rebarLength} onChange={setRebarLength} unit=\"m\" placeholder=\"0\" />\r\n                                <InputField label=\"數量\" value={rebarCount} onChange={setRebarCount} unit=\"支\" placeholder=\"0\" />\r\n                            </div>\r\n\r\n                            {/* 鋼筋規格說明 */}\r\n                            <div className=\"bg-blue-50 rounded-lg p-3 border border-blue-100\">\r\n                                <div className=\"font-medium text-blue-800 text-sm mb-2 flex items-center gap-2\">\r\n                                    <Info size={14} />\r\n                                    鋼筋規格與常用部位說明\r\n                                </div>\r\n                                <div className=\"grid grid-cols-2 sm:grid-cols-4 gap-2 text-xs\">\r\n                                    <div className={`p-2 rounded-lg border ${rebarSpec === 0 ? 'bg-orange-100 border-orange-300' : 'bg-white border-gray-200'}`}>\r\n                                        <div className=\"font-bold text-gray-800\">#3 D10</div>\r\n                                        <div className=\"text-gray-600\">箍筋、繫筋</div>\r\n                                        <div className=\"text-blue-600 text-[10px]\">0.56 kg/m</div>\r\n                                    </div>\r\n                                    <div className={`p-2 rounded-lg border ${rebarSpec === 1 ? 'bg-orange-100 border-orange-300' : 'bg-white border-gray-200'}`}>\r\n                                        <div className=\"font-bold text-gray-800\">#4 D13</div>\r\n                                        <div className=\"text-gray-600\">樓板筋、牆筋</div>\r\n                                        <div className=\"text-blue-600 text-[10px]\">0.99 kg/m</div>\r\n                                    </div>\r\n                                    <div className={`p-2 rounded-lg border ${rebarSpec === 2 ? 'bg-orange-100 border-orange-300' : 'bg-white border-gray-200'}`}>\r\n                                        <div className=\"font-bold text-gray-800\">#5 D16</div>\r\n                                        <div className=\"text-gray-600\">梁主筋、柱筋</div>\r\n                                        <div className=\"text-blue-600 text-[10px]\">1.56 kg/m</div>\r\n                                    </div>\r\n                                    <div className={`p-2 rounded-lg border ${rebarSpec === 3 ? 'bg-orange-100 border-orange-300' : 'bg-white border-gray-200'}`}>\r\n                                        <div className=\"font-bold text-gray-800\">#6 D19</div>\r\n                                        <div className=\"text-gray-600\">大梁主筋</div>\r\n                                        <div className=\"text-blue-600 text-[10px]\">2.25 kg/m</div>\r\n                                    </div>\r\n                                    <div className={`p-2 rounded-lg border ${rebarSpec === 4 ? 'bg-orange-100 border-orange-300' : 'bg-white border-gray-200'}`}>\r\n                                        <div className=\"font-bold text-gray-800\">#7 D22</div>\r\n                                        <div className=\"text-gray-600\">柱主筋、基礎筋</div>\r\n                                        <div className=\"text-blue-600 text-[10px]\">3.04 kg/m</div>\r\n                                    </div>\r\n                                    <div className={`p-2 rounded-lg border ${rebarSpec === 5 ? 'bg-orange-100 border-orange-300' : 'bg-white border-gray-200'}`}>\r\n                                        <div className=\"font-bold text-gray-800\">#8 D25</div>\r\n                                        <div className=\"text-gray-600\">大柱主筋</div>\r\n                                        <div className=\"text-blue-600 text-[10px]\">3.98 kg/m</div>\r\n                                    </div>\r\n                                    <div className={`p-2 rounded-lg border ${rebarSpec === 6 ? 'bg-orange-100 border-orange-300' : 'bg-white border-gray-200'}`}>\r\n                                        <div className=\"font-bold text-gray-800\">#9 D29</div>\r\n                                        <div className=\"text-gray-600\">高樓柱筋</div>\r\n                                        <div className=\"text-blue-600 text-[10px]\">5.08 kg/m</div>\r\n                                    </div>\r\n                                    <div className={`p-2 rounded-lg border ${rebarSpec === 7 ? 'bg-orange-100 border-orange-300' : 'bg-white border-gray-200'}`}>\r\n                                        <div className=\"font-bold text-gray-800\">#10 D32</div>\r\n                                        <div className=\"text-gray-600\">特殊工程</div>\r\n                                        <div className=\"text-blue-600 text-[10px]\">6.39 kg/m</div>\r\n                                    </div>\r\n                                </div>\r\n                                <div className=\"mt-2 text-xs text-gray-500 flex items-start gap-1\">\r\n                                    <span className=\"text-blue-500\">💡</span>\r\n                                    <span>標準鋼筋長度為 12m（可訂製 6m、9m）。搭接長度依規範約為鋼筋直徑的 40~60 倍。建議損耗率 5%。</span>\r\n                                </div>\r\n                            </div>\r\n\r\n                            <WastageControl\r\n                                wastage={rebarWastage}\r\n                                setWastage={setRebarWastage}\r\n                                defaultValue={DEFAULT_WASTAGE.rebar}\r\n                                useCustom={rebarCustomWastage}\r\n                                setUseCustom={setRebarCustomWastage}\r\n                            />\r\n                            <ResultDisplay\r\n                                label=\"鋼筋重量\"\r\n                                value={rebarWeight}\r\n                                unit=\"kg\"\r\n                                wastageValue={rebarWithWastage}\r\n                                onAddRecord={(subType, label, value, unit, wastageValue) =>\r\n                                    onAddRecord(subType, label, value, unit, wastageValue, rebarCost)}\r\n                                subType=\"鋼筋\"\r\n                            />\r\n                            <CostInput\r\n                                label=\"鋼筋\"\r\n                                quantity={rebarWithWastage}\r\n                                unit=\"kg\"\r\n                                vendors={vendors.filter(v => v.category === '建材供應' || v.tradeType?.includes('鋼筋'))}\r\n                                onChange={setRebarCost}\r\n                                placeholder={{ spec: '例：#4 鋼筋' }}\r\n                            />\r\n                        </>\r\n                    )}\r\n\r\n                    {/* 部位概算模式 */}\r\n                    {rebarMode === 'estimate' && (\r\n                        <>\r\n                            <div className=\"flex items-center gap-2 text-sm text-gray-600\">\r\n                                <Info size={16} />\r\n                                依部位輸入面積，自動估算鋼筋用量 (營造經驗值)\r\n                            </div>\r\n\r\n                            {/* 牆面 */}\r\n                            <div className=\"bg-gray-50 rounded-lg p-3 space-y-2\">\r\n                                <div className=\"font-medium text-gray-700 text-sm flex items-center gap-2\">\r\n                                    <span className=\"w-2 h-2 bg-blue-500 rounded-full\"></span>\r\n                                    牆面鋼筋\r\n                                </div>\r\n                                <div className=\"grid grid-cols-1 sm:grid-cols-3 gap-3\">\r\n                                    <SelectField\r\n                                        label=\"牆體類型\"\r\n                                        value={rebarEstimate.wallType}\r\n                                        onChange={(v) => setRebarEstimate(prev => ({ ...prev, wallType: parseInt(v) }))}\r\n                                        options={REBAR_USAGE_BY_COMPONENT.wall.map((w, i) => ({ value: i, label: `${w.label} (${w.usage} kg/m²)` }))}\r\n                                    />\r\n                                    <InputField\r\n                                        label=\"牆面面積\"\r\n                                        value={rebarEstimate.wallArea}\r\n                                        onChange={(v) => setRebarEstimate(prev => ({ ...prev, wallArea: v }))}\r\n                                        unit=\"m²\"\r\n                                        placeholder=\"0\"\r\n                                    />\r\n                                    <div>\r\n                                        <label className=\"block text-xs text-gray-500 mb-1\">估算用量</label>\r\n                                        <div className=\"px-3 py-2 bg-white border border-gray-200 rounded-lg text-sm font-bold text-orange-600\">\r\n                                            {formatNumber(rebarEstimateResults.wall)} kg\r\n                                        </div>\r\n                                    </div>\r\n                                </div>\r\n                            </div>\r\n\r\n                            {/* 地板 */}\r\n                            <div className=\"bg-gray-50 rounded-lg p-3 space-y-2\">\r\n                                <div className=\"font-medium text-gray-700 text-sm flex items-center gap-2\">\r\n                                    <span className=\"w-2 h-2 bg-green-500 rounded-full\"></span>\r\n                                    地板/樓板鋼筋\r\n                                </div>\r\n                                <div className=\"grid grid-cols-1 sm:grid-cols-3 gap-3\">\r\n                                    <SelectField\r\n                                        label=\"樓板類型\"\r\n                                        value={rebarEstimate.floorType}\r\n                                        onChange={(v) => setRebarEstimate(prev => ({ ...prev, floorType: parseInt(v) }))}\r\n                                        options={REBAR_USAGE_BY_COMPONENT.floor.map((f, i) => ({ value: i, label: `${f.label} (${f.usage} kg/m²)` }))}\r\n                                    />\r\n                                    <InputField\r\n                                        label=\"樓板面積\"\r\n                                        value={rebarEstimate.floorArea}\r\n                                        onChange={(v) => setRebarEstimate(prev => ({ ...prev, floorArea: v }))}\r\n                                        unit=\"m²\"\r\n                                        placeholder=\"0\"\r\n                                    />\r\n                                    <div>\r\n                                        <label className=\"block text-xs text-gray-500 mb-1\">估算用量</label>\r\n                                        <div className=\"px-3 py-2 bg-white border border-gray-200 rounded-lg text-sm font-bold text-orange-600\">\r\n                                            {formatNumber(rebarEstimateResults.floor)} kg\r\n                                        </div>\r\n                                    </div>\r\n                                </div>\r\n                            </div>\r\n\r\n                            {/* 樓梯 */}\r\n                            <div className=\"bg-gray-50 rounded-lg p-3 space-y-2\">\r\n                                <div className=\"font-medium text-gray-700 text-sm flex items-center gap-2\">\r\n                                    <span className=\"w-2 h-2 bg-purple-500 rounded-full\"></span>\r\n                                    樓梯鋼筋\r\n                                </div>\r\n                                <div className=\"grid grid-cols-1 sm:grid-cols-3 gap-3\">\r\n                                    <SelectField\r\n                                        label=\"樓梯類型\"\r\n                                        value={rebarEstimate.stairType}\r\n                                        onChange={(v) => setRebarEstimate(prev => ({ ...prev, stairType: parseInt(v) }))}\r\n                                        options={REBAR_USAGE_BY_COMPONENT.stair.map((s, i) => ({ value: i, label: `${s.label} (${s.usage} kg/m²)` }))}\r\n                                    />\r\n                                    <InputField\r\n                                        label=\"樓梯面積\"\r\n                                        value={rebarEstimate.stairArea}\r\n                                        onChange={(v) => setRebarEstimate(prev => ({ ...prev, stairArea: v }))}\r\n                                        unit=\"m²\"\r\n                                        placeholder=\"0\"\r\n                                    />\r\n                                    <div>\r\n                                        <label className=\"block text-xs text-gray-500 mb-1\">估算用量</label>\r\n                                        <div className=\"px-3 py-2 bg-white border border-gray-200 rounded-lg text-sm font-bold text-orange-600\">\r\n                                            {formatNumber(rebarEstimateResults.stair)} kg\r\n                                        </div>\r\n                                    </div>\r\n                                </div>\r\n                            </div>\r\n\r\n                            {/* 總計 */}\r\n                            <div className=\"bg-gradient-to-r from-orange-500 to-orange-600 rounded-xl p-4 text-white\">\r\n                                <div className=\"flex justify-between items-center\">\r\n                                    <div>\r\n                                        <div className=\"text-orange-200 text-sm\">鋼筋概算總量</div>\r\n                                        <div className=\"text-3xl font-bold mt-1\">\r\n                                            {formatNumber(rebarEstimateResults.total)} <span className=\"text-lg\">kg</span>\r\n                                        </div>\r\n                                        <div className=\"text-orange-200 text-xs mt-1\">\r\n                                            約 {formatNumber(rebarEstimateResults.total / 1000, 2)} 噸\r\n                                        </div>\r\n                                    </div>\r\n                                    <button\r\n                                        onClick={() => onAddRecord('鋼筋概算', '鋼筋概算總量', rebarEstimateResults.total, 'kg', rebarEstimateResults.total, null)}\r\n                                        disabled={rebarEstimateResults.total <= 0}\r\n                                        className=\"bg-white/20 hover:bg-white/30 px-4 py-2 rounded-lg text-sm font-medium transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2\"\r\n                                    >\r\n                                        <Plus size={16} />\r\n                                        加入記錄\r\n                                    </button>\r\n                                </div>\r\n                                <div className=\"mt-3 pt-3 border-t border-white/20 grid grid-cols-3 gap-2 text-xs\">\r\n                                    <div className=\"flex items-center gap-1\">\r\n                                        <span className=\"w-2 h-2 bg-blue-300 rounded-full\"></span>\r\n                                        牆面: {formatNumber(rebarEstimateResults.wall)} kg\r\n                                    </div>\r\n                                    <div className=\"flex items-center gap-1\">\r\n                                        <span className=\"w-2 h-2 bg-green-300 rounded-full\"></span>\r\n                                        地板: {formatNumber(rebarEstimateResults.floor)} kg\r\n                                    </div>\r\n                                    <div className=\"flex items-center gap-1\">\r\n                                        <span className=\"w-2 h-2 bg-purple-300 rounded-full\"></span>\r\n                                        樓梯: {formatNumber(rebarEstimateResults.stair)} kg\r\n                                    </div>\r\n                                </div>\r\n                            </div>\r\n\r\n                            {/* 參考表格 */}\r\n                            <div className=\"text-xs text-gray-500 bg-gray-50 p-3 rounded-lg\">\r\n                                <div className=\"font-medium mb-2\">📊 營造經驗參考值</div>\r\n                                <div className=\"grid grid-cols-2 sm:grid-cols-3 gap-2\">\r\n                                    <div>牆 15cm: 23 kg/m²</div>\r\n                                    <div>牆 20cm: 34 kg/m²</div>\r\n                                    <div>牆 25cm: 47 kg/m²</div>\r\n                                    <div>板 12cm: 13 kg/m²</div>\r\n                                    <div>板 15cm: 17 kg/m²</div>\r\n                                    <div>直跑梯: 40 kg/m²</div>\r\n                                </div>\r\n                            </div>\r\n                        </>\r\n                    )}\r\n                </div>\r\n            )}\r\n\r\n            {/* 模板計算 */}\r\n            {calcType === 'formwork' && (\r\n                <div className=\"bg-white rounded-xl p-4 border border-gray-100 space-y-4\">\r\n                    <div className=\"flex items-center gap-2 text-sm text-gray-600\">\r\n                        <Info size={16} />\r\n                        公式: 模板面積 = 建築面積 × 係數 (1.3~2.2)\r\n                    </div>\r\n                    <div className=\"grid grid-cols-2 gap-3\">\r\n                        <InputField label=\"建築面積\" value={formworkArea} onChange={setFormworkArea} unit=\"m²\" placeholder=\"0\" />\r\n                        <SelectField\r\n                            label=\"模板係數\"\r\n                            value={formworkRatio}\r\n                            onChange={setFormworkRatio}\r\n                            options={[\r\n                                { value: '1.3', label: '1.3 - 簡單結構 (少柱少現澆板)' },\r\n                                { value: '1.8', label: '1.8 - 一般結構 (標準框架)' },\r\n                                { value: '2.2', label: '2.2 - 複雜結構 (多層住宅)' },\r\n                            ]}\r\n                        />\r\n                    </div>\r\n\r\n                    {/* 模板係數詳細說明 */}\r\n                    <div className=\"bg-blue-50 rounded-lg p-3 border border-blue-100\">\r\n                        <div className=\"font-medium text-blue-800 text-sm mb-2 flex items-center gap-2\">\r\n                            <Info size={14} />\r\n                            模板係數說明\r\n                        </div>\r\n                        <div className=\"grid grid-cols-1 sm:grid-cols-3 gap-3 text-xs\">\r\n                            <div className={`p-2 rounded-lg border ${formworkRatio === '1.3' ? 'bg-orange-100 border-orange-300' : 'bg-white border-gray-200'}`}>\r\n                                <div className=\"font-bold text-gray-800 mb-1\">係數 1.3</div>\r\n                                <div className=\"text-gray-600 leading-relaxed\">\r\n                                    <div className=\"font-medium text-blue-700 mb-1\">適用：簡單結構</div>\r\n                                    <ul className=\"list-disc list-inside space-y-0.5\">\r\n                                        <li>少量柱子的建築</li>\r\n                                        <li>預鑄板為主，現澆板少</li>\r\n                                        <li>單層或簡易倉庫廠房</li>\r\n                                        <li>開放式空間較多</li>\r\n                                    </ul>\r\n                                </div>\r\n                            </div>\r\n                            <div className={`p-2 rounded-lg border ${formworkRatio === '1.8' ? 'bg-orange-100 border-orange-300' : 'bg-white border-gray-200'}`}>\r\n                                <div className=\"font-bold text-gray-800 mb-1\">係數 1.8</div>\r\n                                <div className=\"text-gray-600 leading-relaxed\">\r\n                                    <div className=\"font-medium text-blue-700 mb-1\">適用：一般結構（最常用）</div>\r\n                                    <ul className=\"list-disc list-inside space-y-0.5\">\r\n                                        <li>標準框架結構</li>\r\n                                        <li>一般商業/辦公建築</li>\r\n                                        <li>標準柱距與樓板配置</li>\r\n                                        <li>3~5 層樓建築</li>\r\n                                    </ul>\r\n                                </div>\r\n                            </div>\r\n                            <div className={`p-2 rounded-lg border ${formworkRatio === '2.2' ? 'bg-orange-100 border-orange-300' : 'bg-white border-gray-200'}`}>\r\n                                <div className=\"font-bold text-gray-800 mb-1\">係數 2.2</div>\r\n                                <div className=\"text-gray-600 leading-relaxed\">\r\n                                    <div className=\"font-medium text-blue-700 mb-1\">適用：複雜結構</div>\r\n                                    <ul className=\"list-disc list-inside space-y-0.5\">\r\n                                        <li>標準多層住宅大樓</li>\r\n                                        <li>密集柱子與牆面</li>\r\n                                        <li>多樓梯/電梯井</li>\r\n                                        <li>複雜梁配置</li>\r\n                                    </ul>\r\n                                </div>\r\n                            </div>\r\n                        </div>\r\n                        <div className=\"mt-2 text-xs text-gray-500 flex items-start gap-1\">\r\n                            <span className=\"text-blue-500\">💡</span>\r\n                            <span>係數越高代表單位建築面積需要越多模板面積。實際使用時請依現場結構複雜度適當調整。</span>\r\n                        </div>\r\n                    </div>\r\n                    <WastageControl\r\n                        wastage={formworkWastage}\r\n                        setWastage={setFormworkWastage}\r\n                        defaultValue={DEFAULT_WASTAGE.formwork}\r\n                        useCustom={formworkCustomWastage}\r\n                        setUseCustom={setFormworkCustomWastage}\r\n                    />\r\n                    <ResultDisplay\r\n                        label=\"模板面積\"\r\n                        value={formworkResult}\r\n                        unit=\"m²\"\r\n                        wastageValue={formworkWithWastage}\r\n                        onAddRecord={(subType, label, value, unit, wastageValue) =>\r\n                            onAddRecord(subType, label, value, unit, wastageValue, formworkCost)}\r\n                        subType=\"模板\"\r\n                    />\r\n\r\n                    <CostInput\r\n                        label=\"模板\"\r\n                        quantity={formworkWithWastage}\r\n                        unit=\"m²\"\r\n                        vendors={vendors.filter(v => v.category === '工程工班' || v.tradeType?.includes('模板'))}\r\n                        onChange={setFormworkCost}\r\n                        placeholder={{ spec: '例：清水模板' }}\r\n                    />\r\n                </div>\r\n            )}\r\n        </div>\r\n    );\r\n};\r\n\r\n// 2️⃣ 泥作工程計算器 (支援多列輸入)\r\nconst MasonryCalculator = ({ onAddRecord, vendors = [] }) => {\r\n    const [calcType, setCalcType] = useState('mortar');\r\n\r\n    // 打底砂漿 - 多列支援\r\n    const [mortarRows, setMortarRows] = useState([\r\n        { id: 1, name: '', area: '', thickness: '2.5' }\r\n    ]);\r\n    const [mortarWastage, setMortarWastage] = useState(DEFAULT_WASTAGE.cement);\r\n    const [mortarCustomWastage, setMortarCustomWastage] = useState(false);\r\n    const [mortarCost, setMortarCost] = useState(null);\r\n\r\n    // 紅磚 - 多列支援\r\n    const [brickRows, setBrickRows] = useState([\r\n        { id: 1, name: '', area: '', wallType: '24' }\r\n    ]);\r\n    const [brickWastage, setBrickWastage] = useState(DEFAULT_WASTAGE.brick);\r\n    const [brickCustomWastage, setBrickCustomWastage] = useState(false);\r\n    const [brickCost, setBrickCost] = useState(null);\r\n\r\n    // 快速估算\r\n    const [quickArea, setQuickArea] = useState('');\r\n\r\n    // 粉光配比計算器\r\n    const [plasterRatio, setPlasterRatio] = useState('1:3');\r\n    const [plasterArea, setPlasterArea] = useState('');\r\n    const [plasterThickness, setPlasterThickness] = useState('1.5');\r\n    const [plasterCost, setPlasterCost] = useState(null);\r\n\r\n    // 計算每列砂漿結果\r\n    const mortarRowResults = mortarRows.map(row => {\r\n        const thicknessRatio = parseFloat(row.thickness) / 2.5;\r\n        const area = parseFloat(row.area) || 0;\r\n        const cement = area * 10.6 * thicknessRatio;\r\n        const sand = area * 42.8 * thicknessRatio;\r\n        return { ...row, cement, sand };\r\n    });\r\n\r\n    // 總計砂漿\r\n    const totalCement = mortarRowResults.reduce((sum, row) => sum + row.cement, 0);\r\n    const totalSand = mortarRowResults.reduce((sum, row) => sum + row.sand, 0);\r\n    const currentMortarWastage = mortarCustomWastage ? mortarWastage : DEFAULT_WASTAGE.cement;\r\n    const totalCementWithWastage = applyWastage(totalCement, currentMortarWastage);\r\n    const totalSandWithWastage = applyWastage(totalSand, currentMortarWastage);\r\n\r\n    // 砂漿列操作\r\n    const addMortarRow = () => {\r\n        const newId = Math.max(...mortarRows.map(r => r.id), 0) + 1;\r\n        setMortarRows([...mortarRows, { id: newId, name: '', area: '', thickness: '2.5' }]);\r\n    };\r\n    const removeMortarRow = (id) => {\r\n        if (mortarRows.length <= 1) return;\r\n        setMortarRows(mortarRows.filter(row => row.id !== id));\r\n    };\r\n    const updateMortarRow = (id, field, value) => {\r\n        setMortarRows(mortarRows.map(row => row.id === id ? { ...row, [field]: value } : row));\r\n    };\r\n    const clearMortarRows = () => {\r\n        setMortarRows([{ id: 1, name: '', area: '', thickness: '2.5' }]);\r\n    };\r\n\r\n    // 計算每列紅磚結果\r\n    const brickRowResults = brickRows.map(row => {\r\n        const area = parseFloat(row.area) || 0;\r\n        const count = area * (BRICK_PER_SQM[row.wallType]?.count || 128);\r\n        return { ...row, count };\r\n    });\r\n\r\n    // 總計紅磚\r\n    const totalBricks = brickRowResults.reduce((sum, row) => sum + row.count, 0);\r\n    const currentBrickWastage = brickCustomWastage ? brickWastage : DEFAULT_WASTAGE.brick;\r\n    const totalBricksWithWastage = applyWastage(totalBricks, currentBrickWastage);\r\n\r\n    // 紅磚列操作\r\n    const addBrickRow = () => {\r\n        const newId = Math.max(...brickRows.map(r => r.id), 0) + 1;\r\n        setBrickRows([...brickRows, { id: newId, name: '', area: '', wallType: '24' }]);\r\n    };\r\n    const removeBrickRow = (id) => {\r\n        if (brickRows.length <= 1) return;\r\n        setBrickRows(brickRows.filter(row => row.id !== id));\r\n    };\r\n    const updateBrickRow = (id, field, value) => {\r\n        setBrickRows(brickRows.map(row => row.id === id ? { ...row, [field]: value } : row));\r\n    };\r\n    const clearBrickRows = () => {\r\n        setBrickRows([{ id: 1, name: '', area: '', wallType: '24' }]);\r\n    };\r\n\r\n    // 快速估算\r\n    const quickCement = (parseFloat(quickArea) || 0) * 0.4;\r\n    const quickSand = (parseFloat(quickArea) || 0) * 0.05;\r\n\r\n    // 粉光配比計算\r\n    const selectedPlaster = PLASTER_RATIOS[plasterRatio];\r\n    const plasterAreaNum = parseFloat(plasterArea) || 0;\r\n    const plasterThicknessNum = parseFloat(plasterThickness) / 100; // cm to m\r\n    const plasterVolume = plasterAreaNum * plasterThicknessNum; // m³\r\n    const plasterCement = plasterVolume * selectedPlaster.cementPerM3;\r\n    const plasterSand = plasterVolume * selectedPlaster.sandPerM3;\r\n\r\n    return (\r\n        <div className=\"space-y-4\">\r\n            <div className=\"flex gap-2 flex-wrap\">\r\n                {[\r\n                    { id: 'mortar', label: '打底砂漿' },\r\n                    { id: 'plaster', label: '粉光配比' },\r\n                    { id: 'brick', label: '紅磚用量' },\r\n                    { id: 'quick', label: '快速估算' },\r\n                ].map(item => (\r\n                    <button\r\n                        key={item.id}\r\n                        onClick={() => setCalcType(item.id)}\r\n                        className={`px-4 py-2 rounded-lg text-sm font-medium transition-all ${calcType === item.id ? 'bg-orange-500 text-white' : 'bg-gray-100 hover:bg-gray-200'\r\n                            }`}\r\n                    >\r\n                        {item.label}\r\n                    </button>\r\n                ))}\r\n            </div>\r\n\r\n            {/* 粉光配比計算器 */}\r\n            {calcType === 'plaster' && (\r\n                <div className=\"bg-white rounded-xl p-4 border border-gray-100 space-y-4\">\r\n                    <div className=\"flex items-center gap-2 text-sm text-gray-600\">\r\n                        <Info size={16} />\r\n                        <div>\r\n                            <p>1:2 粉光: 水泥 650kg/m³ + 砂 800kg/m³ (細緻)</p>\r\n                            <p>1:3 打底: 水泥 450kg/m³ + 砂 950kg/m³ (一般)</p>\r\n                        </div>\r\n                    </div>\r\n\r\n                    <div className=\"grid grid-cols-1 sm:grid-cols-3 gap-3\">\r\n                        <SelectField\r\n                            label=\"配比選擇\"\r\n                            value={plasterRatio}\r\n                            onChange={setPlasterRatio}\r\n                            options={Object.entries(PLASTER_RATIOS).map(([k, v]) => ({ value: k, label: v.label }))}\r\n                        />\r\n                        <InputField label=\"施作面積\" value={plasterArea} onChange={setPlasterArea} unit=\"m²\" placeholder=\"0\" />\r\n                        <InputField label=\"塗抹厚度\" value={plasterThickness} onChange={setPlasterThickness} unit=\"cm\" placeholder=\"1.5\" />\r\n                    </div>\r\n\r\n                    <div className=\"grid grid-cols-2 gap-3\">\r\n                        <ResultDisplay\r\n                            label=\"水泥用量\"\r\n                            value={plasterCement}\r\n                            unit=\"kg\"\r\n                            showWastage={false}\r\n                            onAddRecord={(subType, label, value, unit, wastageValue) =>\r\n                                onAddRecord(subType, label, value, unit, wastageValue, plasterCost)}\r\n                            subType={`粉光 ${plasterRatio}`}\r\n                        />\r\n                        <ResultDisplay\r\n                            label=\"砂用量\"\r\n                            value={plasterSand}\r\n                            unit=\"kg\"\r\n                            showWastage={false}\r\n                            onAddRecord={(subType, label, value, unit, wastageValue) =>\r\n                                onAddRecord(subType, label, value, unit, wastageValue, plasterCost)}\r\n                            subType={`粉光 ${plasterRatio}`}\r\n                        />\r\n                    </div>\r\n\r\n                    <CostInput\r\n                        label=\"水泥/砂\"\r\n                        quantity={plasterCement + plasterSand} // 簡易加總，實際可能需分開但此處簡化\r\n                        unit=\"kg\"\r\n                        vendors={vendors.filter(v => v.category === '建材供應' || v.tradeType?.includes('水泥'))}\r\n                        onChange={setPlasterCost}\r\n                        placeholder={{ spec: '例：水泥+砂' }}\r\n                    />\r\n                </div>\r\n            )}\r\n\r\n            {/* 打底砂漿 - 多列模式 */}\r\n            {calcType === 'mortar' && (\r\n                <div className=\"bg-white rounded-xl p-4 border border-gray-100 space-y-4\">\r\n                    <div className=\"flex items-center justify-between\">\r\n                        <div className=\"flex items-center gap-2 text-sm text-gray-600\">\r\n                            <Info size={16} />\r\n                            公式: 1:3 砂漿, 基準: 2.5cm厚 → 水泥 10.6kg/m², 砂 42.8kg/m²\r\n                        </div>\r\n                        <div className=\"flex items-center gap-2\">\r\n                            <span className=\"text-xs text-gray-500\">{mortarRows.length} 列</span>\r\n                            <button\r\n                                onClick={() => mortarRows.length > 1 && removeMortarRow(mortarRows[mortarRows.length - 1].id)}\r\n                                disabled={mortarRows.length <= 1}\r\n                                className=\"w-7 h-7 rounded-lg bg-red-100 text-red-600 flex items-center justify-center hover:bg-red-200 disabled:opacity-50 disabled:cursor-not-allowed transition-colors\"\r\n                            >\r\n                                <span className=\"text-lg font-bold leading-none\">−</span>\r\n                            </button>\r\n                            <button\r\n                                onClick={addMortarRow}\r\n                                className=\"w-7 h-7 rounded-lg bg-green-100 text-green-600 flex items-center justify-center hover:bg-green-200 transition-colors\"\r\n                            >\r\n                                <Plus size={16} />\r\n                            </button>\r\n                            {mortarRows.length > 1 && (\r\n                                <button onClick={clearMortarRows} className=\"text-xs text-gray-500 hover:text-gray-700 ml-1\">清空</button>\r\n                            )}\r\n                        </div>\r\n                    </div>\r\n\r\n                    <div className=\"space-y-2 max-h-[400px] overflow-y-auto\">\r\n                        {mortarRows.map((row, index) => (\r\n                            <div key={row.id} className=\"bg-gray-50 rounded-lg p-3 border border-gray-100\">\r\n                                <div className=\"grid grid-cols-12 gap-2 items-end\">\r\n                                    <div className=\"col-span-12 sm:col-span-3\">\r\n                                        <label className=\"block text-xs text-gray-500 mb-1\">名稱</label>\r\n                                        <input\r\n                                            type=\"text\"\r\n                                            value={row.name}\r\n                                            onChange={(e) => updateMortarRow(row.id, 'name', e.target.value)}\r\n                                            placeholder={`區域 ${index + 1}`}\r\n                                            className=\"w-full px-2 py-1.5 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-orange-500 focus:border-transparent\"\r\n                                        />\r\n                                    </div>\r\n                                    <div className=\"col-span-5 sm:col-span-3\">\r\n                                        <label className=\"block text-xs text-gray-500 mb-1\">施作面積</label>\r\n                                        <div className=\"relative\">\r\n                                            <input\r\n                                                type=\"number\"\r\n                                                value={row.area}\r\n                                                onChange={(e) => updateMortarRow(row.id, 'area', e.target.value)}\r\n                                                placeholder=\"0\"\r\n                                                min=\"0\"\r\n                                                className=\"w-full px-2 py-1.5 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-orange-500 focus:border-transparent pr-8\"\r\n                                            />\r\n                                            <span className=\"absolute right-2 top-1/2 -translate-y-1/2 text-xs text-gray-400\">m²</span>\r\n                                        </div>\r\n                                    </div>\r\n                                    <div className=\"col-span-5 sm:col-span-2\">\r\n                                        <label className=\"block text-xs text-gray-500 mb-1\">厚度</label>\r\n                                        <select\r\n                                            value={row.thickness}\r\n                                            onChange={(e) => updateMortarRow(row.id, 'thickness', e.target.value)}\r\n                                            className=\"w-full px-2 py-1.5 border border-gray-200 rounded-lg text-sm bg-white focus:ring-2 focus:ring-orange-500\"\r\n                                        >\r\n                                            <option value=\"1.5\">1.5cm</option>\r\n                                            <option value=\"2.0\">2.0cm</option>\r\n                                            <option value=\"2.5\">2.5cm</option>\r\n                                            <option value=\"3.0\">3.0cm</option>\r\n                                            <option value=\"4.0\">4.0cm</option>\r\n                                        </select>\r\n                                    </div>\r\n                                    <div className=\"col-span-10 sm:col-span-3 flex items-center gap-2\">\r\n                                        <div className=\"flex-1 text-xs\">\r\n                                            <span className=\"text-gray-500\">水泥:</span> <span className=\"font-bold text-orange-600\">{formatNumber(mortarRowResults[index].cement, 1)}kg</span>\r\n                                            <span className=\"text-gray-500 ml-2\">砂:</span> <span className=\"font-bold text-orange-600\">{formatNumber(mortarRowResults[index].sand, 1)}kg</span>\r\n                                        </div>\r\n                                    </div>\r\n                                    <div className=\"col-span-2 sm:col-span-1 flex justify-end\">\r\n                                        <button\r\n                                            onClick={() => removeMortarRow(row.id)}\r\n                                            disabled={mortarRows.length <= 1}\r\n                                            className=\"p-1.5 text-red-400 hover:text-red-600 hover:bg-red-50 rounded-lg transition-colors disabled:opacity-30 disabled:cursor-not-allowed\"\r\n                                        >\r\n                                            <Trash2 size={14} />\r\n                                        </button>\r\n                                    </div>\r\n                                </div>\r\n                            </div>\r\n                        ))}\r\n                    </div>\r\n\r\n                    <button\r\n                        onClick={addMortarRow}\r\n                        className=\"w-full py-2 border-2 border-dashed border-gray-200 rounded-xl text-gray-400 hover:border-orange-300 hover:text-orange-500 transition-colors flex items-center justify-center gap-2 text-sm\"\r\n                    >\r\n                        <Plus size={16} />\r\n                        +增加新欄位\r\n                    </button>\r\n\r\n                    <WastageControl\r\n                        wastage={mortarWastage}\r\n                        setWastage={setMortarWastage}\r\n                        defaultValue={DEFAULT_WASTAGE.cement}\r\n                        useCustom={mortarCustomWastage}\r\n                        setUseCustom={setMortarCustomWastage}\r\n                    />\r\n\r\n                    <div className=\"grid grid-cols-2 gap-3\">\r\n                        <ResultDisplay\r\n                            label={`水泥用量 (共 ${mortarRowResults.filter(r => r.cement > 0).length} 項)`}\r\n                            value={totalCement}\r\n                            unit=\"kg\"\r\n                            wastageValue={totalCementWithWastage}\r\n                            onAddRecord={(subType, label, value, unit, wastageValue) =>\r\n                                onAddRecord(subType, label, value, unit, wastageValue, mortarCost)}\r\n                            subType=\"打底砂漿\"\r\n                        />\r\n                        <ResultDisplay\r\n                            label={`砂用量 (共 ${mortarRowResults.filter(r => r.sand > 0).length} 項)`}\r\n                            value={totalSand}\r\n                            unit=\"kg\"\r\n                            wastageValue={totalSandWithWastage}\r\n                            onAddRecord={(subType, label, value, unit, wastageValue) =>\r\n                                onAddRecord(subType, label, value, unit, wastageValue, mortarCost)}\r\n                            subType=\"打底砂漿\"\r\n                        />\r\n                    </div>\r\n\r\n                    <CostInput\r\n                        label=\"水泥/砂\"\r\n                        quantity={totalCementWithWastage + totalSandWithWastage}\r\n                        unit=\"kg\"\r\n                        vendors={vendors.filter(v => v.category === '建材供應' || v.tradeType?.includes('水泥'))}\r\n                        onChange={setMortarCost}\r\n                        placeholder={{ spec: '例：水泥+砂' }}\r\n                    />\r\n\r\n                    {mortarRowResults.filter(r => r.cement > 0).length > 1 && (\r\n                        <div className=\"bg-gray-50 rounded-lg p-3 text-xs\">\r\n                            <div className=\"font-medium text-gray-700 mb-2\">各項明細:</div>\r\n                            <div className=\"space-y-1\">\r\n                                {mortarRowResults.filter(r => r.cement > 0).map((row, idx) => (\r\n                                    <div key={row.id} className=\"flex justify-between text-gray-600\">\r\n                                        <span>{row.name || `區域 ${idx + 1}`} ({row.area}m² × {row.thickness}cm)</span>\r\n                                        <span className=\"font-medium\">水泥 {formatNumber(row.cement, 1)}kg, 砂 {formatNumber(row.sand, 1)}kg</span>\r\n                                    </div>\r\n                                ))}\r\n                            </div>\r\n                        </div>\r\n                    )}\r\n                </div>\r\n            )}\r\n\r\n            {/* 紅磚用量 - 多列模式 */}\r\n            {calcType === 'brick' && (\r\n                <div className=\"bg-white rounded-xl p-4 border border-gray-100 space-y-4\">\r\n                    <div className=\"flex items-center justify-between\">\r\n                        <div className=\"flex items-center gap-2 text-sm text-gray-600\">\r\n                            <Info size={16} />\r\n                            12牆=64塊/m², 18牆=96塊/m², 24牆=128塊/m², 37牆=192塊/m²\r\n                        </div>\r\n                        <div className=\"flex items-center gap-2\">\r\n                            <span className=\"text-xs text-gray-500\">{brickRows.length} 列</span>\r\n                            <button\r\n                                onClick={() => brickRows.length > 1 && removeBrickRow(brickRows[brickRows.length - 1].id)}\r\n                                disabled={brickRows.length <= 1}\r\n                                className=\"w-7 h-7 rounded-lg bg-red-100 text-red-600 flex items-center justify-center hover:bg-red-200 disabled:opacity-50 disabled:cursor-not-allowed transition-colors\"\r\n                            >\r\n                                <span className=\"text-lg font-bold leading-none\">−</span>\r\n                            </button>\r\n                            <button\r\n                                onClick={addBrickRow}\r\n                                className=\"w-7 h-7 rounded-lg bg-green-100 text-green-600 flex items-center justify-center hover:bg-green-200 transition-colors\"\r\n                            >\r\n                                <Plus size={16} />\r\n                            </button>\r\n                            {brickRows.length > 1 && (\r\n                                <button onClick={clearBrickRows} className=\"text-xs text-gray-500 hover:text-gray-700 ml-1\">清空</button>\r\n                            )}\r\n                        </div>\r\n                    </div>\r\n\r\n                    <div className=\"space-y-2 max-h-[400px] overflow-y-auto\">\r\n                        {brickRows.map((row, index) => (\r\n                            <div key={row.id} className=\"bg-gray-50 rounded-lg p-3 border border-gray-100\">\r\n                                <div className=\"grid grid-cols-12 gap-2 items-end\">\r\n                                    <div className=\"col-span-12 sm:col-span-3\">\r\n                                        <label className=\"block text-xs text-gray-500 mb-1\">名稱</label>\r\n                                        <input\r\n                                            type=\"text\"\r\n                                            value={row.name}\r\n                                            onChange={(e) => updateBrickRow(row.id, 'name', e.target.value)}\r\n                                            placeholder={`牆面 ${index + 1}`}\r\n                                            className=\"w-full px-2 py-1.5 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-orange-500 focus:border-transparent\"\r\n                                        />\r\n                                    </div>\r\n                                    <div className=\"col-span-5 sm:col-span-3\">\r\n                                        <label className=\"block text-xs text-gray-500 mb-1\">牆面面積</label>\r\n                                        <div className=\"relative\">\r\n                                            <input\r\n                                                type=\"number\"\r\n                                                value={row.area}\r\n                                                onChange={(e) => updateBrickRow(row.id, 'area', e.target.value)}\r\n                                                placeholder=\"0\"\r\n                                                min=\"0\"\r\n                                                className=\"w-full px-2 py-1.5 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-orange-500 focus:border-transparent pr-8\"\r\n                                            />\r\n                                            <span className=\"absolute right-2 top-1/2 -translate-y-1/2 text-xs text-gray-400\">m²</span>\r\n                                        </div>\r\n                                    </div>\r\n                                    <div className=\"col-span-5 sm:col-span-2\">\r\n                                        <label className=\"block text-xs text-gray-500 mb-1\">牆厚</label>\r\n                                        <select\r\n                                            value={row.wallType}\r\n                                            onChange={(e) => updateBrickRow(row.id, 'wallType', e.target.value)}\r\n                                            className=\"w-full px-2 py-1.5 border border-gray-200 rounded-lg text-sm bg-white focus:ring-2 focus:ring-orange-500\"\r\n                                        >\r\n                                            {Object.entries(BRICK_PER_SQM).map(([k, v]) => (\r\n                                                <option key={k} value={k}>{v.label}</option>\r\n                                            ))}\r\n                                        </select>\r\n                                    </div>\r\n                                    <div className=\"col-span-10 sm:col-span-3 flex items-center\">\r\n                                        <div className=\"flex-1\">\r\n                                            <label className=\"block text-xs text-gray-500 mb-1\">數量</label>\r\n                                            <div className=\"text-sm font-bold text-orange-600\">\r\n                                                {brickRowResults[index].count > 0 ? `${formatNumber(brickRowResults[index].count, 0)} 塊` : '--'}\r\n                                            </div>\r\n                                        </div>\r\n                                    </div>\r\n                                    <div className=\"col-span-2 sm:col-span-1 flex justify-end\">\r\n                                        <button\r\n                                            onClick={() => removeBrickRow(row.id)}\r\n                                            disabled={brickRows.length <= 1}\r\n                                            className=\"p-1.5 text-red-400 hover:text-red-600 hover:bg-red-50 rounded-lg transition-colors disabled:opacity-30 disabled:cursor-not-allowed\"\r\n                                        >\r\n                                            <Trash2 size={14} />\r\n                                        </button>\r\n                                    </div>\r\n                                </div>\r\n                            </div>\r\n                        ))}\r\n                    </div>\r\n\r\n                    <button\r\n                        onClick={addBrickRow}\r\n                        className=\"w-full py-2 border-2 border-dashed border-gray-200 rounded-xl text-gray-400 hover:border-orange-300 hover:text-orange-500 transition-colors flex items-center justify-center gap-2 text-sm\"\r\n                    >\r\n                        <Plus size={16} />\r\n                        +增加新欄位\r\n                    </button>\r\n\r\n                    <WastageControl\r\n                        wastage={brickWastage}\r\n                        setWastage={setBrickWastage}\r\n                        defaultValue={DEFAULT_WASTAGE.brick}\r\n                        useCustom={brickCustomWastage}\r\n                        setUseCustom={setBrickCustomWastage}\r\n                    />\r\n\r\n                    <ResultDisplay\r\n                        label={`紅磚數量 (共 ${brickRowResults.filter(r => r.count > 0).length} 項)`}\r\n                        value={totalBricks}\r\n                        unit=\"塊\"\r\n                        wastageValue={totalBricksWithWastage}\r\n                        onAddRecord={(subType, label, value, unit, wastageValue) =>\r\n                            onAddRecord(subType, label, value, unit, wastageValue, brickCost)}\r\n                        subType=\"紅磚\"\r\n                    />\r\n\r\n                    <CostInput\r\n                        label=\"紅磚\"\r\n                        quantity={totalBricksWithWastage}\r\n                        unit=\"塊\"\r\n                        vendors={vendors.filter(v => v.category === '建材供應' || v.tradeType?.includes('磚'))}\r\n                        onChange={setBrickCost}\r\n                        placeholder={{ spec: '例：2寸紅磚' }}\r\n                    />\r\n\r\n                    {brickRowResults.filter(r => r.count > 0).length > 1 && (\r\n                        <div className=\"bg-gray-50 rounded-lg p-3 text-xs\">\r\n                            <div className=\"font-medium text-gray-700 mb-2\">各項明細:</div>\r\n                            <div className=\"space-y-1\">\r\n                                {brickRowResults.filter(r => r.count > 0).map((row, idx) => (\r\n                                    <div key={row.id} className=\"flex justify-between text-gray-600\">\r\n                                        <span>{row.name || `牆面 ${idx + 1}`} ({row.area}m² × {BRICK_PER_SQM[row.wallType]?.label})</span>\r\n                                        <span className=\"font-medium\">{formatNumber(row.count, 0)} 塊</span>\r\n                                    </div>\r\n                                ))}\r\n                            </div>\r\n                        </div>\r\n                    )}\r\n                </div>\r\n            )}\r\n\r\n            {calcType === 'quick' && (\r\n                <div className=\"bg-white rounded-xl p-4 border border-gray-100 space-y-4\">\r\n                    <div className=\"flex items-center gap-2 text-sm text-gray-600\">\r\n                        <Info size={16} />\r\n                        裝修口訣: 水泥=面積×0.4, 砂=面積×0.05\r\n                    </div>\r\n                    <InputField label=\"建築面積\" value={quickArea} onChange={setQuickArea} unit=\"m²\" placeholder=\"0\" />\r\n                    <div className=\"grid grid-cols-2 gap-3\">\r\n                        <ResultDisplay label=\"水泥概估\" value={quickCement} unit=\"包\" showWastage={false} onAddRecord={onAddRecord} subType=\"快速估算\" />\r\n                        <ResultDisplay label=\"砂概估\" value={quickSand} unit=\"m³\" showWastage={false} onAddRecord={onAddRecord} subType=\"快速估算\" />\r\n                    </div>\r\n                </div>\r\n            )}\r\n        </div>\r\n    );\r\n};\r\n\r\n\r\n// 3️⃣ 磁磚工程計算器 (支援多列輸入)\r\nconst TileCalculator = ({ onAddRecord, vendors = [] }) => {\r\n    const [calcType, setCalcType] = useState('tiles');\r\n\r\n    // 磁磚片數 - 多列支援\r\n    const [tileRows, setTileRows] = useState([\r\n        { id: 1, name: '', area: '', unit: 'ping', sizeIdx: 3, method: 'none' }\r\n    ]);\r\n    const [customTileL, setCustomTileL] = useState('60');\r\n    const [customTileW, setCustomTileW] = useState('60');\r\n    const [tileWastage, setTileWastage] = useState(DEFAULT_WASTAGE.tile);\r\n    const [tileCustomWastage, setTileCustomWastage] = useState(false);\r\n    const [tileCost, setTileCost] = useState(null);\r\n\r\n    // 填縫劑 - 多列支援\r\n    const [groutRows, setGroutRows] = useState([\r\n        { id: 1, name: '', area: '' }\r\n    ]);\r\n    const [groutTileL, setGroutTileL] = useState('60');\r\n    const [groutTileW, setGroutTileW] = useState('60');\r\n    const [groutWidth, setGroutWidth] = useState('3');\r\n    const [groutDepth, setGroutDepth] = useState('5');\r\n    const [groutWastage, setGroutWastage] = useState(DEFAULT_WASTAGE.grout);\r\n    const [groutCustomWastage, setGroutCustomWastage] = useState(false);\r\n    const [groutCost, setGroutCost] = useState(null);\r\n\r\n    // 黏著劑 - 多列支援\r\n    const [adhesiveRows, setAdhesiveRows] = useState([\r\n        { id: 1, name: '', area: '', trowel: '4' }\r\n    ]);\r\n    const [adhesiveWastage, setAdhesiveWastage] = useState(DEFAULT_WASTAGE.adhesive);\r\n    const [adhesiveCustomWastage, setAdhesiveCustomWastage] = useState(false);\r\n    const [adhesiveCost, setAdhesiveCost] = useState(null);\r\n\r\n    // 計算每列磁磚結果\r\n    const tileRowResults = tileRows.map(row => {\r\n        const selectedTile = TILE_SIZES[row.sizeIdx] || TILE_SIZES[3];\r\n        const tileL = selectedTile.l || parseFloat(customTileL) || 60;\r\n        const tileW = selectedTile.w || parseFloat(customTileW) || 60;\r\n        const areaSqm = row.unit === 'ping' ? (parseFloat(row.area) || 0) * 3.30579 : (parseFloat(row.area) || 0);\r\n        const tilesPerSqm = 10000 / (tileL * tileW);\r\n        const count = areaSqm * tilesPerSqm;\r\n        return { ...row, count, tileL, tileW };\r\n    });\r\n\r\n    // 總計磁磚\r\n    const totalTiles = tileRowResults.reduce((sum, row) => sum + row.count, 0);\r\n    const currentTileWastage = tileCustomWastage ? tileWastage : DEFAULT_WASTAGE.tile;\r\n    const totalTilesWithWastage = applyWastage(totalTiles, currentTileWastage);\r\n    const selectedTileForDisplay = TILE_SIZES[tileRows[0]?.sizeIdx || 3];\r\n    const displayTileL = selectedTileForDisplay.l || parseFloat(customTileL) || 60;\r\n    const displayTileW = selectedTileForDisplay.w || parseFloat(customTileW) || 60;\r\n    const tileCountPerPing = 32400 / (displayTileL * displayTileW);\r\n    const [tileLaborCost, setTileLaborCost] = useState(null);\r\n\r\n    // 計算總坪數 (用於工資計算)\r\n    const totalAreaPing = tileRowResults.reduce((sum, row) => {\r\n        const area = parseFloat(row.area) || 0;\r\n        return sum + (row.unit === 'ping' ? area : area * 0.3025);\r\n    }, 0);\r\n\r\n    // 磁磚列操作\r\n    const addTileRow = () => {\r\n        const newId = Math.max(...tileRows.map(r => r.id), 0) + 1;\r\n        setTileRows([...tileRows, { id: newId, name: '', area: '', unit: 'ping', sizeIdx: 3, method: 'none' }]);\r\n    };\r\n    const removeTileRow = (id) => {\r\n        if (tileRows.length <= 1) return;\r\n        setTileRows(tileRows.filter(row => row.id !== id));\r\n    };\r\n    const updateTileRow = (id, field, value) => {\r\n        setTileRows(tileRows.map(row => row.id === id ? { ...row, [field]: value } : row));\r\n    };\r\n    const clearTileRows = () => {\r\n        setTileRows([{ id: 1, name: '', area: '', unit: 'ping', sizeIdx: 3 }]);\r\n    };\r\n\r\n    // 計算填縫劑結果\r\n    const L = parseFloat(groutTileL) * 10 || 600;\r\n    const W = parseFloat(groutTileW) * 10 || 600;\r\n    const D = parseFloat(groutWidth) || 3;\r\n    const C = parseFloat(groutDepth) || 5;\r\n    const groutPerSqm = ((L + W) / (L * W)) * D * C * 1.7;\r\n\r\n    const groutRowResults = groutRows.map(row => {\r\n        const area = parseFloat(row.area) || 0;\r\n        const amount = area * groutPerSqm;\r\n        return { ...row, amount };\r\n    });\r\n\r\n    const totalGrout = groutRowResults.reduce((sum, row) => sum + row.amount, 0);\r\n    const currentGroutWastage = groutCustomWastage ? groutWastage : DEFAULT_WASTAGE.grout;\r\n    const totalGroutWithWastage = applyWastage(totalGrout, currentGroutWastage);\r\n\r\n    // 填縫劑列操作\r\n    const addGroutRow = () => {\r\n        const newId = Math.max(...groutRows.map(r => r.id), 0) + 1;\r\n        setGroutRows([...groutRows, { id: newId, name: '', area: '' }]);\r\n    };\r\n    const removeGroutRow = (id) => {\r\n        if (groutRows.length <= 1) return;\r\n        setGroutRows(groutRows.filter(row => row.id !== id));\r\n    };\r\n    const updateGroutRow = (id, field, value) => {\r\n        setGroutRows(groutRows.map(row => row.id === id ? { ...row, [field]: value } : row));\r\n    };\r\n    const clearGroutRows = () => {\r\n        setGroutRows([{ id: 1, name: '', area: '' }]);\r\n    };\r\n\r\n    // 計算黏著劑結果\r\n    const adhesiveRowResults = adhesiveRows.map(row => {\r\n        const perSqm = parseFloat(row.trowel) === 4 ? 2.5 : parseFloat(row.trowel) === 6 ? 6.25 : 4;\r\n        const area = parseFloat(row.area) || 0;\r\n        const amount = area * perSqm;\r\n        return { ...row, amount };\r\n    });\r\n\r\n    const totalAdhesive = adhesiveRowResults.reduce((sum, row) => sum + row.amount, 0);\r\n    const currentAdhesiveWastage = adhesiveCustomWastage ? adhesiveWastage : DEFAULT_WASTAGE.adhesive;\r\n    const totalAdhesiveWithWastage = applyWastage(totalAdhesive, currentAdhesiveWastage);\r\n\r\n    // 黏著劑列操作\r\n    const addAdhesiveRow = () => {\r\n        const newId = Math.max(...adhesiveRows.map(r => r.id), 0) + 1;\r\n        setAdhesiveRows([...adhesiveRows, { id: newId, name: '', area: '', trowel: '4' }]);\r\n    };\r\n    const removeAdhesiveRow = (id) => {\r\n        if (adhesiveRows.length <= 1) return;\r\n        setAdhesiveRows(adhesiveRows.filter(row => row.id !== id));\r\n    };\r\n    const updateAdhesiveRow = (id, field, value) => {\r\n        setAdhesiveRows(adhesiveRows.map(row => row.id === id ? { ...row, [field]: value } : row));\r\n    };\r\n    const clearAdhesiveRows = () => {\r\n        setAdhesiveRows([{ id: 1, name: '', area: '', trowel: '4' }]);\r\n    };\r\n\r\n    return (\r\n        <div className=\"space-y-4\">\r\n            <div className=\"flex gap-2 flex-wrap\">\r\n                {[\r\n                    { id: 'tiles', label: '磁磚片數' },\r\n                    { id: 'grout', label: '填縫劑' },\r\n                    { id: 'adhesive', label: '黏著劑' },\r\n                ].map(item => (\r\n                    <button\r\n                        key={item.id}\r\n                        onClick={() => setCalcType(item.id)}\r\n                        className={`px-4 py-2 rounded-lg text-sm font-medium transition-all ${calcType === item.id ? 'bg-orange-500 text-white' : 'bg-gray-100 hover:bg-gray-200'}`}\r\n                    >\r\n                        {item.label}\r\n                    </button>\r\n                ))}\r\n            </div>\r\n\r\n            {/* 磁磚片數 - 多列模式 */}\r\n            {calcType === 'tiles' && (\r\n                <div className=\"bg-white rounded-xl p-4 border border-gray-100 space-y-4\">\r\n                    <div className=\"flex items-center justify-between\">\r\n                        <div className=\"flex items-center gap-2 text-sm text-gray-600\">\r\n                            <Info size={16} />\r\n                            公式: 每坪片數 = 32400 ÷ (長cm × 寬cm)\r\n                        </div>\r\n                        <div className=\"flex items-center gap-2\">\r\n                            <span className=\"text-xs text-gray-500\">{tileRows.length} 列</span>\r\n                            <button\r\n                                onClick={() => tileRows.length > 1 && removeTileRow(tileRows[tileRows.length - 1].id)}\r\n                                disabled={tileRows.length <= 1}\r\n                                className=\"w-7 h-7 rounded-lg bg-red-100 text-red-600 flex items-center justify-center hover:bg-red-200 disabled:opacity-50 disabled:cursor-not-allowed transition-colors\"\r\n                            >\r\n                                <span className=\"text-lg font-bold leading-none\">−</span>\r\n                            </button>\r\n                            <button onClick={addTileRow} className=\"w-7 h-7 rounded-lg bg-green-100 text-green-600 flex items-center justify-center hover:bg-green-200 transition-colors\">\r\n                                <Plus size={16} />\r\n                            </button>\r\n                            {tileRows.length > 1 && <button onClick={clearTileRows} className=\"text-xs text-gray-500 hover:text-gray-700 ml-1\">清空</button>}\r\n                        </div>\r\n                    </div>\r\n\r\n                    <div className=\"space-y-2 max-h-[400px] overflow-y-auto\">\r\n                        {tileRows.map((row, index) => (\r\n                            <div key={row.id} className=\"bg-gray-50 rounded-lg p-3 border border-gray-100\">\r\n                                <div className=\"grid grid-cols-12 gap-2 items-end\">\r\n                                    <div className=\"col-span-6 sm:col-span-2\">\r\n                                        <label className=\"block text-xs text-gray-500 mb-1\">名稱</label>\r\n                                        <input type=\"text\" value={row.name} onChange={(e) => updateTileRow(row.id, 'name', e.target.value)}\r\n                                            placeholder={`區域 ${index + 1}`} className=\"w-full px-2 py-1.5 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-orange-500 focus:border-transparent\" />\r\n                                    </div>\r\n                                    <div className=\"col-span-6 sm:col-span-2\">\r\n                                        <label className=\"block text-xs text-gray-500 mb-1\">面積</label>\r\n                                        <div className=\"relative\">\r\n                                            <input type=\"number\" value={row.area} onChange={(e) => updateTileRow(row.id, 'area', e.target.value)}\r\n                                                placeholder=\"0\" min=\"0\" className=\"w-full px-2 py-1.5 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-orange-500 focus:border-transparent pr-8\" />\r\n                                            <span className=\"absolute right-2 top-1/2 -translate-y-1/2 text-xs text-gray-400\">{row.unit === 'ping' ? '坪' : 'm²'}</span>\r\n                                        </div>\r\n                                    </div>\r\n                                    <div className=\"col-span-4 sm:col-span-1\">\r\n                                        <label className=\"block text-xs text-gray-500 mb-1\">單位</label>\r\n                                        <select value={row.unit} onChange={(e) => updateTileRow(row.id, 'unit', e.target.value)}\r\n                                            className=\"w-full px-2 py-1.5 border border-gray-200 rounded-lg text-sm bg-white focus:ring-2 focus:ring-orange-500\">\r\n                                            <option value=\"ping\">坪</option>\r\n                                            <option value=\"sqm\">m²</option>\r\n                                        </select>\r\n                                    </div>\r\n                                    <div className=\"col-span-4 sm:col-span-2\">\r\n                                        <label className=\"block text-xs text-gray-500 mb-1\">磁磚尺寸</label>\r\n                                        <select value={row.sizeIdx} onChange={(e) => updateTileRow(row.id, 'sizeIdx', parseInt(e.target.value))}\r\n                                            className=\"w-full px-2 py-1.5 border border-gray-200 rounded-lg text-sm bg-white focus:ring-2 focus:ring-orange-500\">\r\n                                            {TILE_SIZES.map((t, i) => <option key={i} value={i}>{t.label}</option>)}\r\n                                        </select>\r\n                                    </div>\r\n                                    <div className=\"col-span-4 sm:col-span-2\">\r\n                                        <label className=\"block text-xs text-gray-500 mb-1\">施工方法</label>\r\n                                        <select value={row.method} onChange={(e) => updateTileRow(row.id, 'method', e.target.value)}\r\n                                            className=\"w-full px-2 py-1.5 border border-gray-200 rounded-lg text-sm bg-white focus:ring-2 focus:ring-orange-500\">\r\n                                            {TILE_METHODS.map((m) => <option key={m.value} value={m.value}>{m.label}</option>)}\r\n                                        </select>\r\n                                    </div>\r\n                                    <div className=\"col-span-10 sm:col-span-2 flex items-center\">\r\n                                        <div className=\"flex-1\">\r\n                                            <label className=\"block text-xs text-gray-500 mb-1\">片數</label>\r\n                                            <div className=\"text-sm font-bold text-orange-600\">\r\n                                                {tileRowResults[index].count > 0 ? `${formatNumber(tileRowResults[index].count, 0)} 片` : '--'}\r\n                                            </div>\r\n                                        </div>\r\n                                    </div>\r\n                                    <div className=\"col-span-2 sm:col-span-1 flex justify-end\">\r\n                                        <button onClick={() => removeTileRow(row.id)} disabled={tileRows.length <= 1}\r\n                                            className=\"p-1.5 text-red-400 hover:text-red-600 hover:bg-red-50 rounded-lg transition-colors disabled:opacity-30 disabled:cursor-not-allowed\">\r\n                                            <Trash2 size={14} />\r\n                                        </button>\r\n                                    </div>\r\n                                </div>\r\n                            </div>\r\n                        ))}\r\n                    </div>\r\n\r\n                    <button onClick={addTileRow} className=\"w-full py-2 border-2 border-dashed border-gray-200 rounded-xl text-gray-400 hover:border-orange-300 hover:text-orange-500 transition-colors flex items-center justify-center gap-2 text-sm\">\r\n                        <Plus size={16} />+增加新欄位\r\n                    </button>\r\n\r\n                    <div className=\"text-xs text-gray-500 bg-gray-50 p-2 rounded\">\r\n                        60×60cm 磁磚每坪約 <strong>{formatNumber(tileCountPerPing, 1)}</strong> 片\r\n                    </div>\r\n\r\n                    <WastageControl wastage={tileWastage} setWastage={setTileWastage} defaultValue={DEFAULT_WASTAGE.tile} useCustom={tileCustomWastage} setUseCustom={setTileCustomWastage} />\r\n\r\n                    <ResultDisplay\r\n                        label={`磁磚片數 (共 ${tileRowResults.filter(r => r.count > 0).length} 項)`}\r\n                        value={totalTiles}\r\n                        unit=\"片\"\r\n                        wastageValue={totalTilesWithWastage}\r\n                        onAddRecord={(subType, label, value, unit, wastageValue) =>\r\n                            onAddRecord(subType, label, value, unit, wastageValue, tileCost)}\r\n                        subType=\"磁磚\"\r\n                    />\r\n\r\n                    <CostInput\r\n                        label=\"磁磚\"\r\n                        quantity={totalTilesWithWastage}\r\n                        unit=\"片\"\r\n                        vendors={vendors.filter(v => v.category === '建材供應' || v.tradeType?.includes('磁磚'))}\r\n                        onChange={setTileCost}\r\n                        placeholder={{ spec: '例：60x60cm 拋光石英磚' }}\r\n                    />\r\n\r\n                    {/* 磁磚鋪貼工資 */}\r\n                    <div className=\"bg-orange-50 rounded-lg p-3 space-y-3 border border-orange-100 mt-4\">\r\n                        <div className=\"flex items-center gap-2 text-sm font-medium text-orange-800\">\r\n                            <span className=\"bg-orange-200 text-orange-700 p-1 rounded\">\r\n                                <Layers size={14} />\r\n                            </span>\r\n                            磁磚鋪貼工資\r\n                        </div>\r\n\r\n                        <ResultDisplay\r\n                            label=\"鋪貼工資合計\"\r\n                            value={tileLaborCost?.subtotal || 0}\r\n                            unit=\"元\"\r\n                            showWastage={false}\r\n                            onAddRecord={(subType, label, value, unit) =>\r\n                                onAddRecord(subType, label, value, unit, value, tileLaborCost)}\r\n                            subType=\"鋪貼工資\"\r\n                        />\r\n\r\n                        <CostInput\r\n                            label=\"施工\"\r\n                            quantity={totalAreaPing}\r\n                            unit=\"坪\"\r\n                            vendors={vendors.filter(v => v.category === '工程工班' && (v.tradeType?.includes('泥作') || v.tradeType?.includes('磁磚')))}\r\n                            onChange={setTileLaborCost}\r\n                            placeholder={{ spec: '例：60x60cm 貼工' }}\r\n                        />\r\n                    </div>\r\n\r\n                    {tileRowResults.filter(r => r.count > 0).length > 1 && (\r\n                        <div className=\"bg-gray-50 rounded-lg p-3 text-xs\">\r\n                            <div className=\"font-medium text-gray-700 mb-2\">各項明細:</div>\r\n                            <div className=\"space-y-1\">\r\n                                {tileRowResults.filter(r => r.count > 0).map((row, idx) => (\r\n                                    <div key={row.id} className=\"flex justify-between text-gray-600\">\r\n                                        <span>{row.name || `區域 ${idx + 1}`} ({row.area}{row.unit === 'ping' ? '坪' : 'm²'})</span>\r\n                                        <span className=\"font-medium\">{formatNumber(row.count, 0)} 片</span>\r\n                                    </div>\r\n                                ))}\r\n                            </div>\r\n                        </div>\r\n                    )}\r\n                </div>\r\n            )}\r\n\r\n            {/* 填縫劑 - 多列模式 */}\r\n            {calcType === 'grout' && (\r\n                <div className=\"bg-white rounded-xl p-4 border border-gray-100 space-y-4\">\r\n                    <div className=\"flex items-center justify-between\">\r\n                        <div className=\"flex items-center gap-2 text-sm text-gray-600\">\r\n                            <Info size={16} />\r\n                            公式: U = (L+W)/(L×W) × 縫寬 × 縫深 × 1.7\r\n                        </div>\r\n                        <div className=\"flex items-center gap-2\">\r\n                            <span className=\"text-xs text-gray-500\">{groutRows.length} 列</span>\r\n                            <button onClick={() => groutRows.length > 1 && removeGroutRow(groutRows[groutRows.length - 1].id)} disabled={groutRows.length <= 1}\r\n                                className=\"w-7 h-7 rounded-lg bg-red-100 text-red-600 flex items-center justify-center hover:bg-red-200 disabled:opacity-50 disabled:cursor-not-allowed transition-colors\">\r\n                                <span className=\"text-lg font-bold leading-none\">−</span>\r\n                            </button>\r\n                            <button onClick={addGroutRow} className=\"w-7 h-7 rounded-lg bg-green-100 text-green-600 flex items-center justify-center hover:bg-green-200 transition-colors\">\r\n                                <Plus size={16} />\r\n                            </button>\r\n                            {groutRows.length > 1 && <button onClick={clearGroutRows} className=\"text-xs text-gray-500 hover:text-gray-700 ml-1\">清空</button>}\r\n                        </div>\r\n                    </div>\r\n\r\n                    {/* 共用設定 */}\r\n                    <div className=\"grid grid-cols-4 gap-2 bg-blue-50 p-3 rounded-lg\">\r\n                        <InputField label=\"磚長\" value={groutTileL} onChange={setGroutTileL} unit=\"cm\" />\r\n                        <InputField label=\"磚寬\" value={groutTileW} onChange={setGroutTileW} unit=\"cm\" />\r\n                        <InputField label=\"縫寬\" value={groutWidth} onChange={setGroutWidth} unit=\"mm\" />\r\n                        <InputField label=\"縫深\" value={groutDepth} onChange={setGroutDepth} unit=\"mm\" />\r\n                    </div>\r\n\r\n                    <div className=\"text-xs text-gray-500 bg-gray-50 p-2 rounded\">\r\n                        此規格每平方公尺約 <strong>{formatNumber(groutPerSqm, 2)}</strong> kg\r\n                    </div>\r\n\r\n                    <div className=\"space-y-2 max-h-[300px] overflow-y-auto\">\r\n                        {groutRows.map((row, index) => (\r\n                            <div key={row.id} className=\"bg-gray-50 rounded-lg p-3 border border-gray-100\">\r\n                                <div className=\"grid grid-cols-12 gap-2 items-end\">\r\n                                    <div className=\"col-span-12 sm:col-span-4\">\r\n                                        <label className=\"block text-xs text-gray-500 mb-1\">名稱</label>\r\n                                        <input type=\"text\" value={row.name} onChange={(e) => updateGroutRow(row.id, 'name', e.target.value)}\r\n                                            placeholder={`區域 ${index + 1}`} className=\"w-full px-2 py-1.5 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-orange-500 focus:border-transparent\" />\r\n                                    </div>\r\n                                    <div className=\"col-span-5 sm:col-span-3\">\r\n                                        <label className=\"block text-xs text-gray-500 mb-1\">施作面積</label>\r\n                                        <div className=\"relative\">\r\n                                            <input type=\"number\" value={row.area} onChange={(e) => updateGroutRow(row.id, 'area', e.target.value)}\r\n                                                placeholder=\"0\" min=\"0\" className=\"w-full px-2 py-1.5 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-orange-500 focus:border-transparent pr-8\" />\r\n                                            <span className=\"absolute right-2 top-1/2 -translate-y-1/2 text-xs text-gray-400\">m²</span>\r\n                                        </div>\r\n                                    </div>\r\n                                    <div className=\"col-span-5 sm:col-span-4 flex items-center\">\r\n                                        <div className=\"flex-1\">\r\n                                            <label className=\"block text-xs text-gray-500 mb-1\">填縫劑用量</label>\r\n                                            <div className=\"text-sm font-bold text-orange-600\">\r\n                                                {groutRowResults[index].amount > 0 ? `${formatNumber(groutRowResults[index].amount, 2)} kg` : '--'}\r\n                                            </div>\r\n                                        </div>\r\n                                    </div>\r\n                                    <div className=\"col-span-2 sm:col-span-1 flex justify-end\">\r\n                                        <button onClick={() => removeGroutRow(row.id)} disabled={groutRows.length <= 1}\r\n                                            className=\"p-1.5 text-red-400 hover:text-red-600 hover:bg-red-50 rounded-lg transition-colors disabled:opacity-30 disabled:cursor-not-allowed\">\r\n                                            <Trash2 size={14} />\r\n                                        </button>\r\n                                    </div>\r\n                                </div>\r\n                            </div>\r\n                        ))}\r\n                    </div>\r\n\r\n                    <button onClick={addGroutRow} className=\"w-full py-2 border-2 border-dashed border-gray-200 rounded-xl text-gray-400 hover:border-orange-300 hover:text-orange-500 transition-colors flex items-center justify-center gap-2 text-sm\">\r\n                        <Plus size={16} />+增加新欄位\r\n                    </button>\r\n\r\n                    <WastageControl wastage={groutWastage} setWastage={setGroutWastage} defaultValue={DEFAULT_WASTAGE.grout} useCustom={groutCustomWastage} setUseCustom={setGroutCustomWastage} />\r\n\r\n                    <ResultDisplay\r\n                        label={`填縫劑用量 (共 ${groutRowResults.filter(r => r.amount > 0).length} 項)`}\r\n                        value={totalGrout}\r\n                        unit=\"kg\"\r\n                        wastageValue={totalGroutWithWastage}\r\n                        onAddRecord={(subType, label, value, unit, wastageValue) =>\r\n                            onAddRecord(subType, label, value, unit, wastageValue, groutCost)}\r\n                        subType=\"填縫劑\"\r\n                    />\r\n\r\n                    <CostInput\r\n                        label=\"填縫劑\"\r\n                        quantity={totalGroutWithWastage}\r\n                        unit=\"kg\"\r\n                        vendors={vendors.filter(v => v.category === '建材供應' || v.tradeType?.includes('磁磚'))}\r\n                        onChange={setGroutCost}\r\n                        placeholder={{ spec: '例：本色填縫劑' }}\r\n                    />\r\n                    {groutRowResults.filter(r => r.amount > 0).length > 1 && (\r\n                        <div className=\"bg-gray-50 rounded-lg p-3 text-xs\">\r\n                            <div className=\"font-medium text-gray-700 mb-2\">各項明細:</div>\r\n                            <div className=\"space-y-1\">\r\n                                {groutRowResults.filter(r => r.amount > 0).map((row, idx) => (\r\n                                    <div key={row.id} className=\"flex justify-between text-gray-600\">\r\n                                        <span>{row.name || `區域 ${idx + 1}`} ({row.area}m²)</span>\r\n                                        <span className=\"font-medium\">{formatNumber(row.amount, 2)} kg</span>\r\n                                    </div>\r\n                                ))}\r\n                            </div>\r\n                        </div>\r\n                    )}\r\n                </div>\r\n            )}\r\n\r\n            {/* 黏著劑 - 多列模式 */}\r\n            {calcType === 'adhesive' && (\r\n                <div className=\"bg-white rounded-xl p-4 border border-gray-100 space-y-4\">\r\n                    <div className=\"flex items-center justify-between\">\r\n                        <div className=\"flex items-center gap-2 text-sm text-gray-600\">\r\n                            <Info size={16} />\r\n                            4mm鏝刀 ≈ 2.5kg/m², 6mm鏝刀 ≈ 6.25kg/m²\r\n                        </div>\r\n                        <div className=\"flex items-center gap-2\">\r\n                            <span className=\"text-xs text-gray-500\">{adhesiveRows.length} 列</span>\r\n                            <button onClick={() => adhesiveRows.length > 1 && removeAdhesiveRow(adhesiveRows[adhesiveRows.length - 1].id)} disabled={adhesiveRows.length <= 1}\r\n                                className=\"w-7 h-7 rounded-lg bg-red-100 text-red-600 flex items-center justify-center hover:bg-red-200 disabled:opacity-50 disabled:cursor-not-allowed transition-colors\">\r\n                                <span className=\"text-lg font-bold leading-none\">−</span>\r\n                            </button>\r\n                            <button onClick={addAdhesiveRow} className=\"w-7 h-7 rounded-lg bg-green-100 text-green-600 flex items-center justify-center hover:bg-green-200 transition-colors\">\r\n                                <Plus size={16} />\r\n                            </button>\r\n                            {adhesiveRows.length > 1 && <button onClick={clearAdhesiveRows} className=\"text-xs text-gray-500 hover:text-gray-700 ml-1\">清空</button>}\r\n                        </div>\r\n                    </div>\r\n\r\n                    <div className=\"space-y-2 max-h-[400px] overflow-y-auto\">\r\n                        {adhesiveRows.map((row, index) => (\r\n                            <div key={row.id} className=\"bg-gray-50 rounded-lg p-3 border border-gray-100\">\r\n                                <div className=\"grid grid-cols-12 gap-2 items-end\">\r\n                                    <div className=\"col-span-12 sm:col-span-3\">\r\n                                        <label className=\"block text-xs text-gray-500 mb-1\">名稱</label>\r\n                                        <input type=\"text\" value={row.name} onChange={(e) => updateAdhesiveRow(row.id, 'name', e.target.value)}\r\n                                            placeholder={`區域 ${index + 1}`} className=\"w-full px-2 py-1.5 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-orange-500 focus:border-transparent\" />\r\n                                    </div>\r\n                                    <div className=\"col-span-5 sm:col-span-3\">\r\n                                        <label className=\"block text-xs text-gray-500 mb-1\">施作面積</label>\r\n                                        <div className=\"relative\">\r\n                                            <input type=\"number\" value={row.area} onChange={(e) => updateAdhesiveRow(row.id, 'area', e.target.value)}\r\n                                                placeholder=\"0\" min=\"0\" className=\"w-full px-2 py-1.5 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-orange-500 focus:border-transparent pr-8\" />\r\n                                            <span className=\"absolute right-2 top-1/2 -translate-y-1/2 text-xs text-gray-400\">m²</span>\r\n                                        </div>\r\n                                    </div>\r\n                                    <div className=\"col-span-5 sm:col-span-2\">\r\n                                        <label className=\"block text-xs text-gray-500 mb-1\">鏝刀規格</label>\r\n                                        <select value={row.trowel} onChange={(e) => updateAdhesiveRow(row.id, 'trowel', e.target.value)}\r\n                                            className=\"w-full px-2 py-1.5 border border-gray-200 rounded-lg text-sm bg-white focus:ring-2 focus:ring-orange-500\">\r\n                                            <option value=\"4\">4mm</option>\r\n                                            <option value=\"6\">6mm</option>\r\n                                        </select>\r\n                                    </div>\r\n                                    <div className=\"col-span-10 sm:col-span-3 flex items-center\">\r\n                                        <div className=\"flex-1\">\r\n                                            <label className=\"block text-xs text-gray-500 mb-1\">黏著劑用量</label>\r\n                                            <div className=\"text-sm font-bold text-orange-600\">\r\n                                                {adhesiveRowResults[index].amount > 0 ? `${formatNumber(adhesiveRowResults[index].amount, 2)} kg` : '--'}\r\n                                            </div>\r\n                                        </div>\r\n                                    </div>\r\n                                    <div className=\"col-span-2 sm:col-span-1 flex justify-end\">\r\n                                        <button onClick={() => removeAdhesiveRow(row.id)} disabled={adhesiveRows.length <= 1}\r\n                                            className=\"p-1.5 text-red-400 hover:text-red-600 hover:bg-red-50 rounded-lg transition-colors disabled:opacity-30 disabled:cursor-not-allowed\">\r\n                                            <Trash2 size={14} />\r\n                                        </button>\r\n                                    </div>\r\n                                </div>\r\n                            </div>\r\n                        ))}\r\n                    </div>\r\n\r\n                    <button onClick={addAdhesiveRow} className=\"w-full py-2 border-2 border-dashed border-gray-200 rounded-xl text-gray-400 hover:border-orange-300 hover:text-orange-500 transition-colors flex items-center justify-center gap-2 text-sm\">\r\n                        <Plus size={16} />+增加新欄位\r\n                    </button>\r\n\r\n                    <WastageControl wastage={adhesiveWastage} setWastage={setAdhesiveWastage} defaultValue={DEFAULT_WASTAGE.adhesive} useCustom={adhesiveCustomWastage} setUseCustom={setAdhesiveCustomWastage} />\r\n\r\n                    <ResultDisplay\r\n                        label={`黏著劑用量 (共 ${adhesiveRowResults.filter(r => r.amount > 0).length} 項)`}\r\n                        value={totalAdhesive}\r\n                        unit=\"kg\"\r\n                        wastageValue={totalAdhesiveWithWastage}\r\n                        onAddRecord={(subType, label, value, unit, wastageValue) =>\r\n                            onAddRecord(subType, label, value, unit, wastageValue, adhesiveCost)}\r\n                        subType=\"黏著劑\"\r\n                    />\r\n\r\n                    <CostInput\r\n                        label=\"黏著劑\"\r\n                        quantity={totalAdhesiveWithWastage}\r\n                        unit=\"kg\"\r\n                        vendors={vendors.filter(v => v.category === '建材供應' || v.tradeType?.includes('磁磚'))}\r\n                        onChange={setAdhesiveCost}\r\n                        placeholder={{ spec: '例：高分子益膠泥' }}\r\n                    />\r\n\r\n                    {adhesiveRowResults.filter(r => r.amount > 0).length > 1 && (\r\n                        <div className=\"bg-gray-50 rounded-lg p-3 text-xs\">\r\n                            <div className=\"font-medium text-gray-700 mb-2\">各項明細:</div>\r\n                            <div className=\"space-y-1\">\r\n                                {adhesiveRowResults.filter(r => r.amount > 0).map((row, idx) => (\r\n                                    <div key={row.id} className=\"flex justify-between text-gray-600\">\r\n                                        <span>{row.name || `區域 ${idx + 1}`} ({row.area}m² × {row.trowel}mm鏝刀)</span>\r\n                                        <span className=\"font-medium\">{formatNumber(row.amount, 2)} kg</span>\r\n                                    </div>\r\n                                ))}\r\n                            </div>\r\n                        </div>\r\n                    )}\r\n                </div>\r\n            )}\r\n        </div>\r\n    );\r\n};\r\n\r\n\r\n// 4️⃣ 裝修工程計算器 (支援多列輸入)\r\nconst FinishCalculator = ({ onAddRecord, vendors = [] }) => {\r\n    const [calcType, setCalcType] = useState('paint');\r\n\r\n    // 油漆計算 - 多列支援\r\n    const [paintRows, setPaintRows] = useState([\r\n        { id: 1, name: '', area: '', unit: 'sqm' }\r\n    ]);\r\n    const [paintWastage, setPaintWastage] = useState(DEFAULT_WASTAGE.paint);\r\n    const [paintCustomWastage, setPaintCustomWastage] = useState(false);\r\n    const [paintCost, setPaintCost] = useState(null);\r\n\r\n    // 批土計算 - 多列支援\r\n    const [puttyRows, setPuttyRows] = useState([\r\n        { id: 1, name: '', area: '' }\r\n    ]);\r\n    const [puttyWastage, setPuttyWastage] = useState(DEFAULT_WASTAGE.putty);\r\n    const [puttyCustomWastage, setPuttyCustomWastage] = useState(false);\r\n    const [puttyCost, setPuttyCost] = useState(null);\r\n\r\n    // 塗刷面積估算\r\n    const [buildingArea, setBuildingArea] = useState('');\r\n\r\n    // 計算每列油漆結果\r\n    const paintRowResults = paintRows.map(row => {\r\n        const areaSqm = row.unit === 'ping' ? (parseFloat(row.area) || 0) * 3.30579 : (parseFloat(row.area) || 0);\r\n        const gallons = areaSqm / 3.30579 * 0.5;\r\n        return { ...row, gallons };\r\n    });\r\n\r\n    // 總計油漆\r\n    const totalPaintGallons = paintRowResults.reduce((sum, row) => sum + row.gallons, 0);\r\n    const currentPaintWastage = paintCustomWastage ? paintWastage : DEFAULT_WASTAGE.paint;\r\n    const totalPaintWithWastage = applyWastage(totalPaintGallons, currentPaintWastage);\r\n\r\n    // 油漆列操作\r\n    const addPaintRow = () => {\r\n        const newId = Math.max(...paintRows.map(r => r.id), 0) + 1;\r\n        setPaintRows([...paintRows, { id: newId, name: '', area: '', unit: 'sqm' }]);\r\n    };\r\n    const removePaintRow = (id) => {\r\n        if (paintRows.length <= 1) return;\r\n        setPaintRows(paintRows.filter(row => row.id !== id));\r\n    };\r\n    const updatePaintRow = (id, field, value) => {\r\n        setPaintRows(paintRows.map(row => row.id === id ? { ...row, [field]: value } : row));\r\n    };\r\n    const clearPaintRows = () => {\r\n        setPaintRows([{ id: 1, name: '', area: '', unit: 'sqm' }]);\r\n    };\r\n\r\n    // 計算每列批土結果\r\n    const puttyRowResults = puttyRows.map(row => {\r\n        const area = parseFloat(row.area) || 0;\r\n        const amount = area * 0.35;\r\n        return { ...row, amount };\r\n    });\r\n\r\n    // 總計批土\r\n    const totalPutty = puttyRowResults.reduce((sum, row) => sum + row.amount, 0);\r\n    const currentPuttyWastage = puttyCustomWastage ? puttyWastage : DEFAULT_WASTAGE.putty;\r\n    const totalPuttyWithWastage = applyWastage(totalPutty, currentPuttyWastage);\r\n\r\n    // 批土列操作\r\n    const addPuttyRow = () => {\r\n        const newId = Math.max(...puttyRows.map(r => r.id), 0) + 1;\r\n        setPuttyRows([...puttyRows, { id: newId, name: '', area: '' }]);\r\n    };\r\n    const removePuttyRow = (id) => {\r\n        if (puttyRows.length <= 1) return;\r\n        setPuttyRows(puttyRows.filter(row => row.id !== id));\r\n    };\r\n    const updatePuttyRow = (id, field, value) => {\r\n        setPuttyRows(puttyRows.map(row => row.id === id ? { ...row, [field]: value } : row));\r\n    };\r\n    const clearPuttyRows = () => {\r\n        setPuttyRows([{ id: 1, name: '', area: '' }]);\r\n    };\r\n\r\n    // 塗刷面積估算\r\n    const estimatedPaintArea = (parseFloat(buildingArea) || 0) * 3;\r\n\r\n    return (\r\n        <div className=\"space-y-4\">\r\n            <div className=\"flex gap-2 flex-wrap\">\r\n                {[\r\n                    { id: 'paint', label: '油漆用量' },\r\n                    { id: 'putty', label: '批土用量' },\r\n                    { id: 'estimate', label: '面積估算' },\r\n                ].map(item => (\r\n                    <button\r\n                        key={item.id}\r\n                        onClick={() => setCalcType(item.id)}\r\n                        className={`px-4 py-2 rounded-lg text-sm font-medium transition-all ${calcType === item.id ? 'bg-orange-500 text-white' : 'bg-gray-100 hover:bg-gray-200'}`}\r\n                    >\r\n                        {item.label}\r\n                    </button>\r\n                ))}\r\n            </div>\r\n\r\n            {/* 油漆用量 - 多列模式 */}\r\n            {calcType === 'paint' && (\r\n                <div className=\"bg-white rounded-xl p-4 border border-gray-100 space-y-4\">\r\n                    <div className=\"flex items-center justify-between\">\r\n                        <div className=\"flex items-center gap-2 text-sm text-gray-600\">\r\n                            <Info size={16} />\r\n                            公式: 用量(加侖) ≈ 面積(坪) × 0.5\r\n                        </div>\r\n                        <div className=\"flex items-center gap-2\">\r\n                            <span className=\"text-xs text-gray-500\">{paintRows.length} 列</span>\r\n                            <button onClick={() => paintRows.length > 1 && removePaintRow(paintRows[paintRows.length - 1].id)} disabled={paintRows.length <= 1}\r\n                                className=\"w-7 h-7 rounded-lg bg-red-100 text-red-600 flex items-center justify-center hover:bg-red-200 disabled:opacity-50 disabled:cursor-not-allowed transition-colors\">\r\n                                <span className=\"text-lg font-bold leading-none\">−</span>\r\n                            </button>\r\n                            <button onClick={addPaintRow} className=\"w-7 h-7 rounded-lg bg-green-100 text-green-600 flex items-center justify-center hover:bg-green-200 transition-colors\">\r\n                                <Plus size={16} />\r\n                            </button>\r\n                            {paintRows.length > 1 && <button onClick={clearPaintRows} className=\"text-xs text-gray-500 hover:text-gray-700 ml-1\">清空</button>}\r\n                        </div>\r\n                    </div>\r\n\r\n                    <div className=\"space-y-2 max-h-[400px] overflow-y-auto\">\r\n                        {paintRows.map((row, index) => (\r\n                            <div key={row.id} className=\"bg-gray-50 rounded-lg p-3 border border-gray-100\">\r\n                                <div className=\"grid grid-cols-12 gap-2 items-end\">\r\n                                    <div className=\"col-span-12 sm:col-span-3\">\r\n                                        <label className=\"block text-xs text-gray-500 mb-1\">名稱</label>\r\n                                        <input type=\"text\" value={row.name} onChange={(e) => updatePaintRow(row.id, 'name', e.target.value)}\r\n                                            placeholder={`區域 ${index + 1}`} className=\"w-full px-2 py-1.5 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-orange-500 focus:border-transparent\" />\r\n                                    </div>\r\n                                    <div className=\"col-span-5 sm:col-span-3\">\r\n                                        <label className=\"block text-xs text-gray-500 mb-1\">塗刷面積</label>\r\n                                        <div className=\"relative\">\r\n                                            <input type=\"number\" value={row.area} onChange={(e) => updatePaintRow(row.id, 'area', e.target.value)}\r\n                                                placeholder=\"0\" min=\"0\" className=\"w-full px-2 py-1.5 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-orange-500 focus:border-transparent pr-8\" />\r\n                                            <span className=\"absolute right-2 top-1/2 -translate-y-1/2 text-xs text-gray-400\">{row.unit === 'ping' ? '坪' : 'm²'}</span>\r\n                                        </div>\r\n                                    </div>\r\n                                    <div className=\"col-span-5 sm:col-span-2\">\r\n                                        <label className=\"block text-xs text-gray-500 mb-1\">單位</label>\r\n                                        <select value={row.unit} onChange={(e) => updatePaintRow(row.id, 'unit', e.target.value)}\r\n                                            className=\"w-full px-2 py-1.5 border border-gray-200 rounded-lg text-sm bg-white focus:ring-2 focus:ring-orange-500\">\r\n                                            <option value=\"sqm\">m²</option>\r\n                                            <option value=\"ping\">坪</option>\r\n                                        </select>\r\n                                    </div>\r\n                                    <div className=\"col-span-10 sm:col-span-3 flex items-center\">\r\n                                        <div className=\"flex-1\">\r\n                                            <label className=\"block text-xs text-gray-500 mb-1\">油漆用量</label>\r\n                                            <div className=\"text-sm font-bold text-orange-600\">\r\n                                                {paintRowResults[index].gallons > 0 ? `${formatNumber(paintRowResults[index].gallons, 2)} 加侖` : '--'}\r\n                                            </div>\r\n                                        </div>\r\n                                    </div>\r\n                                    <div className=\"col-span-2 sm:col-span-1 flex justify-end\">\r\n                                        <button onClick={() => removePaintRow(row.id)} disabled={paintRows.length <= 1}\r\n                                            className=\"p-1.5 text-red-400 hover:text-red-600 hover:bg-red-50 rounded-lg transition-colors disabled:opacity-30 disabled:cursor-not-allowed\">\r\n                                            <Trash2 size={14} />\r\n                                        </button>\r\n                                    </div>\r\n                                </div>\r\n                            </div>\r\n                        ))}\r\n                    </div>\r\n\r\n                    <button onClick={addPaintRow} className=\"w-full py-2 border-2 border-dashed border-gray-200 rounded-xl text-gray-400 hover:border-orange-300 hover:text-orange-500 transition-colors flex items-center justify-center gap-2 text-sm\">\r\n                        <Plus size={16} />+增加新欄位\r\n                    </button>\r\n\r\n                    <WastageControl wastage={paintWastage} setWastage={setPaintWastage} defaultValue={DEFAULT_WASTAGE.paint} useCustom={paintCustomWastage} setUseCustom={setPaintCustomWastage} />\r\n\r\n                    <ResultDisplay\r\n                        label={`油漆用量 (共 ${paintRowResults.filter(r => r.gallons > 0).length} 項)`}\r\n                        value={totalPaintGallons}\r\n                        unit=\"加侖\"\r\n                        wastageValue={totalPaintWithWastage}\r\n                        onAddRecord={(subType, label, value, unit, wastageValue) =>\r\n                            onAddRecord(subType, label, value, unit, wastageValue, paintCost)}\r\n                        subType=\"油漆\"\r\n                    />\r\n\r\n                    <CostInput\r\n                        label=\"油漆\"\r\n                        quantity={totalPaintWithWastage}\r\n                        unit=\"坪\"\r\n                        unitLabel=\"工帶料/坪\"\r\n                        vendors={vendors.filter(v => v.category === '建材供應' || v.tradeType?.includes('油漆'))}\r\n                        onChange={setPaintCost}\r\n                        placeholder={{ spec: '例：乳膠漆' }}\r\n                    />\r\n\r\n                    {paintRowResults.filter(r => r.gallons > 0).length > 1 && (\r\n                        <div className=\"bg-gray-50 rounded-lg p-3 text-xs\">\r\n                            <div className=\"font-medium text-gray-700 mb-2\">各項明細:</div>\r\n                            <div className=\"space-y-1\">\r\n                                {paintRowResults.filter(r => r.gallons > 0).map((row, idx) => (\r\n                                    <div key={row.id} className=\"flex justify-between text-gray-600\">\r\n                                        <span>{row.name || `區域 ${idx + 1}`} ({row.area}{row.unit === 'ping' ? '坪' : 'm²'})</span>\r\n                                        <span className=\"font-medium\">{formatNumber(row.gallons, 2)} 加侖</span>\r\n                                    </div>\r\n                                ))}\r\n                            </div>\r\n                        </div>\r\n                    )}\r\n                </div>\r\n            )}\r\n\r\n            {/* 批土用量 - 多列模式 */}\r\n            {calcType === 'putty' && (\r\n                <div className=\"bg-white rounded-xl p-4 border border-gray-100 space-y-4\">\r\n                    <div className=\"flex items-center justify-between\">\r\n                        <div className=\"flex items-center gap-2 text-sm text-gray-600\">\r\n                            <Info size={16} />\r\n                            公式: 批土用量 = 建築面積 × 0.35\r\n                        </div>\r\n                        <div className=\"flex items-center gap-2\">\r\n                            <span className=\"text-xs text-gray-500\">{puttyRows.length} 列</span>\r\n                            <button onClick={() => puttyRows.length > 1 && removePuttyRow(puttyRows[puttyRows.length - 1].id)} disabled={puttyRows.length <= 1}\r\n                                className=\"w-7 h-7 rounded-lg bg-red-100 text-red-600 flex items-center justify-center hover:bg-red-200 disabled:opacity-50 disabled:cursor-not-allowed transition-colors\">\r\n                                <span className=\"text-lg font-bold leading-none\">−</span>\r\n                            </button>\r\n                            <button onClick={addPuttyRow} className=\"w-7 h-7 rounded-lg bg-green-100 text-green-600 flex items-center justify-center hover:bg-green-200 transition-colors\">\r\n                                <Plus size={16} />\r\n                            </button>\r\n                            {puttyRows.length > 1 && <button onClick={clearPuttyRows} className=\"text-xs text-gray-500 hover:text-gray-700 ml-1\">清空</button>}\r\n                        </div>\r\n                    </div>\r\n\r\n                    <div className=\"space-y-2 max-h-[400px] overflow-y-auto\">\r\n                        {puttyRows.map((row, index) => (\r\n                            <div key={row.id} className=\"bg-gray-50 rounded-lg p-3 border border-gray-100\">\r\n                                <div className=\"grid grid-cols-12 gap-2 items-end\">\r\n                                    <div className=\"col-span-12 sm:col-span-4\">\r\n                                        <label className=\"block text-xs text-gray-500 mb-1\">名稱</label>\r\n                                        <input type=\"text\" value={row.name} onChange={(e) => updatePuttyRow(row.id, 'name', e.target.value)}\r\n                                            placeholder={`區域 ${index + 1}`} className=\"w-full px-2 py-1.5 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-orange-500 focus:border-transparent\" />\r\n                                    </div>\r\n                                    <div className=\"col-span-5 sm:col-span-3\">\r\n                                        <label className=\"block text-xs text-gray-500 mb-1\">建築面積</label>\r\n                                        <div className=\"relative\">\r\n                                            <input type=\"number\" value={row.area} onChange={(e) => updatePuttyRow(row.id, 'area', e.target.value)}\r\n                                                placeholder=\"0\" min=\"0\" className=\"w-full px-2 py-1.5 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-orange-500 focus:border-transparent pr-8\" />\r\n                                            <span className=\"absolute right-2 top-1/2 -translate-y-1/2 text-xs text-gray-400\">m²</span>\r\n                                        </div>\r\n                                    </div>\r\n                                    <div className=\"col-span-5 sm:col-span-4 flex items-center\">\r\n                                        <div className=\"flex-1\">\r\n                                            <label className=\"block text-xs text-gray-500 mb-1\">批土用量</label>\r\n                                            <div className=\"text-sm font-bold text-orange-600\">\r\n                                                {puttyRowResults[index].amount > 0 ? `${formatNumber(puttyRowResults[index].amount, 2)} kg` : '--'}\r\n                                            </div>\r\n                                        </div>\r\n                                    </div>\r\n                                    <div className=\"col-span-2 sm:col-span-1 flex justify-end\">\r\n                                        <button onClick={() => removePuttyRow(row.id)} disabled={puttyRows.length <= 1}\r\n                                            className=\"p-1.5 text-red-400 hover:text-red-600 hover:bg-red-50 rounded-lg transition-colors disabled:opacity-30 disabled:cursor-not-allowed\">\r\n                                            <Trash2 size={14} />\r\n                                        </button>\r\n                                    </div>\r\n                                </div>\r\n                            </div>\r\n                        ))}\r\n                    </div>\r\n\r\n                    <button onClick={addPuttyRow} className=\"w-full py-2 border-2 border-dashed border-gray-200 rounded-xl text-gray-400 hover:border-orange-300 hover:text-orange-500 transition-colors flex items-center justify-center gap-2 text-sm\">\r\n                        <Plus size={16} />+增加新欄位\r\n                    </button>\r\n\r\n                    <WastageControl wastage={puttyWastage} setWastage={setPuttyWastage} defaultValue={DEFAULT_WASTAGE.putty} useCustom={puttyCustomWastage} setUseCustom={setPuttyCustomWastage} />\r\n\r\n                    <ResultDisplay\r\n                        label={`批土用量 (共 ${puttyRowResults.filter(r => r.amount > 0).length} 項)`}\r\n                        value={totalPutty}\r\n                        unit=\"kg\"\r\n                        wastageValue={totalPuttyWithWastage}\r\n                        onAddRecord={(subType, label, value, unit, wastageValue) =>\r\n                            onAddRecord(subType, label, value, unit, wastageValue, puttyCost)}\r\n                        subType=\"批土\"\r\n                    />\r\n\r\n                    <CostInput\r\n                        label=\"批土\"\r\n                        quantity={totalPuttyWithWastage}\r\n                        unit=\"kg\"\r\n                        vendors={vendors.filter(v => v.category === '建材供應' || v.tradeType?.includes('油漆'))}\r\n                        onChange={setPuttyCost}\r\n                        placeholder={{ spec: '例：AB批土' }}\r\n                    />\r\n\r\n                    {puttyRowResults.filter(r => r.amount > 0).length > 1 && (\r\n                        <div className=\"bg-gray-50 rounded-lg p-3 text-xs\">\r\n                            <div className=\"font-medium text-gray-700 mb-2\">各項明細:</div>\r\n                            <div className=\"space-y-1\">\r\n                                {puttyRowResults.filter(r => r.amount > 0).map((row, idx) => (\r\n                                    <div key={row.id} className=\"flex justify-between text-gray-600\">\r\n                                        <span>{row.name || `區域 ${idx + 1}`} ({row.area}m²)</span>\r\n                                        <span className=\"font-medium\">{formatNumber(row.amount, 2)} kg</span>\r\n                                    </div>\r\n                                ))}\r\n                            </div>\r\n                        </div>\r\n                    )}\r\n                </div>\r\n            )}\r\n\r\n            {calcType === 'estimate' && (\r\n                <div className=\"bg-white rounded-xl p-4 border border-gray-100 space-y-4\">\r\n                    <div className=\"flex items-center gap-2 text-sm text-gray-600\">\r\n                        <Info size={16} />\r\n                        室內抹灰/塗刷面積 ≈ 建築面積 × 3 ~ 3.8\r\n                    </div>\r\n                    <InputField label=\"建築面積\" value={buildingArea} onChange={setBuildingArea} unit=\"m²\" placeholder=\"0\" />\r\n                    <ResultDisplay label=\"預估塗刷面積\" value={estimatedPaintArea} unit=\"m²\" showWastage={false} onAddRecord={onAddRecord} subType=\"面積估算\" />\r\n                    <div className=\"text-xs text-gray-500 bg-gray-50 p-2 rounded\">\r\n                        地磚面積 ≈ 建築面積 × 0.7 = <strong>{formatNumber((parseFloat(buildingArea) || 0) * 0.7)}</strong> m²\r\n                    </div>\r\n                </div>\r\n            )}\r\n        </div>\r\n    );\r\n};\r\n\r\n\r\n// 5️⃣ 建築概估計算器\r\nconst BuildingEstimator = ({ onAddRecord }) => {\r\n    const [buildingType, setBuildingType] = useState(1);\r\n    const [floorArea, setFloorArea] = useState('');\r\n    const [wallThicknessFilter, setWallThicknessFilter] = useState('all');\r\n\r\n    // 根據牆壁厚度篩選建築類型\r\n    const filteredTypes = BUILDING_TYPES.map((t, i) => ({ ...t, originalIndex: i }))\r\n        .filter(t => wallThicknessFilter === 'all' || t.wallThickness === parseInt(wallThicknessFilter));\r\n\r\n    // 確保選中的類型在過濾後仍然有效\r\n    const selectedIndex = filteredTypes.findIndex(t => t.originalIndex === buildingType);\r\n    const validSelectedIndex = selectedIndex >= 0 ? buildingType : (filteredTypes[0]?.originalIndex ?? 0);\r\n    const selected = BUILDING_TYPES[validSelectedIndex];\r\n\r\n    const totalRebar = (parseFloat(floorArea) || 0) * selected.rebar;\r\n    const totalConcrete = (parseFloat(floorArea) || 0) * selected.concrete;\r\n    const totalFormwork = (parseFloat(floorArea) || 0) * selected.formwork;\r\n    const totalSand = (parseFloat(floorArea) || 0) * selected.sand;\r\n\r\n    // 當篩選改變時，自動選擇篩選後的第一個類型\r\n    const handleWallThicknessChange = (value) => {\r\n        setWallThicknessFilter(value);\r\n        if (value !== 'all') {\r\n            const newFiltered = BUILDING_TYPES.map((t, i) => ({ ...t, originalIndex: i }))\r\n                .filter(t => t.wallThickness === parseInt(value));\r\n            if (newFiltered.length > 0) {\r\n                setBuildingType(newFiltered[0].originalIndex);\r\n            }\r\n        }\r\n    };\r\n\r\n    return (\r\n        <div className=\"space-y-4\">\r\n            <div className=\"bg-orange-50 border border-orange-200 rounded-xl p-4\">\r\n                <div className=\"flex items-start gap-2\">\r\n                    <Info size={18} className=\"text-orange-500 flex-shrink-0 mt-0.5\" />\r\n                    <div className=\"text-sm text-orange-800\">\r\n                        <p className=\"font-medium\">建築概估說明</p>\r\n                        <p className=\"text-orange-600 mt-1\">依據建築類型與樓地板面積，快速估算整棟建築的主要結構材料用量。數據來源為抗震7度區規則結構設計經驗值。</p>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n\r\n            <div className=\"bg-white rounded-xl p-4 border border-gray-100 space-y-4\">\r\n                <div className=\"grid grid-cols-1 sm:grid-cols-3 gap-3\">\r\n                    <SelectField\r\n                        label=\"牆壁厚度篩選\"\r\n                        value={wallThicknessFilter}\r\n                        onChange={handleWallThicknessChange}\r\n                        options={WALL_THICKNESS_OPTIONS}\r\n                    />\r\n                    <SelectField\r\n                        label=\"建築類型\"\r\n                        value={validSelectedIndex}\r\n                        onChange={(v) => setBuildingType(parseInt(v))}\r\n                        options={filteredTypes.map((t) => ({ value: t.originalIndex, label: `${t.label} (${t.structure})` }))}\r\n                    />\r\n                    <InputField label=\"總樓地板面積\" value={floorArea} onChange={setFloorArea} unit=\"m²\" placeholder=\"0\" />\r\n                </div>\r\n\r\n                <div className=\"bg-gray-50 rounded-lg p-3 text-sm\">\r\n                    <div className=\"grid grid-cols-2 sm:grid-cols-5 gap-2 text-gray-600\">\r\n                        <span>結構: <strong className=\"text-gray-800\">{selected.structure}</strong></span>\r\n                        <span>牆厚: <strong className=\"text-gray-800\">{selected.wallThickness} cm</strong></span>\r\n                        <span>鋼筋: {selected.rebar} kg/m²</span>\r\n                        <span>混凝土: {selected.concrete} m³/m²</span>\r\n                        <span>模板: {selected.formwork} m²/m²</span>\r\n                    </div>\r\n                </div>\r\n\r\n                <div className=\"grid grid-cols-2 sm:grid-cols-4 gap-3\">\r\n                    <ResultDisplay label=\"鋼筋總量\" value={totalRebar} unit=\"kg\" showWastage={false} onAddRecord={onAddRecord} subType=\"建築概估\" />\r\n                    <ResultDisplay label=\"混凝土總量\" value={totalConcrete} unit=\"m³\" showWastage={false} onAddRecord={onAddRecord} subType=\"建築概估\" />\r\n                    <ResultDisplay label=\"模板總量\" value={totalFormwork} unit=\"m²\" showWastage={false} onAddRecord={onAddRecord} subType=\"建築概估\" />\r\n                    <ResultDisplay label=\"砂用量\" value={totalSand} unit=\"m³\" showWastage={false} onAddRecord={onAddRecord} subType=\"建築概估\" />\r\n                </div>\r\n\r\n                <div className=\"text-xs text-gray-500\">\r\n                    鋼筋約 <strong>{formatNumber(totalRebar / 1000, 1)}</strong> 噸 |\r\n                    混凝土約 <strong>{formatNumber(totalConcrete)}</strong> 立方公尺\r\n                </div>\r\n            </div>\r\n\r\n            {/* 參考表格 */}\r\n            <div className=\"bg-white rounded-xl p-4 border border-gray-100\">\r\n                <div className=\"flex items-center justify-between mb-3\">\r\n                    <h4 className=\"font-medium text-gray-700\">建築類型參考指標</h4>\r\n                    {wallThicknessFilter !== 'all' && (\r\n                        <span className=\"text-xs bg-orange-100 text-orange-700 px-2 py-1 rounded-full\">\r\n                            篩選: 牆厚 {wallThicknessFilter} cm\r\n                        </span>\r\n                    )}\r\n                </div>\r\n                <div className=\"overflow-x-auto\">\r\n                    <table className=\"w-full text-sm whitespace-nowrap\">\r\n                        <thead>\r\n                            <tr className=\"border-b bg-gray-50\">\r\n                                <th className=\"text-left py-2 px-2\">建築類型</th>\r\n                                <th className=\"text-center py-2 px-2\">結構</th>\r\n                                <th className=\"text-center py-2 px-2\">牆厚(cm)</th>\r\n                                <th className=\"text-right py-2 px-2\">鋼筋(kg/m²)</th>\r\n                                <th className=\"text-right py-2 px-2\">混凝土(m³/m²)</th>\r\n                                <th className=\"text-right py-2 px-2\">模板(m²/m²)</th>\r\n                                <th className=\"text-right py-2 px-2\">砂(m³/m²)</th>\r\n                            </tr>\r\n                        </thead>\r\n                        <tbody>\r\n                            {filteredTypes.map((t) => (\r\n                                <tr key={t.originalIndex} className={`border-b hover:bg-gray-50 transition-colors ${t.originalIndex === validSelectedIndex ? 'bg-orange-50' : ''} ${t.structure === 'RB' ? 'text-amber-700' : ''}`}>\r\n                                    <td className=\"py-2 px-2\">\r\n                                        {t.label}\r\n                                        {t.structure === 'RB' && <span className=\"ml-1 text-xs bg-amber-100 text-amber-700 px-1 rounded\">磚造</span>}\r\n                                    </td>\r\n                                    <td className=\"text-center py-2 px-2\">{t.structure}</td>\r\n                                    <td className=\"text-center py-2 px-2\">{t.wallThickness}</td>\r\n                                    <td className=\"text-right py-2 px-2\">{t.rebar}</td>\r\n                                    <td className=\"text-right py-2 px-2\">{t.concrete}</td>\r\n                                    <td className=\"text-right py-2 px-2\">{t.formwork}</td>\r\n                                    <td className=\"text-right py-2 px-2\">{t.sand}</td>\r\n                                </tr>\r\n                            ))}\r\n                        </tbody>\r\n                    </table>\r\n                </div>\r\n                <div className=\"mt-3 text-xs text-gray-500 flex items-center gap-4\">\r\n                    <span className=\"flex items-center gap-1\">\r\n                        <span className=\"w-3 h-3 bg-amber-100 rounded\"></span>\r\n                        RB = 加強磚造\r\n                    </span>\r\n                    <span className=\"flex items-center gap-1\">\r\n                        <span className=\"w-3 h-3 bg-gray-100 rounded\"></span>\r\n                        RC = 鋼筋混凝土 | SRC = 鋼骨鋼筋混凝土 | SC = 鋼構\r\n                    </span>\r\n                </div>\r\n            </div>\r\n        </div>\r\n    );\r\n};\r\n\r\n\r\n// ============================================\r\n// 主組件\r\n// ============================================\r\n\r\nexport const MaterialCalculator = ({ addToast, vendors = [] }) => {\r\n    const [activeTab, setActiveTab] = useState('structure');\r\n\r\n    // 計算記錄\r\n    const [calcRecords, setCalcRecords] = useState([]);\r\n    const [exportName, setExportName] = useState('');\r\n    const [isExporting, setIsExporting] = useState(false);\r\n    const [exportedSheet, setExportedSheet] = useState(null);\r\n\r\n    const tabs = [\r\n        { id: 'structure', icon: Building2, label: '結構工程' },\r\n        { id: 'masonry', icon: Layers, label: '泥作工程' },\r\n        { id: 'tile', icon: Grid3X3, label: '磁磚工程' },\r\n        { id: 'finish', icon: Paintbrush, label: '塗料工程' },\r\n        { id: 'estimate', icon: BarChart3, label: '建築概估' },\r\n    ];\r\n\r\n    // 新增計算記錄\r\n    const addRecord = (category, subType, label, value, unit, wastageValue, costData) => {\r\n        const record = {\r\n            id: Date.now(),\r\n            category,\r\n            subType,\r\n            label,\r\n            value: parseFloat(value) || 0,\r\n            unit,\r\n            wastageValue: parseFloat(wastageValue) || parseFloat(value) || 0,\r\n            createdAt: new Date().toLocaleString('zh-TW'),\r\n            // 成本資訊\r\n            vendor: costData?.vendor || '',\r\n            spec: costData?.spec || '',\r\n            price: costData?.price || 0,\r\n            subtotal: costData?.subtotal || 0,\r\n            note: costData?.note || ''\r\n        };\r\n        setCalcRecords(prev => [...prev, record]);\r\n        addToast?.(`已加入記錄: ${label}`, 'success');\r\n    };\r\n\r\n    // 刪除記錄\r\n    const removeRecord = (id) => {\r\n        setCalcRecords(prev => prev.filter(r => r.id !== id));\r\n    };\r\n\r\n    // 清空記錄\r\n    const clearRecords = () => {\r\n        setCalcRecords([]);\r\n        addToast?.('已清空計算記錄', 'info');\r\n    };\r\n\r\n    // 匯出到 Google Sheet (存入物料算量資料夾)\r\n    const exportToSheet = async () => {\r\n        if (calcRecords.length === 0) {\r\n            addToast?.('請先加入計算記錄', 'warning');\r\n            return;\r\n        }\r\n\r\n        setIsExporting(true);\r\n        try {\r\n            // 使用新的匯出功能，會自動建立物料算量資料夾並以日期時間命名\r\n            const result = await GoogleService.exportMaterialCalculationToFolder(\r\n                calcRecords,\r\n                exportName // 如果有自訂名稱則使用，否則會自動產生含日期時間的檔名\r\n            );\r\n\r\n            if (result.success) {\r\n                setExportedSheet(result);\r\n                addToast?.('已匯出到 Google Sheet！', 'success', {\r\n                    action: {\r\n                        label: '開啟 Sheet',\r\n                        onClick: () => window.open(result.sheetUrl, '_blank')\r\n                    }\r\n                });\r\n            } else {\r\n                addToast?.(result.error || '匯出失敗', 'error');\r\n            }\r\n        } catch (error) {\r\n            console.error('Export error:', error);\r\n            addToast?.('匯出失敗：' + error.message, 'error');\r\n        } finally {\r\n            setIsExporting(false);\r\n        }\r\n    };\r\n\r\n    const renderCalculator = () => {\r\n        switch (activeTab) {\r\n            case 'structure': return <StructureCalculator onAddRecord={(s, l, v, u, w, c) => addRecord('結構工程', s, l, v, u, w, c)} vendors={vendors} />;\r\n            case 'masonry': return <MasonryCalculator onAddRecord={(s, l, v, u, w, c) => addRecord('泥作工程', s, l, v, u, w, c)} vendors={vendors} />;\r\n            case 'tile': return <TileCalculator onAddRecord={(s, l, v, u, w, c) => addRecord('磁磚工程', s, l, v, u, w, c)} vendors={vendors} />;\r\n            case 'finish': return <FinishCalculator onAddRecord={(s, l, v, u, w, c) => addRecord('塗料工程', s, l, v, u, w, c)} vendors={vendors} />;\r\n            case 'estimate': return <BuildingEstimator onAddRecord={(s, l, v, u, w, c) => addRecord('建築概估', s, l, v, u, w, c)} />;\r\n            default: return <StructureCalculator onAddRecord={(s, l, v, u, w, c) => addRecord('結構工程', s, l, v, u, w, c)} vendors={vendors} />;\r\n        }\r\n    };\r\n\r\n    return (\r\n        <div className=\"space-y-6 animate-fade-in\">\r\n            <SectionTitle title=\"營建物料快速換算\" />\r\n\r\n            <div className=\"grid grid-cols-1 lg:grid-cols-3 gap-6\">\r\n                {/* 左側：計算器 */}\r\n                <div className=\"lg:col-span-2 space-y-4\">\r\n                    {/* 工項選擇 */}\r\n                    <div className=\"bg-white rounded-2xl p-4 shadow-sm border border-gray-100\">\r\n                        <div className=\"flex gap-2 overflow-x-auto pb-2\">\r\n                            {tabs.map(tab => {\r\n                                const Icon = tab.icon;\r\n                                return (\r\n                                    <button\r\n                                        key={tab.id}\r\n                                        onClick={() => setActiveTab(tab.id)}\r\n                                        className={`flex items-center gap-2 px-4 py-3 rounded-xl whitespace-nowrap transition-all ${activeTab === tab.id\r\n                                            ? 'bg-gradient-to-r from-orange-500 to-orange-600 text-white shadow-lg'\r\n                                            : 'bg-gray-100 hover:bg-gray-200 text-gray-700'\r\n                                            }`}\r\n                                    >\r\n                                        <Icon size={18} />\r\n                                        <span className=\"font-medium\">{tab.label}</span>\r\n                                    </button>\r\n                                );\r\n                            })}\r\n                        </div>\r\n                    </div>\r\n\r\n                    {/* 計算器區域 */}\r\n                    <div className=\"bg-gray-50 rounded-2xl p-5\">\r\n                        {renderCalculator()}\r\n                    </div>\r\n\r\n                    {/* 公式說明 */}\r\n                    <div className=\"bg-white rounded-2xl p-5 shadow-sm border border-gray-100\">\r\n                        <h4 className=\"font-bold text-gray-800 mb-3 flex items-center gap-2\">\r\n                            <Calculator size={18} />\r\n                            常用換算公式\r\n                        </h4>\r\n                        <div className=\"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 text-sm\">\r\n                            <div className=\"bg-gray-50 p-3 rounded-lg\">\r\n                                <div className=\"font-medium text-gray-700\">🧱 鋼筋重量</div>\r\n                                <div className=\"text-gray-500 mt-1\">每米重 = 0.00617 × d²</div>\r\n                            </div>\r\n                            <div className=\"bg-gray-50 p-3 rounded-lg\">\r\n                                <div className=\"font-medium text-gray-700\">🧱 紅磚數量</div>\r\n                                <div className=\"text-gray-500 mt-1\">24牆 = 128塊/m²</div>\r\n                            </div>\r\n                            <div className=\"bg-gray-50 p-3 rounded-lg\">\r\n                                <div className=\"font-medium text-gray-700\">🔲 磁磚片數</div>\r\n                                <div className=\"text-gray-500 mt-1\">每坪 = 32400 ÷ (長×寬)</div>\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n\r\n                {/* 右側：計算記錄與匯出 */}\r\n                <div className=\"space-y-4\">\r\n                    {/* 計算記錄 */}\r\n                    <div className=\"bg-gradient-to-br from-orange-500 to-orange-600 rounded-2xl p-4 text-white\">\r\n                        <div className=\"flex items-center justify-between mb-3\">\r\n                            <span className=\"font-bold flex items-center gap-2\">\r\n                                <Calculator size={18} />\r\n                                計算記錄\r\n                            </span>\r\n                            {calcRecords.length > 0 && (\r\n                                <button\r\n                                    onClick={clearRecords}\r\n                                    className=\"text-xs bg-white/20 hover:bg-white/30 px-2 py-1 rounded\"\r\n                                >\r\n                                    清空\r\n                                </button>\r\n                            )}\r\n                        </div>\r\n\r\n                        {calcRecords.length === 0 ? (\r\n                            <div className=\"text-center py-8 text-orange-200\">\r\n                                <Calculator size={40} className=\"mx-auto mb-2 opacity-50\" />\r\n                                <p className=\"text-sm\">計算後點擊「加入記錄」</p>\r\n                            </div>\r\n                        ) : (\r\n                            <div className=\"space-y-2 max-h-[300px] overflow-y-auto\">\r\n                                {calcRecords.map(record => (\r\n                                    <div key={record.id} className=\"flex items-center justify-between py-2 border-b border-white/20 last:border-0\">\r\n                                        <div className=\"flex-1 min-w-0\">\r\n                                            <div className=\"font-medium text-sm truncate\">{record.label}</div>\r\n                                            <div className=\"text-xs text-orange-200\">\r\n                                                {record.category} - {record.subType}\r\n                                            </div>\r\n                                        </div>\r\n                                        <div className=\"flex items-center gap-2\">\r\n                                            <span className=\"text-sm font-bold\">\r\n                                                {formatNumber(record.wastageValue)} {record.unit}\r\n                                            </span>\r\n                                            <button\r\n                                                onClick={() => removeRecord(record.id)}\r\n                                                className=\"p-1 hover:bg-white/20 rounded text-red-200\"\r\n                                            >\r\n                                                <Trash2 size={14} />\r\n                                            </button>\r\n                                        </div>\r\n                                    </div>\r\n                                ))}\r\n                            </div>\r\n                        )}\r\n                    </div>\r\n\r\n                    {/* 匯出到 Google Sheet */}\r\n                    {calcRecords.length > 0 && (\r\n                        <div className=\"bg-blue-50 border border-blue-200 rounded-2xl p-4\">\r\n                            <div className=\"flex items-center gap-2 mb-3\">\r\n                                <FileSpreadsheet size={18} className=\"text-blue-600\" />\r\n                                <span className=\"font-medium text-blue-800\">匯出到 Google Sheet</span>\r\n                            </div>\r\n                            <div className=\"space-y-3\">\r\n                                <input\r\n                                    type=\"text\"\r\n                                    value={exportName}\r\n                                    onChange={(e) => setExportName(e.target.value)}\r\n                                    placeholder=\"輸入報表名稱（選填）\"\r\n                                    className=\"w-full px-3 py-2 rounded-lg border border-blue-200 text-sm focus:outline-none focus:ring-2 focus:ring-blue-300\"\r\n                                />\r\n                                <button\r\n                                    onClick={exportToSheet}\r\n                                    disabled={isExporting}\r\n                                    className=\"w-full bg-blue-600 hover:bg-blue-700 text-white py-2.5 rounded-lg text-sm font-medium transition-colors flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed\"\r\n                                >\r\n                                    {isExporting ? (\r\n                                        <>\r\n                                            <RefreshCw size={16} className=\"animate-spin\" />\r\n                                            匯出中...\r\n                                        </>\r\n                                    ) : (\r\n                                        <>\r\n                                            <FileSpreadsheet size={16} />\r\n                                            匯出到 Google Sheet\r\n                                        </>\r\n                                    )}\r\n                                </button>\r\n                            </div>\r\n\r\n                            {exportedSheet && (\r\n                                <div className=\"mt-3 pt-3 border-t border-blue-200\">\r\n                                    <a\r\n                                        href={exportedSheet.sheetUrl}\r\n                                        target=\"_blank\"\r\n                                        rel=\"noopener noreferrer\"\r\n                                        className=\"text-sm text-blue-600 hover:text-blue-800 flex items-center gap-1\"\r\n                                    >\r\n                                        <ExternalLink size={14} />\r\n                                        開啟已匯出的 Sheet\r\n                                    </a>\r\n                                </div>\r\n                            )}\r\n                        </div>\r\n                    )}\r\n\r\n                    {/* 使用提示 */}\r\n                    <div className=\"bg-orange-50 border border-orange-200 rounded-xl p-4\">\r\n                        <div className=\"flex gap-2\">\r\n                            <Info size={16} className=\"text-orange-500 flex-shrink-0 mt-0.5\" />\r\n                            <div className=\"text-xs text-orange-700\">\r\n                                <p className=\"font-medium mb-1\">使用說明</p>\r\n                                <ol className=\"list-decimal list-inside space-y-0.5 text-orange-600\">\r\n                                    <li>選擇工程類別進行計算</li>\r\n                                    <li>點「加入記錄」保存結果</li>\r\n                                    <li>匯出到 Google Sheet</li>\r\n                                </ol>\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n        </div>\r\n    );\r\n};\r\n\r\nexport default MaterialCalculator;\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\xiang\\senteng-frontend\\src\\pages\\MaterialGallery.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\xiang\\senteng-frontend\\src\\pages\\Payments.jsx","messages":[{"ruleId":"no-unused-vars","severity":2,"message":"'Icon' is defined but never used. Allowed unused args must match /^_|^e$|^err$|^event$/u.","line":57,"column":27,"nodeType":"Identifier","messageId":"unusedVar","endLine":57,"endColumn":31,"suggestions":[{"messageId":"removeVar","data":{"varName":"Icon"},"fix":{"range":[1712,1723],"text":""},"desc":"Remove unused variable 'Icon'."}]},{"ruleId":"no-unused-vars","severity":2,"message":"'error' is defined but never used.","line":133,"column":22,"nodeType":"Identifier","messageId":"unusedVar","endLine":133,"endColumn":27},{"ruleId":"no-unused-vars","severity":2,"message":"'error' is defined but never used.","line":144,"column":18,"nodeType":"Identifier","messageId":"unusedVar","endLine":144,"endColumn":23},{"ruleId":"no-unused-vars","severity":2,"message":"'error' is defined but never used.","line":156,"column":22,"nodeType":"Identifier","messageId":"unusedVar","endLine":156,"endColumn":27},{"ruleId":"no-unused-vars","severity":2,"message":"'error' is defined but never used.","line":169,"column":22,"nodeType":"Identifier","messageId":"unusedVar","endLine":169,"endColumn":27},{"ruleId":"no-unused-vars","severity":2,"message":"'onBack' is defined but never used. Allowed unused args must match /^_|^e$|^err$|^event$/u.","line":401,"column":32,"nodeType":"Identifier","messageId":"unusedVar","endLine":401,"endColumn":38,"suggestions":[{"messageId":"removeVar","data":{"varName":"onBack"},"fix":{"range":[17561,17569],"text":""},"desc":"Remove unused variable 'onBack'."}]}],"suppressedMessages":[],"errorCount":6,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * 請款管理頁面 (Payments.jsx)\r\n * 請款單列表與編輯器\r\n */\r\n\r\nimport React, { useState, useEffect, useMemo } from 'react';\r\nimport {\r\n    FileText, Plus, Search, Filter, Eye, Edit2, Trash2, Send,\r\n    Check, X, DollarSign, Calendar, Building2, Users, Receipt,\r\n    AlertCircle, Clock, CheckCircle, TrendingUp\r\n} from 'lucide-react';\r\nimport { SectionTitle } from '../components/common/Indicators';\r\nimport PaymentService, {\r\n    PAYMENT_STATUS,\r\n    PAYMENT_STATUS_LABELS,\r\n    PAYMENT_STATUS_COLORS,\r\n    PAYMENT_TYPES,\r\n    PAYMENT_TYPE_LABELS,\r\n    calculateRetention,\r\n} from '../services/PaymentService';\r\n\r\n// ============================================\r\n// 格式化函數\r\n// ============================================\r\nconst formatCurrency = (amount) => {\r\n    return new Intl.NumberFormat('zh-TW', {\r\n        style: 'currency',\r\n        currency: 'TWD',\r\n        minimumFractionDigits: 0,\r\n        maximumFractionDigits: 0,\r\n    }).format(amount || 0);\r\n};\r\n\r\nconst formatDate = (dateString) => {\r\n    if (!dateString) return '-';\r\n    return new Date(dateString).toLocaleDateString('zh-TW');\r\n};\r\n\r\n// ============================================\r\n// 狀態徽章\r\n// ============================================\r\nconst StatusBadge = ({ status }) => (\r\n    <span className={`px-2 py-1 rounded-full text-xs font-medium ${PAYMENT_STATUS_COLORS[status]}`}>\r\n        {PAYMENT_STATUS_LABELS[status]}\r\n    </span>\r\n);\r\n\r\nconst TypeBadge = ({ type }) => (\r\n    <span className=\"px-2 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-700\">\r\n        {PAYMENT_TYPE_LABELS[type]}\r\n    </span>\r\n);\r\n\r\n// ============================================\r\n// 統計卡片\r\n// ============================================\r\nconst StatCard = ({ icon: Icon, label, value, color = 'gray', subValue }) => (\r\n    <div className=\"bg-white rounded-xl p-4 border border-gray-100\">\r\n        <div className=\"flex items-center gap-3\">\r\n            <div className={`p-2 rounded-lg bg-${color}-100`}>\r\n                <Icon size={20} className={`text-${color}-600`} />\r\n            </div>\r\n            <div className=\"flex-1\">\r\n                <p className=\"text-sm text-gray-500\">{label}</p>\r\n                <p className={`text-xl font-bold text-${color}-600`}>{value}</p>\r\n                {subValue && <p className=\"text-xs text-gray-400\">{subValue}</p>}\r\n            </div>\r\n        </div>\r\n    </div>\r\n);\r\n\r\n// ============================================\r\n// 請款單編輯器\r\n// ============================================\r\nconst PaymentEditor = ({ payment, onSave, onBack, addToast }) => {\r\n    const [formData, setFormData] = useState({\r\n        title: payment?.title || '',\r\n        type: payment?.type || PAYMENT_TYPES.PROGRESS,\r\n        description: payment?.description || '',\r\n        projectName: payment?.projectName || '',\r\n        customerName: payment?.customerName || '',\r\n        contractAmount: payment?.contractAmount || 0,\r\n        previousPaidAmount: payment?.previousPaidAmount || 0,\r\n        requestAmount: payment?.requestAmount || 0,\r\n        retentionRate: payment?.retentionRate || 5,\r\n        dueDate: payment?.dueDate?.split('T')[0] || '',\r\n        invoiceNo: payment?.invoiceNo || '',\r\n        items: payment?.items || [],\r\n    });\r\n    const [isSaving, setIsSaving] = useState(false);\r\n\r\n    const isEditable = !payment || payment.status === PAYMENT_STATUS.DRAFT;\r\n\r\n    // 計算金額\r\n    const retentionAmount = calculateRetention(formData.requestAmount, formData.retentionRate);\r\n    const payableAmount = formData.requestAmount - retentionAmount;\r\n    const remainingAmount = formData.contractAmount - formData.previousPaidAmount - formData.requestAmount;\r\n\r\n    const handleSave = async () => {\r\n        if (!formData.title.trim()) {\r\n            addToast?.('error', '請輸入請款單標題');\r\n            return;\r\n        }\r\n        if (formData.requestAmount <= 0) {\r\n            addToast?.('error', '請輸入請款金額');\r\n            return;\r\n        }\r\n\r\n        setIsSaving(true);\r\n        try {\r\n            if (payment?.id) {\r\n                await PaymentService.updatePayment(payment.id, formData);\r\n            } else {\r\n                await PaymentService.createPayment(formData);\r\n            }\r\n            addToast?.('success', '儲存成功');\r\n            onSave?.();\r\n        } catch (error) {\r\n            console.error('Save error:', error);\r\n            addToast?.('error', '儲存失敗');\r\n        } finally {\r\n            setIsSaving(false);\r\n        }\r\n    };\r\n\r\n    const handleSubmit = async () => {\r\n        await handleSave();\r\n        if (payment?.id) {\r\n            try {\r\n                await PaymentService.submitForReview(payment.id, 'current-user');\r\n                addToast?.('success', '已送出審核');\r\n                onSave?.();\r\n            } catch (error) {\r\n                addToast?.('error', '送出失敗');\r\n            }\r\n        }\r\n    };\r\n\r\n    const handleApprove = async () => {\r\n        try {\r\n            await PaymentService.approve(payment.id, 'current-user');\r\n            addToast?.('success', '已核准');\r\n            onSave?.();\r\n        } catch (error) {\r\n            addToast?.('error', '核准失敗');\r\n        }\r\n    };\r\n\r\n    const handleCreateInvoice = async () => {\r\n        const invoiceNo = prompt('請輸入發票號碼：');\r\n        if (invoiceNo) {\r\n            try {\r\n                await PaymentService.createInvoice(payment.id, invoiceNo);\r\n                addToast?.('success', '已開立發票');\r\n                onSave?.();\r\n            } catch (error) {\r\n                addToast?.('error', '開票失敗');\r\n            }\r\n        }\r\n    };\r\n\r\n    const handleRecordReceipt = async () => {\r\n        const amount = prompt('請輸入收款金額：', payableAmount.toString());\r\n        if (amount) {\r\n            try {\r\n                await PaymentService.recordReceipt(payment.id, parseFloat(amount));\r\n                addToast?.('success', '已記錄收款');\r\n                onSave?.();\r\n            } catch (error) {\r\n                addToast?.('error', '記錄失敗');\r\n            }\r\n        }\r\n    };\r\n\r\n    return (\r\n        <div className=\"space-y-6\">\r\n            {/* 頂部導航 */}\r\n            <div className=\"flex items-center justify-between\">\r\n                <div className=\"flex items-center gap-4\">\r\n                    <button onClick={onBack} className=\"p-2 hover:bg-gray-100 rounded-lg\">\r\n                        ← 返回\r\n                    </button>\r\n                    <div>\r\n                        <h2 className=\"text-xl font-bold\">\r\n                            {payment?.paymentNo || '新增請款單'}\r\n                        </h2>\r\n                        {payment?.projectName && (\r\n                            <p className=\"text-sm text-gray-500\">{payment.projectName}</p>\r\n                        )}\r\n                    </div>\r\n                    {payment && <StatusBadge status={payment.status} />}\r\n                </div>\r\n                <div className=\"flex gap-2\">\r\n                    {isEditable && (\r\n                        <>\r\n                            <button\r\n                                onClick={handleSave}\r\n                                disabled={isSaving}\r\n                                className=\"px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50\"\r\n                            >\r\n                                {isSaving ? '儲存中...' : '儲存'}\r\n                            </button>\r\n                            {payment?.id && (\r\n                                <button\r\n                                    onClick={handleSubmit}\r\n                                    className=\"px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700\"\r\n                                >\r\n                                    送出審核\r\n                                </button>\r\n                            )}\r\n                        </>\r\n                    )}\r\n                    {payment?.status === PAYMENT_STATUS.PENDING && (\r\n                        <button\r\n                            onClick={handleApprove}\r\n                            className=\"px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700\"\r\n                        >\r\n                            核准\r\n                        </button>\r\n                    )}\r\n                    {payment?.status === PAYMENT_STATUS.APPROVED && (\r\n                        <button\r\n                            onClick={handleCreateInvoice}\r\n                            className=\"px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700\"\r\n                        >\r\n                            開立發票\r\n                        </button>\r\n                    )}\r\n                    {(payment?.status === PAYMENT_STATUS.INVOICED || payment?.status === PAYMENT_STATUS.PARTIAL) && (\r\n                        <button\r\n                            onClick={handleRecordReceipt}\r\n                            className=\"px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700\"\r\n                        >\r\n                            記錄收款\r\n                        </button>\r\n                    )}\r\n                </div>\r\n            </div>\r\n\r\n            {/* 基本資訊 */}\r\n            <div className=\"bg-white rounded-xl p-6 shadow-sm border border-gray-100\">\r\n                <h3 className=\"font-semibold mb-4\">基本資訊</h3>\r\n                <div className=\"grid grid-cols-3 gap-4\">\r\n                    <div>\r\n                        <label className=\"block text-sm text-gray-600 mb-1\">請款標題</label>\r\n                        <input\r\n                            type=\"text\"\r\n                            value={formData.title}\r\n                            onChange={(e) => setFormData(prev => ({ ...prev, title: e.target.value }))}\r\n                            disabled={!isEditable}\r\n                            placeholder=\"例：第一期工程款\"\r\n                            className=\"w-full px-3 py-2 border rounded-lg\"\r\n                        />\r\n                    </div>\r\n                    <div>\r\n                        <label className=\"block text-sm text-gray-600 mb-1\">請款類型</label>\r\n                        <select\r\n                            value={formData.type}\r\n                            onChange={(e) => setFormData(prev => ({ ...prev, type: e.target.value }))}\r\n                            disabled={!isEditable}\r\n                            className=\"w-full px-3 py-2 border rounded-lg\"\r\n                        >\r\n                            {Object.entries(PAYMENT_TYPE_LABELS).map(([key, label]) => (\r\n                                <option key={key} value={key}>{label}</option>\r\n                            ))}\r\n                        </select>\r\n                    </div>\r\n                    <div>\r\n                        <label className=\"block text-sm text-gray-600 mb-1\">請款日期</label>\r\n                        <input\r\n                            type=\"date\"\r\n                            value={formData.dueDate}\r\n                            onChange={(e) => setFormData(prev => ({ ...prev, dueDate: e.target.value }))}\r\n                            disabled={!isEditable}\r\n                            className=\"w-full px-3 py-2 border rounded-lg\"\r\n                        />\r\n                    </div>\r\n                </div>\r\n                <div className=\"grid grid-cols-2 gap-4 mt-4\">\r\n                    <div>\r\n                        <label className=\"block text-sm text-gray-600 mb-1\">專案名稱</label>\r\n                        <input\r\n                            type=\"text\"\r\n                            value={formData.projectName}\r\n                            onChange={(e) => setFormData(prev => ({ ...prev, projectName: e.target.value }))}\r\n                            disabled={!isEditable}\r\n                            placeholder=\"輸入專案名稱\"\r\n                            className=\"w-full px-3 py-2 border rounded-lg\"\r\n                        />\r\n                    </div>\r\n                    <div>\r\n                        <label className=\"block text-sm text-gray-600 mb-1\">客戶名稱</label>\r\n                        <input\r\n                            type=\"text\"\r\n                            value={formData.customerName}\r\n                            onChange={(e) => setFormData(prev => ({ ...prev, customerName: e.target.value }))}\r\n                            disabled={!isEditable}\r\n                            placeholder=\"輸入客戶名稱\"\r\n                            className=\"w-full px-3 py-2 border rounded-lg\"\r\n                        />\r\n                    </div>\r\n                </div>\r\n            </div>\r\n\r\n            {/* 金額資訊 */}\r\n            <div className=\"bg-white rounded-xl p-6 shadow-sm border border-gray-100\">\r\n                <h3 className=\"font-semibold mb-4\">金額資訊</h3>\r\n                <div className=\"grid grid-cols-4 gap-4\">\r\n                    <div>\r\n                        <label className=\"block text-sm text-gray-600 mb-1\">合約總金額</label>\r\n                        <input\r\n                            type=\"number\"\r\n                            value={formData.contractAmount}\r\n                            onChange={(e) => setFormData(prev => ({ ...prev, contractAmount: parseFloat(e.target.value) || 0 }))}\r\n                            disabled={!isEditable}\r\n                            className=\"w-full px-3 py-2 border rounded-lg text-right\"\r\n                        />\r\n                    </div>\r\n                    <div>\r\n                        <label className=\"block text-sm text-gray-600 mb-1\">前期已請金額</label>\r\n                        <input\r\n                            type=\"number\"\r\n                            value={formData.previousPaidAmount}\r\n                            onChange={(e) => setFormData(prev => ({ ...prev, previousPaidAmount: parseFloat(e.target.value) || 0 }))}\r\n                            disabled={!isEditable}\r\n                            className=\"w-full px-3 py-2 border rounded-lg text-right\"\r\n                        />\r\n                    </div>\r\n                    <div>\r\n                        <label className=\"block text-sm text-gray-600 mb-1\">本期請款金額</label>\r\n                        <input\r\n                            type=\"number\"\r\n                            value={formData.requestAmount}\r\n                            onChange={(e) => setFormData(prev => ({ ...prev, requestAmount: parseFloat(e.target.value) || 0 }))}\r\n                            disabled={!isEditable}\r\n                            className=\"w-full px-3 py-2 border rounded-lg text-right font-semibold\"\r\n                        />\r\n                    </div>\r\n                    <div>\r\n                        <label className=\"block text-sm text-gray-600 mb-1\">保留款比例 (%)</label>\r\n                        <input\r\n                            type=\"number\"\r\n                            value={formData.retentionRate}\r\n                            onChange={(e) => setFormData(prev => ({ ...prev, retentionRate: parseFloat(e.target.value) || 0 }))}\r\n                            disabled={!isEditable}\r\n                            min=\"0\"\r\n                            max=\"100\"\r\n                            className=\"w-full px-3 py-2 border rounded-lg text-right\"\r\n                        />\r\n                    </div>\r\n                </div>\r\n            </div>\r\n\r\n            {/* 金額摘要 */}\r\n            <div className=\"bg-gradient-to-br from-gray-800 to-gray-700 rounded-xl p-6 text-white\">\r\n                <div className=\"grid grid-cols-4 gap-4\">\r\n                    <div className=\"text-center\">\r\n                        <p className=\"text-gray-400 text-sm mb-1\">本期請款</p>\r\n                        <p className=\"text-xl font-bold\">{formatCurrency(formData.requestAmount)}</p>\r\n                    </div>\r\n                    <div className=\"text-center\">\r\n                        <p className=\"text-gray-400 text-sm mb-1\">保留款 ({formData.retentionRate}%)</p>\r\n                        <p className=\"text-xl font-bold text-red-400\">-{formatCurrency(retentionAmount)}</p>\r\n                    </div>\r\n                    <div className=\"text-center\">\r\n                        <p className=\"text-gray-400 text-sm mb-1\">應付金額</p>\r\n                        <p className=\"text-xl font-bold text-green-400\">{formatCurrency(payableAmount)}</p>\r\n                    </div>\r\n                    <div className=\"text-center\">\r\n                        <p className=\"text-gray-400 text-sm mb-1\">剩餘未請</p>\r\n                        <p className=\"text-xl font-bold text-orange-400\">{formatCurrency(remainingAmount)}</p>\r\n                    </div>\r\n                </div>\r\n                {payment?.receivedAmount > 0 && (\r\n                    <div className=\"mt-4 pt-4 border-t border-white/20 text-center\">\r\n                        <p className=\"text-gray-400 text-sm\">已收款金額</p>\r\n                        <p className=\"text-2xl font-bold text-green-400\">{formatCurrency(payment.receivedAmount)}</p>\r\n                    </div>\r\n                )}\r\n            </div>\r\n\r\n            {/* 備註 */}\r\n            <div className=\"bg-white rounded-xl p-6 shadow-sm border border-gray-100\">\r\n                <h3 className=\"font-semibold mb-4\">備註說明</h3>\r\n                <textarea\r\n                    value={formData.description}\r\n                    onChange={(e) => setFormData(prev => ({ ...prev, description: e.target.value }))}\r\n                    disabled={!isEditable}\r\n                    placeholder=\"請款說明、施工進度等...\"\r\n                    rows={3}\r\n                    className=\"w-full px-3 py-2 border rounded-lg resize-none\"\r\n                />\r\n            </div>\r\n        </div>\r\n    );\r\n};\r\n\r\n// ============================================\r\n// 請款單列表\r\n// ============================================\r\nconst PaymentList = ({ onEdit, onBack, addToast }) => {\r\n    const [payments, setPayments] = useState([]);\r\n    const [loading, setLoading] = useState(true);\r\n    const [searchTerm, setSearchTerm] = useState('');\r\n    const [statusFilter, setStatusFilter] = useState('ALL');\r\n\r\n    const loadPayments = async () => {\r\n        setLoading(true);\r\n        try {\r\n            const data = await PaymentService.getPayments();\r\n            setPayments(data);\r\n        } catch (error) {\r\n            console.error('Load error:', error);\r\n        } finally {\r\n            setLoading(false);\r\n        }\r\n    };\r\n\r\n    useEffect(() => {\r\n        loadPayments();\r\n    }, []);\r\n\r\n    // 篩選\r\n    const filteredPayments = useMemo(() => {\r\n        return payments.filter(p => {\r\n            if (statusFilter !== 'ALL' && p.status !== statusFilter) return false;\r\n            if (searchTerm) {\r\n                const term = searchTerm.toLowerCase();\r\n                return (\r\n                    p.paymentNo?.toLowerCase().includes(term) ||\r\n                    p.title?.toLowerCase().includes(term) ||\r\n                    p.projectName?.toLowerCase().includes(term) ||\r\n                    p.customerName?.toLowerCase().includes(term)\r\n                );\r\n            }\r\n            return true;\r\n        });\r\n    }, [payments, statusFilter, searchTerm]);\r\n\r\n    // 統計\r\n    const stats = useMemo(() => {\r\n        const total = payments.length;\r\n        const pending = payments.filter(p => p.status === PAYMENT_STATUS.PENDING).length;\r\n        const invoiced = payments.filter(p => p.status === PAYMENT_STATUS.INVOICED).length;\r\n        const totalRequested = payments.reduce((sum, p) => sum + (p.requestAmount || 0), 0);\r\n        const totalReceived = payments.reduce((sum, p) => sum + (p.receivedAmount || 0), 0);\r\n\r\n        return { total, pending, invoiced, totalRequested, totalReceived };\r\n    }, [payments]);\r\n\r\n    const handleCreate = () => {\r\n        onEdit(null);\r\n    };\r\n\r\n    const handleDelete = async (id) => {\r\n        if (!window.confirm('確定要刪除此請款單？')) return;\r\n        try {\r\n            await PaymentService.deletePayment(id);\r\n            addToast?.('success', '已刪除');\r\n            loadPayments();\r\n        } catch (error) {\r\n            addToast?.('error', error.message);\r\n        }\r\n    };\r\n\r\n    return (\r\n        <div className=\"space-y-6\">\r\n            {/* 標題 */}\r\n            <div className=\"flex items-center justify-between\">\r\n                <SectionTitle\r\n                    icon={Receipt}\r\n                    title=\"請款管理\"\r\n                    subtitle=\"管理專案請款與收款\"\r\n                />\r\n                <button\r\n                    onClick={handleCreate}\r\n                    className=\"px-4 py-2 bg-orange-500 text-white rounded-xl hover:bg-orange-600 flex items-center gap-2\"\r\n                >\r\n                    <Plus size={18} /> 新增請款單\r\n                </button>\r\n            </div>\r\n\r\n            {/* 統計卡片 */}\r\n            <div className=\"grid grid-cols-2 lg:grid-cols-5 gap-4\">\r\n                <StatCard icon={FileText} label=\"全部請款單\" value={stats.total} color=\"gray\" />\r\n                <StatCard icon={Clock} label=\"待審核\" value={stats.pending} color=\"yellow\" />\r\n                <StatCard icon={Receipt} label=\"已開票\" value={stats.invoiced} color=\"purple\" />\r\n                <StatCard icon={TrendingUp} label=\"總請款金額\" value={formatCurrency(stats.totalRequested)} color=\"blue\" />\r\n                <StatCard icon={CheckCircle} label=\"已收款金額\" value={formatCurrency(stats.totalReceived)} color=\"green\" />\r\n            </div>\r\n\r\n            {/* 搜尋與篩選 */}\r\n            <div className=\"flex gap-3\">\r\n                <div className=\"relative flex-1\">\r\n                    <Search size={18} className=\"absolute left-3 top-1/2 -translate-y-1/2 text-gray-400\" />\r\n                    <input\r\n                        type=\"text\"\r\n                        value={searchTerm}\r\n                        onChange={(e) => setSearchTerm(e.target.value)}\r\n                        placeholder=\"搜尋請款單編號、專案、客戶...\"\r\n                        className=\"w-full pl-10 pr-4 py-2.5 border border-gray-200 rounded-xl\"\r\n                    />\r\n                </div>\r\n                <select\r\n                    value={statusFilter}\r\n                    onChange={(e) => setStatusFilter(e.target.value)}\r\n                    className=\"px-4 py-2.5 border border-gray-200 rounded-xl bg-white\"\r\n                >\r\n                    <option value=\"ALL\">全部狀態</option>\r\n                    {Object.entries(PAYMENT_STATUS_LABELS).map(([key, label]) => (\r\n                        <option key={key} value={key}>{label}</option>\r\n                    ))}\r\n                </select>\r\n            </div>\r\n\r\n            {/* 請款單列表 */}\r\n            <div className=\"bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden\">\r\n                <table className=\"w-full\">\r\n                    <thead className=\"bg-gray-50\">\r\n                        <tr>\r\n                            <th className=\"py-3 px-4 text-left text-sm font-medium text-gray-600\">請款單號</th>\r\n                            <th className=\"py-3 px-4 text-left text-sm font-medium text-gray-600\">標題</th>\r\n                            <th className=\"py-3 px-4 text-left text-sm font-medium text-gray-600\">專案/客戶</th>\r\n                            <th className=\"py-3 px-4 text-center text-sm font-medium text-gray-600\">類型</th>\r\n                            <th className=\"py-3 px-4 text-center text-sm font-medium text-gray-600\">狀態</th>\r\n                            <th className=\"py-3 px-4 text-right text-sm font-medium text-gray-600\">請款金額</th>\r\n                            <th className=\"py-3 px-4 text-right text-sm font-medium text-gray-600\">已收金額</th>\r\n                            <th className=\"py-3 px-4 text-center text-sm font-medium text-gray-600\">到期日</th>\r\n                            <th className=\"py-3 px-4 text-center text-sm font-medium text-gray-600\">操作</th>\r\n                        </tr>\r\n                    </thead>\r\n                    <tbody>\r\n                        {filteredPayments.map(payment => (\r\n                            <tr key={payment.id} className=\"border-b border-gray-100 hover:bg-gray-50\">\r\n                                <td className=\"py-3 px-4 font-medium\">{payment.paymentNo}</td>\r\n                                <td className=\"py-3 px-4\">{payment.title}</td>\r\n                                <td className=\"py-3 px-4\">\r\n                                    <div className=\"text-sm\">{payment.projectName}</div>\r\n                                    <div className=\"text-xs text-gray-400\">{payment.customerName}</div>\r\n                                </td>\r\n                                <td className=\"py-3 px-4 text-center\">\r\n                                    <TypeBadge type={payment.type} />\r\n                                </td>\r\n                                <td className=\"py-3 px-4 text-center\">\r\n                                    <StatusBadge status={payment.status} />\r\n                                </td>\r\n                                <td className=\"py-3 px-4 text-right font-medium text-blue-600\">\r\n                                    {formatCurrency(payment.requestAmount)}\r\n                                </td>\r\n                                <td className=\"py-3 px-4 text-right font-medium text-green-600\">\r\n                                    {formatCurrency(payment.receivedAmount)}\r\n                                </td>\r\n                                <td className=\"py-3 px-4 text-center text-sm text-gray-500\">\r\n                                    {formatDate(payment.dueDate)}\r\n                                </td>\r\n                                <td className=\"py-3 px-4 text-center\">\r\n                                    <div className=\"flex justify-center gap-2\">\r\n                                        <button\r\n                                            onClick={() => onEdit(payment)}\r\n                                            className=\"px-2 py-1 text-sm text-blue-600 hover:bg-blue-50 rounded\"\r\n                                        >\r\n                                            {payment.status === PAYMENT_STATUS.DRAFT ? '編輯' : '查看'}\r\n                                        </button>\r\n                                        {payment.status === PAYMENT_STATUS.DRAFT && (\r\n                                            <button\r\n                                                onClick={() => handleDelete(payment.id)}\r\n                                                className=\"px-2 py-1 text-sm text-red-600 hover:bg-red-50 rounded\"\r\n                                            >\r\n                                                刪除\r\n                                            </button>\r\n                                        )}\r\n                                    </div>\r\n                                </td>\r\n                            </tr>\r\n                        ))}\r\n                    </tbody>\r\n                </table>\r\n                {loading ? (\r\n                    <div className=\"text-center py-8 text-gray-400\">載入中...</div>\r\n                ) : filteredPayments.length === 0 && (\r\n                    <div className=\"text-center py-8 text-gray-400\">\r\n                        尚無請款單，請點擊「新增請款單」建立\r\n                    </div>\r\n                )}\r\n            </div>\r\n        </div>\r\n    );\r\n};\r\n\r\n// ============================================\r\n// 主元件\r\n// ============================================\r\nconst Payments = ({ addToast }) => {\r\n    const [viewMode, setViewMode] = useState('list');\r\n    const [selectedPayment, setSelectedPayment] = useState(null);\r\n\r\n    const handleEdit = (payment) => {\r\n        setSelectedPayment(payment);\r\n        setViewMode('editor');\r\n    };\r\n\r\n    const handleBack = () => {\r\n        setSelectedPayment(null);\r\n        setViewMode('list');\r\n    };\r\n\r\n    if (viewMode === 'editor') {\r\n        return (\r\n            <PaymentEditor\r\n                payment={selectedPayment}\r\n                onSave={handleBack}\r\n                onBack={handleBack}\r\n                addToast={addToast}\r\n            />\r\n        );\r\n    }\r\n\r\n    return (\r\n        <PaymentList\r\n            onEdit={handleEdit}\r\n            addToast={addToast}\r\n        />\r\n    );\r\n};\r\n\r\nexport default Payments;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\xiang\\senteng-frontend\\src\\pages\\ProfitAnalysis.jsx","messages":[{"ruleId":"no-unused-vars","severity":2,"message":"'useMemo' is defined but never used. Allowed unused vars must match /^[A-Z_]|^_/u.","line":6,"column":38,"nodeType":"Identifier","messageId":"unusedVar","endLine":6,"endColumn":45,"suggestions":[{"messageId":"removeVar","data":{"varName":"useMemo"},"fix":{"range":[99,108],"text":""},"desc":"Remove unused variable 'useMemo'."}]},{"ruleId":"no-unused-vars","severity":2,"message":"'Icon' is defined but never used. Allowed unused args must match /^_|^e$|^err$|^event$/u.","line":44,"column":30,"nodeType":"Identifier","messageId":"unusedVar","endLine":44,"endColumn":34,"suggestions":[{"messageId":"removeVar","data":{"varName":"Icon"},"fix":{"range":[1312,1323],"text":""},"desc":"Remove unused variable 'Icon'."}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'loadData'. Either include it or remove the dependency array.","line":306,"column":8,"nodeType":"ArrayExpression","endLine":306,"endColumn":10,"suggestions":[{"desc":"Update the dependencies array to be: [loadData]","fix":{"range":[12148,12150],"text":"[loadData]"}}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * 利潤分析儀表板 (ProfitAnalysis.jsx)\r\n * 專案利潤、成本、請款綜合分析\r\n */\r\n\r\nimport React, { useState, useEffect, useMemo } from 'react';\r\nimport {\r\n    TrendingUp, TrendingDown, DollarSign, Percent, AlertTriangle,\r\n    CheckCircle, XCircle, BarChart3, PieChart, ArrowUpRight,\r\n    ArrowDownRight, Minus, Building2, Receipt, FileText, Info\r\n} from 'lucide-react';\r\nimport { SectionTitle } from '../components/common/Indicators';\r\nimport ProfitAnalysisService, {\r\n    PROFIT_STATUS,\r\n    PROFIT_STATUS_LABELS,\r\n    PROFIT_STATUS_COLORS,\r\n    COST_CATEGORY_LABELS,\r\n} from '../services/ProfitAnalysisService';\r\n\r\n// ============================================\r\n// 格式化函數\r\n// ============================================\r\nconst formatCurrency = (amount) => {\r\n    if (amount >= 1000000) {\r\n        return `${(amount / 1000000).toFixed(1)}M`;\r\n    }\r\n    if (amount >= 1000) {\r\n        return `${(amount / 1000).toFixed(0)}K`;\r\n    }\r\n    return amount?.toLocaleString() || '0';\r\n};\r\n\r\nconst formatFullCurrency = (amount) => {\r\n    return new Intl.NumberFormat('zh-TW', {\r\n        style: 'currency',\r\n        currency: 'TWD',\r\n        minimumFractionDigits: 0,\r\n    }).format(amount || 0);\r\n};\r\n\r\n// ============================================\r\n// 大型統計卡片\r\n// ============================================\r\nconst BigStatCard = ({ icon: Icon, label, value, subValue, trend, color = 'gray' }) => (\r\n    <div className={`bg-gradient-to-br from-${color}-500 to-${color}-600 rounded-2xl p-6 text-white shadow-lg`}>\r\n        <div className=\"flex items-start justify-between\">\r\n            <div>\r\n                <p className=\"text-white/80 text-sm font-medium\">{label}</p>\r\n                <p className=\"text-3xl font-bold mt-1\">{value}</p>\r\n                {subValue && <p className=\"text-white/70 text-sm mt-1\">{subValue}</p>}\r\n            </div>\r\n            <div className=\"p-3 bg-white/20 rounded-xl\">\r\n                <Icon size={24} />\r\n            </div>\r\n        </div>\r\n        {trend && (\r\n            <div className=\"mt-4 flex items-center gap-1 text-sm\">\r\n                {trend.direction === 'up' ? (\r\n                    <ArrowUpRight size={16} className=\"text-green-300\" />\r\n                ) : trend.direction === 'down' ? (\r\n                    <ArrowDownRight size={16} className=\"text-red-300\" />\r\n                ) : (\r\n                    <Minus size={16} />\r\n                )}\r\n                <span className=\"text-white/80\">\r\n                    {trend.direction === 'up' && '+'}\r\n                    {trend.direction === 'down' && '-'}\r\n                    {trend.value}% 相較上月\r\n                </span>\r\n            </div>\r\n        )}\r\n    </div>\r\n);\r\n\r\n// ============================================\r\n// 毛利狀態徽章\r\n// ============================================\r\nconst ProfitStatusBadge = ({ status }) => (\r\n    <span className={`px-2 py-1 rounded-full text-xs font-medium ${PROFIT_STATUS_COLORS[status]}`}>\r\n        {PROFIT_STATUS_LABELS[status]}\r\n    </span>\r\n);\r\n\r\n// ============================================\r\n// 進度條\r\n// ============================================\r\nconst ProgressBar = ({ value, max, color = 'orange' }) => {\r\n    const percent = max > 0 ? Math.min((value / max) * 100, 100) : 0;\r\n    return (\r\n        <div className=\"h-2 bg-gray-100 rounded-full overflow-hidden\">\r\n            <div\r\n                className={`h-full bg-${color}-500 rounded-full transition-all`}\r\n                style={{ width: `${percent}%` }}\r\n            />\r\n        </div>\r\n    );\r\n};\r\n\r\n// ============================================\r\n// 警報列表\r\n// ============================================\r\nconst AlertList = ({ alerts }) => {\r\n    if (!alerts?.length) {\r\n        return (\r\n            <div className=\"text-center py-8 text-gray-400\">\r\n                <CheckCircle size={32} className=\"mx-auto mb-2 opacity-50\" />\r\n                <p>目前無任何警報</p>\r\n            </div>\r\n        );\r\n    }\r\n\r\n    const getAlertIcon = (type) => {\r\n        switch (type) {\r\n            case 'error': return <XCircle size={18} className=\"text-red-500\" />;\r\n            case 'warning': return <AlertTriangle size={18} className=\"text-yellow-500\" />;\r\n            default: return <Info size={18} className=\"text-blue-500\" />;\r\n        }\r\n    };\r\n\r\n    const getAlertBg = (type) => {\r\n        switch (type) {\r\n            case 'error': return 'bg-red-50 border-red-200';\r\n            case 'warning': return 'bg-yellow-50 border-yellow-200';\r\n            default: return 'bg-blue-50 border-blue-200';\r\n        }\r\n    };\r\n\r\n    return (\r\n        <div className=\"space-y-2\">\r\n            {alerts.map((alert, i) => (\r\n                <div key={i} className={`p-3 rounded-lg border ${getAlertBg(alert.type)} flex items-start gap-3`}>\r\n                    {getAlertIcon(alert.type)}\r\n                    <div>\r\n                        <p className=\"text-sm font-medium text-gray-800\">{alert.title}</p>\r\n                        <p className=\"text-sm text-gray-600\">{alert.message}</p>\r\n                    </div>\r\n                </div>\r\n            ))}\r\n        </div>\r\n    );\r\n};\r\n\r\n// ============================================\r\n// 專案毛利列表\r\n// ============================================\r\nconst ProjectProfitList = ({ projects }) => {\r\n    if (!projects?.length) {\r\n        return (\r\n            <div className=\"text-center py-8 text-gray-400\">\r\n                <Building2 size={32} className=\"mx-auto mb-2 opacity-50\" />\r\n                <p>尚無進行中的專案</p>\r\n            </div>\r\n        );\r\n    }\r\n\r\n    return (\r\n        <div className=\"space-y-3\">\r\n            {projects.slice(0, 5).map(project => (\r\n                <div key={project.contractId} className=\"p-4 bg-gray-50 rounded-xl\">\r\n                    <div className=\"flex items-center justify-between mb-2\">\r\n                        <div className=\"flex items-center gap-2\">\r\n                            <span className=\"font-medium text-gray-800\">{project.projectName}</span>\r\n                            <ProfitStatusBadge status={project.status} />\r\n                        </div>\r\n                        <span className={`text-lg font-bold ${parseFloat(project.marginRate) < 10 ? 'text-red-600' :\r\n                                parseFloat(project.marginRate) < 20 ? 'text-yellow-600' : 'text-green-600'\r\n                            }`}>\r\n                            {project.marginRate}%\r\n                        </span>\r\n                    </div>\r\n                    <div className=\"grid grid-cols-3 gap-2 text-sm\">\r\n                        <div>\r\n                            <span className=\"text-gray-500\">收入</span>\r\n                            <p className=\"font-medium\">{formatFullCurrency(project.revenue)}</p>\r\n                        </div>\r\n                        <div>\r\n                            <span className=\"text-gray-500\">成本</span>\r\n                            <p className=\"font-medium text-red-600\">{formatFullCurrency(project.totalCost)}</p>\r\n                        </div>\r\n                        <div>\r\n                            <span className=\"text-gray-500\">毛利</span>\r\n                            <p className={`font-medium ${project.grossProfit >= 0 ? 'text-green-600' : 'text-red-600'}`}>\r\n                                {formatFullCurrency(project.grossProfit)}\r\n                            </p>\r\n                        </div>\r\n                    </div>\r\n                    <div className=\"mt-2\">\r\n                        <div className=\"flex justify-between text-xs text-gray-500 mb-1\">\r\n                            <span>請款進度</span>\r\n                            <span>{project.paymentProgress}%</span>\r\n                        </div>\r\n                        <ProgressBar value={parseFloat(project.paymentProgress)} max={100} />\r\n                    </div>\r\n                </div>\r\n            ))}\r\n        </div>\r\n    );\r\n};\r\n\r\n// ============================================\r\n// 狀態分佈圓餅區\r\n// ============================================\r\nconst StatusDistribution = ({ distribution }) => {\r\n    const total = Object.values(distribution || {}).reduce((a, b) => a + b, 0);\r\n    if (total === 0) {\r\n        return (\r\n            <div className=\"text-center py-4 text-gray-400 text-sm\">\r\n                尚無專案資料\r\n            </div>\r\n        );\r\n    }\r\n\r\n    const items = [\r\n        { key: 'healthy', label: '健康', color: 'green', count: distribution?.healthy || 0 },\r\n        { key: 'warning', label: '警示', color: 'yellow', count: distribution?.warning || 0 },\r\n        { key: 'critical', label: '危險', color: 'orange', count: distribution?.critical || 0 },\r\n        { key: 'loss', label: '虧損', color: 'red', count: distribution?.loss || 0 },\r\n    ];\r\n\r\n    return (\r\n        <div className=\"space-y-3\">\r\n            {items.map(item => (\r\n                <div key={item.key} className=\"flex items-center gap-3\">\r\n                    <div className={`w-3 h-3 rounded-full bg-${item.color}-500`} />\r\n                    <span className=\"flex-1 text-sm text-gray-600\">{item.label}</span>\r\n                    <span className=\"font-semibold\">{item.count}</span>\r\n                    <span className=\"text-sm text-gray-400\">\r\n                        ({total > 0 ? ((item.count / total) * 100).toFixed(0) : 0}%)\r\n                    </span>\r\n                </div>\r\n            ))}\r\n        </div>\r\n    );\r\n};\r\n\r\n// ============================================\r\n// 月度趨勢圖表\r\n// ============================================\r\nconst MonthlyTrendChart = ({ data }) => {\r\n    if (!data?.length) return null;\r\n\r\n    const maxValue = Math.max(...data.map(d => Math.max(d.revenue, d.cost)));\r\n\r\n    return (\r\n        <div className=\"space-y-4\">\r\n            <div className=\"flex justify-end gap-4 text-sm\">\r\n                <div className=\"flex items-center gap-2\">\r\n                    <div className=\"w-3 h-3 rounded-full bg-blue-500\" />\r\n                    <span className=\"text-gray-600\">收入</span>\r\n                </div>\r\n                <div className=\"flex items-center gap-2\">\r\n                    <div className=\"w-3 h-3 rounded-full bg-red-400\" />\r\n                    <span className=\"text-gray-600\">成本</span>\r\n                </div>\r\n            </div>\r\n            <div className=\"flex items-end justify-between gap-2 h-40\">\r\n                {data.map((item, i) => (\r\n                    <div key={i} className=\"flex-1 flex flex-col items-center gap-1\">\r\n                        <div className=\"flex-1 w-full flex items-end justify-center gap-1\">\r\n                            <div\r\n                                className=\"w-3 bg-blue-500 rounded-t\"\r\n                                style={{ height: `${(item.revenue / maxValue) * 100}%` }}\r\n                                title={`收入: ${formatFullCurrency(item.revenue)}`}\r\n                            />\r\n                            <div\r\n                                className=\"w-3 bg-red-400 rounded-t\"\r\n                                style={{ height: `${(item.cost / maxValue) * 100}%` }}\r\n                                title={`成本: ${formatFullCurrency(item.cost)}`}\r\n                            />\r\n                        </div>\r\n                        <span className=\"text-xs text-gray-500\">{item.month}</span>\r\n                    </div>\r\n                ))}\r\n            </div>\r\n        </div>\r\n    );\r\n};\r\n\r\n// ============================================\r\n// 主元件\r\n// ============================================\r\nconst ProfitAnalysis = ({ addToast }) => {\r\n    const [metrics, setMetrics] = useState(null);\r\n    const [alerts, setAlerts] = useState([]);\r\n    const [loading, setLoading] = useState(true);\r\n\r\n    const loadData = async () => {\r\n        setLoading(true);\r\n        try {\r\n            const [metricsData, alertsData] = await Promise.all([\r\n                ProfitAnalysisService.getDashboardMetrics(),\r\n                ProfitAnalysisService.getAlerts(),\r\n            ]);\r\n            setMetrics(metricsData);\r\n            setAlerts(alertsData);\r\n        } catch (error) {\r\n            console.error('Load error:', error);\r\n            addToast?.('error', '載入資料失敗');\r\n        } finally {\r\n            setLoading(false);\r\n        }\r\n    };\r\n\r\n    useEffect(() => {\r\n        loadData();\r\n    }, []);\r\n\r\n    if (loading) {\r\n        return (\r\n            <div className=\"flex items-center justify-center h-64\">\r\n                <div className=\"animate-spin rounded-full h-8 w-8 border-b-2 border-orange-500\" />\r\n            </div>\r\n        );\r\n    }\r\n\r\n    return (\r\n        <div className=\"space-y-6\">\r\n            {/* 標題 */}\r\n            <SectionTitle\r\n                icon={BarChart3}\r\n                title=\"利潤分析\"\r\n                subtitle=\"專案成本、收入與毛利綜合分析\"\r\n            />\r\n\r\n            {/* 主要指標 */}\r\n            <div className=\"grid grid-cols-4 gap-4\">\r\n                <BigStatCard\r\n                    icon={DollarSign}\r\n                    label=\"總收入\"\r\n                    value={formatCurrency(metrics?.totalRevenue || 0)}\r\n                    subValue={formatFullCurrency(metrics?.totalRevenue || 0)}\r\n                    color=\"blue\"\r\n                />\r\n                <BigStatCard\r\n                    icon={Receipt}\r\n                    label=\"總成本\"\r\n                    value={formatCurrency(metrics?.totalCost || 0)}\r\n                    subValue={formatFullCurrency(metrics?.totalCost || 0)}\r\n                    color=\"red\"\r\n                />\r\n                <BigStatCard\r\n                    icon={TrendingUp}\r\n                    label=\"毛利\"\r\n                    value={formatCurrency(metrics?.totalProfit || 0)}\r\n                    subValue={`毛利率 ${metrics?.overallMargin || 0}%`}\r\n                    color=\"green\"\r\n                />\r\n                <BigStatCard\r\n                    icon={Percent}\r\n                    label=\"收款率\"\r\n                    value={`${metrics?.collectionRate || 0}%`}\r\n                    subValue={`已收 ${formatCurrency(metrics?.totalPaid || 0)}`}\r\n                    color=\"orange\"\r\n                />\r\n            </div>\r\n\r\n            {/* 中間區塊 */}\r\n            <div className=\"grid grid-cols-3 gap-6\">\r\n                {/* 專案狀態分佈 */}\r\n                <div className=\"bg-white rounded-2xl p-6 border border-gray-100 shadow-sm\">\r\n                    <h3 className=\"font-semibold text-gray-800 mb-4 flex items-center gap-2\">\r\n                        <PieChart size={18} /> 專案毛利狀態\r\n                    </h3>\r\n                    <StatusDistribution distribution={metrics?.statusDistribution} />\r\n                </div>\r\n\r\n                {/* 警報 */}\r\n                <div className=\"bg-white rounded-2xl p-6 border border-gray-100 shadow-sm\">\r\n                    <h3 className=\"font-semibold text-gray-800 mb-4 flex items-center gap-2\">\r\n                        <AlertTriangle size={18} /> 警報通知\r\n                        {alerts.length > 0 && (\r\n                            <span className=\"px-2 py-0.5 bg-red-100 text-red-600 text-xs rounded-full\">\r\n                                {alerts.length}\r\n                            </span>\r\n                        )}\r\n                    </h3>\r\n                    <AlertList alerts={alerts} />\r\n                </div>\r\n\r\n                {/* 月度趨勢 */}\r\n                <div className=\"bg-white rounded-2xl p-6 border border-gray-100 shadow-sm\">\r\n                    <h3 className=\"font-semibold text-gray-800 mb-4 flex items-center gap-2\">\r\n                        <BarChart3 size={18} /> 月度趨勢\r\n                    </h3>\r\n                    <MonthlyTrendChart data={metrics?.monthlyTrend} />\r\n                </div>\r\n            </div>\r\n\r\n            {/* 專案利潤列表 */}\r\n            <div className=\"bg-white rounded-2xl p-6 border border-gray-100 shadow-sm\">\r\n                <h3 className=\"font-semibold text-gray-800 mb-4 flex items-center gap-2\">\r\n                    <Building2 size={18} /> 專案毛利排行（低毛利優先）\r\n                </h3>\r\n                <ProjectProfitList projects={metrics?.projectAnalyses} />\r\n            </div>\r\n        </div>\r\n    );\r\n};\r\n\r\nexport default ProfitAnalysis;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\xiang\\senteng-frontend\\src\\pages\\Projects.jsx","messages":[{"ruleId":"no-unused-vars","severity":2,"message":"'size' is defined but never used. Allowed unused args must match /^_|^e$|^err$|^event$/u.","line":19,"column":42,"nodeType":"Identifier","messageId":"unusedVar","endLine":19,"endColumn":46,"suggestions":[{"messageId":"removeVar","data":{"varName":"size"},"fix":{"range":[1236,1242],"text":""},"desc":"Remove unused variable 'size'."}]},{"ruleId":"no-unused-vars","severity":2,"message":"'size' is defined but never used. Allowed unused args must match /^_|^e$|^err$|^event$/u.","line":34,"column":53,"nodeType":"Identifier","messageId":"unusedVar","endLine":34,"endColumn":57,"suggestions":[{"messageId":"removeVar","data":{"varName":"size"},"fix":{"range":[2529,2535],"text":""},"desc":"Remove unused variable 'size'."}]},{"ruleId":"no-unused-vars","severity":2,"message":"'loading' is defined but never used. Allowed unused args must match /^_|^e$|^err$|^event$/u.","line":138,"column":27,"nodeType":"Identifier","messageId":"unusedVar","endLine":138,"endColumn":34,"suggestions":[{"messageId":"removeVar","data":{"varName":"loading"},"fix":{"range":[7744,7753],"text":""},"desc":"Remove unused variable 'loading'."}]},{"ruleId":"no-unused-vars","severity":2,"message":"'onSelectProject' is defined but never used. Allowed unused args must match /^_|^e$|^err$|^event$/u.","line":138,"column":46,"nodeType":"Identifier","messageId":"unusedVar","endLine":138,"endColumn":61,"suggestions":[{"messageId":"removeVar","data":{"varName":"onSelectProject"},"fix":{"range":[7763,7780],"text":""},"desc":"Remove unused variable 'onSelectProject'."}]},{"ruleId":"no-unused-vars","severity":2,"message":"'onAddGlobalTx' is defined but never used. Allowed unused args must match /^_|^e$|^err$|^event$/u.","line":138,"column":147,"nodeType":"Identifier","messageId":"unusedVar","endLine":138,"endColumn":160,"suggestions":[{"messageId":"removeVar","data":{"varName":"onAddGlobalTx"},"fix":{"range":[7864,7879],"text":""},"desc":"Remove unused variable 'onAddGlobalTx'."}]},{"ruleId":"no-unused-vars","severity":2,"message":"'existingFolders' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]|^_/u.","line":178,"column":12,"nodeType":"Identifier","messageId":"unusedVar","endLine":178,"endColumn":27,"suggestions":[{"messageId":"removeVar","data":{"varName":"existingFolders"},"fix":{"range":[9651,9666],"text":""},"desc":"Remove unused variable 'existingFolders'."}]},{"ruleId":"no-unused-vars","severity":2,"message":"'setExistingFolders' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]|^_/u.","line":178,"column":29,"nodeType":"Identifier","messageId":"unusedVar","endLine":178,"endColumn":47,"suggestions":[{"messageId":"removeVar","data":{"varName":"setExistingFolders"},"fix":{"range":[9666,9686],"text":""},"desc":"Remove unused variable 'setExistingFolders'."}]},{"ruleId":"no-unused-vars","severity":2,"message":"'projectRootId' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]|^_/u.","line":179,"column":12,"nodeType":"Identifier","messageId":"unusedVar","endLine":179,"endColumn":25,"suggestions":[{"messageId":"removeVar","data":{"varName":"projectRootId"},"fix":{"range":[9716,9729],"text":""},"desc":"Remove unused variable 'projectRootId'."}]},{"ruleId":"no-unused-vars","severity":2,"message":"'setProjectRootId' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]|^_/u.","line":179,"column":27,"nodeType":"Identifier","messageId":"unusedVar","endLine":179,"endColumn":43,"suggestions":[{"messageId":"removeVar","data":{"varName":"setProjectRootId"},"fix":{"range":[9729,9747],"text":""},"desc":"Remove unused variable 'setProjectRootId'."}]},{"ruleId":"no-unused-vars","severity":2,"message":"'handleFileUpload' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]|^_/u.","line":279,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":279,"endColumn":27,"suggestions":[{"messageId":"removeVar","data":{"varName":"handleFileUpload"},"fix":{"range":[13292,14512],"text":""},"desc":"Remove unused variable 'handleFileUpload'."}]},{"ruleId":"no-unused-vars","severity":2,"message":"'handleAddRecord' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]|^_/u.","line":348,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":348,"endColumn":26,"suggestions":[{"messageId":"removeVar","data":{"varName":"handleAddRecord"},"fix":{"range":[15789,16762],"text":""},"desc":"Remove unused variable 'handleAddRecord'."}]},{"ruleId":"no-unused-vars","severity":2,"message":"'i' is defined but never used. Allowed unused args must match /^_|^e$|^err$|^event$/u.","line":495,"column":44,"nodeType":"Identifier","messageId":"unusedVar","endLine":495,"endColumn":45,"suggestions":[{"messageId":"removeVar","data":{"varName":"i"},"fix":{"range":[22992,22995],"text":""},"desc":"Remove unused variable 'i'."}]},{"ruleId":"no-unused-vars","severity":2,"message":"'i' is defined but never used. Allowed unused args must match /^_|^e$|^err$|^event$/u.","line":573,"column":42,"nodeType":"Identifier","messageId":"unusedVar","endLine":573,"endColumn":43,"suggestions":[{"messageId":"removeVar","data":{"varName":"i"},"fix":{"range":[27598,27601],"text":""},"desc":"Remove unused variable 'i'."}]}],"suppressedMessages":[],"errorCount":13,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\r\nimport React, { useState } from 'react';\r\nimport { WidgetWrapper } from '../components/common/WidgetWrapper';\r\nimport { WidgetProjectStats, WidgetProjectList, WidgetProjectInfo, WidgetProjectFiles } from '../components/widgets/ProjectWidgets';\r\nimport { WidgetProjectVendors } from '../components/widgets/ProjectVendorsWidget';\r\nimport { WidgetProjectInventory } from '../components/widgets/ProjectInventoryWidget';\r\nimport { AddVendorModal } from '../components/project/AddVendorModal';\r\nimport { AddInventoryModal } from '../components/project/AddInventoryModal';\r\nimport { Plus, ChevronLeft, Calendar as CalendarIcon, Upload, ImageIcon, Edit2, Save, X, Trash2, Database } from 'lucide-react';\r\nimport { Modal } from '../components/common/Modal';\r\nimport { InputField } from '../components/common/InputField';\r\nimport { LocationField } from '../components/common/LocationField';\r\nimport { ProgressBar } from '../components/common/Indicators';\r\nimport SearchableSelect from '../components/common/SearchableSelect';\r\nimport { projectsApi } from '../services/api';\r\nimport { GoogleService } from '../services/GoogleService';\r\n\r\n// --- Missing Detail Widgets (Implementing inline for safety) ---\r\nconst WidgetProjectRecords = ({ records, size, onAddRecord }) => (\r\n    <div className=\"flex flex-col h-full\">\r\n        <div className=\"flex justify-between mb-3 items-center\"><h4 className=\"text-xs font-bold text-gray-600\">工程/會議紀錄</h4><button onClick={onAddRecord} className=\"text-morandi-blue-600 hover:bg-morandi-blue-50 p-1.5 rounded-lg transition-colors\"><Plus size={14} /></button></div>\r\n        <div className=\"flex-1 overflow-y-auto space-y-3 pr-1 custom-scrollbar\">\r\n            {records.map(r => (\r\n                <div key={r.id} className=\"bg-gray-50 p-3 rounded-xl border border-gray-100 hover:border-morandi-blue-200 transition-colors\">\r\n                    <div className=\"flex justify-between text-[10px] text-gray-400 mb-1\"><span>{r.date} · {r.type}</span><span>{r.author}</span></div>\r\n                    <div className=\"text-xs text-gray-800 mb-2 leading-relaxed\">{r.content}</div>\r\n                    {r.photos && r.photos.length > 0 && (<div className=\"flex gap-2 overflow-x-auto pb-1\">{r.photos.map((p, idx) => (<div key={idx} className=\"w-10 h-10 bg-gray-200 rounded-lg flex items-center justify-center shrink-0\"><ImageIcon size={14} className=\"text-gray-400\" /></div>))}</div>)}\r\n                </div>\r\n            ))}\r\n        </div>\r\n    </div>\r\n);\r\n\r\nconst WidgetProjectFinanceDetail = ({ transactions, size, onAddTx, onSyncToSheet, project }) => {\r\n    const income = transactions.filter(t => t.type === '收入').reduce((acc, c) => acc + c.amount, 0);\r\n    const expense = transactions.filter(t => t.type === '支出').reduce((acc, c) => acc + c.amount, 0);\r\n    const balance = income - expense;\r\n\r\n    // 按類別分組支出\r\n    const expenseByCategory = transactions\r\n        .filter(t => t.type === '支出')\r\n        .reduce((acc, t) => {\r\n            const cat = t.category || '其他支出';\r\n            acc[cat] = (acc[cat] || 0) + t.amount;\r\n            return acc;\r\n        }, {});\r\n\r\n    const categoryColors = {\r\n        '材料費': 'bg-orange-400',\r\n        '人工費': 'bg-blue-400',\r\n        '設備費': 'bg-purple-400',\r\n        '運輸費': 'bg-yellow-400',\r\n        '其他支出': 'bg-gray-400'\r\n    };\r\n\r\n    return (\r\n        <div className=\"flex flex-col h-full\">\r\n            {/* 收支摘要 */}\r\n            <div className=\"grid grid-cols-3 gap-2 mb-3\">\r\n                <div className=\"bg-green-50 rounded-lg p-2 text-center\">\r\n                    <div className=\"text-xs text-gray-500\">收入</div>\r\n                    <div className=\"text-sm font-bold text-green-600\">${income.toLocaleString()}</div>\r\n                </div>\r\n                <div className=\"bg-red-50 rounded-lg p-2 text-center\">\r\n                    <div className=\"text-xs text-gray-500\">支出</div>\r\n                    <div className=\"text-sm font-bold text-red-600\">${expense.toLocaleString()}</div>\r\n                </div>\r\n                <div className={`${balance >= 0 ? 'bg-blue-50' : 'bg-orange-50'} rounded-lg p-2 text-center`}>\r\n                    <div className=\"text-xs text-gray-500\">淨額</div>\r\n                    <div className={`text-sm font-bold ${balance >= 0 ? 'text-blue-600' : 'text-orange-600'}`}>\r\n                        ${balance.toLocaleString()}\r\n                    </div>\r\n                </div>\r\n            </div>\r\n\r\n            {/* 支出類別分佈 */}\r\n            {expense > 0 && (\r\n                <div className=\"mb-3\">\r\n                    <div className=\"text-xs text-gray-500 mb-1\">支出分佈</div>\r\n                    <div className=\"flex h-2 rounded-full overflow-hidden bg-gray-100\">\r\n                        {Object.entries(expenseByCategory).map(([cat, amount]) => (\r\n                            <div\r\n                                key={cat}\r\n                                className={`${categoryColors[cat] || 'bg-gray-400'}`}\r\n                                style={{ width: `${(amount / expense) * 100}%` }}\r\n                                title={`${cat}: $${amount.toLocaleString()}`}\r\n                            />\r\n                        ))}\r\n                    </div>\r\n                    <div className=\"flex flex-wrap gap-2 mt-1.5\">\r\n                        {Object.entries(expenseByCategory).map(([cat, amount]) => (\r\n                            <span key={cat} className=\"text-[10px] text-gray-500 flex items-center gap-1\">\r\n                                <span className={`w-2 h-2 rounded-full ${categoryColors[cat] || 'bg-gray-400'}`}></span>\r\n                                {cat} ${amount.toLocaleString()}\r\n                            </span>\r\n                        ))}\r\n                    </div>\r\n                </div>\r\n            )}\r\n\r\n            {/* 交易列表 */}\r\n            <div className=\"flex-1 overflow-y-auto space-y-1.5 pr-1 custom-scrollbar mb-2\">\r\n                {transactions.length > 0 ? (\r\n                    transactions.slice(0, 10).map(t => (\r\n                        <div key={t.id} className=\"flex justify-between items-center text-xs bg-gray-50 p-2 rounded-lg hover:bg-gray-100 transition-colors\">\r\n                            <div className=\"flex-1 min-w-0\">\r\n                                <div className=\"font-medium text-gray-800 truncate\">{t.desc || t.category || '無摘要'}</div>\r\n                                <div className=\"text-[10px] text-gray-400\">{t.date} · {t.category || '-'}</div>\r\n                            </div>\r\n                            <span className={`font-bold ml-2 ${t.type === '收入' ? 'text-green-600' : 'text-red-500'}`}>\r\n                                {t.type === '收入' ? '+' : '-'}${t.amount.toLocaleString()}\r\n                            </span>\r\n                        </div>\r\n                    ))\r\n                ) : (\r\n                    <div className=\"text-center text-gray-400 text-xs py-4\">尚無收支記錄</div>\r\n                )}\r\n                {transactions.length > 10 && (\r\n                    <div className=\"text-center text-xs text-gray-400\">...還有 {transactions.length - 10} 筆</div>\r\n                )}\r\n            </div>\r\n\r\n            {/* 操作按鈕 */}\r\n            <div className=\"flex gap-2\">\r\n                <button onClick={onAddTx} className=\"flex-1 py-1.5 text-xs bg-gray-800 text-white rounded-lg hover:bg-gray-700 transition-colors\">\r\n                    新增收支\r\n                </button>\r\n                {project?.folderId && (\r\n                    <button onClick={onSyncToSheet} className=\"py-1.5 px-3 text-xs bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors\" title=\"同步到專案 Sheet\">\r\n                        同步\r\n                    </button>\r\n                )}\r\n            </div>\r\n        </div>\r\n    );\r\n}\r\n\r\nconst Projects = ({ data, loading, addToast, onSelectProject, activeProject, setActiveProject, onUpdateProject, onDeleteProject, allTransactions, onAddGlobalTx, accounts, allVendors, allInventory, allClients }) => {\r\n\r\n    // List View State\r\n    const [listWidgets, setListWidgets] = useState([{ id: 'wp-stats', type: 'project-stats', title: '專案概況', size: 'S' }, { id: 'wp-list', type: 'project-list', title: '專案列表', size: 'L' }]);\r\n\r\n    // Detail View State\r\n    const [detailWidgets, setDetailWidgets] = useState([\r\n        { id: 'wp-info', type: 'info', title: '基本資訊', size: 'S' },\r\n        { id: 'wp-vendors', type: 'vendors', title: '參與廠商', size: 'M' },\r\n        { id: 'wp-records', type: 'records', title: '工程紀錄', size: 'L' },\r\n        { id: 'wp-finance', type: 'finance', title: '專案收支', size: 'M' },\r\n        { id: 'wp-inventory', type: 'inventory', title: '庫存追蹤', size: 'M' },\r\n        { id: 'wp-files', type: 'files', title: '檔案中心', size: 'M' },\r\n    ]);\r\n\r\n    const [isAddModalOpen, setIsAddModalOpen] = useState(false);\r\n    const [newProject, setNewProject] = useState({\r\n        name: \"\",\r\n        client: \"\",\r\n        type: \"翻修\",\r\n        budget: \"\",\r\n        location: \"\",\r\n        startDate: \"\",\r\n        endDate: \"\",\r\n        status: \"設計中\"\r\n    });\r\n\r\n    // Edit & Delete State\r\n    const [isEditing, setIsEditing] = useState(false);\r\n    const [editFormData, setEditFormData] = useState({});\r\n    const [isDeleteModalOpen, setIsDeleteModalOpen] = useState(false);\r\n\r\n    // Vendor & Inventory Modals\r\n    const [isVendorModalOpen, setIsVendorModalOpen] = useState(false);\r\n    const [isInventoryModalOpen, setIsInventoryModalOpen] = useState(false);\r\n    const [isSaving, setIsSaving] = useState(false);\r\n\r\n    // Folder selection state\r\n    const [folderMode, setFolderMode] = useState('auto'); // 'auto' = 自動新增, 'link' = 關聯現有\r\n    const [existingFolderUrl, setExistingFolderUrl] = useState('');\r\n    const [existingFolders, setExistingFolders] = useState([]);\r\n    const [projectRootId, setProjectRootId] = useState(null);\r\n\r\n\r\n    // Detail Modals\r\n    const [isRecordModalOpen, setIsRecordModalOpen] = useState(false);\r\n    const [newRecord, setNewRecord] = useState({ type: '工程', content: '', photos: [] });\r\n\r\n    const handleResize = (widgets, setWidgets) => (id, size) => setWidgets(prev => prev.map(w => w.id === id ? { ...w, size } : w));\r\n\r\n    // Edit Handlers\r\n    const startEdit = () => {\r\n        setEditFormData({ ...activeProject });\r\n        setIsEditing(true);\r\n    };\r\n\r\n    const saveEdit = () => {\r\n        onUpdateProject(editFormData);\r\n        setActiveProject(editFormData);\r\n        setIsEditing(false);\r\n        addToast('專案資訊已更新！', 'success');\r\n    };\r\n\r\n    const cancelEdit = () => {\r\n        setEditFormData({});\r\n        setIsEditing(false);\r\n    };\r\n\r\n    // Add Project Handler with Google Drive Integration\r\n    const handleAddProject = async () => {\r\n        if (!newProject.name || !newProject.client) {\r\n            addToast(\"請填寫專案名稱和客戶\", 'error');\r\n            return;\r\n        }\r\n\r\n        // 如果選擇關聯現有資料夾，需要填寫URL\r\n        if (folderMode === 'link' && !existingFolderUrl) {\r\n            addToast(\"請填寫或選擇現有資料夾\", 'error');\r\n            return;\r\n        }\r\n\r\n        setIsSaving(true);\r\n        try {\r\n            let driveUrl = existingFolderUrl;\r\n\r\n            if (folderMode === 'auto') {\r\n                // Step 1: 獲取或建立「專案管理」根資料夾\r\n                const rootResult = await GoogleService.getOrCreateProjectRoot();\r\n                if (rootResult.success) {\r\n                    // Step 2: 在「專案管理」下建立專案資料夾\r\n                    const folderName = `${newProject.name} - ${newProject.client}`;\r\n                    const driveResult = await GoogleService.createDriveFolder(folderName, rootResult.folderId);\r\n                    if (driveResult.success) {\r\n                        driveUrl = driveResult.url;\r\n                    }\r\n                }\r\n            }\r\n\r\n            const projectData = {\r\n                name: newProject.name,\r\n                clientId: newProject.client, // Will be matched on backend\r\n                type: newProject.type.toUpperCase().replace('翻修', 'RENOVATION').replace('新建', 'NEW_BUILD').replace('設計', 'DESIGN').replace('裝潢', 'INTERIOR'),\r\n                budget: parseFloat(newProject.budget) || 0,\r\n                location: newProject.location,\r\n                address: newProject.location,\r\n                startDate: newProject.startDate || null,\r\n                endDate: newProject.endDate || null,\r\n                status: newProject.status,\r\n                driveFolder: driveUrl,\r\n            };\r\n\r\n            const savedProject = await projectsApi.create(projectData);\r\n            onUpdateProject(savedProject);\r\n\r\n            addToast(`專案「${newProject.name}」已建立！`, 'success', {\r\n                link: driveUrl,\r\n                linkText: '開啟 Drive 資料夾'\r\n            });\r\n\r\n            setIsAddModalOpen(false);\r\n            setFolderMode('auto');\r\n            setExistingFolderUrl('');\r\n            setNewProject({\r\n                name: \"\",\r\n                client: \"\",\r\n                type: \"翻修\",\r\n                budget: \"\",\r\n                location: \"\",\r\n                startDate: \"\",\r\n                endDate: \"\",\r\n                status: \"設計中\"\r\n            });\r\n        } catch (error) {\r\n            console.error('Create project failed:', error);\r\n            addToast(`建立失敗: ${error.message}`, 'error');\r\n        } finally {\r\n            setIsSaving(false);\r\n        }\r\n    };\r\n\r\n    // File Upload Handler - Upload to project's Drive folder\r\n    const handleFileUpload = async (e) => {\r\n        const file = e.target.files[0];\r\n        if (file) {\r\n            if (!activeProject.driveFolder) {\r\n                addToast('此專案沒有 Drive 資料夾', 'error');\r\n                return;\r\n            }\r\n\r\n            addToast('正在上傳檔案...', 'info');\r\n            const res = await GoogleService.uploadToDrive(file, activeProject.name, activeProject.driveFolder);\r\n\r\n            if (res.success) {\r\n                const fileRecord = {\r\n                    id: `file-${Date.now()}`,\r\n                    name: file.name,\r\n                    url: res.url,\r\n                    uploadDate: new Date().toLocaleDateString('zh-TW'),\r\n                    size: file.size\r\n                };\r\n                const updatedProject = { ...activeProject, files: [...(activeProject.files || []), fileRecord] };\r\n                onUpdateProject(updatedProject);\r\n                setActiveProject(updatedProject);\r\n                addToast(`檔案「${file.name}」已上傳至 Drive`, 'success', {\r\n                    link: res.url,\r\n                    linkText: '開啟檔案'\r\n                });\r\n            } else {\r\n                addToast(`檔案上傳失敗: ${res.error}`, 'error');\r\n            }\r\n        }\r\n    };\r\n    // Delete Handler - 只從列表中移除，不刪除 Drive 資料夾\r\n    const handleDeleteProject = () => {\r\n        setIsDeleteModalOpen(true);\r\n    };\r\n\r\n    const confirmDelete = () => {\r\n        // Remove project from data array\r\n        if (onDeleteProject) {\r\n            onDeleteProject(activeProject.id);\r\n        }\r\n        addToast(`專案「${activeProject.name}」已從列表移除（Drive 資料夾保留）`, 'success');\r\n        setIsDeleteModalOpen(false);\r\n        setActiveProject(null);\r\n    };\r\n\r\n    // Vendor Handlers\r\n    const handleAddVendor = (vendorData) => {\r\n        const updatedProject = {\r\n            ...activeProject,\r\n            vendors: [...(activeProject.vendors || []), vendorData]\r\n        };\r\n        onUpdateProject(updatedProject);\r\n        setActiveProject(updatedProject);\r\n        setIsVendorModalOpen(false);\r\n        addToast(`廠商「${vendorData.name}」已加入專案`, 'success');\r\n    };\r\n\r\n    const handleRemoveVendor = (vendorId) => {\r\n        const updatedProject = {\r\n            ...activeProject,\r\n            vendors: activeProject.vendors.filter(v => v.vendorId !== vendorId)\r\n        };\r\n        onUpdateProject(updatedProject);\r\n        setActiveProject(updatedProject);\r\n        addToast('廠商已移除', 'info');\r\n    };\r\n\r\n    // Record Handler - Save records with metadata via API\r\n    const handleAddRecord = async () => {\r\n        const record = {\r\n            ...newRecord,\r\n            id: `r-${Date.now()}`,\r\n            date: new Date().toLocaleDateString('zh-TW'),\r\n            time: new Date().toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit' }),\r\n            author: '使用者A'\r\n        };\r\n\r\n        try {\r\n            const updatedRecords = [record, ...(activeProject.records || [])];\r\n            const updatedProject = await projectsApi.update(activeProject.id, {\r\n                records: updatedRecords\r\n            });\r\n\r\n            onUpdateProject(updatedProject);\r\n            setActiveProject(updatedProject);\r\n\r\n            setNewRecord({ type: '工程', content: '', photos: [] });\r\n            setIsRecordModalOpen(false);\r\n            addToast('工程紀錄已新增', 'success');\r\n        } catch (error) {\r\n            console.error('Add record failed:', error);\r\n            addToast(`新增失敗: ${error.message}`, 'error');\r\n        }\r\n    };\r\n\r\n    // Inventory Handlers\r\n    const handleAddInventory = (inventoryData) => {\r\n        const updatedProject = {\r\n            ...activeProject,\r\n            inventory: [...(activeProject.inventory || []), inventoryData]\r\n        };\r\n        onUpdateProject(updatedProject);\r\n        setActiveProject(updatedProject);\r\n        setIsInventoryModalOpen(false);\r\n        addToast(`已記錄${inventoryData.type === '出' ? '出庫' : '入庫'}：${inventoryData.itemName} x${inventoryData.quantity}`, 'success');\r\n    };\r\n\r\n    // Sync project transactions to Sheet\r\n    const handleSyncProjectFinance = async () => {\r\n        if (!activeProject?.folderId) {\r\n            addToast('此專案沒有 Drive 資料夾', 'error');\r\n            return;\r\n        }\r\n\r\n        const projectTx = allTransactions.filter(t => t.projectId === activeProject.id);\r\n        if (projectTx.length === 0) {\r\n            addToast('尚無收支記錄可同步', 'info');\r\n            return;\r\n        }\r\n\r\n        addToast('正在同步專案收支...', 'info');\r\n        try {\r\n            const result = await GoogleService.syncAllProjectTransactions(\r\n                activeProject.folderId,\r\n                activeProject.name,\r\n                projectTx.map(t => ({\r\n                    date: t.date,\r\n                    type: t.type,\r\n                    category: t.category || '',\r\n                    amount: t.amount,\r\n                    target: '',\r\n                    account: accounts?.find(a => a.id === t.accountId)?.name || '',\r\n                    invoiceNo: '',\r\n                    note: t.desc || ''\r\n                }))\r\n            );\r\n\r\n            if (result.success) {\r\n                addToast(`已同步 ${projectTx.length} 筆收支到專案 Sheet`, 'success', {\r\n                    action: { label: '開啟 Sheet', onClick: () => window.open(result.sheetUrl, '_blank') }\r\n                });\r\n            } else {\r\n                addToast(`同步失敗: ${result.error}`, 'error');\r\n            }\r\n        } catch (error) {\r\n            addToast(`同步失敗: ${error.message}`, 'error');\r\n        }\r\n    };\r\n\r\n    if (activeProject) {\r\n        const projectTx = allTransactions.filter(t => t.projectId === activeProject.id);\r\n\r\n        return (\r\n            <div className=\"space-y-4 sm:space-y-6 animate-fade-in\">\r\n                <button onClick={() => setActiveProject(null)} className=\"flex items-center gap-2 text-sm text-gray-600 hover:text-gray-800 mb-4\">\r\n                    <ChevronLeft size={16} /> 返回列表\r\n                </button>\r\n\r\n                <div className=\"flex items-center justify-between mb-4\">\r\n                    <div className=\"flex items-center gap-4\">\r\n                        <div>\r\n                            {isEditing ? (\r\n                                <input\r\n                                    value={editFormData.name}\r\n                                    onChange={e => setEditFormData({ ...editFormData, name: e.target.value })}\r\n                                    className=\"text-2xl font-bold text-gray-800 bg-yellow-50 border-2 border-yellow-300 rounded px-2 py-1\"\r\n                                />\r\n                            ) : (\r\n                                <h2 className=\"text-2xl font-bold text-gray-800\">{activeProject.name}</h2>\r\n                            )}\r\n                            <div className=\"flex items-center gap-2 text-sm text-gray-500\">\r\n                                <span className=\"font-mono bg-gray-100 px-1.5 rounded\">{activeProject.code}</span>\r\n                                <span>·</span>\r\n                                {isEditing ? (\r\n                                    <select\r\n                                        value={editFormData.status}\r\n                                        onChange={e => setEditFormData({ ...editFormData, status: e.target.value })}\r\n                                        className=\"px-2 py-0.5 rounded-full text-xs border-2 border-blue-300\"\r\n                                    >\r\n                                        <option>設計中</option>\r\n                                        <option>施工中</option>\r\n                                        <option>完工驗收</option>\r\n                                        <option>已完工</option>\r\n                                    </select>\r\n                                ) : (\r\n                                    <span className={`px-2 py-0.5 rounded-full text-xs text-white ${activeProject.status === '施工中' ? 'bg-morandi-orange-500' : 'bg-morandi-blue-500'}`}>{activeProject.status}</span>\r\n                                )}\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n\r\n                    <div className=\"flex items-center gap-2\">\r\n                        {isEditing ? (\r\n                            <>\r\n                                <button onClick={cancelEdit} className=\"px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg flex items-center gap-2 transition-colors\">\r\n                                    <X size={16} /> 取消\r\n                                </button>\r\n                                <button onClick={saveEdit} className=\"px-4 py-2 bg-green-500 hover:bg-green-600 text-white rounded-lg flex items-center gap-2 transition-colors\">\r\n                                    <Save size={16} /> 儲存\r\n                                </button>\r\n                            </>\r\n                        ) : (\r\n                            <>\r\n                                <button onClick={startEdit} className=\"px-4 py-2 bg-blue-50 hover:bg-blue-100 text-blue-600 rounded-lg flex items-center gap-2 transition-colors\">\r\n                                    <Edit2 size={16} /> 編輯\r\n                                </button>\r\n                                <button onClick={handleDeleteProject} className=\"px-4 py-2 bg-red-50 hover:bg-red-100 text-red-600 rounded-lg flex items-center gap-2 transition-colors\">\r\n                                    <Trash2 size={16} /> 刪除\r\n                                </button>\r\n                            </>\r\n                        )}\r\n                    </div>\r\n                </div>\r\n\r\n                <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 auto-rows-auto\">\r\n                    {detailWidgets.map((w, i) => (\r\n                        <WidgetWrapper key={w.id} widget={w} onResize={handleResize(detailWidgets, setDetailWidgets)}>\r\n                            {w.type === 'info' && <WidgetProjectInfo project={activeProject} size={w.size} />}\r\n                            {/* Reuse Widgets */}\r\n                            {w.type === 'files' && <WidgetProjectFiles files={activeProject.files} size={w.size} onUpload={() => { }} />}\r\n                            {w.type === 'records' && <WidgetProjectRecords records={activeProject.records} size={w.size} onAddRecord={() => setIsRecordModalOpen(true)} />}\r\n                            {w.type === 'finance' && <WidgetProjectFinanceDetail\r\n                                transactions={projectTx}\r\n                                size={w.size}\r\n                                onAddTx={() => { }}\r\n                                onSyncToSheet={handleSyncProjectFinance}\r\n                                project={activeProject}\r\n                            />}\r\n                            {w.type === 'vendors' && <WidgetProjectVendors vendors={activeProject.vendors || []} size={w.size} onAddVendor={() => setIsVendorModalOpen(true)} onRemoveVendor={handleRemoveVendor} />}\r\n                            {w.type === 'inventory' && <WidgetProjectInventory inventory={activeProject.inventory || []} size={w.size} onAddRecord={() => setIsInventoryModalOpen(true)} />}\r\n                        </WidgetWrapper>\r\n                    ))}\r\n\r\n                </div>\r\n\r\n                <Modal isOpen={isRecordModalOpen} onClose={() => setIsRecordModalOpen(false)} title=\"新增紀錄\" onConfirm={() => {\r\n                    // Mock Implementation\r\n                    const record = { id: `r-${Date.now()}`, date: new Date().toISOString().split('T')[0], author: 'Alex', ...newRecord };\r\n                    onUpdateProject({ ...activeProject, records: [record, ...(activeProject.records || [])] });\r\n                    setIsRecordModalOpen(false);\r\n                }}>\r\n                    <InputField label=\"內容\" type=\"textarea\" value={newRecord.content} onChange={e => setNewRecord({ ...newRecord, content: e.target.value })} />\r\n                </Modal>\r\n\r\n                <AddVendorModal\r\n                    isOpen={isVendorModalOpen}\r\n                    onClose={() => setIsVendorModalOpen(false)}\r\n                    onConfirm={handleAddVendor}\r\n                    allVendors={allVendors || []}\r\n                />\r\n\r\n                <AddInventoryModal\r\n                    isOpen={isInventoryModalOpen}\r\n                    onClose={() => setIsInventoryModalOpen(false)}\r\n                    onConfirm={handleAddInventory}\r\n                    allInventory={allInventory || []}\r\n                />\r\n\r\n                <Modal\r\n                    isOpen={isDeleteModalOpen}\r\n                    onClose={() => setIsDeleteModalOpen(false)}\r\n                    title=\"從列表移除專案\"\r\n                    onConfirm={confirmDelete}\r\n                    confirmText=\"確定移除\"\r\n                >\r\n                    <div className=\"space-y-4\">\r\n                        <div className=\"bg-yellow-50 border border-yellow-200 rounded-lg p-4\">\r\n                            <p className=\"text-yellow-800 font-medium\">📁 Drive 資料夾將會保留</p>\r\n                        </div>\r\n                        <p className=\"text-gray-700\">\r\n                            您確定要從列表移除專案「<span className=\"font-bold\">{activeProject?.name}</span>」嗎？\r\n                        </p>\r\n                        <p className=\"text-sm text-gray-500\">\r\n                            專案將從系統列表中移除，但 Google Drive 中的資料夾及所有檔案將會保留。\r\n\r\n                        </p>\r\n                    </div>\r\n                </Modal>\r\n            </div>\r\n        );\r\n    }\r\n\r\n    return (\r\n        <>\r\n            {/* Projects List View */}\r\n            <div className=\"space-y-4 sm:space-y-6 animate-fade-in\">\r\n                <div className=\"flex justify-between items-center mb-4\">\r\n                    <h2 className=\"text-2xl sm:text-3xl font-bold text-morandi-text-primary\">專案管理</h2>\r\n                    <button onClick={() => setIsAddModalOpen(true)} className=\"flex items-center gap-2 px-3 sm:px-4 py-2 bg-morandi-text-accent text-white rounded-xl hover:bg-gray-800 transition-colors shadow-lg\">\r\n                        <Plus size={16} /> <span className=\"hidden sm:inline\">新增專案</span><span className=\"sm:hidden\">新增</span>\r\n                    </button>\r\n                </div>\r\n                <div className=\"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 sm:gap-6 auto-rows-auto\">\r\n                    {listWidgets.map((w, i) => (\r\n                        <WidgetWrapper key={w.id} widget={w} onResize={handleResize(listWidgets, setListWidgets)}>\r\n                            {w.type === 'project-stats' && <WidgetProjectStats data={data} size={w.size} />}\r\n                            {w.type === 'project-list' && <WidgetProjectList data={data} size={w.size} onSelectProject={setActiveProject} onAdd={() => setIsAddModalOpen(true)} />}\r\n                        </WidgetWrapper>\r\n                    ))}\r\n                </div>\r\n            </div>\r\n            <Modal\r\n                isOpen={isAddModalOpen}\r\n                onClose={() => setIsAddModalOpen(false)}\r\n                title=\"建立新專案\"\r\n                onConfirm={handleAddProject}\r\n                confirmDisabled={isSaving}\r\n                confirmText={isSaving ? '處理中...' : '確認'}\r\n            >\r\n                <div className=\"grid grid-cols-1 sm:grid-cols-2 gap-4\">\r\n                    <InputField label=\"專案名稱\" value={newProject.name} onChange={e => setNewProject({ ...newProject, name: e.target.value })} placeholder=\"例：信義區住宅翻修\" />\r\n                    <SearchableSelect\r\n                        label=\"客戶\"\r\n                        value={newProject.client}\r\n                        onChange={(clientId) => setNewProject({ ...newProject, client: clientId })}\r\n                        options={allClients || []}\r\n                        placeholder=\"請選擇客戶...\"\r\n                        searchPlaceholder=\"搜尋客戶名稱或編號...\"\r\n                        required\r\n                    />\r\n                </div>\r\n                <div className=\"grid grid-cols-1 sm:grid-cols-2 gap-4\">\r\n                    <InputField label=\"專案類型\" type=\"select\" value={newProject.type} onChange={e => setNewProject({ ...newProject, type: e.target.value })}>\r\n                        <option value=\"翻修\">翻修</option>\r\n                        <option value=\"新建\">新建</option>\r\n                        <option value=\"設計\">設計</option>\r\n                        <option value=\"裝潢\">裝潢</option>\r\n                    </InputField>\r\n                    <InputField label=\"預算\" type=\"number\" value={newProject.budget} onChange={e => setNewProject({ ...newProject, budget: e.target.value })} placeholder=\"例：500000\" />\r\n                </div>\r\n                <LocationField label=\"專案地點\" value={newProject.location || ''} onChange={e => setNewProject({ ...newProject, location: e.target.value })} placeholder=\"例：台北市信義區松智路1號\" />\r\n                <div className=\"grid grid-cols-1 sm:grid-cols-2 gap-4\">\r\n                    <InputField label=\"開始日期\" type=\"date\" value={newProject.startDate} onChange={e => setNewProject({ ...newProject, startDate: e.target.value })} />\r\n                    <InputField label=\"預計完工\" type=\"date\" value={newProject.endDate} onChange={e => setNewProject({ ...newProject, endDate: e.target.value })} />\r\n                </div>\r\n\r\n                {/* Drive 資料夾設定 */}\r\n                <div className=\"border-t pt-4 mt-4\">\r\n                    <label className=\"block text-sm font-medium text-gray-700 mb-3\">Drive 資料夾設定</label>\r\n                    <div className=\"flex gap-4 mb-3\">\r\n                        <label className=\"flex items-center gap-2 cursor-pointer\">\r\n                            <input\r\n                                type=\"radio\"\r\n                                name=\"folderMode\"\r\n                                value=\"auto\"\r\n                                checked={folderMode === 'auto'}\r\n                                onChange={() => setFolderMode('auto')}\r\n                                className=\"w-4 h-4 text-blue-600\"\r\n                            />\r\n                            <span className=\"text-sm\">自動建立新資料夾</span>\r\n                        </label>\r\n                        <label className=\"flex items-center gap-2 cursor-pointer\">\r\n                            <input\r\n                                type=\"radio\"\r\n                                name=\"folderMode\"\r\n                                value=\"link\"\r\n                                checked={folderMode === 'link'}\r\n                                onChange={() => setFolderMode('link')}\r\n                                className=\"w-4 h-4 text-blue-600\"\r\n                            />\r\n                            <span className=\"text-sm\">關聯現有資料夾</span>\r\n                        </label>\r\n                    </div>\r\n\r\n                    {folderMode === 'auto' && (\r\n                        <p className=\"text-xs text-gray-500 bg-gray-50 p-2 rounded\">\r\n                            將在「專案管理」資料夾下自動建立：<strong>{newProject.name || '[專案名稱]'} - {newProject.client || '[客戶]'}</strong>\r\n                        </p>\r\n                    )}\r\n\r\n                    {folderMode === 'link' && (\r\n                        <InputField\r\n                            label=\"現有資料夾連結\"\r\n                            value={existingFolderUrl}\r\n                            onChange={e => setExistingFolderUrl(e.target.value)}\r\n                            placeholder=\"貼上 Google Drive 資料夾連結，例：https://drive.google.com/drive/folders/xxxxx\"\r\n                        />\r\n                    )}\r\n                </div>\r\n            </Modal>\r\n        </>\r\n    );\r\n};\r\nexport default Projects;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\xiang\\senteng-frontend\\src\\pages\\QuotationEditor.jsx","messages":[{"ruleId":"no-unused-vars","severity":2,"message":"'useRef' is defined but never used. Allowed unused vars must match /^[A-Z_]|^_/u.","line":7,"column":60,"nodeType":"Identifier","messageId":"unusedVar","endLine":7,"endColumn":66,"suggestions":[{"messageId":"removeVar","data":{"varName":"useRef"},"fix":{"range":[135,143],"text":""},"desc":"Remove unused variable 'useRef'."}]},{"ruleId":"no-unused-vars","severity":2,"message":"'index' is defined but never used. Allowed unused args must match /^_|^e$|^err$|^event$/u.","line":37,"column":5,"nodeType":"Identifier","messageId":"unusedVar","endLine":37,"endColumn":10,"suggestions":[{"messageId":"removeVar","data":{"varName":"index"},"fix":{"range":[1155,1167],"text":""},"desc":"Remove unused variable 'index'."}]},{"ruleId":"no-unused-vars","severity":2,"message":"'levelColors' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]|^_/u.","line":68,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":68,"endColumn":22,"suggestions":[{"messageId":"removeVar","data":{"varName":"levelColors"},"fix":{"range":[2059,2212],"text":""},"desc":"Remove unused variable 'levelColors'."}]},{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\n  237 |             return matchSearch && matchCategory;\n  238 |         });\n> 239 |         setResults(filtered);\n      |         ^^^^^^^^^^ Avoid calling setState() directly within an effect\n  240 |     }, [searchTerm, selectedCategory]);\n  241 |\n  242 |     if (!isOpen) return null;","line":239,"column":9,"nodeType":null,"endLine":239,"endColumn":19},{"ruleId":"no-unused-vars","severity":2,"message":"'totals' is defined but never used. Allowed unused args must match /^_|^e$|^err$|^event$/u.","line":308,"column":46,"nodeType":"Identifier","messageId":"unusedVar","endLine":308,"endColumn":52,"suggestions":[{"messageId":"removeVar","data":{"varName":"totals"},"fix":{"range":[13675,13683],"text":""},"desc":"Remove unused variable 'totals'."}]},{"ruleId":"no-unused-vars","severity":2,"message":"'setIsEditing' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]|^_/u.","line":454,"column":23,"nodeType":"Identifier","messageId":"unusedVar","endLine":454,"endColumn":35,"suggestions":[{"messageId":"removeVar","data":{"varName":"setIsEditing"},"fix":{"range":[21060,21074],"text":""},"desc":"Remove unused variable 'setIsEditing'."}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'addToast'. Either include it or remove the dependency array. If 'addToast' changes too often, find the parent component that defines it and wrap that definition in useCallback.","line":498,"column":8,"nodeType":"ArrayExpression","endLine":498,"endColumn":21,"suggestions":[{"desc":"Update the dependencies array to be: [addToast, quotationId]","fix":{"range":[22821,22834],"text":"[addToast, quotationId]"}}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useCallback has a missing dependency: 'addToast'. Either include it or remove the dependency array. If 'addToast' changes too often, find the parent component that defines it and wrap that definition in useCallback.","line":618,"column":8,"nodeType":"ArrayExpression","endLine":618,"endColumn":15,"suggestions":[{"desc":"Update the dependencies array to be: [addToast, items]","fix":{"range":[27057,27064],"text":"[addToast, items]"}}]},{"ruleId":"no-unused-vars","severity":2,"message":"'index' is defined but never used. Allowed unused args must match /^_|^e$|^err$|^event$/u.","line":644,"column":33,"nodeType":"Identifier","messageId":"unusedVar","endLine":644,"endColumn":38,"suggestions":[{"messageId":"removeVar","data":{"varName":"index"},"fix":{"range":[27753,27760],"text":""},"desc":"Remove unused variable 'index'."}]}],"suppressedMessages":[],"errorCount":7,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * 估價單編輯器 - 工項編輯器組件\r\n * QuotationEditor.jsx\r\n * 提供類 Excel 表格編輯體驗\r\n */\r\n\r\nimport React, { useState, useEffect, useCallback, useMemo, useRef } from 'react';\r\nimport {\r\n    FileText, Save, ArrowLeft, Plus, Trash2, Copy, Search, Upload,\r\n    Download, Settings2, ChevronDown, ChevronUp, GripVertical,\r\n    MoreVertical, Calculator, Eye, Send, Check, X, Info, AlertCircle,\r\n    Layers, Package, Percent, FileSpreadsheet, RotateCcw, FilePlus2\r\n} from 'lucide-react';\r\nimport { SectionTitle } from '../components/common/Indicators';\r\nimport { QuotationPdfButton } from '../components/quotation/QuotationPdfExport';\r\nimport ChangeOrders from './ChangeOrders';\r\nimport QuotationService, {\r\n    QUOTATION_STATUS,\r\n    QUOTATION_STATUS_LABELS,\r\n    QUOTATION_STATUS_COLORS,\r\n    ITEM_TYPES,\r\n    SUPPLY_TYPES,\r\n    TAX_TYPES,\r\n    DEFAULT_SETTINGS,\r\n    CATALOG_CATEGORIES,\r\n    DEFAULT_CATALOG_ITEMS,\r\n    calculateLineAmount,\r\n    calculateQuotationTotals,\r\n    generateItemCode,\r\n} from '../services/QuotationService';\r\n\r\n// ============================================\r\n// 工項列元件\r\n// ============================================\r\nconst ItemRow = ({\r\n    item,\r\n    index,\r\n    level = 0,\r\n    isEditing,\r\n    onUpdate,\r\n    onDelete,\r\n    onAddChild,\r\n    onDuplicate,\r\n    isSelected,\r\n    onSelect,\r\n}) => {\r\n    const [isExpanded, setIsExpanded] = useState(true);\r\n    const hasChildren = item.type === ITEM_TYPES.CHAPTER || item.type === ITEM_TYPES.SECTION;\r\n\r\n    const handleChange = (field, value) => {\r\n        const updates = { [field]: value };\r\n\r\n        // 自動計算複價\r\n        if (field === 'quantity' || field === 'unitPrice') {\r\n            const qty = field === 'quantity' ? value : item.quantity;\r\n            const price = field === 'unitPrice' ? value : item.unitPrice;\r\n            updates.amount = calculateLineAmount(qty, price);\r\n        }\r\n\r\n        onUpdate(item.id, updates);\r\n    };\r\n\r\n    const formatNumber = (num) => {\r\n        if (!num && num !== 0) return '';\r\n        return new Intl.NumberFormat('zh-TW').format(num);\r\n    };\r\n\r\n    const levelColors = [\r\n        'bg-gray-800 text-white', // Chapter\r\n        'bg-gray-100 text-gray-800', // Section\r\n        'bg-white', // Item\r\n    ];\r\n\r\n    const isChapter = item.type === ITEM_TYPES.CHAPTER;\r\n    const isSection = item.type === ITEM_TYPES.SECTION;\r\n    const isItem = item.type === ITEM_TYPES.ITEM;\r\n\r\n    return (\r\n        <tr\r\n            className={`\r\n                group border-b border-gray-100 transition-all\r\n                ${isChapter ? 'bg-gray-800 text-white font-semibold' : ''}\r\n                ${isSection ? 'bg-gray-100 font-medium' : ''}\r\n                ${isItem ? 'hover:bg-orange-50/50' : ''}\r\n                ${isSelected ? 'bg-orange-100' : ''}\r\n            `}\r\n            onClick={() => onSelect?.(item.id)}\r\n        >\r\n            {/* 項次 */}\r\n            <td className={`px-2 py-2 text-center text-sm w-20 ${isChapter ? 'text-white' : 'text-gray-600'}`}>\r\n                <div className=\"flex items-center gap-1\">\r\n                    <GripVertical size={14} className=\"opacity-30 cursor-grab\" />\r\n                    <span>{item.itemCode}</span>\r\n                </div>\r\n            </td>\r\n\r\n            {/* 名稱 */}\r\n            <td className={`px-2 py-2 ${isChapter ? '' : ''}`} style={{ paddingLeft: `${level * 16 + 8}px` }}>\r\n                <div className=\"flex items-center gap-2\">\r\n                    {hasChildren && (\r\n                        <button\r\n                            onClick={(e) => { e.stopPropagation(); setIsExpanded(!isExpanded); }}\r\n                            className={`p-0.5 rounded ${isChapter ? 'hover:bg-white/20' : 'hover:bg-gray-200'}`}\r\n                        >\r\n                            {isExpanded ? <ChevronDown size={14} /> : <ChevronUp size={14} />}\r\n                        </button>\r\n                    )}\r\n                    {isEditing ? (\r\n                        <input\r\n                            type=\"text\"\r\n                            value={item.name || ''}\r\n                            onChange={(e) => handleChange('name', e.target.value)}\r\n                            className={`flex-1 px-2 py-1 rounded border text-sm ${isChapter ? 'bg-gray-700 border-gray-600 text-white' : 'border-gray-200'}`}\r\n                            onClick={(e) => e.stopPropagation()}\r\n                        />\r\n                    ) : (\r\n                        <span className=\"flex-1 text-sm\">{item.name}</span>\r\n                    )}\r\n                </div>\r\n            </td>\r\n\r\n            {/* 規格 (只有明細項顯示) */}\r\n            <td className={`px-2 py-2 text-sm ${isChapter || isSection ? 'opacity-30' : ''}`}>\r\n                {isItem && (isEditing ? (\r\n                    <input\r\n                        type=\"text\"\r\n                        value={item.specification || ''}\r\n                        onChange={(e) => handleChange('specification', e.target.value)}\r\n                        className=\"w-full px-2 py-1 rounded border border-gray-200 text-sm\"\r\n                        placeholder=\"規格說明\"\r\n                        onClick={(e) => e.stopPropagation()}\r\n                    />\r\n                ) : (\r\n                    <span className=\"text-gray-500\">{item.specification}</span>\r\n                ))}\r\n            </td>\r\n\r\n            {/* 單位 */}\r\n            <td className={`px-2 py-2 text-center text-sm w-16 ${isChapter || isSection ? 'opacity-30' : ''}`}>\r\n                {isItem && (isEditing ? (\r\n                    <input\r\n                        type=\"text\"\r\n                        value={item.unit || ''}\r\n                        onChange={(e) => handleChange('unit', e.target.value)}\r\n                        className=\"w-full px-1 py-1 rounded border border-gray-200 text-sm text-center\"\r\n                        placeholder=\"式\"\r\n                        onClick={(e) => e.stopPropagation()}\r\n                    />\r\n                ) : (\r\n                    <span>{item.unit}</span>\r\n                ))}\r\n            </td>\r\n\r\n            {/* 數量 */}\r\n            <td className={`px-2 py-2 text-right text-sm w-20 ${isChapter || isSection ? 'opacity-30' : ''}`}>\r\n                {isItem && (isEditing ? (\r\n                    <input\r\n                        type=\"number\"\r\n                        value={item.quantity || ''}\r\n                        onChange={(e) => handleChange('quantity', parseFloat(e.target.value) || 0)}\r\n                        className=\"w-full px-1 py-1 rounded border border-gray-200 text-sm text-right\"\r\n                        min=\"0\"\r\n                        step=\"0.01\"\r\n                        onClick={(e) => e.stopPropagation()}\r\n                    />\r\n                ) : (\r\n                    <span>{formatNumber(item.quantity)}</span>\r\n                ))}\r\n            </td>\r\n\r\n            {/* 單價 */}\r\n            <td className={`px-2 py-2 text-right text-sm w-24 ${isChapter || isSection ? 'opacity-30' : ''}`}>\r\n                {isItem && (isEditing ? (\r\n                    <input\r\n                        type=\"number\"\r\n                        value={item.unitPrice || ''}\r\n                        onChange={(e) => handleChange('unitPrice', parseFloat(e.target.value) || 0)}\r\n                        className=\"w-full px-1 py-1 rounded border border-gray-200 text-sm text-right\"\r\n                        min=\"0\"\r\n                        onClick={(e) => e.stopPropagation()}\r\n                    />\r\n                ) : (\r\n                    <span>{formatNumber(item.unitPrice)}</span>\r\n                ))}\r\n            </td>\r\n\r\n            {/* 複價 */}\r\n            <td className={`px-2 py-2 text-right text-sm w-28 font-medium ${isChapter ? 'text-white' : 'text-orange-600'}`}>\r\n                {formatNumber(item.amount || calculateLineAmount(item.quantity, item.unitPrice))}\r\n            </td>\r\n\r\n            {/* 操作 */}\r\n            <td className=\"px-2 py-2 w-24\">\r\n                <div className=\"flex items-center justify-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity\">\r\n                    {hasChildren && (\r\n                        <button\r\n                            onClick={(e) => { e.stopPropagation(); onAddChild?.(item.id); }}\r\n                            className={`p-1 rounded ${isChapter ? 'hover:bg-white/20 text-white' : 'hover:bg-gray-100 text-gray-500'}`}\r\n                            title=\"新增子項\"\r\n                        >\r\n                            <Plus size={14} />\r\n                        </button>\r\n                    )}\r\n                    <button\r\n                        onClick={(e) => { e.stopPropagation(); onDuplicate?.(item.id); }}\r\n                        className={`p-1 rounded ${isChapter ? 'hover:bg-white/20 text-white' : 'hover:bg-gray-100 text-gray-500'}`}\r\n                        title=\"複製\"\r\n                    >\r\n                        <Copy size={14} />\r\n                    </button>\r\n                    <button\r\n                        onClick={(e) => { e.stopPropagation(); onDelete?.(item.id); }}\r\n                        className={`p-1 rounded ${isChapter ? 'hover:bg-red-500/50 text-white' : 'hover:bg-red-100 text-red-500'}`}\r\n                        title=\"刪除\"\r\n                    >\r\n                        <Trash2 size={14} />\r\n                    </button>\r\n                </div>\r\n            </td>\r\n        </tr>\r\n    );\r\n};\r\n\r\n// ============================================\r\n// 工項庫搜尋 Modal\r\n// ============================================\r\nconst CatalogSearchModal = ({ isOpen, onClose, onSelect }) => {\r\n    const [searchTerm, setSearchTerm] = useState('');\r\n    const [selectedCategory, setSelectedCategory] = useState('');\r\n    const [results, setResults] = useState(DEFAULT_CATALOG_ITEMS);\r\n\r\n    useEffect(() => {\r\n        const filtered = DEFAULT_CATALOG_ITEMS.filter(item => {\r\n            const matchSearch = !searchTerm ||\r\n                item.name.toLowerCase().includes(searchTerm.toLowerCase());\r\n            const matchCategory = !selectedCategory || item.category === selectedCategory;\r\n            return matchSearch && matchCategory;\r\n        });\r\n        setResults(filtered);\r\n    }, [searchTerm, selectedCategory]);\r\n\r\n    if (!isOpen) return null;\r\n\r\n    return (\r\n        <div className=\"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4\">\r\n            <div className=\"bg-white rounded-2xl shadow-xl max-w-2xl w-full max-h-[80vh] flex flex-col\">\r\n                <div className=\"p-4 border-b border-gray-100 flex items-center justify-between\">\r\n                    <h3 className=\"font-semibold text-gray-800\">從工項庫選擇</h3>\r\n                    <button onClick={onClose} className=\"p-1 hover:bg-gray-100 rounded-lg\">\r\n                        <X size={20} />\r\n                    </button>\r\n                </div>\r\n\r\n                <div className=\"p-4 space-y-3 border-b border-gray-100\">\r\n                    <div className=\"flex gap-3\">\r\n                        <div className=\"relative flex-1\">\r\n                            <Search size={18} className=\"absolute left-3 top-1/2 -translate-y-1/2 text-gray-400\" />\r\n                            <input\r\n                                type=\"text\"\r\n                                value={searchTerm}\r\n                                onChange={(e) => setSearchTerm(e.target.value)}\r\n                                placeholder=\"搜尋工項...\"\r\n                                className=\"w-full pl-10 pr-4 py-2 border border-gray-200 rounded-lg\"\r\n                            />\r\n                        </div>\r\n                        <select\r\n                            value={selectedCategory}\r\n                            onChange={(e) => setSelectedCategory(e.target.value)}\r\n                            className=\"px-3 py-2 border border-gray-200 rounded-lg bg-white\"\r\n                        >\r\n                            <option value=\"\">全部分類</option>\r\n                            {CATALOG_CATEGORIES.map(cat => (\r\n                                <option key={cat.id} value={cat.id}>{cat.icon} {cat.name}</option>\r\n                            ))}\r\n                        </select>\r\n                    </div>\r\n                </div>\r\n\r\n                <div className=\"flex-1 overflow-y-auto p-2\">\r\n                    <div className=\"space-y-1\">\r\n                        {results.map(item => {\r\n                            const category = CATALOG_CATEGORIES.find(c => c.id === item.category);\r\n                            return (\r\n                                <button\r\n                                    key={item.id}\r\n                                    onClick={() => { onSelect(item); onClose(); }}\r\n                                    className=\"w-full flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-orange-50 transition-colors text-left\"\r\n                                >\r\n                                    <span className=\"text-lg\">{category?.icon || '📦'}</span>\r\n                                    <div className=\"flex-1\">\r\n                                        <div className=\"font-medium text-gray-800\">{item.name}</div>\r\n                                        <div className=\"text-xs text-gray-500\">{item.unit} · 參考價 ${item.refPrice.toLocaleString()}</div>\r\n                                    </div>\r\n                                    <Plus size={16} className=\"text-orange-500\" />\r\n                                </button>\r\n                            );\r\n                        })}\r\n                    </div>\r\n                </div>\r\n            </div>\r\n        </div>\r\n    );\r\n};\r\n\r\n// ============================================\r\n// 費用設定面板\r\n// ============================================\r\nconst SettingsPanel = ({ settings, onChange, totals }) => {\r\n    const [isExpanded, setIsExpanded] = useState(false);\r\n\r\n    return (\r\n        <div className=\"bg-white rounded-xl border border-gray-100 overflow-hidden\">\r\n            <button\r\n                onClick={() => setIsExpanded(!isExpanded)}\r\n                className=\"w-full flex items-center justify-between px-4 py-3 hover:bg-gray-50 transition-colors\"\r\n            >\r\n                <div className=\"flex items-center gap-2\">\r\n                    <Settings2 size={18} className=\"text-gray-500\" />\r\n                    <span className=\"font-medium text-gray-700\">費用設定</span>\r\n                </div>\r\n                {isExpanded ? <ChevronUp size={18} /> : <ChevronDown size={18} />}\r\n            </button>\r\n\r\n            {isExpanded && (\r\n                <div className=\"p-4 pt-0 space-y-3 border-t border-gray-100\">\r\n                    <div className=\"grid grid-cols-2 sm:grid-cols-4 gap-3\">\r\n                        <div>\r\n                            <label className=\"block text-xs text-gray-500 mb-1\">折扣金額</label>\r\n                            <input\r\n                                type=\"number\"\r\n                                value={settings.discountAmount || 0}\r\n                                onChange={(e) => onChange({ ...settings, discountAmount: parseFloat(e.target.value) || 0 })}\r\n                                className=\"w-full px-3 py-2 border border-gray-200 rounded-lg text-sm\"\r\n                                min=\"0\"\r\n                            />\r\n                        </div>\r\n                        <div>\r\n                            <label className=\"block text-xs text-gray-500 mb-1\">管理費 (%)</label>\r\n                            <input\r\n                                type=\"number\"\r\n                                value={settings.managementFeeRate || DEFAULT_SETTINGS.managementFee}\r\n                                onChange={(e) => onChange({ ...settings, managementFeeRate: parseFloat(e.target.value) || 0 })}\r\n                                className=\"w-full px-3 py-2 border border-gray-200 rounded-lg text-sm\"\r\n                                min=\"0\"\r\n                                max=\"100\"\r\n                            />\r\n                        </div>\r\n                        <div>\r\n                            <label className=\"block text-xs text-gray-500 mb-1\">利潤率 (%)</label>\r\n                            <input\r\n                                type=\"number\"\r\n                                value={settings.profitRate || DEFAULT_SETTINGS.profitRate}\r\n                                onChange={(e) => onChange({ ...settings, profitRate: parseFloat(e.target.value) || 0 })}\r\n                                className=\"w-full px-3 py-2 border border-gray-200 rounded-lg text-sm\"\r\n                                min=\"0\"\r\n                                max=\"100\"\r\n                            />\r\n                        </div>\r\n                        <div>\r\n                            <label className=\"block text-xs text-gray-500 mb-1\">稅率 (%)</label>\r\n                            <input\r\n                                type=\"number\"\r\n                                value={settings.taxRate || DEFAULT_SETTINGS.taxRate}\r\n                                onChange={(e) => onChange({ ...settings, taxRate: parseFloat(e.target.value) || 0 })}\r\n                                className=\"w-full px-3 py-2 border border-gray-200 rounded-lg text-sm\"\r\n                                min=\"0\"\r\n                                max=\"100\"\r\n                            />\r\n                        </div>\r\n                    </div>\r\n                    <div className=\"flex items-center gap-4\">\r\n                        <label className=\"flex items-center gap-2 text-sm text-gray-600\">\r\n                            <input\r\n                                type=\"radio\"\r\n                                name=\"taxType\"\r\n                                checked={settings.taxType === TAX_TYPES.INCLUSIVE}\r\n                                onChange={() => onChange({ ...settings, taxType: TAX_TYPES.INCLUSIVE })}\r\n                                className=\"text-orange-500\"\r\n                            />\r\n                            含稅價\r\n                        </label>\r\n                        <label className=\"flex items-center gap-2 text-sm text-gray-600\">\r\n                            <input\r\n                                type=\"radio\"\r\n                                name=\"taxType\"\r\n                                checked={settings.taxType === TAX_TYPES.EXCLUSIVE}\r\n                                onChange={() => onChange({ ...settings, taxType: TAX_TYPES.EXCLUSIVE })}\r\n                                className=\"text-orange-500\"\r\n                            />\r\n                            未稅價\r\n                        </label>\r\n                    </div>\r\n                </div>\r\n            )}\r\n        </div>\r\n    );\r\n};\r\n\r\n// ============================================\r\n// 金額摘要\r\n// ============================================\r\nconst TotalsSummary = ({ totals }) => {\r\n    const formatCurrency = (amount) => {\r\n        return new Intl.NumberFormat('zh-TW', {\r\n            style: 'currency',\r\n            currency: 'TWD',\r\n            minimumFractionDigits: 0,\r\n        }).format(amount || 0);\r\n    };\r\n\r\n    return (\r\n        <div className=\"bg-gradient-to-br from-gray-800 to-gray-700 rounded-xl p-4 text-white\">\r\n            <div className=\"grid grid-cols-2 sm:grid-cols-4 gap-4 text-sm mb-3\">\r\n                <div>\r\n                    <div className=\"text-gray-400 text-xs mb-1\">工項小計</div>\r\n                    <div className=\"font-medium\">{formatCurrency(totals.subtotal)}</div>\r\n                </div>\r\n                <div>\r\n                    <div className=\"text-gray-400 text-xs mb-1\">管理費</div>\r\n                    <div className=\"font-medium\">{formatCurrency(totals.managementFee)}</div>\r\n                </div>\r\n                <div>\r\n                    <div className=\"text-gray-400 text-xs mb-1\">利潤</div>\r\n                    <div className=\"font-medium\">{formatCurrency(totals.profitAmount)}</div>\r\n                </div>\r\n                <div>\r\n                    <div className=\"text-gray-400 text-xs mb-1\">稅額</div>\r\n                    <div className=\"font-medium\">{formatCurrency(totals.taxAmount)}</div>\r\n                </div>\r\n            </div>\r\n            <div className=\"flex items-center justify-between pt-3 border-t border-white/20\">\r\n                <div className=\"flex items-center gap-3\">\r\n                    <span className=\"text-gray-300\">報價總計</span>\r\n                    {totals.discountAmount > 0 && (\r\n                        <span className=\"text-xs text-orange-400\">已折 {formatCurrency(totals.discountAmount)}</span>\r\n                    )}\r\n                </div>\r\n                <div className=\"text-2xl font-bold text-orange-400\">\r\n                    {formatCurrency(totals.totalAmount)}\r\n                </div>\r\n            </div>\r\n        </div>\r\n    );\r\n};\r\n\r\n// ============================================\r\n// 主編輯器組件\r\n// ============================================\r\nconst QuotationEditor = ({ quotationId, onBack, addToast }) => {\r\n    const [quotation, setQuotation] = useState(null);\r\n    const [items, setItems] = useState([]);\r\n    const [loading, setLoading] = useState(true);\r\n    const [saving, setSaving] = useState(false);\r\n    const [isEditing, setIsEditing] = useState(true);\r\n    const [selectedItemId, setSelectedItemId] = useState(null);\r\n    const [showCatalog, setShowCatalog] = useState(false);\r\n    const [showChangeOrders, setShowChangeOrders] = useState(false);\r\n    const [settings, setSettings] = useState({\r\n        discountAmount: 0,\r\n        managementFeeRate: DEFAULT_SETTINGS.managementFee,\r\n        profitRate: DEFAULT_SETTINGS.profitRate,\r\n        taxRate: DEFAULT_SETTINGS.taxRate,\r\n        taxType: TAX_TYPES.INCLUSIVE,\r\n    });\r\n    const [hasChanges, setHasChanges] = useState(false);\r\n\r\n    // 載入估價單\r\n    useEffect(() => {\r\n        const loadQuotation = async () => {\r\n            if (!quotationId) {\r\n                setLoading(false);\r\n                return;\r\n            }\r\n\r\n            setLoading(true);\r\n            try {\r\n                const data = await QuotationService.getQuotation(quotationId);\r\n                if (data) {\r\n                    setQuotation(data);\r\n                    setItems(data.items || []);\r\n                    setSettings({\r\n                        discountAmount: data.discountAmount || 0,\r\n                        managementFeeRate: data.managementFeeRate || DEFAULT_SETTINGS.managementFee,\r\n                        profitRate: data.profitRate || DEFAULT_SETTINGS.profitRate,\r\n                        taxRate: data.taxRate || DEFAULT_SETTINGS.taxRate,\r\n                        taxType: data.taxType || TAX_TYPES.INCLUSIVE,\r\n                    });\r\n                }\r\n            } catch (error) {\r\n                console.error('Failed to load quotation:', error);\r\n                addToast?.('載入估價單失敗', 'error');\r\n            } finally {\r\n                setLoading(false);\r\n            }\r\n        };\r\n\r\n        loadQuotation();\r\n    }, [quotationId]);\r\n\r\n    // 計算總金額\r\n    const totals = useMemo(() => {\r\n        return calculateQuotationTotals(items, settings);\r\n    }, [items, settings]);\r\n\r\n    // 更新工項\r\n    const handleUpdateItem = useCallback((itemId, updates) => {\r\n        setItems(prev => prev.map(item =>\r\n            item.id === itemId ? { ...item, ...updates } : item\r\n        ));\r\n        setHasChanges(true);\r\n    }, []);\r\n\r\n    // 刪除工項\r\n    const handleDeleteItem = useCallback((itemId) => {\r\n        setItems(prev => prev.filter(item => item.id !== itemId && item.parentId !== itemId));\r\n        setHasChanges(true);\r\n    }, []);\r\n\r\n    // 複製工項\r\n    const handleDuplicateItem = useCallback((itemId) => {\r\n        const item = items.find(i => i.id === itemId);\r\n        if (!item) return;\r\n\r\n        const newItem = {\r\n            ...item,\r\n            id: `item-${Date.now()}`,\r\n            name: `${item.name} (複製)`,\r\n        };\r\n\r\n        const index = items.findIndex(i => i.id === itemId);\r\n        const newItems = [...items];\r\n        newItems.splice(index + 1, 0, newItem);\r\n        setItems(newItems);\r\n        setHasChanges(true);\r\n    }, [items]);\r\n\r\n    // 新增章節\r\n    const handleAddChapter = useCallback(() => {\r\n        const chapterCount = items.filter(i => i.type === ITEM_TYPES.CHAPTER).length;\r\n        const newChapter = {\r\n            id: `item-${Date.now()}`,\r\n            parentId: null,\r\n            itemCode: `${chapterCount + 1}`,\r\n            type: ITEM_TYPES.CHAPTER,\r\n            name: `第${['一', '二', '三', '四', '五', '六', '七', '八', '九', '十'][chapterCount] || chapterCount + 1}章`,\r\n            unit: '',\r\n            quantity: 0,\r\n            unitPrice: 0,\r\n            amount: 0,\r\n            sortOrder: items.length,\r\n        };\r\n        setItems(prev => [...prev, newChapter]);\r\n        setHasChanges(true);\r\n    }, [items]);\r\n\r\n    // 新增工項\r\n    const handleAddItem = useCallback((parentId = null) => {\r\n        // 找到父項\r\n        const parent = parentId ? items.find(i => i.id === parentId) : null;\r\n        const siblings = items.filter(i => i.parentId === parentId);\r\n\r\n        const newItem = {\r\n            id: `item-${Date.now()}`,\r\n            parentId,\r\n            itemCode: generateItemCode(parent?.itemCode || '', siblings.length),\r\n            type: parent?.type === ITEM_TYPES.CHAPTER ? ITEM_TYPES.SECTION : ITEM_TYPES.ITEM,\r\n            name: '新工項',\r\n            specification: '',\r\n            unit: '式',\r\n            quantity: 1,\r\n            unitPrice: 0,\r\n            costPrice: 0,\r\n            amount: 0,\r\n            supplyType: SUPPLY_TYPES.CONTRACTOR,\r\n            remark: '',\r\n            sortOrder: items.length,\r\n        };\r\n\r\n        // 在父項後面插入\r\n        if (parentId) {\r\n            const parentIndex = items.findIndex(i => i.id === parentId);\r\n            const lastChildIndex = items.reduce((lastIdx, item, idx) =>\r\n                item.parentId === parentId ? idx : lastIdx, parentIndex);\r\n            const newItems = [...items];\r\n            newItems.splice(lastChildIndex + 1, 0, newItem);\r\n            setItems(newItems);\r\n        } else {\r\n            setItems(prev => [...prev, newItem]);\r\n        }\r\n        setHasChanges(true);\r\n    }, [items]);\r\n\r\n    // 從工項庫新增\r\n    const handleAddFromCatalog = useCallback((catalogItem) => {\r\n        const lastChapter = [...items].reverse().find(i => i.type === ITEM_TYPES.CHAPTER);\r\n        const siblings = items.filter(i => i.parentId === lastChapter?.id);\r\n\r\n        const newItem = {\r\n            id: `item-${Date.now()}`,\r\n            parentId: lastChapter?.id || null,\r\n            itemCode: generateItemCode(lastChapter?.itemCode || '', siblings.length),\r\n            type: ITEM_TYPES.ITEM,\r\n            name: catalogItem.name,\r\n            specification: '',\r\n            unit: catalogItem.unit,\r\n            quantity: 1,\r\n            unitPrice: catalogItem.refPrice,\r\n            costPrice: catalogItem.costPrice,\r\n            amount: catalogItem.refPrice,\r\n            supplyType: SUPPLY_TYPES.CONTRACTOR,\r\n            catalogItemId: catalogItem.id,\r\n            sortOrder: items.length,\r\n        };\r\n\r\n        setItems(prev => [...prev, newItem]);\r\n        setHasChanges(true);\r\n        addToast?.(`已新增「${catalogItem.name}」`, 'success');\r\n    }, [items]);\r\n\r\n    // 儲存\r\n    const handleSave = async () => {\r\n        if (!quotation) return;\r\n\r\n        setSaving(true);\r\n        try {\r\n            await QuotationService.updateQuotation(quotation.id, {\r\n                items,\r\n                ...settings,\r\n                ...totals,\r\n            });\r\n            setHasChanges(false);\r\n            addToast?.('儲存成功', 'success');\r\n        } catch (error) {\r\n            console.error('Failed to save:', error);\r\n            addToast?.('儲存失敗', 'error');\r\n        } finally {\r\n            setSaving(false);\r\n        }\r\n    };\r\n\r\n    // 組織階層結構\r\n    const organizedItems = useMemo(() => {\r\n        // 簡單平坦化 - 保持原始順序\r\n        return items.map((item, index) => {\r\n            let level = 0;\r\n            if (item.type === ITEM_TYPES.SECTION) level = 1;\r\n            if (item.type === ITEM_TYPES.ITEM) level = item.parentId ? 2 : 1;\r\n            return { ...item, level };\r\n        });\r\n    }, [items]);\r\n\r\n    if (loading) {\r\n        return (\r\n            <div className=\"flex items-center justify-center h-64\">\r\n                <div className=\"animate-spin rounded-full h-8 w-8 border-b-2 border-orange-500\" />\r\n            </div>\r\n        );\r\n    }\r\n\r\n    if (!quotation) {\r\n        return (\r\n            <div className=\"text-center py-12 text-gray-500\">\r\n                找不到估價單\r\n            </div>\r\n        );\r\n    }\r\n\r\n    // 變更單模式\r\n    if (showChangeOrders) {\r\n        return (\r\n            <ChangeOrders\r\n                quotationId={quotationId}\r\n                onBack={() => setShowChangeOrders(false)}\r\n                addToast={addToast}\r\n            />\r\n        );\r\n    }\r\n\r\n    return (\r\n        <div className=\"space-y-4\">\r\n            {/* 頁首 */}\r\n            <div className=\"flex flex-col sm:flex-row sm:items-center justify-between gap-4\">\r\n                <div className=\"flex items-center gap-3\">\r\n                    <button\r\n                        onClick={onBack}\r\n                        className=\"p-2 hover:bg-gray-100 rounded-lg transition-colors\"\r\n                    >\r\n                        <ArrowLeft size={20} />\r\n                    </button>\r\n                    <div>\r\n                        <div className=\"flex items-center gap-2\">\r\n                            <span className=\"text-sm text-gray-500\">{quotation.quotationNo}</span>\r\n                            <span className={`px-2 py-0.5 rounded-full text-xs ${QUOTATION_STATUS_COLORS[quotation.status]}`}>\r\n                                {QUOTATION_STATUS_LABELS[quotation.status]}\r\n                            </span>\r\n                        </div>\r\n                        <h1 className=\"text-xl font-bold text-gray-800\">{quotation.title}</h1>\r\n                    </div>\r\n                </div>\r\n\r\n                <div className=\"flex items-center gap-2\">\r\n                    {hasChanges && (\r\n                        <span className=\"text-xs text-orange-500 flex items-center gap-1\">\r\n                            <AlertCircle size={14} /> 尚未儲存\r\n                        </span>\r\n                    )}\r\n                    <button\r\n                        onClick={handleSave}\r\n                        disabled={saving || !hasChanges}\r\n                        className=\"px-4 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600 disabled:opacity-50 transition-colors flex items-center gap-2\"\r\n                    >\r\n                        {saving ? <span className=\"animate-spin\">⟳</span> : <Save size={18} />}\r\n                        儲存\r\n                    </button>\r\n                </div>\r\n            </div>\r\n\r\n            {/* 工具列 */}\r\n            <div className=\"bg-white rounded-xl p-3 border border-gray-100 flex flex-wrap items-center gap-2\">\r\n                <button\r\n                    onClick={handleAddChapter}\r\n                    className=\"px-3 py-1.5 bg-gray-800 text-white rounded-lg text-sm hover:bg-gray-700 flex items-center gap-1\"\r\n                >\r\n                    <Plus size={16} /> 新增章節\r\n                </button>\r\n                <button\r\n                    onClick={() => handleAddItem()}\r\n                    className=\"px-3 py-1.5 bg-gray-100 text-gray-700 rounded-lg text-sm hover:bg-gray-200 flex items-center gap-1\"\r\n                >\r\n                    <Plus size={16} /> 新增工項\r\n                </button>\r\n                <button\r\n                    onClick={() => setShowCatalog(true)}\r\n                    className=\"px-3 py-1.5 bg-gray-100 text-gray-700 rounded-lg text-sm hover:bg-gray-200 flex items-center gap-1\"\r\n                >\r\n                    <Search size={16} /> 工項庫\r\n                </button>\r\n                <button\r\n                    onClick={() => setShowChangeOrders(true)}\r\n                    className=\"px-3 py-1.5 bg-blue-100 text-blue-700 rounded-lg text-sm hover:bg-blue-200 flex items-center gap-1\"\r\n                >\r\n                    <FilePlus2 size={16} /> 變更單\r\n                </button>\r\n                <div className=\"flex-1\" />\r\n                <button className=\"px-3 py-1.5 text-gray-500 rounded-lg text-sm hover:bg-gray-100 flex items-center gap-1\">\r\n                    <Upload size={16} /> 匯入\r\n                </button>\r\n                <button className=\"px-3 py-1.5 text-gray-500 rounded-lg text-sm hover:bg-gray-100 flex items-center gap-1\">\r\n                    <Download size={16} /> 匯出\r\n                </button>\r\n\r\n                {/* PDF 下載 */}\r\n                <QuotationPdfButton\r\n                    quotation={{\r\n                        ...quotation,\r\n                        items: items,\r\n                        taxRate: settings.taxRate,\r\n                        isTaxIncluded: settings.taxType === TAX_TYPES.INCLUSIVE,\r\n                    }}\r\n                    className=\"text-sm py-1.5\"\r\n                />\r\n            </div>\r\n\r\n            {/* 費用設定 */}\r\n            <SettingsPanel settings={settings} onChange={setSettings} totals={totals} />\r\n\r\n            {/* 工項表格 */}\r\n            <div className=\"bg-white rounded-xl border border-gray-100 overflow-hidden\">\r\n                <div className=\"overflow-x-auto\">\r\n                    <table className=\"w-full min-w-[800px]\">\r\n                        <thead className=\"bg-gray-50 border-b border-gray-100\">\r\n                            <tr className=\"text-xs text-gray-500 uppercase\">\r\n                                <th className=\"px-2 py-3 text-left w-20\">項次</th>\r\n                                <th className=\"px-2 py-3 text-left\">名稱</th>\r\n                                <th className=\"px-2 py-3 text-left\">規格</th>\r\n                                <th className=\"px-2 py-3 text-center w-16\">單位</th>\r\n                                <th className=\"px-2 py-3 text-right w-20\">數量</th>\r\n                                <th className=\"px-2 py-3 text-right w-24\">單價</th>\r\n                                <th className=\"px-2 py-3 text-right w-28\">複價</th>\r\n                                <th className=\"px-2 py-3 text-center w-24\">操作</th>\r\n                            </tr>\r\n                        </thead>\r\n                        <tbody>\r\n                            {organizedItems.length === 0 ? (\r\n                                <tr>\r\n                                    <td colSpan={8} className=\"px-4 py-12 text-center text-gray-400\">\r\n                                        <Layers size={32} className=\"mx-auto mb-2 opacity-50\" />\r\n                                        <p>尚無工項</p>\r\n                                        <p className=\"text-sm\">點擊上方按鈕新增章節或工項</p>\r\n                                    </td>\r\n                                </tr>\r\n                            ) : (\r\n                                organizedItems.map((item, index) => (\r\n                                    <ItemRow\r\n                                        key={item.id}\r\n                                        item={item}\r\n                                        index={index}\r\n                                        level={item.level}\r\n                                        isEditing={isEditing}\r\n                                        onUpdate={handleUpdateItem}\r\n                                        onDelete={handleDeleteItem}\r\n                                        onAddChild={handleAddItem}\r\n                                        onDuplicate={handleDuplicateItem}\r\n                                        isSelected={selectedItemId === item.id}\r\n                                        onSelect={setSelectedItemId}\r\n                                    />\r\n                                ))\r\n                            )}\r\n                        </tbody>\r\n                    </table>\r\n                </div>\r\n            </div>\r\n\r\n            {/* 金額摘要 */}\r\n            <TotalsSummary totals={totals} />\r\n\r\n            {/* 工項庫 Modal */}\r\n            <CatalogSearchModal\r\n                isOpen={showCatalog}\r\n                onClose={() => setShowCatalog(false)}\r\n                onSelect={handleAddFromCatalog}\r\n            />\r\n        </div>\r\n    );\r\n};\r\n\r\nexport default QuotationEditor;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\xiang\\senteng-frontend\\src\\pages\\Quotations.jsx","messages":[{"ruleId":"no-unused-vars","severity":2,"message":"'applyTemplate' is defined but never used. Allowed unused vars must match /^[A-Z_]|^_/u.","line":21,"column":5,"nodeType":"Identifier","messageId":"unusedVar","endLine":21,"endColumn":18,"suggestions":[{"messageId":"removeVar","data":{"varName":"applyTemplate"},"fix":{"range":[749,769],"text":""},"desc":"Remove unused variable 'applyTemplate'."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * 估價單列表與管理頁面\r\n * Quotations.jsx\r\n */\r\n\r\nimport React, { useState, useEffect, useMemo } from 'react';\r\nimport {\r\n    FileText, Plus, Search, Filter, MoreVertical, Eye, Edit2, Copy,\r\n    Trash2, Send, Check, X, Clock, ChevronDown, FileSpreadsheet,\r\n    Building2, Users, Calendar, DollarSign, Tag, AlertCircle, Download\r\n} from 'lucide-react';\r\nimport { SectionTitle } from '../components/common/Indicators';\r\nimport SearchableSelect from '../components/common/SearchableSelect';\r\nimport TemplateItemsEditor from '../components/quotation/TemplateItemsEditor';\r\nimport QuotationEditor from './QuotationEditor';\r\nimport QuotationService, {\r\n    QUOTATION_STATUS,\r\n    QUOTATION_STATUS_LABELS,\r\n    QUOTATION_STATUS_COLORS,\r\n    QUOTATION_TEMPLATES,\r\n    applyTemplate,\r\n} from '../services/QuotationService';\r\n\r\n// ============================================\r\n// 狀態標籤元件\r\n// ============================================\r\nconst StatusBadge = ({ status }) => {\r\n    const colorClass = QUOTATION_STATUS_COLORS[status] || 'bg-gray-100 text-gray-700';\r\n    const label = QUOTATION_STATUS_LABELS[status] || status;\r\n\r\n    return (\r\n        <span className={`px-2 py-1 rounded-full text-xs font-medium ${colorClass}`}>\r\n            {label}\r\n        </span>\r\n    );\r\n};\r\n\r\n// ============================================\r\n// 模板預覽 Modal\r\n// ============================================\r\nconst TemplatePreviewModal = ({ isOpen, onClose, template }) => {\r\n    if (!isOpen || !template) return null;\r\n\r\n    // 計算模板總價估算\r\n    const calculateEstimate = () => {\r\n        let total = 0;\r\n        template.items?.forEach(chapter => {\r\n            chapter.children?.forEach(item => {\r\n                // 假設每項數量為 1\r\n                total += item.unitPrice || 0;\r\n            });\r\n        });\r\n        return total;\r\n    };\r\n\r\n    const formatCurrency = (amount) => {\r\n        return new Intl.NumberFormat('zh-TW', {\r\n            style: 'currency',\r\n            currency: 'TWD',\r\n            minimumFractionDigits: 0,\r\n        }).format(amount || 0);\r\n    };\r\n\r\n    return (\r\n        <div className=\"fixed inset-0 bg-black/60 flex items-center justify-center z-[60] p-4\">\r\n            <div className=\"bg-white rounded-2xl shadow-2xl max-w-2xl w-full max-h-[85vh] flex flex-col\">\r\n                {/* 標題 */}\r\n                <div className=\"p-5 border-b border-gray-100 flex justify-between items-center\">\r\n                    <div>\r\n                        <h3 className=\"text-lg font-bold text-gray-800\">{template.name}</h3>\r\n                        <p className=\"text-sm text-gray-500\">{template.description}</p>\r\n                    </div>\r\n                    <button\r\n                        onClick={onClose}\r\n                        className=\"p-2 hover:bg-gray-100 rounded-lg transition-colors\"\r\n                    >\r\n                        <X size={20} className=\"text-gray-500\" />\r\n                    </button>\r\n                </div>\r\n\r\n                {/* 內容 */}\r\n                <div className=\"flex-1 overflow-y-auto p-5\">\r\n                    <div className=\"space-y-4\">\r\n                        {template.items?.map((chapter, chapterIdx) => (\r\n                            <div key={chapterIdx} className=\"bg-gray-50 rounded-xl p-4\">\r\n                                {/* 章節標題 */}\r\n                                <h4 className=\"font-semibold text-gray-800 mb-3 flex items-center gap-2\">\r\n                                    <span className=\"w-6 h-6 bg-orange-500 text-white rounded-full flex items-center justify-center text-xs font-bold\">\r\n                                        {chapterIdx + 1}\r\n                                    </span>\r\n                                    {chapter.name}\r\n                                </h4>\r\n                                {/* 工項列表 */}\r\n                                <div className=\"space-y-2\">\r\n                                    {chapter.children?.map((item, itemIdx) => (\r\n                                        <div\r\n                                            key={itemIdx}\r\n                                            className=\"flex items-center justify-between bg-white rounded-lg p-3 border border-gray-100\"\r\n                                        >\r\n                                            <div className=\"flex-1\">\r\n                                                <span className=\"text-sm text-gray-800\">{item.name}</span>\r\n                                            </div>\r\n                                            <div className=\"flex items-center gap-4 text-sm\">\r\n                                                <span className=\"text-gray-500\">{item.unit}</span>\r\n                                                <span className=\"font-medium text-orange-600 min-w-[80px] text-right\">\r\n                                                    {formatCurrency(item.unitPrice)}\r\n                                                </span>\r\n                                            </div>\r\n                                        </div>\r\n                                    ))}\r\n                                </div>\r\n                            </div>\r\n                        ))}\r\n                    </div>\r\n                </div>\r\n\r\n                {/* 底部統計 */}\r\n                <div className=\"p-5 border-t border-gray-100 bg-gray-50 rounded-b-2xl\">\r\n                    <div className=\"flex items-center justify-between\">\r\n                        <div className=\"text-sm text-gray-500\">\r\n                            <span className=\"font-medium text-gray-700\">\r\n                                {template.items?.length || 0}\r\n                            </span> 個章節，\r\n                            <span className=\"font-medium text-gray-700\">\r\n                                {template.items?.reduce((sum, ch) => sum + (ch.children?.length || 0), 0)}\r\n                            </span> 個工項\r\n                        </div>\r\n                        <div className=\"text-right\">\r\n                            <div className=\"text-xs text-gray-400\">參考單價合計</div>\r\n                            <div className=\"text-lg font-bold text-orange-600\">\r\n                                {formatCurrency(calculateEstimate())}\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n                    <button\r\n                        onClick={onClose}\r\n                        className=\"w-full mt-4 py-2.5 bg-gray-800 text-white rounded-lg hover:bg-gray-700 transition-colors\"\r\n                    >\r\n                        關閉預覽\r\n                    </button>\r\n                </div>\r\n            </div>\r\n        </div>\r\n    );\r\n};\r\n\r\n// ============================================\r\n// 新增估價單 Modal\r\n// ============================================\r\nconst NewQuotationModal = ({ isOpen, onClose, onSubmit, projects = [], customers = [] }) => {\r\n    const [formData, setFormData] = useState({\r\n        title: '',\r\n        projectId: '',\r\n        projectName: '',\r\n        customerId: '',\r\n        customerName: '',\r\n        templateId: '',\r\n        description: '',\r\n    });\r\n    const [previewTemplate, setPreviewTemplate] = useState(null);\r\n    const [editableItems, setEditableItems] = useState([]);\r\n\r\n    // 當選擇模板時，載入模板工項\r\n    const handleTemplateChange = (templateId) => {\r\n        setFormData(prev => ({ ...prev, templateId }));\r\n\r\n        if (templateId) {\r\n            const template = QUOTATION_TEMPLATES.find(t => t.id === templateId);\r\n            if (template) {\r\n                // 展開模板工項為可編輯列表\r\n                const items = [];\r\n                template.items?.forEach((chapter, chapterIdx) => {\r\n                    chapter.children?.forEach((item, itemIdx) => {\r\n                        items.push({\r\n                            id: `tpl-${chapterIdx}-${itemIdx}`,\r\n                            chapter: chapter.name,\r\n                            chapterIndex: chapterIdx,\r\n                            name: item.name,\r\n                            unit: item.unit || '式',\r\n                            quantity: 1,\r\n                            unitPrice: item.unitPrice || 0,\r\n                            type: 'ITEM',\r\n                        });\r\n                    });\r\n                });\r\n                setEditableItems(items);\r\n            }\r\n        } else {\r\n            setEditableItems([]);\r\n        }\r\n    };\r\n\r\n    const handleSubmit = (e) => {\r\n        e.preventDefault();\r\n\r\n        onSubmit({\r\n            ...formData,\r\n            items: editableItems,\r\n        });\r\n        onClose();\r\n        // Reset\r\n        setFormData({\r\n            title: '',\r\n            projectId: '',\r\n            projectName: '',\r\n            customerId: '',\r\n            customerName: '',\r\n            templateId: '',\r\n            description: '',\r\n        });\r\n        setEditableItems([]);\r\n    };\r\n\r\n    const handlePreview = () => {\r\n        if (formData.templateId) {\r\n            const template = QUOTATION_TEMPLATES.find(t => t.id === formData.templateId);\r\n            setPreviewTemplate(template);\r\n        }\r\n    };\r\n\r\n    if (!isOpen) return null;\r\n\r\n    return (\r\n        <>\r\n            <div className=\"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4\">\r\n                <div className=\"bg-white rounded-2xl shadow-xl max-w-3xl w-full max-h-[90vh] overflow-y-auto\">\r\n                    <div className=\"p-6 border-b border-gray-100\">\r\n                        <h2 className=\"text-xl font-bold text-gray-800\">新增估價單</h2>\r\n                    </div>\r\n\r\n                    <form onSubmit={handleSubmit} className=\"p-6 space-y-4\">\r\n                        {/* 標題 */}\r\n                        <div>\r\n                            <label className=\"block text-sm font-medium text-gray-700 mb-1\">\r\n                                估價單標題 <span className=\"text-red-500\">*</span>\r\n                            </label>\r\n                            <input\r\n                                type=\"text\"\r\n                                value={formData.title}\r\n                                onChange={(e) => setFormData(prev => ({ ...prev, title: e.target.value }))}\r\n                                placeholder=\"例：陳先生住宅裝修報價\"\r\n                                className=\"w-full px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent\"\r\n                                required\r\n                            />\r\n                        </div>\r\n\r\n                        {/* 專案 - 下拉式選單 */}\r\n                        <div>\r\n                            <SearchableSelect\r\n                                label=\"關聯專案\"\r\n                                placeholder=\"搜尋並選擇專案...\"\r\n                                options={projects.map(p => ({ id: p.id, name: p.name }))}\r\n                                value={formData.projectId}\r\n                                onChange={(id) => {\r\n                                    const proj = projects.find(p => p.id === id);\r\n                                    setFormData(prev => ({ ...prev, projectId: id, projectName: proj?.name || '' }));\r\n                                }}\r\n                            />\r\n                        </div>\r\n\r\n                        {/* 客戶 - 下拉式選單 */}\r\n                        <div>\r\n                            <SearchableSelect\r\n                                label=\"客戶名稱\"\r\n                                placeholder=\"搜尋並選擇客戶...\"\r\n                                options={customers.map(c => ({ id: c.id, name: c.name }))}\r\n                                value={formData.customerId}\r\n                                onChange={(id) => {\r\n                                    const client = customers.find(c => c.id === id);\r\n                                    setFormData(prev => ({ ...prev, customerId: id, customerName: client?.name || '' }));\r\n                                }}\r\n                            />\r\n                        </div>\r\n\r\n                        {/* 模板選擇 - RWD 友善設計 */}\r\n                        <div>\r\n                            <label className=\"block text-sm font-medium text-gray-700 mb-1\">\r\n                                套用模板\r\n                            </label>\r\n                            <select\r\n                                value={formData.templateId}\r\n                                onChange={(e) => handleTemplateChange(e.target.value)}\r\n                                className=\"w-full px-4 py-2.5 border border-gray-200 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent bg-white\"\r\n                            >\r\n                                <option value=\"\">不套用模板 (空白開始)</option>\r\n                                {QUOTATION_TEMPLATES.map(tpl => (\r\n                                    <option key={tpl.id} value={tpl.id}>\r\n                                        {tpl.name}\r\n                                    </option>\r\n                                ))}\r\n                            </select>\r\n\r\n                            {/* 選擇模板後顯示的資訊卡與預覽按鈕 */}\r\n                            {formData.templateId && (() => {\r\n                                const selectedTpl = QUOTATION_TEMPLATES.find(t => t.id === formData.templateId);\r\n                                return selectedTpl ? (\r\n                                    <div className=\"mt-3 p-3 bg-orange-50 border border-orange-100 rounded-lg\">\r\n                                        <div className=\"flex items-start justify-between gap-3\">\r\n                                            <div className=\"flex-1 min-w-0\">\r\n                                                <div className=\"font-medium text-gray-800 text-sm\">{selectedTpl.name}</div>\r\n                                                <div className=\"text-xs text-gray-500 mt-0.5\">{selectedTpl.description}</div>\r\n                                                <div className=\"text-xs text-orange-600 mt-1\">\r\n                                                    📦 {selectedTpl.items?.length || 0} 個章節，\r\n                                                    {selectedTpl.items?.reduce((sum, ch) => sum + (ch.children?.length || 0), 0)} 個工項\r\n                                                </div>\r\n                                            </div>\r\n                                            <button\r\n                                                type=\"button\"\r\n                                                onClick={handlePreview}\r\n                                                className=\"shrink-0 px-3 py-1.5 bg-white text-orange-600 border border-orange-200 rounded-lg hover:bg-orange-100 transition-colors text-sm font-medium flex items-center gap-1.5\"\r\n                                            >\r\n                                                <Eye size={14} />\r\n                                                預覽內容\r\n                                            </button>\r\n                                        </div>\r\n                                    </div>\r\n                                ) : null;\r\n                            })()}\r\n                        </div>\r\n\r\n                        {/* 工項編輯器 */}\r\n                        {(editableItems.length > 0 || formData.templateId) && (\r\n                            <div className=\"mt-4\">\r\n                                <label className=\"block text-sm font-medium text-gray-700 mb-2\">\r\n                                    工項明細 <span className=\"text-xs text-gray-400\">(可新增、編輯、刪除)</span>\r\n                                </label>\r\n                                <div className=\"border border-gray-200 rounded-xl p-4 bg-gray-50\">\r\n                                    <TemplateItemsEditor\r\n                                        items={editableItems}\r\n                                        onChange={setEditableItems}\r\n                                    />\r\n                                </div>\r\n                            </div>\r\n                        )}\r\n\r\n                        {/* 說明 */}\r\n                        <div>\r\n                            <label className=\"block text-sm font-medium text-gray-700 mb-1\">\r\n                                備註說明\r\n                            </label>\r\n                            <textarea\r\n                                value={formData.description}\r\n                                onChange={(e) => setFormData(prev => ({ ...prev, description: e.target.value }))}\r\n                                placeholder=\"可填入補充說明...\"\r\n                                rows={3}\r\n                                className=\"w-full px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent resize-none\"\r\n                            />\r\n                        </div>\r\n\r\n                        {/* 按鈕 */}\r\n                        <div className=\"flex justify-end gap-3 pt-4\">\r\n                            <button\r\n                                type=\"button\"\r\n                                onClick={onClose}\r\n                                className=\"px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg transition-colors\"\r\n                            >\r\n                                取消\r\n                            </button>\r\n                            <button\r\n                                type=\"submit\"\r\n                                className=\"px-6 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600 transition-colors flex items-center gap-2\"\r\n                            >\r\n                                <Plus size={18} />\r\n                                建立估價單\r\n                            </button>\r\n                        </div>\r\n                    </form>\r\n                </div>\r\n            </div>\r\n\r\n            {/* 模板預覽 Modal */}\r\n            <TemplatePreviewModal\r\n                isOpen={!!previewTemplate}\r\n                onClose={() => setPreviewTemplate(null)}\r\n                template={previewTemplate}\r\n            />\r\n        </>\r\n    );\r\n};\r\n\r\n// ============================================\r\n// 估價單卡片元件\r\n// ============================================\r\nconst QuotationCard = ({ quotation, onView, onEdit, onCopy, onDelete }) => {\r\n    const [showMenu, setShowMenu] = useState(false);\r\n\r\n    const formatCurrency = (amount) => {\r\n        return new Intl.NumberFormat('zh-TW', {\r\n            style: 'currency',\r\n            currency: 'TWD',\r\n            minimumFractionDigits: 0,\r\n        }).format(amount || 0);\r\n    };\r\n\r\n    const formatDate = (dateStr) => {\r\n        if (!dateStr) return '-';\r\n        return new Date(dateStr).toLocaleDateString('zh-TW');\r\n    };\r\n\r\n    return (\r\n        <div className=\"bg-white rounded-xl border border-gray-100 p-4 hover:shadow-lg transition-all group\">\r\n            {/* 頂部 */}\r\n            <div className=\"flex items-start justify-between mb-3\">\r\n                <div className=\"flex items-center gap-2\">\r\n                    <span className=\"text-sm font-medium text-gray-500\">{quotation.quotationNo}</span>\r\n                    <StatusBadge status={quotation.status} />\r\n                </div>\r\n                <div className=\"relative\">\r\n                    <button\r\n                        onClick={() => setShowMenu(!showMenu)}\r\n                        className=\"p-1 text-gray-400 hover:text-gray-600 rounded-lg hover:bg-gray-100 transition-colors\"\r\n                    >\r\n                        <MoreVertical size={18} />\r\n                    </button>\r\n                    {showMenu && (\r\n                        <>\r\n                            <div className=\"fixed inset-0 z-10\" onClick={() => setShowMenu(false)} />\r\n                            <div className=\"absolute right-0 top-8 bg-white rounded-lg shadow-lg border border-gray-100 py-1 z-20 min-w-[140px]\">\r\n                                <button\r\n                                    onClick={() => { onView?.(quotation); setShowMenu(false); }}\r\n                                    className=\"w-full px-4 py-2 text-left text-sm text-gray-700 hover:bg-gray-50 flex items-center gap-2\"\r\n                                >\r\n                                    <Eye size={16} /> 檢視\r\n                                </button>\r\n                                <button\r\n                                    onClick={() => { onEdit?.(quotation); setShowMenu(false); }}\r\n                                    className=\"w-full px-4 py-2 text-left text-sm text-gray-700 hover:bg-gray-50 flex items-center gap-2\"\r\n                                >\r\n                                    <Edit2 size={16} /> 編輯\r\n                                </button>\r\n                                <button\r\n                                    onClick={() => { onCopy?.(quotation); setShowMenu(false); }}\r\n                                    className=\"w-full px-4 py-2 text-left text-sm text-gray-700 hover:bg-gray-50 flex items-center gap-2\"\r\n                                >\r\n                                    <Copy size={16} /> 複製\r\n                                </button>\r\n                                <hr className=\"my-1 border-gray-100\" />\r\n                                <button\r\n                                    onClick={() => { onDelete?.(quotation); setShowMenu(false); }}\r\n                                    className=\"w-full px-4 py-2 text-left text-sm text-red-600 hover:bg-red-50 flex items-center gap-2\"\r\n                                >\r\n                                    <Trash2 size={16} /> 刪除\r\n                                </button>\r\n                            </div>\r\n                        </>\r\n                    )}\r\n                </div>\r\n            </div>\r\n\r\n            {/* 標題 */}\r\n            <h3 className=\"font-semibold text-gray-800 mb-2 line-clamp-1\">{quotation.title}</h3>\r\n\r\n            {/* 資訊 */}\r\n            <div className=\"space-y-1.5 text-sm text-gray-500 mb-4\">\r\n                {quotation.customerName && (\r\n                    <div className=\"flex items-center gap-2\">\r\n                        <Users size={14} className=\"text-gray-400\" />\r\n                        {quotation.customerName}\r\n                    </div>\r\n                )}\r\n                {quotation.projectName && (\r\n                    <div className=\"flex items-center gap-2\">\r\n                        <Building2 size={14} className=\"text-gray-400\" />\r\n                        {quotation.projectName}\r\n                    </div>\r\n                )}\r\n                <div className=\"flex items-center gap-2\">\r\n                    <Calendar size={14} className=\"text-gray-400\" />\r\n                    有效期限：{formatDate(quotation.validUntil)}\r\n                </div>\r\n            </div>\r\n\r\n            {/* 金額 */}\r\n            <div className=\"flex items-center justify-between pt-3 border-t border-gray-100\">\r\n                <span className=\"text-xs text-gray-400\">報價金額</span>\r\n                <span className=\"text-lg font-bold text-orange-600\">\r\n                    {formatCurrency(quotation.totalAmount)}\r\n                </span>\r\n            </div>\r\n\r\n            {/* 快速動作 */}\r\n            <div className=\"flex gap-2 mt-3 opacity-0 group-hover:opacity-100 transition-opacity\">\r\n                <button\r\n                    onClick={() => onEdit?.(quotation)}\r\n                    className=\"flex-1 py-2 bg-orange-50 text-orange-600 rounded-lg text-sm font-medium hover:bg-orange-100 transition-colors flex items-center justify-center gap-1\"\r\n                >\r\n                    <Edit2 size={14} /> 編輯\r\n                </button>\r\n                <button\r\n                    onClick={() => onView?.(quotation)}\r\n                    className=\"flex-1 py-2 bg-gray-50 text-gray-600 rounded-lg text-sm font-medium hover:bg-gray-100 transition-colors flex items-center justify-center gap-1\"\r\n                >\r\n                    <Eye size={14} /> 檢視\r\n                </button>\r\n            </div>\r\n        </div>\r\n    );\r\n};\r\n\r\n// ============================================\r\n// 主頁面\r\n// ============================================\r\nconst Quotations = ({ addToast, projects = [], clients = [] }) => {\r\n    const [quotations, setQuotations] = useState([]);\r\n    const [loading, setLoading] = useState(true);\r\n    const [showNewModal, setShowNewModal] = useState(false);\r\n    const [searchTerm, setSearchTerm] = useState('');\r\n    const [statusFilter, setStatusFilter] = useState('ALL');\r\n    const [selectedQuotation, setSelectedQuotation] = useState(null);\r\n    const [viewMode, setViewMode] = useState('list'); // list / editor\r\n\r\n    // 載入估價單\r\n    useEffect(() => {\r\n        loadQuotations();\r\n    }, []);\r\n\r\n    const loadQuotations = async () => {\r\n        setLoading(true);\r\n        try {\r\n            const data = await QuotationService.getQuotations();\r\n            setQuotations(data);\r\n        } catch (error) {\r\n            console.error('Failed to load quotations:', error);\r\n        } finally {\r\n            setLoading(false);\r\n        }\r\n    };\r\n\r\n    // 篩選估價單\r\n    const filteredQuotations = useMemo(() => {\r\n        return quotations.filter(q => {\r\n            // 狀態篩選\r\n            if (statusFilter !== 'ALL' && q.status !== statusFilter) return false;\r\n            // 搜尋\r\n            if (searchTerm) {\r\n                const term = searchTerm.toLowerCase();\r\n                return (\r\n                    q.quotationNo?.toLowerCase().includes(term) ||\r\n                    q.title?.toLowerCase().includes(term) ||\r\n                    q.customerName?.toLowerCase().includes(term) ||\r\n                    q.projectName?.toLowerCase().includes(term)\r\n                );\r\n            }\r\n            return true;\r\n        });\r\n    }, [quotations, statusFilter, searchTerm]);\r\n\r\n    // 統計\r\n    const stats = useMemo(() => {\r\n        const total = quotations.length;\r\n        const draft = quotations.filter(q => q.status === QUOTATION_STATUS.DRAFT).length;\r\n        const pending = quotations.filter(q => q.status === QUOTATION_STATUS.PENDING).length;\r\n        const approved = quotations.filter(q => q.status === QUOTATION_STATUS.APPROVED).length;\r\n        const totalAmount = quotations\r\n            .filter(q => [QUOTATION_STATUS.APPROVED, QUOTATION_STATUS.SENT, QUOTATION_STATUS.ACCEPTED].includes(q.status))\r\n            .reduce((sum, q) => sum + (q.totalAmount || 0), 0);\r\n\r\n        return { total, draft, pending, approved, totalAmount };\r\n    }, [quotations]);\r\n\r\n    // 新增估價單\r\n    const handleCreate = async (data) => {\r\n        try {\r\n            const newQuotation = await QuotationService.createQuotation(data);\r\n            loadQuotations();\r\n            // 自動進入編輯模式\r\n            setSelectedQuotation(newQuotation);\r\n            setViewMode('editor');\r\n        } catch (error) {\r\n            console.error('Failed to create quotation:', error);\r\n        }\r\n    };\r\n\r\n    // 複製估價單\r\n    const handleCopy = async (quotation) => {\r\n        if (window.confirm(`確定要複製估價單「${quotation.title}」嗎？`)) {\r\n            try {\r\n                await QuotationService.copyQuotation(quotation.id);\r\n                loadQuotations();\r\n            } catch (error) {\r\n                console.error('Failed to copy quotation:', error);\r\n            }\r\n        }\r\n    };\r\n\r\n    // 刪除估價單\r\n    const handleDelete = async (quotation) => {\r\n        if (window.confirm(`確定要刪除估價單「${quotation.title}」嗎？此操作無法復原。`)) {\r\n            try {\r\n                await QuotationService.deleteQuotation(quotation.id);\r\n                loadQuotations();\r\n            } catch (error) {\r\n                console.error('Failed to delete quotation:', error);\r\n            }\r\n        }\r\n    };\r\n\r\n    // 編輯估價單\r\n    const handleEdit = (quotation) => {\r\n        setSelectedQuotation(quotation);\r\n        setViewMode('editor');\r\n    };\r\n\r\n    // 檢視估價單\r\n    const handleView = (quotation) => {\r\n        setSelectedQuotation(quotation);\r\n        setViewMode('editor');\r\n    };\r\n\r\n    // 返回列表\r\n    const handleBack = () => {\r\n        setSelectedQuotation(null);\r\n        setViewMode('list');\r\n        loadQuotations(); // 重新載入\r\n    };\r\n\r\n    const formatCurrency = (amount) => {\r\n        return new Intl.NumberFormat('zh-TW', {\r\n            style: 'currency',\r\n            currency: 'TWD',\r\n            minimumFractionDigits: 0,\r\n        }).format(amount || 0);\r\n    };\r\n\r\n    // 編輯模式\r\n    if (viewMode === 'editor' && selectedQuotation) {\r\n        return (\r\n            <QuotationEditor\r\n                quotationId={selectedQuotation.id}\r\n                onBack={handleBack}\r\n                addToast={addToast}\r\n            />\r\n        );\r\n    }\r\n\r\n    return (\r\n        <div className=\"space-y-6\">\r\n            {/* 標題與操作 */}\r\n            <div className=\"flex flex-col sm:flex-row sm:items-center justify-between gap-4\">\r\n                <SectionTitle\r\n                    icon={FileText}\r\n                    title=\"估價單管理\"\r\n                    subtitle=\"建立與管理專案報價\"\r\n                />\r\n                <button\r\n                    onClick={() => setShowNewModal(true)}\r\n                    className=\"px-4 py-2 bg-orange-500 text-white rounded-xl hover:bg-orange-600 transition-colors flex items-center gap-2 shadow-md\"\r\n                >\r\n                    <Plus size={18} />\r\n                    新增估價單\r\n                </button>\r\n            </div>\r\n\r\n            {/* 統計卡片 */}\r\n            <div className=\"grid grid-cols-2 lg:grid-cols-5 gap-4\">\r\n                <div className=\"bg-white rounded-xl p-4 border border-gray-100\">\r\n                    <div className=\"text-sm text-gray-500 mb-1\">全部估價單</div>\r\n                    <div className=\"text-2xl font-bold text-gray-800\">{stats.total}</div>\r\n                </div>\r\n                <div className=\"bg-white rounded-xl p-4 border border-gray-100\">\r\n                    <div className=\"text-sm text-gray-500 mb-1\">草稿中</div>\r\n                    <div className=\"text-2xl font-bold text-gray-600\">{stats.draft}</div>\r\n                </div>\r\n                <div className=\"bg-white rounded-xl p-4 border border-gray-100\">\r\n                    <div className=\"text-sm text-gray-500 mb-1\">待審核</div>\r\n                    <div className=\"text-2xl font-bold text-yellow-600\">{stats.pending}</div>\r\n                </div>\r\n                <div className=\"bg-white rounded-xl p-4 border border-gray-100\">\r\n                    <div className=\"text-sm text-gray-500 mb-1\">已核准</div>\r\n                    <div className=\"text-2xl font-bold text-green-600\">{stats.approved}</div>\r\n                </div>\r\n                <div className=\"bg-white rounded-xl p-4 border border-gray-100 col-span-2 lg:col-span-1\">\r\n                    <div className=\"text-sm text-gray-500 mb-1\">已核准金額</div>\r\n                    <div className=\"text-xl font-bold text-orange-600\">{formatCurrency(stats.totalAmount)}</div>\r\n                </div>\r\n            </div>\r\n\r\n            {/* 搜尋與篩選 */}\r\n            <div className=\"flex flex-col sm:flex-row gap-3\">\r\n                <div className=\"relative flex-1\">\r\n                    <Search size={18} className=\"absolute left-3 top-1/2 -translate-y-1/2 text-gray-400\" />\r\n                    <input\r\n                        type=\"text\"\r\n                        value={searchTerm}\r\n                        onChange={(e) => setSearchTerm(e.target.value)}\r\n                        placeholder=\"搜尋估價單編號、標題、客戶...\"\r\n                        className=\"w-full pl-10 pr-4 py-2.5 border border-gray-200 rounded-xl focus:ring-2 focus:ring-orange-500 focus:border-transparent\"\r\n                    />\r\n                </div>\r\n                <select\r\n                    value={statusFilter}\r\n                    onChange={(e) => setStatusFilter(e.target.value)}\r\n                    className=\"px-4 py-2.5 border border-gray-200 rounded-xl focus:ring-2 focus:ring-orange-500 focus:border-transparent bg-white min-w-[140px]\"\r\n                >\r\n                    <option value=\"ALL\">全部狀態</option>\r\n                    {Object.entries(QUOTATION_STATUS_LABELS).map(([key, label]) => (\r\n                        <option key={key} value={key}>{label}</option>\r\n                    ))}\r\n                </select>\r\n            </div>\r\n\r\n            {/* 估價單列表 */}\r\n            {loading ? (\r\n                <div className=\"text-center py-12 text-gray-500\">\r\n                    載入中...\r\n                </div>\r\n            ) : filteredQuotations.length === 0 ? (\r\n                <div className=\"text-center py-12\">\r\n                    <FileText size={48} className=\"mx-auto text-gray-300 mb-4\" />\r\n                    <h3 className=\"text-lg font-medium text-gray-600 mb-2\">\r\n                        {searchTerm || statusFilter !== 'ALL' ? '沒有符合條件的估價單' : '尚無估價單'}\r\n                    </h3>\r\n                    <p className=\"text-gray-500 mb-4\">\r\n                        {searchTerm || statusFilter !== 'ALL'\r\n                            ? '請調整搜尋條件或篩選條件'\r\n                            : '點擊上方按鈕建立您的第一張估價單'}\r\n                    </p>\r\n                    {!searchTerm && statusFilter === 'ALL' && (\r\n                        <button\r\n                            onClick={() => setShowNewModal(true)}\r\n                            className=\"px-4 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600 transition-colors\"\r\n                        >\r\n                            建立估價單\r\n                        </button>\r\n                    )}\r\n                </div>\r\n            ) : (\r\n                <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4\">\r\n                    {filteredQuotations.map(quotation => (\r\n                        <QuotationCard\r\n                            key={quotation.id}\r\n                            quotation={quotation}\r\n                            onView={handleView}\r\n                            onEdit={handleEdit}\r\n                            onCopy={handleCopy}\r\n                            onDelete={handleDelete}\r\n                        />\r\n                    ))}\r\n                </div>\r\n            )}\r\n\r\n            {/* 新增 Modal */}\r\n            <NewQuotationModal\r\n                isOpen={showNewModal}\r\n                onClose={() => setShowNewModal(false)}\r\n                onSubmit={handleCreate}\r\n                projects={projects}\r\n                customers={clients}\r\n            />\r\n        </div>\r\n    );\r\n};\r\n\r\nexport default Quotations;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\xiang\\senteng-frontend\\src\\pages\\Schedule.jsx","messages":[{"ruleId":"no-unused-vars","severity":2,"message":"'refetchGoogleStatus' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]|^_/u.","line":79,"column":42,"nodeType":"Identifier","messageId":"unusedVar","endLine":79,"endColumn":61,"suggestions":[{"messageId":"removeVar","data":{"varName":"refetchGoogleStatus"},"fix":{"range":[2854,2884],"text":""},"desc":"Remove unused variable 'refetchGoogleStatus'."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\r\nimport React, { useState, useMemo } from 'react';\r\nimport { ChevronLeft, ChevronRight, Plus, CalendarDays, Building2, X, RefreshCw, MapPin, Clock, FileText } from 'lucide-react';\r\nimport { Modal } from '../components/common/Modal';\r\nimport { InputField } from '../components/common/InputField';\r\nimport { LocationField } from '../components/common/LocationField';\r\nimport { SectionTitle } from '../components/common/Indicators';\r\nimport { GoogleService } from '../services/GoogleService';\r\nimport { SyncStatusBadge } from '../components/common/SyncStatusBadge';\r\nimport { useAuth } from '../context/AuthContext';\r\nimport { useGoogleIntegrationStatus } from '../hooks/useGoogleIntegrationStatus';\r\nimport { syncEventToGoogle } from '../services/eventsSyncApi';\r\n\r\n// 台灣節慶假日 2024-2026\r\nconst TAIWAN_HOLIDAYS = {\r\n    // 2024\r\n    '2024-01-01': '元旦',\r\n    '2024-02-08': '除夕',\r\n    '2024-02-09': '春節',\r\n    '2024-02-10': '初二',\r\n    '2024-02-11': '初三',\r\n    '2024-02-12': '初四',\r\n    '2024-02-13': '初五',\r\n    '2024-02-14': '初六',\r\n    '2024-02-28': '和平紀念日',\r\n    '2024-04-04': '兒童節',\r\n    '2024-04-05': '清明節',\r\n    '2024-05-01': '勞動節',\r\n    '2024-06-10': '端午節',\r\n    '2024-09-17': '中秋節',\r\n    '2024-10-10': '國慶日',\r\n    '2024-12-25': '行憲紀念日',\r\n    // 2025\r\n    '2025-01-01': '元旦',\r\n    '2025-01-28': '除夕',\r\n    '2025-01-29': '春節',\r\n    '2025-01-30': '初二',\r\n    '2025-01-31': '初三',\r\n    '2025-02-01': '初四',\r\n    '2025-02-28': '和平紀念日',\r\n    '2025-04-03': '兒童節（彈性）',\r\n    '2025-04-04': '兒童節/清明節',\r\n    '2025-04-05': '清明節（彈性）',\r\n    '2025-05-01': '勞動節',\r\n    '2025-05-31': '端午節',\r\n    '2025-10-06': '中秋節',\r\n    '2025-10-10': '國慶日',\r\n    '2025-12-25': '行憲紀念日',\r\n    // 2026\r\n    '2026-01-01': '元旦',\r\n    '2026-02-16': '除夕',\r\n    '2026-02-17': '春節',\r\n    '2026-02-18': '初二',\r\n    '2026-02-19': '初三',\r\n    '2026-02-20': '初四',\r\n    '2026-02-28': '和平紀念日',\r\n    '2026-04-04': '兒童節',\r\n    '2026-04-05': '清明節',\r\n    '2026-05-01': '勞動節',\r\n    '2026-06-19': '端午節',\r\n    '2026-09-25': '中秋節',\r\n    '2026-10-10': '國慶日',\r\n    '2026-12-25': '行憲紀念日',\r\n};\r\n\r\nconst Schedule = ({ data = [], loans = [], addToast, onUpdateCalendar }) => {\r\n    const [currentDate, setCurrentDate] = useState(new Date());\r\n    const [isAddModalOpen, setIsAddModalOpen] = useState(false);\r\n    const [newEvent, setNewEvent] = useState({ title: \"\", date: \"\", time: \"10:00\", type: \"meeting\", description: \"\", location: \"\" });\r\n    const [isSaving, setIsSaving] = useState(false);\r\n    const [showHolidays, setShowHolidays] = useState(true);\r\n    const [showLoanReminders, setShowLoanReminders] = useState(true);\r\n    const [localEvents, setLocalEvents] = useState(data);\r\n    const [selectedEvent, setSelectedEvent] = useState(null);\r\n    const [isSyncing, setIsSyncing] = useState(false);\r\n\r\n    // RBAC and Google integration status\r\n    const { hasAction } = useAuth();\r\n    const { data: googleStatus, refetch: refetchGoogleStatus } = useGoogleIntegrationStatus();\r\n    const canSyncEvent = hasAction?.('integrations.google.calendar', 'sync_event') ?? false;\r\n\r\n    // 生成貸款還款提醒事件\r\n    const loanPaymentEvents = useMemo(() => {\r\n        if (!showLoanReminders || !loans.length) return [];\r\n\r\n        const events = [];\r\n        const year = currentDate.getFullYear();\r\n        const month = currentDate.getMonth();\r\n\r\n        loans.forEach(loan => {\r\n            if (loan.status !== 'active') return;\r\n\r\n            const paymentDay = loan.paymentDay || 15;\r\n            // 確保日期在月份範圍內\r\n            const daysInMonth = new Date(year, month + 1, 0).getDate();\r\n            const actualDay = Math.min(paymentDay, daysInMonth);\r\n\r\n            const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(actualDay).padStart(2, '0')}`;\r\n\r\n            events.push({\r\n                id: `loan-${loan.id}-${dateStr}`,\r\n                title: `🏦 ${loan.bankName} 還款`,\r\n                date: dateStr,\r\n                time: '09:00',\r\n                type: 'loan',\r\n                description: `每月還款 $${loan.monthlyPayment?.toLocaleString() || 0}`,\r\n                location: loan.bankName,\r\n                loanId: loan.id,\r\n                amount: loan.monthlyPayment\r\n            });\r\n        });\r\n\r\n        return events;\r\n    }, [loans, currentDate, showLoanReminders]);\r\n\r\n    // 合併一般事件和貸款還款事件\r\n    const allEvents = useMemo(() => {\r\n        return [...localEvents, ...loanPaymentEvents];\r\n    }, [localEvents, loanPaymentEvents]);\r\n\r\n    const getDaysInMonth = (d) => new Date(d.getFullYear(), d.getMonth() + 1, 0).getDate();\r\n    const getFirstDayOfMonth = (d) => new Date(d.getFullYear(), d.getMonth(), 1).getDay();\r\n    const daysInMonth = getDaysInMonth(currentDate);\r\n    const firstDay = getFirstDayOfMonth(currentDate);\r\n    const days = Array(firstDay).fill(null).concat([...Array(daysInMonth).keys()].map(i => i + 1));\r\n\r\n    // 檢查是否為假日\r\n    const getHoliday = (dateStr) => {\r\n        return TAIWAN_HOLIDAYS[dateStr] || null;\r\n    };\r\n\r\n    // 檢查是否為週末\r\n    const isWeekend = (dateStr) => {\r\n        const date = new Date(dateStr);\r\n        const day = date.getDay();\r\n        return day === 0 || day === 6;\r\n    };\r\n\r\n    const handleAddEvent = async () => {\r\n        if (!newEvent.title || !newEvent.date) {\r\n            return addToast(\"請填寫標題和日期\", 'error');\r\n        }\r\n\r\n        setIsSaving(true);\r\n\r\n        // 創建本地事件物件\r\n        const eventToAdd = {\r\n            id: `evt-${Date.now()}`,\r\n            ...newEvent\r\n        };\r\n\r\n        // 嘗試同步到 Google Calendar\r\n        const result = await GoogleService.addToCalendar(newEvent);\r\n        setIsSaving(false);\r\n\r\n        // 無論 GAS 成功與否，都新增到本地\r\n        const updatedEvents = [...localEvents, eventToAdd];\r\n        setLocalEvents(updatedEvents);\r\n        if (onUpdateCalendar) onUpdateCalendar(updatedEvents);\r\n\r\n        if (result.success) {\r\n            addToast(`✅ 行程「${newEvent.title}」已同步至 Google Calendar`, 'success');\r\n        } else {\r\n            addToast(`⚠️ 行程已新增（本地），但 Google 同步失敗: ${result.error}`, 'warning');\r\n        }\r\n\r\n        setNewEvent({ title: \"\", date: \"\", time: \"10:00\", type: \"meeting\", description: \"\", location: \"\" });\r\n        setIsAddModalOpen(false);\r\n    };\r\n\r\n    // 跳轉到今天\r\n    const goToToday = () => {\r\n        setCurrentDate(new Date());\r\n    };\r\n\r\n    // 同步事件到 Google Calendar\r\n    const handleSyncEvent = async () => {\r\n        if (!selectedEvent || selectedEvent.type === 'loan') return;\r\n\r\n        setIsSyncing(true);\r\n        try {\r\n            await syncEventToGoogle(selectedEvent.id);\r\n            // Update local event status\r\n            const updatedEvents = localEvents.map(evt =>\r\n                evt.id === selectedEvent.id\r\n                    ? { ...evt, syncStatus: 'SYNCED', lastSyncedAt: new Date().toISOString() }\r\n                    : evt\r\n            );\r\n            setLocalEvents(updatedEvents);\r\n            if (onUpdateCalendar) onUpdateCalendar(updatedEvents);\r\n            setSelectedEvent(prev => ({ ...prev, syncStatus: 'SYNCED' }));\r\n            addToast('✅ 事件已同步至 Google Calendar', 'success');\r\n        } catch (error) {\r\n            console.error('Sync event failed:', error);\r\n            const updatedEvents = localEvents.map(evt =>\r\n                evt.id === selectedEvent.id\r\n                    ? { ...evt, syncStatus: 'FAILED', lastSyncError: error.message }\r\n                    : evt\r\n            );\r\n            setLocalEvents(updatedEvents);\r\n            setSelectedEvent(prev => ({ ...prev, syncStatus: 'FAILED', lastSyncError: error.message }));\r\n            addToast(`同步失敗: ${error.message}`, 'error');\r\n        } finally {\r\n            setIsSyncing(false);\r\n        }\r\n    };\r\n\r\n    const today = new Date();\r\n    const todayStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;\r\n\r\n    return (\r\n        <div className=\"space-y-4 sm:space-y-6 animate-fade-in\">\r\n            <SectionTitle title=\"行程管理\" />\r\n\r\n            {/* 頂部控制列 */}\r\n            <div className=\"flex flex-wrap items-center gap-3\">\r\n                {/* 月份導航 */}\r\n                <div className=\"flex items-center gap-2 bg-white p-2 rounded-2xl shadow-sm border border-gray-100\">\r\n                    <button\r\n                        onClick={() => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() - 1, 1))}\r\n                        className=\"p-2 hover:bg-gray-100 rounded-xl transition-colors\"\r\n                    >\r\n                        <ChevronLeft size={20} />\r\n                    </button>\r\n                    <span className=\"text-lg font-bold text-gray-800 w-32 text-center select-none\">\r\n                        {currentDate.getFullYear()} 年 {currentDate.getMonth() + 1} 月\r\n                    </span>\r\n                    <button\r\n                        onClick={() => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 1))}\r\n                        className=\"p-2 hover:bg-gray-100 rounded-xl transition-colors\"\r\n                    >\r\n                        <ChevronRight size={20} />\r\n                    </button>\r\n                </div>\r\n\r\n                {/* 今天按鈕 */}\r\n                <button\r\n                    onClick={goToToday}\r\n                    className=\"px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded-xl text-sm font-medium transition-colors\"\r\n                >\r\n                    今天\r\n                </button>\r\n\r\n                {/* 假日顯示開關 */}\r\n                <button\r\n                    onClick={() => setShowHolidays(!showHolidays)}\r\n                    className={`flex items-center gap-2 px-4 py-2 rounded-xl text-sm font-medium transition-colors ${showHolidays\r\n                        ? 'bg-red-100 text-red-700 hover:bg-red-200'\r\n                        : 'bg-gray-100 text-gray-600 hover:bg-gray-200'\r\n                        }`}\r\n                >\r\n                    <CalendarDays size={16} />\r\n                    台灣假日\r\n                </button>\r\n\r\n                {/* 貸款還款提醒開關 */}\r\n                {loans.length > 0 && (\r\n                    <button\r\n                        onClick={() => setShowLoanReminders(!showLoanReminders)}\r\n                        className={`flex items-center gap-2 px-4 py-2 rounded-xl text-sm font-medium transition-colors ${showLoanReminders\r\n                            ? 'bg-blue-100 text-blue-700 hover:bg-blue-200'\r\n                            : 'bg-gray-100 text-gray-600 hover:bg-gray-200'\r\n                            }`}\r\n                    >\r\n                        <Building2 size={16} />\r\n                        貸款提醒\r\n                    </button>\r\n                )}\r\n\r\n                {/* 新增行程 */}\r\n                <button\r\n                    onClick={() => setIsAddModalOpen(true)}\r\n                    className=\"ml-auto bg-morandi-text-accent text-white px-4 py-2 rounded-xl text-sm font-medium hover:shadow-lg transition-all flex items-center gap-2\"\r\n                >\r\n                    <Plus size={16} />\r\n                    新增行程\r\n                </button>\r\n            </div>\r\n\r\n            {/* 日曆 */}\r\n            <div className=\"flex-1 bg-white rounded-3xl border border-gray-100 shadow-sm overflow-hidden flex flex-col\">\r\n                {/* 星期標題 */}\r\n                <div className=\"grid grid-cols-7 border-b border-gray-100 bg-gray-50/50\">\r\n                    {['日', '一', '二', '三', '四', '五', '六'].map((d, idx) => (\r\n                        <div\r\n                            key={d}\r\n                            className={`py-4 text-center text-sm font-bold ${idx === 0 || idx === 6 ? 'text-red-400' : 'text-gray-400'\r\n                                }`}\r\n                        >\r\n                            {d}\r\n                        </div>\r\n                    ))}\r\n                </div>\r\n\r\n                {/* 日期格子 */}\r\n                <div className=\"flex-1 grid grid-cols-7 auto-rows-fr\">\r\n                    {days.map((day, idx) => {\r\n                        const dateStr = day ? `${currentDate.getFullYear()}-${String(currentDate.getMonth() + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}` : '';\r\n                        const events = allEvents.filter(e => e.date === dateStr);\r\n                        const holiday = showHolidays && day ? getHoliday(dateStr) : null;\r\n                        const weekend = day ? isWeekend(dateStr) : false;\r\n                        const isToday = dateStr === todayStr;\r\n                        const hasLoanEvent = events.some(e => e.type === 'loan');\r\n\r\n                        return (\r\n                            <div\r\n                                key={idx}\r\n                                className={`border-b border-r border-gray-50 p-2 min-h-[100px] transition-colors ${!day ? 'bg-gray-50/20' : 'hover:bg-gray-50'\r\n                                    } ${isToday ? 'bg-blue-50/50' : ''}`}\r\n                            >\r\n                                {day && (\r\n                                    <>\r\n                                        {/* 日期數字 */}\r\n                                        <div className={`w-7 h-7 rounded-full flex items-center justify-center text-sm mb-1 ${isToday\r\n                                            ? 'bg-blue-500 text-white font-bold shadow-md'\r\n                                            : hasLoanEvent\r\n                                                ? 'bg-indigo-500 text-white font-bold shadow-md'\r\n                                                : events.length > 0\r\n                                                    ? 'bg-morandi-text-accent text-white font-bold shadow-md'\r\n                                                    : holiday || weekend\r\n                                                        ? 'text-red-500 font-medium'\r\n                                                        : 'text-gray-500'\r\n                                            }`}>\r\n                                            {day}\r\n                                        </div>\r\n\r\n                                        {/* 假日名稱 */}\r\n                                        {holiday && (\r\n                                            <div className=\"text-[10px] text-red-500 font-medium truncate mb-1\">\r\n                                                {holiday}\r\n                                            </div>\r\n                                        )}\r\n\r\n                                        {/* 行程 */}\r\n                                        <div className=\"space-y-1\">\r\n                                            {events.map(evt => (\r\n                                                <div\r\n                                                    key={evt.id}\r\n                                                    onClick={(e) => {\r\n                                                        e.stopPropagation();\r\n                                                        setSelectedEvent(evt);\r\n                                                    }}\r\n                                                    className={`text-[10px] px-2 py-1 rounded-lg border truncate cursor-pointer ${evt.type === 'loan'\r\n                                                        ? 'bg-indigo-100/50 text-indigo-700 border-indigo-200 hover:bg-indigo-100'\r\n                                                        : 'bg-morandi-blue-100/50 text-morandi-blue-600 border-morandi-blue-100 hover:bg-morandi-blue-100'\r\n                                                        }`}\r\n                                                >\r\n                                                    {evt.type === 'loan' ? `🏦 $${evt.amount?.toLocaleString() || ''} ` : `${evt.time} `}{evt.title}\r\n                                                </div>\r\n                                            ))}\r\n                                        </div>\r\n                                    </>\r\n                                )}\r\n                            </div>\r\n                        );\r\n                    })}\r\n                </div>\r\n            </div>\r\n\r\n            {/* 新增行程 Modal */}\r\n            <Modal\r\n                isOpen={isAddModalOpen}\r\n                onClose={() => { setIsAddModalOpen(false); setIsSaving(false); }}\r\n                title=\"新增行程\"\r\n                onConfirm={handleAddEvent}\r\n                confirmDisabled={isSaving}\r\n                confirmText={isSaving ? '處理中...' : '確定'}\r\n            >\r\n                <InputField\r\n                    label=\"標題\"\r\n                    value={newEvent.title}\r\n                    onChange={e => setNewEvent({ ...newEvent, title: e.target.value })}\r\n                    placeholder=\"例：客戶會議\"\r\n                />\r\n                <div className=\"grid grid-cols-1 sm:grid-cols-2 gap-4\">\r\n                    <InputField\r\n                        label=\"日期\"\r\n                        type=\"date\"\r\n                        value={newEvent.date}\r\n                        onChange={e => setNewEvent({ ...newEvent, date: e.target.value })}\r\n                    />\r\n                    <InputField\r\n                        label=\"時間\"\r\n                        type=\"time\"\r\n                        value={newEvent.time}\r\n                        onChange={e => setNewEvent({ ...newEvent, time: e.target.value })}\r\n                    />\r\n                </div>\r\n                <LocationField\r\n                    label=\"地點\"\r\n                    value={newEvent.location}\r\n                    onChange={e => setNewEvent({ ...newEvent, location: e.target.value })}\r\n                    placeholder=\"例：台北市信義區松智路1號\"\r\n                />\r\n                <InputField\r\n                    label=\"描述\"\r\n                    value={newEvent.description}\r\n                    onChange={e => setNewEvent({ ...newEvent, description: e.target.value })}\r\n                    placeholder=\"備註...\"\r\n                />\r\n            </Modal>\r\n\r\n            {/* 事件詳情 Modal */}\r\n            <Modal\r\n                isOpen={!!selectedEvent}\r\n                onClose={() => setSelectedEvent(null)}\r\n                title={selectedEvent?.type === 'loan' ? '貸款還款提醒' : '行程詳情'}\r\n            >\r\n                {selectedEvent && (\r\n                    <div className=\"space-y-4\">\r\n                        <div className=\"text-lg font-bold text-gray-800\">{selectedEvent.title}</div>\r\n\r\n                        <div className=\"space-y-2 text-sm\">\r\n                            <div className=\"flex items-center gap-2 text-gray-600\">\r\n                                <CalendarDays size={16} />\r\n                                <span>{selectedEvent.date}</span>\r\n                                {selectedEvent.time && <span>• {selectedEvent.time}</span>}\r\n                            </div>\r\n\r\n                            {selectedEvent.location && (\r\n                                <div className=\"flex items-center gap-2 text-gray-600\">\r\n                                    <MapPin size={16} />\r\n                                    <span>{selectedEvent.location}</span>\r\n                                </div>\r\n                            )}\r\n\r\n                            {selectedEvent.description && (\r\n                                <div className=\"flex items-start gap-2 text-gray-600\">\r\n                                    <FileText size={16} className=\"mt-0.5\" />\r\n                                    <span>{selectedEvent.description}</span>\r\n                                </div>\r\n                            )}\r\n                        </div>\r\n\r\n                        {/* Google Calendar 同步狀態與按鈕 */}\r\n                        {selectedEvent.type !== 'loan' && (\r\n                            <div className=\"border-t border-gray-100 pt-4 space-y-3\">\r\n                                <div className=\"flex items-center justify-between\">\r\n                                    <span className=\"text-sm text-gray-500\">Google Calendar 同步</span>\r\n                                    <SyncStatusBadge\r\n                                        status={selectedEvent.syncStatus || 'PENDING'}\r\n                                        error={selectedEvent.lastSyncError}\r\n                                    />\r\n                                </div>\r\n\r\n                                {canSyncEvent && (\r\n                                    <button\r\n                                        onClick={handleSyncEvent}\r\n                                        disabled={\r\n                                            isSyncing ||\r\n                                            !googleStatus?.connected ||\r\n                                            !googleStatus?.calendarId ||\r\n                                            selectedEvent.syncStatus === 'DISABLED'\r\n                                        }\r\n                                        className=\"w-full bg-blue-500 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-blue-600 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2 transition-colors\"\r\n                                        title={\r\n                                            !googleStatus?.connected ? '請先連結 Google 帳號' :\r\n                                                !googleStatus?.calendarId ? '請先設定目標日曆' :\r\n                                                    '同步至 Google Calendar'\r\n                                        }\r\n                                    >\r\n                                        <RefreshCw size={16} className={isSyncing ? 'animate-spin' : ''} />\r\n                                        {isSyncing ? '同步中...' : 'Sync to Google Calendar'}\r\n                                    </button>\r\n                                )}\r\n\r\n                                {!googleStatus?.connected && canSyncEvent && (\r\n                                    <p className=\"text-xs text-amber-600 text-center\">\r\n                                        請先至「設定 → 整合」連結 Google 帳號\r\n                                    </p>\r\n                                )}\r\n                            </div>\r\n                        )}\r\n                    </div>\r\n                )}\r\n            </Modal>\r\n        </div >\r\n    );\r\n};\r\n\r\nexport default Schedule;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\xiang\\senteng-frontend\\src\\pages\\UserManagement.jsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'loadData'. Either include it or remove the dependency array.","line":69,"column":8,"nodeType":"ArrayExpression","endLine":69,"endColumn":10,"suggestions":[{"desc":"Update the dependencies array to be: [loadData]","fix":{"range":[2304,2306],"text":"[loadData]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// User Management Page (Super Admin Only)\r\nimport React, { useState, useEffect } from 'react';\r\nimport {\r\n    Users,\r\n    Shield,\r\n    ChevronDown,\r\n    Search,\r\n    MoreVertical,\r\n    Trash2,\r\n    Edit3,\r\n    Check,\r\n    X,\r\n    UserCog,\r\n    Eye,\r\n    EyeOff,\r\n    Save,\r\n    RefreshCw\r\n} from 'lucide-react';\r\nimport { useAuth } from '../context/AuthContext';\r\nimport {\r\n    getAllUsers,\r\n    getAllRoles,\r\n    updateUserRole,\r\n    updateRoleConfig,\r\n    deleteUser,\r\n    DEFAULT_ROLES,\r\n} from '../services/firebase';\r\n\r\n// All available pages for permission configuration\r\nconst ALL_PAGES = [\r\n    { id: 'dashboard', label: '儀表板', icon: '📊' },\r\n    { id: 'schedule', label: '行程管理', icon: '📅' },\r\n    { id: 'projects', label: '專案管理', icon: '💼' },\r\n    { id: 'quotations', label: '估價單', icon: '📝' },\r\n    { id: 'payments', label: '請款管理', icon: '🧾' },\r\n    { id: 'contracts', label: '合約管理', icon: '📋' },\r\n    { id: 'profit', label: '利潤分析', icon: '📊' },\r\n    { id: 'clients', label: '客戶管理', icon: '👥' },\r\n    { id: 'finance', label: '財務管理', icon: '💰' },\r\n    { id: 'vendors', label: '廠商管理', icon: '🏗️' },\r\n    { id: 'inventory', label: '庫存管理', icon: '📦' },\r\n    { id: 'materials', label: '建材資料', icon: '🖼️' },\r\n    { id: 'invoice', label: '發票小幫手', icon: '📜' },\r\n    { id: 'unit', label: '單位換算', icon: '📐' },\r\n    { id: 'cost', label: '成本估算', icon: '🧮' },\r\n    { id: 'calc', label: '物料換算', icon: '🏢' },\r\n];\r\n\r\n// Role level labels\r\nconst ROLE_LABELS = {\r\n    super_admin: { label: '最高管理員', color: 'bg-purple-500', textColor: 'text-purple-600' },\r\n    admin: { label: '管理員', color: 'bg-blue-500', textColor: 'text-blue-600' },\r\n    user: { label: '一般使用者', color: 'bg-gray-400', textColor: 'text-gray-600' },\r\n};\r\n\r\nconst UserManagement = ({ addToast }) => {\r\n    const { user: currentUser } = useAuth();\r\n    const [users, setUsers] = useState([]);\r\n    const [roles, setRoles] = useState([]);\r\n    const [loading, setLoading] = useState(true);\r\n    const [searchQuery, setSearchQuery] = useState('');\r\n    const [activeTab, setActiveTab] = useState('users'); // 'users' | 'roles'\r\n    const [editingRole, setEditingRole] = useState(null);\r\n    const [rolePermissions, setRolePermissions] = useState({});\r\n\r\n    // Load users and roles\r\n    useEffect(() => {\r\n        loadData();\r\n    }, []);\r\n\r\n    const loadData = async () => {\r\n        try {\r\n            setLoading(true);\r\n            const [usersData, rolesData] = await Promise.all([\r\n                getAllUsers(),\r\n                getAllRoles(),\r\n            ]);\r\n            setUsers(usersData);\r\n            setRoles(rolesData);\r\n\r\n            // Initialize role permissions\r\n            const permissions = {};\r\n            rolesData.forEach(role => {\r\n                permissions[role.name] = role.allowedPages || [];\r\n            });\r\n            setRolePermissions(permissions);\r\n        } catch (error) {\r\n            console.error('Error loading data:', error);\r\n            addToast?.('載入資料失敗', 'error');\r\n        } finally {\r\n            setLoading(false);\r\n        }\r\n    };\r\n\r\n    // Handle role change for a user\r\n    const handleRoleChange = async (userId, newRole) => {\r\n        if (userId === currentUser?.uid) {\r\n            addToast?.('無法更改自己的角色', 'warning');\r\n            return;\r\n        }\r\n\r\n        try {\r\n            await updateUserRole(userId, newRole);\r\n            setUsers(prev => prev.map(u =>\r\n                u.uid === userId ? { ...u, role: newRole } : u\r\n            ));\r\n            addToast?.('角色已更新', 'success');\r\n        } catch (error) {\r\n            console.error('Error updating role:', error);\r\n            addToast?.('更新角色失敗', 'error');\r\n        }\r\n    };\r\n\r\n    // Handle delete user\r\n    const handleDeleteUser = async (userId) => {\r\n        if (userId === currentUser?.uid) {\r\n            addToast?.('無法刪除自己的帳號', 'warning');\r\n            return;\r\n        }\r\n\r\n        if (!window.confirm('確定要刪除此使用者嗎？')) return;\r\n\r\n        try {\r\n            await deleteUser(userId);\r\n            setUsers(prev => prev.filter(u => u.uid !== userId));\r\n            addToast?.('使用者已刪除', 'success');\r\n        } catch (error) {\r\n            console.error('Error deleting user:', error);\r\n            addToast?.('刪除使用者失敗', 'error');\r\n        }\r\n    };\r\n\r\n    // Toggle page permission for a role\r\n    const togglePagePermission = (roleName, pageId) => {\r\n        if (roleName === 'super_admin') {\r\n            addToast?.('無法修改最高管理員權限', 'warning');\r\n            return;\r\n        }\r\n\r\n        setRolePermissions(prev => {\r\n            const current = prev[roleName] || [];\r\n            const updated = current.includes(pageId)\r\n                ? current.filter(p => p !== pageId)\r\n                : [...current, pageId];\r\n            return { ...prev, [roleName]: updated };\r\n        });\r\n    };\r\n\r\n    // Save role permissions\r\n    const saveRolePermissions = async (roleName) => {\r\n        try {\r\n            const roleConfig = roles.find(r => r.name === roleName);\r\n            await updateRoleConfig(roleName, {\r\n                ...roleConfig,\r\n                allowedPages: rolePermissions[roleName],\r\n            });\r\n            addToast?.('權限已儲存', 'success');\r\n            setEditingRole(null);\r\n            loadData();\r\n        } catch (error) {\r\n            console.error('Error saving permissions:', error);\r\n            addToast?.('儲存權限失敗', 'error');\r\n        }\r\n    };\r\n\r\n    // Filter users by search\r\n    const filteredUsers = users.filter(u =>\r\n        u.displayName?.toLowerCase().includes(searchQuery.toLowerCase()) ||\r\n        u.email?.toLowerCase().includes(searchQuery.toLowerCase())\r\n    );\r\n\r\n    // Format date\r\n    const formatDate = (timestamp) => {\r\n        if (!timestamp) return '-';\r\n        const date = timestamp.toDate?.() || new Date(timestamp);\r\n        return date.toLocaleDateString('zh-TW', {\r\n            year: 'numeric',\r\n            month: '2-digit',\r\n            day: '2-digit',\r\n            hour: '2-digit',\r\n            minute: '2-digit',\r\n        });\r\n    };\r\n\r\n    if (loading) {\r\n        return (\r\n            <div className=\"flex items-center justify-center h-64\">\r\n                <div className=\"flex flex-col items-center gap-4\">\r\n                    <div className=\"w-12 h-12 border-4 border-gray-200 border-t-gray-600 rounded-full animate-spin\" />\r\n                    <p className=\"text-gray-500 text-sm\">載入中...</p>\r\n                </div>\r\n            </div>\r\n        );\r\n    }\r\n\r\n    return (\r\n        <div className=\"space-y-6\">\r\n            {/* Header */}\r\n            <div className=\"flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4\">\r\n                <div>\r\n                    <h1 className=\"text-2xl font-bold text-gray-800\">使用者管理</h1>\r\n                    <p className=\"text-sm text-gray-500 mt-1\">管理使用者帳號與權限設定</p>\r\n                </div>\r\n\r\n                <button\r\n                    onClick={loadData}\r\n                    className=\"flex items-center gap-2 px-4 py-2 text-sm text-gray-600 hover:text-gray-800 bg-white rounded-xl border border-gray-200 hover:border-gray-300 transition-all\"\r\n                >\r\n                    <RefreshCw size={16} />\r\n                    重新整理\r\n                </button>\r\n            </div>\r\n\r\n            {/* Tabs */}\r\n            <div className=\"flex gap-2 p-1 bg-gray-100 rounded-xl w-fit\">\r\n                <button\r\n                    onClick={() => setActiveTab('users')}\r\n                    className={`flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-medium transition-all ${activeTab === 'users'\r\n                        ? 'bg-white text-gray-800 shadow-sm'\r\n                        : 'text-gray-500 hover:text-gray-700'\r\n                        }`}\r\n                >\r\n                    <Users size={16} />\r\n                    使用者列表\r\n                </button>\r\n                <button\r\n                    onClick={() => setActiveTab('roles')}\r\n                    className={`flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-medium transition-all ${activeTab === 'roles'\r\n                        ? 'bg-white text-gray-800 shadow-sm'\r\n                        : 'text-gray-500 hover:text-gray-700'\r\n                        }`}\r\n                >\r\n                    <Shield size={16} />\r\n                    角色權限\r\n                </button>\r\n            </div>\r\n\r\n            {/* Users Tab */}\r\n            {activeTab === 'users' && (\r\n                <div className=\"bg-white rounded-2xl border border-gray-100 shadow-sm overflow-hidden\">\r\n                    {/* Search */}\r\n                    <div className=\"p-4 border-b border-gray-100\">\r\n                        <div className=\"relative max-w-md\">\r\n                            <Search size={18} className=\"absolute left-3 top-1/2 -translate-y-1/2 text-gray-400\" />\r\n                            <input\r\n                                type=\"text\"\r\n                                placeholder=\"搜尋使用者名稱或 Email...\"\r\n                                value={searchQuery}\r\n                                onChange={(e) => setSearchQuery(e.target.value)}\r\n                                className=\"w-full pl-10 pr-4 py-2.5 border border-gray-200 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-gray-200 transition-all\"\r\n                            />\r\n                        </div>\r\n                    </div>\r\n\r\n                    {/* Users Table */}\r\n                    <div className=\"overflow-x-auto\">\r\n                        <table className=\"w-full\">\r\n                            <thead>\r\n                                <tr className=\"bg-gray-50 text-left text-xs text-gray-500 uppercase tracking-wider\">\r\n                                    <th className=\"px-6 py-3 font-medium\">使用者</th>\r\n                                    <th className=\"px-6 py-3 font-medium\">角色</th>\r\n                                    <th className=\"px-6 py-3 font-medium hidden md:table-cell\">建立時間</th>\r\n                                    <th className=\"px-6 py-3 font-medium hidden md:table-cell\">最後登入</th>\r\n                                    <th className=\"px-6 py-3 font-medium text-right\">操作</th>\r\n                                </tr>\r\n                            </thead>\r\n                            <tbody className=\"divide-y divide-gray-100\">\r\n                                {filteredUsers.map(user => (\r\n                                    <tr key={user.uid} className=\"hover:bg-gray-50/50 transition-colors\">\r\n                                        <td className=\"px-6 py-4\">\r\n                                            <div className=\"flex items-center gap-3\">\r\n                                                {user.photoURL ? (\r\n                                                    <img\r\n                                                        src={user.photoURL}\r\n                                                        alt={user.displayName}\r\n                                                        className=\"w-10 h-10 rounded-full object-cover\"\r\n                                                    />\r\n                                                ) : (\r\n                                                    <div className=\"w-10 h-10 bg-gray-200 rounded-full flex items-center justify-center\">\r\n                                                        <span className=\"text-sm font-medium text-gray-600\">\r\n                                                            {user.displayName?.[0] || user.email?.[0] || '?'}\r\n                                                        </span>\r\n                                                    </div>\r\n                                                )}\r\n                                                <div>\r\n                                                    <p className=\"text-sm font-medium text-gray-800\">{user.displayName}</p>\r\n                                                    <p className=\"text-xs text-gray-500\">{user.email}</p>\r\n                                                </div>\r\n                                            </div>\r\n                                        </td>\r\n                                        <td className=\"px-6 py-4\">\r\n                                            <select\r\n                                                value={user.role}\r\n                                                onChange={(e) => handleRoleChange(user.uid, e.target.value)}\r\n                                                disabled={user.uid === currentUser?.uid}\r\n                                                className={`\r\n                          px-3 py-1.5 text-xs font-medium rounded-lg border-0 cursor-pointer\r\n                          ${ROLE_LABELS[user.role]?.color || 'bg-gray-400'} text-white\r\n                          ${user.uid === currentUser?.uid ? 'opacity-60 cursor-not-allowed' : ''}\r\n                          focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-400\r\n                        `}\r\n                                            >\r\n                                                <option value=\"super_admin\">最高管理員</option>\r\n                                                <option value=\"admin\">管理員</option>\r\n                                                <option value=\"user\">一般使用者</option>\r\n                                            </select>\r\n                                        </td>\r\n                                        <td className=\"px-6 py-4 hidden md:table-cell\">\r\n                                            <span className=\"text-sm text-gray-500\">{formatDate(user.createdAt)}</span>\r\n                                        </td>\r\n                                        <td className=\"px-6 py-4 hidden md:table-cell\">\r\n                                            <span className=\"text-sm text-gray-500\">{formatDate(user.lastLogin)}</span>\r\n                                        </td>\r\n                                        <td className=\"px-6 py-4 text-right\">\r\n                                            {user.uid !== currentUser?.uid && (\r\n                                                <button\r\n                                                    onClick={() => handleDeleteUser(user.uid)}\r\n                                                    className=\"p-2 text-gray-400 hover:text-red-500 hover:bg-red-50 rounded-lg transition-colors\"\r\n                                                    title=\"刪除使用者\"\r\n                                                >\r\n                                                    <Trash2 size={16} />\r\n                                                </button>\r\n                                            )}\r\n                                        </td>\r\n                                    </tr>\r\n                                ))}\r\n                            </tbody>\r\n                        </table>\r\n\r\n                        {filteredUsers.length === 0 && (\r\n                            <div className=\"text-center py-12 text-gray-500\">\r\n                                <Users size={48} className=\"mx-auto mb-4 opacity-30\" />\r\n                                <p>找不到符合的使用者</p>\r\n                            </div>\r\n                        )}\r\n                    </div>\r\n                </div>\r\n            )}\r\n\r\n            {/* Roles Tab */}\r\n            {activeTab === 'roles' && (\r\n                <div className=\"space-y-6\">\r\n                    {Object.keys(DEFAULT_ROLES).map(roleName => (\r\n                        <div key={roleName} className=\"bg-white rounded-2xl border border-gray-100 shadow-sm overflow-hidden\">\r\n                            {/* Role Header */}\r\n                            <div className=\"px-6 py-4 bg-gray-50 border-b border-gray-100 flex items-center justify-between\">\r\n                                <div className=\"flex items-center gap-3\">\r\n                                    <div className={`w-3 h-3 rounded-full ${ROLE_LABELS[roleName]?.color}`} />\r\n                                    <div>\r\n                                        <h3 className=\"font-semibold text-gray-800\">{ROLE_LABELS[roleName]?.label}</h3>\r\n                                        <p className=\"text-xs text-gray-500\">\r\n                                            權限等級: {DEFAULT_ROLES[roleName]?.level} |\r\n                                            可訪問 {rolePermissions[roleName]?.length || 0} 個頁面\r\n                                        </p>\r\n                                    </div>\r\n                                </div>\r\n\r\n                                {roleName !== 'super_admin' && (\r\n                                    <div className=\"flex items-center gap-2\">\r\n                                        {editingRole === roleName ? (\r\n                                            <>\r\n                                                <button\r\n                                                    onClick={() => saveRolePermissions(roleName)}\r\n                                                    className=\"flex items-center gap-1 px-3 py-1.5 text-sm text-white bg-green-500 hover:bg-green-600 rounded-lg transition-colors\"\r\n                                                >\r\n                                                    <Save size={14} />\r\n                                                    儲存\r\n                                                </button>\r\n                                                <button\r\n                                                    onClick={() => {\r\n                                                        setEditingRole(null);\r\n                                                        loadData();\r\n                                                    }}\r\n                                                    className=\"flex items-center gap-1 px-3 py-1.5 text-sm text-gray-600 hover:text-gray-800 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors\"\r\n                                                >\r\n                                                    <X size={14} />\r\n                                                    取消\r\n                                                </button>\r\n                                            </>\r\n                                        ) : (\r\n                                            <button\r\n                                                onClick={() => setEditingRole(roleName)}\r\n                                                className=\"flex items-center gap-1 px-3 py-1.5 text-sm text-gray-600 hover:text-gray-800 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors\"\r\n                                            >\r\n                                                <Edit3 size={14} />\r\n                                                編輯權限\r\n                                            </button>\r\n                                        )}\r\n                                    </div>\r\n                                )}\r\n                            </div>\r\n\r\n                            {/* Permission Grid */}\r\n                            <div className=\"p-6\">\r\n                                <div className=\"grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-3\">\r\n                                    {ALL_PAGES.map(page => {\r\n                                        const isAllowed = rolePermissions[roleName]?.includes(page.id);\r\n                                        const isEditing = editingRole === roleName;\r\n                                        const isLocked = roleName === 'super_admin';\r\n\r\n                                        return (\r\n                                            <button\r\n                                                key={page.id}\r\n                                                onClick={() => isEditing && !isLocked && togglePagePermission(roleName, page.id)}\r\n                                                disabled={!isEditing || isLocked}\r\n                                                className={`\r\n                          flex flex-col items-center gap-2 p-3 rounded-xl border-2 transition-all\r\n                          ${isAllowed\r\n                                                        ? 'bg-green-50 border-green-200 text-green-700'\r\n                                                        : 'bg-gray-50 border-gray-100 text-gray-400'\r\n                                                    }\r\n                          ${isEditing && !isLocked ? 'cursor-pointer hover:scale-105' : 'cursor-default'}\r\n                          ${isLocked ? 'opacity-60' : ''}\r\n                        `}\r\n                                            >\r\n                                                <span className=\"text-xl\">{page.icon}</span>\r\n                                                <span className=\"text-xs font-medium text-center leading-tight\">{page.label}</span>\r\n                                                {isAllowed ? (\r\n                                                    <Eye size={12} className=\"text-green-500\" />\r\n                                                ) : (\r\n                                                    <EyeOff size={12} className=\"text-gray-300\" />\r\n                                                )}\r\n                                            </button>\r\n                                        );\r\n                                    })}\r\n                                </div>\r\n                            </div>\r\n                        </div>\r\n                    ))}\r\n                </div>\r\n            )}\r\n        </div>\r\n    );\r\n};\r\n\r\nexport default UserManagement;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\xiang\\senteng-frontend\\src\\pages\\Vendors.jsx","messages":[{"ruleId":"no-unused-vars","severity":2,"message":"'useEffect' is defined but never used. Allowed unused vars must match /^[A-Z_]|^_/u.","line":2,"column":36,"nodeType":"Identifier","messageId":"unusedVar","endLine":2,"endColumn":45,"suggestions":[{"messageId":"removeVar","data":{"varName":"useEffect"},"fix":{"range":[35,46],"text":""},"desc":"Remove unused variable 'useEffect'."}]},{"ruleId":"no-unused-vars","severity":2,"message":"'Icon' is defined but never used. Allowed unused args must match /^_|^e$|^err$|^event$/u.","line":61,"column":27,"nodeType":"Identifier","messageId":"unusedVar","endLine":61,"endColumn":31,"suggestions":[{"messageId":"removeVar","data":{"varName":"Icon"},"fix":{"range":[2434,2445],"text":""},"desc":"Remove unused variable 'Icon'."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\r\nimport React, { useState, useMemo, useEffect } from 'react';\r\nimport { Modal } from '../components/common/Modal';\r\nimport { InputField } from '../components/common/InputField';\r\nimport { LocationField } from '../components/common/LocationField';\r\nimport { Card } from '../components/common/Card';\r\nimport { Badge } from '../components/common/Badge';\r\nimport { SectionTitle, LoadingSkeleton } from '../components/common/Indicators';\r\nimport {\r\n    Phone, Folder, Edit2, Trash2, Cloud, ChevronLeft, Save, Plus,\r\n    Search, HardHat, Star, Building, MapPin, User, Tag, X, ChevronRight,\r\n    ThumbsUp, ThumbsDown, MessageSquare, Clock, Wrench, Briefcase, Database\r\n} from 'lucide-react';\r\nimport { vendorsApi } from '../services/api';\r\nimport { GoogleService } from '../services/GoogleService';\r\nimport { ContactsSection } from '../components/common/ContactsSection';\r\n\r\n// 狀態配置\r\nconst STATUS_CONFIG = {\r\n    '長期合作': { color: 'green', bg: 'bg-green-100 text-green-700' },\r\n    '合作中': { color: 'blue', bg: 'bg-blue-100 text-blue-700' },\r\n    '觀察中': { color: 'yellow', bg: 'bg-yellow-100 text-yellow-700' },\r\n    '黑名單': { color: 'red', bg: 'bg-red-100 text-red-700' },\r\n};\r\n\r\n// 類別配置\r\nconst CATEGORY_CONFIG = {\r\n    '工程工班': { icon: HardHat, color: 'orange' },\r\n    '建材供應': { icon: Building, color: 'blue' },\r\n    '設備廠商': { icon: Wrench, color: 'purple' },\r\n    '其他': { icon: Tag, color: 'gray' },\r\n};\r\n\r\n// 星星評分組件\r\nconst StarRating = ({ rating, onChange, readonly = false }) => {\r\n    const stars = [1, 2, 3, 4, 5];\r\n    const currentRating = parseFloat(rating) || 0;\r\n\r\n    return (\r\n        <div className=\"flex items-center gap-1\">\r\n            {stars.map(star => (\r\n                <button\r\n                    key={star}\r\n                    type=\"button\"\r\n                    onClick={() => !readonly && onChange?.(star.toString())}\r\n                    className={`${readonly ? 'cursor-default' : 'cursor-pointer hover:scale-110'} transition-transform`}\r\n                    disabled={readonly}\r\n                >\r\n                    <Star\r\n                        size={readonly ? 14 : 20}\r\n                        className={star <= currentRating ? 'text-yellow-400 fill-yellow-400' : 'text-gray-300'}\r\n                    />\r\n                </button>\r\n            ))}\r\n            {!readonly && <span className=\"ml-2 text-sm text-gray-500\">{currentRating}/5</span>}\r\n        </div>\r\n    );\r\n};\r\n\r\n// 統計卡片\r\nconst StatCard = ({ icon: Icon, label, value, color = 'gray', onClick }) => (\r\n    <button\r\n        onClick={onClick}\r\n        className={`bg-white rounded-xl p-4 shadow-sm border border-gray-100 flex items-center gap-3 hover:shadow-md transition-all text-left w-full ${onClick ? 'cursor-pointer' : ''}`}\r\n    >\r\n        <div className={`w-10 h-10 rounded-full flex items-center justify-center ${color === 'blue' ? 'bg-blue-100 text-blue-600' :\r\n            color === 'green' ? 'bg-green-100 text-green-600' :\r\n                color === 'yellow' ? 'bg-yellow-100 text-yellow-600' :\r\n                    color === 'orange' ? 'bg-orange-100 text-orange-600' :\r\n                        color === 'red' ? 'bg-red-100 text-red-600' :\r\n                            'bg-gray-100 text-gray-600'\r\n            }`}>\r\n            <Icon size={20} />\r\n        </div>\r\n        <div>\r\n            <div className=\"text-2xl font-bold text-gray-800\">{value}</div>\r\n            <div className=\"text-xs text-gray-500\">{label}</div>\r\n        </div>\r\n    </button>\r\n);\r\n\r\n// 廠商列表項目\r\nconst VendorRow = ({ vendor, onSelect, onDelete }) => {\r\n    const statusConfig = STATUS_CONFIG[vendor.status] || STATUS_CONFIG['合作中'];\r\n    const categoryConfig = CATEGORY_CONFIG[vendor.category] || CATEGORY_CONFIG['其他'];\r\n    const CategoryIcon = categoryConfig.icon;\r\n\r\n    return (\r\n        <div\r\n            className=\"flex flex-col sm:flex-row sm:items-center justify-between p-3 sm:p-4 bg-white rounded-xl border border-gray-100 hover:shadow-md hover:border-gray-200 transition-all cursor-pointer group gap-2 sm:gap-0\"\r\n            onClick={() => onSelect(vendor)}\r\n        >\r\n            <div className=\"flex items-center gap-3 sm:gap-4 flex-1 min-w-0\">\r\n                <div className={`w-10 h-10 sm:w-12 sm:h-12 rounded-full flex items-center justify-center flex-shrink-0 ${categoryConfig.color === 'orange' ? 'bg-orange-100 text-orange-600' :\r\n                    categoryConfig.color === 'blue' ? 'bg-blue-100 text-blue-600' :\r\n                        categoryConfig.color === 'purple' ? 'bg-purple-100 text-purple-600' :\r\n                            'bg-gray-100 text-gray-600'\r\n                    }`}>\r\n                    <CategoryIcon size={20} className=\"sm:w-6 sm:h-6\" />\r\n                </div>\r\n                <div className=\"min-w-0 flex-1\">\r\n                    <div className=\"font-bold text-gray-800 flex items-center gap-2 flex-wrap\">\r\n                        <span className=\"truncate\">{vendor.name}</span>\r\n                        <span className={`text-xs px-2 py-0.5 rounded-full whitespace-nowrap ${statusConfig.bg}`}>\r\n                            {vendor.status}\r\n                        </span>\r\n                    </div>\r\n                    <div className=\"text-xs sm:text-sm text-gray-500 flex items-center gap-2 sm:gap-3 mt-1 flex-wrap\">\r\n                        {vendor.tradeType && <span className=\"flex items-center gap-1\"><Wrench size={12} /> {vendor.tradeType}</span>}\r\n                        {vendor.contactPerson && <span className=\"hidden sm:flex items-center gap-1\"><User size={12} /> {vendor.contactPerson}</span>}\r\n                        <StarRating rating={vendor.rating} readonly />\r\n                    </div>\r\n                </div>\r\n            </div>\r\n            <div className=\"flex items-center gap-2 self-end sm:self-auto\">\r\n                <button\r\n                    onClick={(e) => { e.stopPropagation(); onDelete(vendor.id); }}\r\n                    className=\"sm:opacity-0 sm:group-hover:opacity-100 p-2 text-red-400 hover:text-red-600 hover:bg-red-50 rounded-lg transition-all\"\r\n                >\r\n                    <Trash2 size={16} />\r\n                </button>\r\n                <ChevronRight size={20} className=\"text-gray-300\" />\r\n            </div>\r\n        </div>\r\n    );\r\n};\r\n\r\n// 評價記錄項目\r\nconst ReviewItem = ({ review }) => (\r\n    <div className=\"flex gap-3 p-3 bg-gray-50 rounded-lg\">\r\n        <div className={`w-8 h-8 rounded-full flex items-center justify-center flex-shrink-0 ${review.sentiment === 'positive' ? 'bg-green-100' : review.sentiment === 'negative' ? 'bg-red-100' : 'bg-gray-100'\r\n            }`}>\r\n            {review.sentiment === 'positive' ? <ThumbsUp size={14} className=\"text-green-600\" /> :\r\n                review.sentiment === 'negative' ? <ThumbsDown size={14} className=\"text-red-600\" /> :\r\n                    <MessageSquare size={14} className=\"text-gray-600\" />}\r\n        </div>\r\n        <div className=\"flex-1\">\r\n            <div className=\"text-sm font-medium text-gray-800\">{review.project}</div>\r\n            <div className=\"text-xs text-gray-500 mt-0.5\">{review.date} - {review.note}</div>\r\n        </div>\r\n    </div>\r\n);\r\n\r\nconst Vendors = ({ data = [], loading, addToast, onUpdateVendors, allProjects = [] }) => {\r\n    // 狀態管理\r\n    const [vendorsList, setVendorsList] = useState(data);\r\n    const [activeVendor, setActiveVendor] = useState(null);\r\n    const [isModalOpen, setIsModalOpen] = useState(false);\r\n    const [currentVendor, setCurrentVendor] = useState(null);\r\n    const [isSaving, setIsSaving] = useState(false);\r\n    const [isEditing, setIsEditing] = useState(false);\r\n    const [isDeleteModalOpen, setIsDeleteModalOpen] = useState(false);\r\n    const [deletingVendor, setDeletingVendor] = useState(null);\r\n\r\n    // 搜尋與篩選\r\n    const [searchTerm, setSearchTerm] = useState('');\r\n    const [categoryFilter, setCategoryFilter] = useState('全部');\r\n    const [statusFilter, setStatusFilter] = useState('全部');\r\n\r\n    // 評價 Modal\r\n    const [isReviewModalOpen, setIsReviewModalOpen] = useState(false);\r\n    const [newReview, setNewReview] = useState({ project: '', date: new Date().toISOString().split('T')[0], note: '', sentiment: 'neutral' });\r\n\r\n    // 同步 data\r\n    React.useEffect(() => { setVendorsList(data); }, [data]);\r\n\r\n    // 計算統計\r\n    const stats = useMemo(() => ({\r\n        total: vendorsList.length,\r\n        crews: vendorsList.filter(v => v.category === '工程工班').length,\r\n        suppliers: vendorsList.filter(v => v.category === '建材供應').length,\r\n        longTerm: vendorsList.filter(v => v.status === '長期合作').length,\r\n    }), [vendorsList]);\r\n\r\n    // 篩選後的廠商列表\r\n    const filteredVendors = useMemo(() => {\r\n        return vendorsList.filter(vendor => {\r\n            const matchesSearch = searchTerm === '' ||\r\n                vendor.name?.toLowerCase().includes(searchTerm.toLowerCase()) ||\r\n                vendor.tradeType?.toLowerCase().includes(searchTerm.toLowerCase()) ||\r\n                vendor.contactPerson?.toLowerCase().includes(searchTerm.toLowerCase());\r\n            const matchesCategory = categoryFilter === '全部' || vendor.category === categoryFilter;\r\n            const matchesStatus = statusFilter === '全部' || vendor.status === statusFilter;\r\n            return matchesSearch && matchesCategory && matchesStatus;\r\n        });\r\n    }, [vendorsList, searchTerm, categoryFilter, statusFilter]);\r\n\r\n    // 操作函數\r\n    const handleOpenAdd = () => {\r\n        setCurrentVendor({\r\n            name: \"\", category: \"工程工班\", tradeType: \"\", contactPerson: \"\",\r\n            phone: \"\", email: \"\", lineId: \"\", address: \"\", rating: \"5\", status: \"合作中\", tags: \"\", reviews: []\r\n        });\r\n        setIsModalOpen(true);\r\n    };\r\n\r\n    const handleSaveVendor = async () => {\r\n        if (!currentVendor.name) return addToast(\"請輸入廠商名稱\", 'error');\r\n\r\n        setIsSaving(true);\r\n        try {\r\n            const tagsArray = typeof currentVendor.tags === 'string'\r\n                ? currentVendor.tags.split(',').map(t => t.trim()).filter(t => t !== \"\")\r\n                : currentVendor.tags || [];\r\n\r\n            const vendorData = {\r\n                name: currentVendor.name,\r\n                category: currentVendor.category,\r\n                tradeType: currentVendor.tradeType,\r\n                contactPerson: currentVendor.contactPerson,\r\n                phone: currentVendor.phone,\r\n                email: currentVendor.email,\r\n                lineId: currentVendor.lineId,\r\n                address: currentVendor.address,\r\n                taxId: currentVendor.taxId,\r\n                bankAccount: currentVendor.bankAccount,\r\n                rating: parseFloat(currentVendor.rating) || 5,\r\n                status: currentVendor.status,\r\n                tags: tagsArray,\r\n                driveFolder: currentVendor.driveFolder,\r\n                reviews: currentVendor.reviews || [],\r\n            };\r\n\r\n            let savedVendor;\r\n            let driveResult = null;\r\n\r\n            if (currentVendor.id) {\r\n                // Update existing vendor\r\n                savedVendor = await vendorsApi.update(currentVendor.id, vendorData);\r\n                addToast(\"廠商資料已更新！\", 'success');\r\n            } else {\r\n                // Create Drive folder first (optional)\r\n                driveResult = await GoogleService.createVendorFolder(currentVendor.name);\r\n                if (driveResult.success) {\r\n                    vendorData.driveFolder = driveResult.url;\r\n                }\r\n                // Create new vendor via API\r\n                savedVendor = await vendorsApi.create(vendorData);\r\n                addToast(\"新廠商已建立！\", 'success', {\r\n                    action: driveResult?.url ? { label: '開啟 Drive', onClick: () => window.open(driveResult.url, '_blank') } : null\r\n                });\r\n            }\r\n\r\n            // Update local state\r\n            const newVendorsList = currentVendor.id\r\n                ? vendorsList.map(v => v.id === savedVendor.id ? savedVendor : v)\r\n                : [...vendorsList, savedVendor];\r\n            setVendorsList(newVendorsList);\r\n            if (onUpdateVendors) onUpdateVendors(newVendorsList);\r\n\r\n            setIsModalOpen(false);\r\n        } catch (error) {\r\n            console.error('Save vendor failed:', error);\r\n            addToast(`儲存失敗: ${error.message}`, 'error');\r\n        } finally {\r\n            setIsSaving(false);\r\n        }\r\n    };\r\n\r\n    // 開啟刪除確認 Modal\r\n    const openDeleteModal = (vendor) => {\r\n        setDeletingVendor(vendor);\r\n        setIsDeleteModalOpen(true);\r\n    };\r\n\r\n    // 確認刪除廠商\r\n    const confirmDeleteVendor = async () => {\r\n        if (!deletingVendor) return;\r\n\r\n        try {\r\n            await vendorsApi.delete(deletingVendor.id);\r\n            const updatedList = vendorsList.filter(v => v.id !== deletingVendor.id);\r\n            setVendorsList(updatedList);\r\n            if (onUpdateVendors) onUpdateVendors(updatedList);\r\n            addToast(`廠商「${deletingVendor.name}」已刪除！`, 'success');\r\n\r\n            if (activeVendor?.id === deletingVendor.id) setActiveVendor(null);\r\n        } catch (error) {\r\n            console.error('Delete vendor failed:', error);\r\n            addToast(`刪除失敗: ${error.message}`, 'error');\r\n        } finally {\r\n            setIsDeleteModalOpen(false);\r\n            setDeletingVendor(null);\r\n        }\r\n    };\r\n\r\n    const startEdit = () => {\r\n        setCurrentVendor({ ...activeVendor, tags: activeVendor.tags?.join(', ') || '' });\r\n        setIsEditing(true);\r\n    };\r\n\r\n    const handleSaveEdit = async () => {\r\n        setIsSaving(true);\r\n        try {\r\n            const tagsArray = typeof currentVendor.tags === 'string'\r\n                ? currentVendor.tags.split(',').map(t => t.trim()).filter(t => t !== \"\")\r\n                : currentVendor.tags || [];\r\n\r\n            const vendorData = {\r\n                name: currentVendor.name,\r\n                category: currentVendor.category,\r\n                tradeType: currentVendor.tradeType,\r\n                contactPerson: currentVendor.contactPerson,\r\n                phone: currentVendor.phone,\r\n                email: currentVendor.email,\r\n                lineId: currentVendor.lineId,\r\n                address: currentVendor.address,\r\n                taxId: currentVendor.taxId,\r\n                bankAccount: currentVendor.bankAccount,\r\n                rating: parseFloat(currentVendor.rating) || 5,\r\n                status: currentVendor.status,\r\n                tags: tagsArray,\r\n            };\r\n\r\n            const updatedVendor = await vendorsApi.update(currentVendor.id, vendorData);\r\n\r\n            const newList = vendorsList.map(v => v.id === updatedVendor.id ? updatedVendor : v);\r\n            setVendorsList(newList);\r\n            if (onUpdateVendors) onUpdateVendors(newList);\r\n\r\n            setActiveVendor(updatedVendor);\r\n            setIsEditing(false);\r\n            addToast(\"資料已更新\", 'success');\r\n        } catch (error) {\r\n            console.error('Update vendor failed:', error);\r\n            addToast(`更新失敗: ${error.message}`, 'error');\r\n        } finally {\r\n            setIsSaving(false);\r\n        }\r\n    };\r\n\r\n    // 新增評價\r\n    const handleAddReview = async () => {\r\n        if (!newReview.note) return addToast(\"請輸入評價內容\", \"error\");\r\n\r\n        try {\r\n            const updatedReviews = [...(activeVendor.reviews || []), { ...newReview, id: Date.now() }];\r\n\r\n            const updatedVendor = await vendorsApi.update(activeVendor.id, {\r\n                reviews: updatedReviews\r\n            });\r\n\r\n            const newList = vendorsList.map(v => v.id === updatedVendor.id ? updatedVendor : v);\r\n            setVendorsList(newList);\r\n            setActiveVendor(updatedVendor);\r\n            if (onUpdateVendors) onUpdateVendors(newList);\r\n\r\n            setIsReviewModalOpen(false);\r\n            setNewReview({ project: '', date: new Date().toISOString().split('T')[0], note: '', sentiment: 'neutral' });\r\n            addToast(\"評價已新增\", \"success\");\r\n        } catch (error) {\r\n            console.error('Add review failed:', error);\r\n            addToast(`新增評價失敗: ${error.message}`, 'error');\r\n        }\r\n    };\r\n\r\n    // 廠商詳情頁\r\n    if (activeVendor) {\r\n        const statusConfig = STATUS_CONFIG[activeVendor.status] || STATUS_CONFIG['合作中'];\r\n        const categoryConfig = CATEGORY_CONFIG[activeVendor.category] || CATEGORY_CONFIG['其他'];\r\n        const CategoryIcon = categoryConfig.icon;\r\n\r\n        return (\r\n            <div className=\"space-y-6 animate-fade-in\">\r\n                <button onClick={() => { setActiveVendor(null); setIsEditing(false); }} className=\"text-sm text-gray-500 hover:text-gray-900 flex items-center gap-1\">\r\n                    <ChevronLeft size={16} /> 返回列表\r\n                </button>\r\n\r\n                {/* 廠商標題 */}\r\n                <div className=\"bg-white rounded-2xl p-6 shadow-sm border border-gray-100\">\r\n                    <div className=\"flex flex-col sm:flex-row justify-between items-start gap-4\">\r\n                        <div className=\"flex items-center gap-4\">\r\n                            <div className={`w-16 h-16 rounded-full flex items-center justify-center ${categoryConfig.color === 'orange' ? 'bg-orange-100 text-orange-600' :\r\n                                categoryConfig.color === 'blue' ? 'bg-blue-100 text-blue-600' :\r\n                                    categoryConfig.color === 'purple' ? 'bg-purple-100 text-purple-600' :\r\n                                        'bg-gray-100 text-gray-600'\r\n                                }`}>\r\n                                <CategoryIcon size={32} />\r\n                            </div>\r\n                            <div>\r\n                                {isEditing ? (\r\n                                    <input\r\n                                        value={currentVendor.name}\r\n                                        onChange={e => setCurrentVendor({ ...currentVendor, name: e.target.value })}\r\n                                        className=\"text-2xl font-bold text-gray-900 border-b border-gray-300 focus:outline-none bg-transparent\"\r\n                                    />\r\n                                ) : (\r\n                                    <h2 className=\"text-2xl font-bold text-gray-900 flex items-center gap-2 flex-wrap\">\r\n                                        {activeVendor.name}\r\n                                        <span className={`text-sm px-3 py-1 rounded-full ${statusConfig.bg}`}>\r\n                                            {activeVendor.status}\r\n                                        </span>\r\n                                    </h2>\r\n                                )}\r\n                                <div className=\"flex items-center gap-3 mt-2 flex-wrap\">\r\n                                    <span className=\"text-sm text-gray-500\">{activeVendor.category} - {activeVendor.tradeType}</span>\r\n                                    <StarRating rating={activeVendor.rating} readonly />\r\n                                </div>\r\n                            </div>\r\n                        </div>\r\n                        <div className=\"flex flex-wrap gap-2\">\r\n                            {isEditing ? (\r\n                                <>\r\n                                    <button onClick={() => setIsEditing(false)} className=\"bg-white border border-gray-200 px-3 py-1.5 rounded-lg text-sm text-gray-600\">取消</button>\r\n                                    <button onClick={handleSaveEdit} disabled={isSaving} className=\"bg-green-500 text-white px-3 py-1.5 rounded-lg text-sm flex items-center gap-1 hover:bg-green-600 disabled:opacity-50\">\r\n                                        <Save size={14} /> {isSaving ? '儲存中...' : '儲存'}\r\n                                    </button>\r\n                                </>\r\n                            ) : (\r\n                                <>\r\n                                    {activeVendor.driveFolder && (\r\n                                        <a href={activeVendor.driveFolder} target=\"_blank\" rel=\"noreferrer\" className=\"bg-blue-50 text-blue-600 px-3 py-1.5 rounded-lg text-sm flex items-center gap-2 hover:bg-blue-100 border border-blue-100\">\r\n                                            <Folder size={16} /> 雲端資料夾\r\n                                        </a>\r\n                                    )}\r\n                                    <button onClick={startEdit} className=\"bg-white border border-gray-200 px-3 py-1.5 rounded-lg text-sm text-gray-600 hover:bg-gray-50 flex items-center gap-2\">\r\n                                        <Edit2 size={14} /> 編輯\r\n                                    </button>\r\n                                    <button onClick={() => openDeleteModal(activeVendor)} className=\"bg-white border border-red-200 text-red-500 px-3 py-1.5 rounded-lg text-sm hover:bg-red-50 flex items-center gap-2\">\r\n                                        <Trash2 size={14} /> 刪除\r\n                                    </button>\r\n                                </>\r\n                            )}\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n\r\n                {/* 內容區 */}\r\n                <div className=\"grid grid-cols-1 lg:grid-cols-3 gap-6\">\r\n                    {/* 基本資料 */}\r\n                    <Card className=\"lg:col-span-2\">\r\n                        <h3 className=\"font-bold text-gray-800 mb-4 flex items-center gap-2\">\r\n                            <HardHat size={18} /> 廠商資料\r\n                        </h3>\r\n                        {isEditing ? (\r\n                            <div className=\"space-y-4\">\r\n                                <div className=\"grid grid-cols-1 sm:grid-cols-2 gap-4\">\r\n                                    <div>\r\n                                        <label className=\"block text-sm text-gray-500 mb-1\">類別</label>\r\n                                        <select value={currentVendor.category} onChange={e => setCurrentVendor({ ...currentVendor, category: e.target.value })} className=\"w-full border rounded-lg px-3 py-2 bg-white\">\r\n                                            {Object.keys(CATEGORY_CONFIG).map(c => <option key={c} value={c}>{c}</option>)}\r\n                                        </select>\r\n                                    </div>\r\n                                    <InputField label=\"工種/項目\" value={currentVendor.tradeType} onChange={e => setCurrentVendor({ ...currentVendor, tradeType: e.target.value })} />\r\n                                </div>\r\n                                <div className=\"grid grid-cols-1 sm:grid-cols-2 gap-4\">\r\n                                    <InputField label=\"聯絡人\" value={currentVendor.contactPerson} onChange={e => setCurrentVendor({ ...currentVendor, contactPerson: e.target.value })} />\r\n                                    <InputField label=\"電話\" value={currentVendor.phone} onChange={e => setCurrentVendor({ ...currentVendor, phone: e.target.value })} />\r\n                                </div>\r\n                                <div className=\"grid grid-cols-1 sm:grid-cols-2 gap-4\">\r\n                                    <InputField label=\"統一編號\" value={currentVendor.taxId || ''} onChange={e => setCurrentVendor({ ...currentVendor, taxId: e.target.value })} placeholder=\"8位數統一編號\" />\r\n                                    <InputField label=\"銀行帳號\" value={currentVendor.bankAccount || ''} onChange={e => setCurrentVendor({ ...currentVendor, bankAccount: e.target.value })} placeholder=\"例：812-1234-5678-901\" />\r\n                                </div>\r\n                                <LocationField label=\"地址\" value={currentVendor.address} onChange={e => setCurrentVendor({ ...currentVendor, address: e.target.value })} />\r\n                                <div className=\"grid grid-cols-1 sm:grid-cols-2 gap-4\">\r\n                                    <div>\r\n                                        <label className=\"block text-sm text-gray-500 mb-1\">評分</label>\r\n                                        <StarRating rating={currentVendor.rating} onChange={(val) => setCurrentVendor({ ...currentVendor, rating: val })} />\r\n                                    </div>\r\n                                    <div>\r\n                                        <label className=\"block text-sm text-gray-500 mb-1\">狀態</label>\r\n                                        <select value={currentVendor.status} onChange={e => setCurrentVendor({ ...currentVendor, status: e.target.value })} className=\"w-full border rounded-lg px-3 py-2 bg-white\">\r\n                                            {Object.keys(STATUS_CONFIG).map(s => <option key={s} value={s}>{s}</option>)}\r\n                                        </select>\r\n                                    </div>\r\n                                </div>\r\n                                <InputField label=\"標籤 (逗號分隔)\" value={currentVendor.tags} onChange={e => setCurrentVendor({ ...currentVendor, tags: e.target.value })} placeholder=\"例：配合度高, 手工細緻\" />\r\n                            </div>\r\n                        ) : (\r\n                            <div className=\"grid grid-cols-1 sm:grid-cols-2 gap-4 text-sm\">\r\n                                <div>\r\n                                    <span className=\"text-gray-500 block mb-1\"><User size={14} className=\"inline mr-1\" />聯絡人</span>\r\n                                    <span className=\"text-gray-900\">{activeVendor.contactPerson || '-'}</span>\r\n                                </div>\r\n                                <div>\r\n                                    <span className=\"text-gray-500 block mb-1\"><Phone size={14} className=\"inline mr-1\" />電話</span>\r\n                                    <span className=\"text-gray-900\">{activeVendor.phone || '-'}</span>\r\n                                </div>\r\n                                {activeVendor.address && (\r\n                                    <div className=\"col-span-2\">\r\n                                        <span className=\"text-gray-500 block mb-1\"><MapPin size={14} className=\"inline mr-1\" />地址</span>\r\n                                        <span className=\"text-gray-900\">{activeVendor.address}</span>\r\n                                    </div>\r\n                                )}\r\n                                {activeVendor.email && (\r\n                                    <div>\r\n                                        <span className=\"text-gray-500 block mb-1\">Email</span>\r\n                                        <span className=\"text-gray-900\">{activeVendor.email}</span>\r\n                                    </div>\r\n                                )}\r\n                                {activeVendor.lineId && (\r\n                                    <div>\r\n                                        <span className=\"text-gray-500 block mb-1\">LINE ID</span>\r\n                                        <span className=\"text-gray-900\">{activeVendor.lineId}</span>\r\n                                    </div>\r\n                                )}\r\n                                {activeVendor.taxId && (\r\n                                    <div>\r\n                                        <span className=\"text-gray-500 block mb-1\">統一編號</span>\r\n                                        <span className=\"text-gray-900 font-mono\">{activeVendor.taxId}</span>\r\n                                    </div>\r\n                                )}\r\n                                {activeVendor.bankAccount && (\r\n                                    <div>\r\n                                        <span className=\"text-gray-500 block mb-1\">銀行帳號</span>\r\n                                        <span className=\"text-gray-900 font-mono\">{activeVendor.bankAccount}</span>\r\n                                    </div>\r\n                                )}\r\n                                {activeVendor.tags?.length > 0 && (\r\n                                    <div className=\"col-span-2\">\r\n                                        <span className=\"text-gray-500 block mb-1\"><Tag size={14} className=\"inline mr-1\" />標籤</span>\r\n                                        <div className=\"flex flex-wrap gap-2 mt-1\">\r\n                                            {activeVendor.tags.map((tag, idx) => (\r\n                                                <span key={idx} className=\"text-xs bg-gray-100 text-gray-700 px-2 py-1 rounded-full\">{tag}</span>\r\n                                            ))}\r\n                                        </div>\r\n                                    </div>\r\n                                )}\r\n                            </div>\r\n                        )}\r\n                    </Card>\r\n\r\n                    {/* 合作評價 */}\r\n                    <Card>\r\n                        <div className=\"flex justify-between items-center mb-4\">\r\n                            <h3 className=\"font-bold text-gray-800 flex items-center gap-2\">\r\n                                <MessageSquare size={18} /> 合作評價\r\n                            </h3>\r\n                            <button\r\n                                onClick={() => setIsReviewModalOpen(true)}\r\n                                className=\"text-sm text-blue-600 hover:text-blue-800 flex items-center gap-1\"\r\n                            >\r\n                                <Plus size={14} /> 新增\r\n                            </button>\r\n                        </div>\r\n                        <div className=\"space-y-2 max-h-80 overflow-y-auto\">\r\n                            {(activeVendor.reviews || []).length > 0 ? (\r\n                                activeVendor.reviews.slice().reverse().map((review, idx) => (\r\n                                    <ReviewItem key={idx} review={review} />\r\n                                ))\r\n                            ) : (\r\n                                <div className=\"text-sm text-gray-400 text-center py-8\">\r\n                                    尚無評價記錄\r\n                                </div>\r\n                            )}\r\n                        </div>\r\n                    </Card>\r\n\r\n                    {/* 聯絡人 (Google Contacts 同步) */}\r\n                    <Card className=\"lg:col-span-3\">\r\n                        <ContactsSection\r\n                            contacts={activeVendor.contacts || []}\r\n                            entityType=\"vendor\"\r\n                            entityId={activeVendor.id}\r\n                            onRefresh={() => {\r\n                                // Refetch vendor data\r\n                                vendorsApi.getById(activeVendor.id).then(updated => {\r\n                                    const newList = vendorsList.map(v => v.id === updated.id ? updated : v);\r\n                                    setVendorsList(newList);\r\n                                    setActiveVendor(updated);\r\n                                    if (onUpdateVendors) onUpdateVendors(newList);\r\n                                }).catch(console.error);\r\n                            }}\r\n                            addToast={addToast}\r\n                        />\r\n                    </Card>\r\n\r\n                    {/* 服務專案 */}\r\n                    <Card className=\"lg:col-span-3\">\r\n                        <h3 className=\"font-bold text-gray-800 mb-4 flex items-center gap-2\">\r\n                            <Briefcase size={18} /> 服務專案\r\n                        </h3>\r\n                        {(() => {\r\n                            const relatedProjects = allProjects.filter(p =>\r\n                                p.vendors?.some(v => v.name === activeVendor.name || v.id === activeVendor.id) ||\r\n                                p.vendorIds?.includes(activeVendor.id)\r\n                            );\r\n                            return relatedProjects.length > 0 ? (\r\n                                <div className=\"space-y-2\">\r\n                                    {relatedProjects.map(project => (\r\n                                        <div key={project.id} className=\"flex items-center justify-between p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors\">\r\n                                            <div className=\"flex items-center gap-3\">\r\n                                                <div className=\"w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center\">\r\n                                                    <Briefcase size={14} className=\"text-blue-600\" />\r\n                                                </div>\r\n                                                <div>\r\n                                                    <div className=\"font-medium text-gray-800\">{project.name}</div>\r\n                                                    <div className=\"text-xs text-gray-500\">\r\n                                                        {project.status || '進行中'} • {project.startDate || '未設定'}\r\n                                                    </div>\r\n                                                </div>\r\n                                            </div>\r\n                                            {project.folderUrl && (\r\n                                                <a href={project.folderUrl} target=\"_blank\" rel=\"noreferrer\" className=\"text-blue-500 hover:text-blue-700\">\r\n                                                    <Folder size={16} />\r\n                                                </a>\r\n                                            )}\r\n                                        </div>\r\n                                    ))}\r\n                                </div>\r\n                            ) : (\r\n                                <div className=\"text-sm text-gray-400 text-center py-8\">\r\n                                    尚無服務專案記錄\r\n                                </div>\r\n                            );\r\n                        })()}\r\n                    </Card>\r\n                </div>\r\n\r\n                {/* 新增評價 Modal */}\r\n                <Modal\r\n                    isOpen={isReviewModalOpen}\r\n                    onClose={() => setIsReviewModalOpen(false)}\r\n                    title=\"新增合作評價\"\r\n                    onConfirm={handleAddReview}\r\n                >\r\n                    <div className=\"space-y-4\">\r\n                        <div className=\"grid grid-cols-1 sm:grid-cols-2 gap-4\">\r\n                            <InputField label=\"專案名稱\" value={newReview.project} onChange={e => setNewReview({ ...newReview, project: e.target.value })} placeholder=\"例：陳宅裝修案\" />\r\n                            <InputField label=\"日期\" type=\"date\" value={newReview.date} onChange={e => setNewReview({ ...newReview, date: e.target.value })} />\r\n                        </div>\r\n                        <div>\r\n                            <label className=\"block text-sm text-gray-500 mb-2\">評價傾向</label>\r\n                            <div className=\"flex gap-2\">\r\n                                {[\r\n                                    { value: 'positive', label: '正面', icon: ThumbsUp, color: 'green' },\r\n                                    { value: 'neutral', label: '中立', icon: MessageSquare, color: 'gray' },\r\n                                    { value: 'negative', label: '負面', icon: ThumbsDown, color: 'red' },\r\n                                ].map(opt => (\r\n                                    <button\r\n                                        key={opt.value}\r\n                                        type=\"button\"\r\n                                        onClick={() => setNewReview({ ...newReview, sentiment: opt.value })}\r\n                                        className={`flex-1 py-2 px-3 rounded-lg flex items-center justify-center gap-2 transition-all ${newReview.sentiment === opt.value\r\n                                            ? opt.color === 'green' ? 'bg-green-100 text-green-700 border-2 border-green-300'\r\n                                                : opt.color === 'red' ? 'bg-red-100 text-red-700 border-2 border-red-300'\r\n                                                    : 'bg-gray-100 text-gray-700 border-2 border-gray-300'\r\n                                            : 'bg-gray-50 text-gray-500 border border-gray-200'\r\n                                            }`}\r\n                                    >\r\n                                        <opt.icon size={16} />\r\n                                        {opt.label}\r\n                                    </button>\r\n                                ))}\r\n                            </div>\r\n                        </div>\r\n                        <div>\r\n                            <label className=\"block text-sm text-gray-500 mb-1\">評價內容</label>\r\n                            <textarea\r\n                                value={newReview.note}\r\n                                onChange={e => setNewReview({ ...newReview, note: e.target.value })}\r\n                                placeholder=\"記錄合作心得...\"\r\n                                className=\"w-full border rounded-lg px-3 py-2 min-h-[100px] resize-none\"\r\n                            />\r\n                        </div>\r\n                    </div>\r\n                </Modal>\r\n            </div>\r\n        );\r\n    }\r\n\r\n    // 廠商列表頁\r\n    return (\r\n        <div className=\"space-y-6 animate-fade-in\">\r\n            <SectionTitle title=\"廠商管理\" />\r\n\r\n            {loading ? <LoadingSkeleton /> : (\r\n                <>\r\n                    {/* 統計卡片 */}\r\n                    <div className=\"grid grid-cols-2 md:grid-cols-4 gap-3 sm:gap-4\">\r\n                        <StatCard icon={HardHat} label=\"總廠商數\" value={stats.total} color=\"gray\" onClick={() => { setCategoryFilter('全部'); setStatusFilter('全部'); }} />\r\n                        <StatCard icon={Wrench} label=\"工程工班\" value={stats.crews} color=\"orange\" onClick={() => setCategoryFilter('工程工班')} />\r\n                        <StatCard icon={Building} label=\"建材供應\" value={stats.suppliers} color=\"blue\" onClick={() => setCategoryFilter('建材供應')} />\r\n                        <StatCard icon={Star} label=\"長期合作\" value={stats.longTerm} color=\"green\" onClick={() => setStatusFilter('長期合作')} />\r\n                    </div>\r\n\r\n                    {/* 搜尋與篩選列 */}\r\n                    <div className=\"flex flex-wrap items-center gap-3\">\r\n                        <div className=\"relative flex-1 min-w-[200px]\">\r\n                            <Search size={18} className=\"absolute left-3 top-1/2 -translate-y-1/2 text-gray-400\" />\r\n                            <input\r\n                                type=\"text\"\r\n                                value={searchTerm}\r\n                                onChange={(e) => setSearchTerm(e.target.value)}\r\n                                placeholder=\"搜尋廠商名稱、工種、聯絡人...\"\r\n                                className=\"w-full pl-10 pr-4 py-2.5 rounded-xl border border-gray-200 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 outline-none transition-all\"\r\n                            />\r\n                        </div>\r\n                        <select\r\n                            value={categoryFilter}\r\n                            onChange={(e) => setCategoryFilter(e.target.value)}\r\n                            className=\"px-4 py-2.5 rounded-xl border border-gray-200 bg-white focus:border-blue-500 outline-none\"\r\n                        >\r\n                            <option value=\"全部\">全部類別</option>\r\n                            {Object.keys(CATEGORY_CONFIG).map(cat => (\r\n                                <option key={cat} value={cat}>{cat}</option>\r\n                            ))}\r\n                        </select>\r\n                        <select\r\n                            value={statusFilter}\r\n                            onChange={(e) => setStatusFilter(e.target.value)}\r\n                            className=\"px-4 py-2.5 rounded-xl border border-gray-200 bg-white focus:border-blue-500 outline-none\"\r\n                        >\r\n                            <option value=\"全部\">全部狀態</option>\r\n                            {Object.keys(STATUS_CONFIG).map(status => (\r\n                                <option key={status} value={status}>{status}</option>\r\n                            ))}\r\n                        </select>\r\n                        {(searchTerm || categoryFilter !== '全部' || statusFilter !== '全部') && (\r\n                            <button\r\n                                onClick={() => { setSearchTerm(''); setCategoryFilter('全部'); setStatusFilter('全部'); }}\r\n                                className=\"px-3 py-2.5 text-gray-500 hover:text-gray-700 flex items-center gap-1\"\r\n                            >\r\n                                <X size={16} /> 清除\r\n                            </button>\r\n                        )}\r\n                        <button\r\n                            onClick={handleOpenAdd}\r\n                            className=\"ml-auto bg-morandi-text-accent text-white px-4 py-2.5 rounded-xl text-sm font-medium hover:shadow-lg transition-all flex items-center gap-2\"\r\n                        >\r\n                            <Plus size={16} /> 新增廠商\r\n                        </button>\r\n                    </div>\r\n\r\n                    {/* 廠商列表 */}\r\n                    <div className=\"space-y-3\">\r\n                        {filteredVendors.length > 0 ? (\r\n                            filteredVendors.map(vendor => (\r\n                                <VendorRow\r\n                                    key={vendor.id}\r\n                                    vendor={vendor}\r\n                                    onSelect={setActiveVendor}\r\n                                    onDelete={() => openDeleteModal(vendor)}\r\n                                />\r\n                            ))\r\n                        ) : (\r\n                            <div className=\"text-center py-12 text-gray-400\">\r\n                                {searchTerm || categoryFilter !== '全部' || statusFilter !== '全部' ? '無符合條件的廠商' : '尚無廠商資料'}\r\n                            </div>\r\n                        )}\r\n                    </div>\r\n                </>\r\n            )}\r\n\r\n            {/* 新增/編輯廠商 Modal */}\r\n            <Modal\r\n                isOpen={isModalOpen}\r\n                onClose={() => { setIsModalOpen(false); setIsSaving(false); }}\r\n                title={currentVendor?.id ? \"編輯廠商\" : \"新增廠商\"}\r\n                onConfirm={handleSaveVendor}\r\n                confirmDisabled={isSaving}\r\n                confirmText={isSaving ? '處理中...' : '確定'}\r\n            >\r\n                {currentVendor && (\r\n                    <div className=\"space-y-4\">\r\n                        <InputField label=\"廠商名稱\" value={currentVendor.name} onChange={e => setCurrentVendor({ ...currentVendor, name: e.target.value })} placeholder=\"必填\" />\r\n                        <div className=\"grid grid-cols-1 sm:grid-cols-2 gap-4\">\r\n                            <div>\r\n                                <label className=\"block text-sm text-gray-500 mb-1\">類別</label>\r\n                                <select value={currentVendor.category} onChange={e => setCurrentVendor({ ...currentVendor, category: e.target.value })} className=\"w-full border rounded-lg px-3 py-2 bg-white\">\r\n                                    {Object.keys(CATEGORY_CONFIG).map(c => <option key={c} value={c}>{c}</option>)}\r\n                                </select>\r\n                            </div>\r\n                            <InputField label=\"工種/項目\" value={currentVendor.tradeType} onChange={e => setCurrentVendor({ ...currentVendor, tradeType: e.target.value })} placeholder=\"例：木工、水電\" />\r\n                        </div>\r\n                        <div className=\"grid grid-cols-1 sm:grid-cols-2 gap-4\">\r\n                            <InputField label=\"聯絡人\" value={currentVendor.contactPerson} onChange={e => setCurrentVendor({ ...currentVendor, contactPerson: e.target.value })} />\r\n                            <InputField label=\"電話\" value={currentVendor.phone} onChange={e => setCurrentVendor({ ...currentVendor, phone: e.target.value })} />\r\n                        </div>\r\n                        <div className=\"grid grid-cols-1 sm:grid-cols-2 gap-4\">\r\n                            <InputField label=\"Email\" value={currentVendor.email || ''} onChange={e => setCurrentVendor({ ...currentVendor, email: e.target.value })} placeholder=\"例：vendor@email.com\" />\r\n                            <InputField label=\"LINE ID\" value={currentVendor.lineId || ''} onChange={e => setCurrentVendor({ ...currentVendor, lineId: e.target.value })} placeholder=\"例：@lineid\" />\r\n                        </div>\r\n                        <div className=\"grid grid-cols-1 sm:grid-cols-2 gap-4\">\r\n                            <InputField label=\"統一編號\" value={currentVendor.taxId || ''} onChange={e => setCurrentVendor({ ...currentVendor, taxId: e.target.value })} placeholder=\"8位數統一編號\" />\r\n                            <InputField label=\"銀行帳號\" value={currentVendor.bankAccount || ''} onChange={e => setCurrentVendor({ ...currentVendor, bankAccount: e.target.value })} placeholder=\"例：812-1234-5678-901\" />\r\n                        </div>\r\n                        <LocationField label=\"地址\" value={currentVendor.address} onChange={e => setCurrentVendor({ ...currentVendor, address: e.target.value })} />\r\n                        <div className=\"grid grid-cols-1 sm:grid-cols-2 gap-4\">\r\n                            <div>\r\n                                <label className=\"block text-sm text-gray-500 mb-1\">評分</label>\r\n                                <StarRating rating={currentVendor.rating} onChange={(val) => setCurrentVendor({ ...currentVendor, rating: val })} />\r\n                            </div>\r\n                            <div>\r\n                                <label className=\"block text-sm text-gray-500 mb-1\">狀態</label>\r\n                                <select value={currentVendor.status} onChange={e => setCurrentVendor({ ...currentVendor, status: e.target.value })} className=\"w-full border rounded-lg px-3 py-2 bg-white\">\r\n                                    {Object.keys(STATUS_CONFIG).map(s => <option key={s} value={s}>{s}</option>)}\r\n                                </select>\r\n                            </div>\r\n                        </div>\r\n                        <InputField label=\"標籤 (逗號分隔)\" value={currentVendor.tags} onChange={e => setCurrentVendor({ ...currentVendor, tags: e.target.value })} placeholder=\"例：配合度高, 手工細緻\" />\r\n                        <div className=\"mt-4 p-3 bg-blue-50 text-blue-700 text-xs rounded-lg flex items-center gap-2\">\r\n                            <Cloud size={14} /> 系統將自動於 Google Drive 建立專屬資料夾\r\n                        </div>\r\n                    </div>\r\n                )}\r\n            </Modal>\r\n\r\n            {/* 刪除確認 Modal */}\r\n            <Modal\r\n                isOpen={isDeleteModalOpen}\r\n                onClose={() => { setIsDeleteModalOpen(false); setDeletingVendor(null); }}\r\n                title=\"確認刪除廠商\"\r\n                onConfirm={confirmDeleteVendor}\r\n                confirmText=\"確定刪除\"\r\n            >\r\n                <div className=\"space-y-4\">\r\n                    <div className=\"bg-red-50 border border-red-200 rounded-lg p-4\">\r\n                        <p className=\"text-red-800 font-medium\">⚠️ 此操作無法復原</p>\r\n                    </div>\r\n                    <p className=\"text-gray-700\">\r\n                        您確定要刪除廠商「<span className=\"font-bold\">{deletingVendor?.name}</span>」嗎？\r\n                    </p>\r\n                    <p className=\"text-sm text-gray-500\">\r\n                        刪除後，該廠商的所有資料將從系統中移除。\r\n                    </p>\r\n                </div>\r\n            </Modal>\r\n        </div>\r\n    );\r\n};\r\n\r\nexport default Vendors;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\xiang\\senteng-frontend\\src\\services\\ChangeOrderService.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\xiang\\senteng-frontend\\src\\services\\ContractService.js","messages":[{"ruleId":"no-unused-vars","severity":2,"message":"'quotationsApi' is defined but never used. Allowed unused vars must match /^[A-Z_]|^_/u.","line":8,"column":24,"nodeType":"Identifier","messageId":"unusedVar","endLine":8,"endColumn":37,"suggestions":[{"messageId":"removeVar","data":{"varName":"quotationsApi"},"fix":{"range":[131,146],"text":""},"desc":"Remove unused variable 'quotationsApi'."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * 合約管理服務層 (ContractService)\r\n * 處理合約建立、版本控管、履約追蹤\r\n * \r\n * ⚠️ 已整合 Backend API - 資料儲存於 PostgreSQL\r\n */\r\n\r\nimport { contractsApi, quotationsApi } from './api';\r\n\r\n// ============================================\r\n// 常數定義\r\n// ============================================\r\n\r\n// 合約狀態 (對應後端 CTR_*)\r\nexport const CONTRACT_STATUS = {\r\n    DRAFT: 'CTR_DRAFT',           // 草稿\r\n    PENDING_SIGN: 'CTR_PENDING',  // 待簽約\r\n    ACTIVE: 'CTR_ACTIVE',         // 履約中\r\n    COMPLETED: 'CTR_COMPLETED',   // 已完工\r\n    WARRANTY: 'CTR_WARRANTY',     // 保固期\r\n    CLOSED: 'CTR_CLOSED',         // 已結案\r\n    TERMINATED: 'CTR_TERMINATED', // 終止\r\n};\r\n\r\nexport const CONTRACT_STATUS_LABELS = {\r\n    CTR_DRAFT: '草稿',\r\n    CTR_PENDING: '待簽約',\r\n    CTR_ACTIVE: '履約中',\r\n    CTR_COMPLETED: '已完工',\r\n    CTR_WARRANTY: '保固期',\r\n    CTR_CLOSED: '已結案',\r\n    CTR_TERMINATED: '終止',\r\n    // Legacy mapping\r\n    DRAFT: '草稿',\r\n    PENDING_SIGN: '待簽約',\r\n    ACTIVE: '履約中',\r\n    COMPLETED: '已完工',\r\n    WARRANTY: '保固期',\r\n    CLOSED: '已結案',\r\n    TERMINATED: '終止',\r\n};\r\n\r\nexport const CONTRACT_STATUS_COLORS = {\r\n    CTR_DRAFT: 'bg-gray-100 text-gray-700',\r\n    CTR_PENDING: 'bg-yellow-100 text-yellow-700',\r\n    CTR_ACTIVE: 'bg-blue-100 text-blue-700',\r\n    CTR_COMPLETED: 'bg-green-100 text-green-700',\r\n    CTR_WARRANTY: 'bg-purple-100 text-purple-700',\r\n    CTR_CLOSED: 'bg-gray-200 text-gray-600',\r\n    CTR_TERMINATED: 'bg-red-100 text-red-700',\r\n    // Legacy mapping\r\n    DRAFT: 'bg-gray-100 text-gray-700',\r\n    PENDING_SIGN: 'bg-yellow-100 text-yellow-700',\r\n    ACTIVE: 'bg-blue-100 text-blue-700',\r\n    COMPLETED: 'bg-green-100 text-green-700',\r\n    WARRANTY: 'bg-purple-100 text-purple-700',\r\n    CLOSED: 'bg-gray-200 text-gray-600',\r\n    TERMINATED: 'bg-red-100 text-red-700',\r\n};\r\n\r\n// 合約類型\r\nexport const CONTRACT_TYPES = {\r\n    LUMP_SUM: 'LUMP_SUM',           // 總價承攬\r\n    UNIT_PRICE: 'UNIT_PRICE',       // 單價承攬\r\n    COST_PLUS: 'COST_PLUS',         // 成本加成\r\n    DESIGN_BUILD: 'DESIGN_BUILD',   // 統包\r\n};\r\n\r\nexport const CONTRACT_TYPE_LABELS = {\r\n    LUMP_SUM: '總價承攬',\r\n    UNIT_PRICE: '單價承攬',\r\n    COST_PLUS: '成本加成',\r\n    DESIGN_BUILD: '統包工程',\r\n};\r\n\r\n// 付款條件範本\r\nexport const PAYMENT_TERM_TEMPLATES = [\r\n    {\r\n        id: 'standard-3',\r\n        name: '標準三期款',\r\n        terms: [\r\n            { name: '簽約訂金', percentage: 30, trigger: 'SIGNED' },\r\n            { name: '中期款', percentage: 40, trigger: 'PROGRESS_50' },\r\n            { name: '完工尾款', percentage: 30, trigger: 'COMPLETED' },\r\n        ],\r\n    },\r\n    {\r\n        id: 'standard-4',\r\n        name: '標準四期款',\r\n        terms: [\r\n            { name: '簽約訂金', percentage: 30, trigger: 'SIGNED' },\r\n            { name: '第一期', percentage: 30, trigger: 'PROGRESS_30' },\r\n            { name: '第二期', percentage: 30, trigger: 'PROGRESS_70' },\r\n            { name: '完工尾款', percentage: 10, trigger: 'COMPLETED' },\r\n        ],\r\n    },\r\n    {\r\n        id: 'monthly',\r\n        name: '按月請款',\r\n        terms: [\r\n            { name: '簽約訂金', percentage: 10, trigger: 'SIGNED' },\r\n            { name: '月結款', percentage: 80, trigger: 'MONTHLY' },\r\n            { name: '完工尾款', percentage: 10, trigger: 'COMPLETED' },\r\n        ],\r\n    },\r\n];\r\n\r\n// ============================================\r\n// 工具函數\r\n// ============================================\r\n\r\n/**\r\n * 生成合約編號\r\n */\r\nexport const generateContractNo = (year, sequence) => {\r\n    return `CTR${year}-${String(sequence).padStart(4, '0')}`;\r\n};\r\n\r\n// ============================================\r\n// 合約服務類 - 使用 Backend API\r\n// ============================================\r\n\r\nclass ContractServiceClass {\r\n    constructor() {\r\n        // No localStorage needed - using backend API\r\n    }\r\n\r\n    // 取得所有合約\r\n    async getContracts(filters = {}) {\r\n        try {\r\n            const params = {};\r\n            if (filters.status) params.status = filters.status;\r\n            if (filters.projectId) params.projectId = filters.projectId;\r\n\r\n            const contracts = await contractsApi.getAll(params);\r\n            return contracts.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));\r\n        } catch (error) {\r\n            console.error('Failed to get contracts:', error);\r\n            return [];\r\n        }\r\n    }\r\n\r\n    // 取得單一合約\r\n    async getContract(id) {\r\n        try {\r\n            return await contractsApi.getById(id);\r\n        } catch (error) {\r\n            console.error('Failed to get contract:', error);\r\n            return null;\r\n        }\r\n    }\r\n\r\n    // 從估價單建立合約\r\n    async createFromQuotation(quotationId, additionalData = {}) {\r\n        try {\r\n            const payload = {\r\n                quotationId,\r\n                contractNo: additionalData.contractNo,\r\n                paymentTerms: additionalData.paymentTerms || 'PROGRESS',\r\n                retentionRate: additionalData.retentionRate || 5,\r\n                warrantyMonths: additionalData.warrantyMonths || 12,\r\n            };\r\n\r\n            return await contractsApi.convertFromQuotation(payload);\r\n        } catch (error) {\r\n            console.error('Failed to create contract from quotation:', error);\r\n            throw error;\r\n        }\r\n    }\r\n\r\n    // 建立新合約\r\n    async createContract(data) {\r\n        try {\r\n            const payload = {\r\n                projectId: data.projectId,\r\n                contractNo: data.contractNo,\r\n                title: data.title,\r\n                contractType: data.contractType || 'FIXED_PRICE',\r\n                originalAmount: data.originalAmount || data.amount || 0,\r\n                retentionRate: data.retentionRate || 5,\r\n                paymentTerms: data.paymentTerms || 'PROGRESS',\r\n                warrantyMonths: data.warrantyMonths || 12,\r\n                notes: data.notes,\r\n            };\r\n\r\n            return await contractsApi.create(payload);\r\n        } catch (error) {\r\n            console.error('Failed to create contract:', error);\r\n            throw error;\r\n        }\r\n    }\r\n\r\n    // 更新合約\r\n    async updateContract(id, data) {\r\n        try {\r\n            return await contractsApi.update(id, data);\r\n        } catch (error) {\r\n            console.error('Failed to update contract:', error);\r\n            throw error;\r\n        }\r\n    }\r\n\r\n    // 簽約\r\n    async sign(id, signedDate) {\r\n        try {\r\n            return await contractsApi.sign(id, signedDate);\r\n        } catch (error) {\r\n            console.error('Failed to sign contract:', error);\r\n            throw error;\r\n        }\r\n    }\r\n\r\n    // 完工\r\n    async complete(id) {\r\n        try {\r\n            return await contractsApi.complete(id);\r\n        } catch (error) {\r\n            console.error('Failed to complete contract:', error);\r\n            throw error;\r\n        }\r\n    }\r\n\r\n    // 結案\r\n    async close(id) {\r\n        try {\r\n            return await contractsApi.close(id);\r\n        } catch (error) {\r\n            console.error('Failed to close contract:', error);\r\n            throw error;\r\n        }\r\n    }\r\n\r\n    // 取得合約統計\r\n    async getContractStats() {\r\n        const contracts = await this.getContracts();\r\n\r\n        return {\r\n            total: contracts.length,\r\n            active: contracts.filter(c => c.status === CONTRACT_STATUS.ACTIVE).length,\r\n            completed: contracts.filter(c => c.status === CONTRACT_STATUS.COMPLETED).length,\r\n            warranty: contracts.filter(c => c.status === CONTRACT_STATUS.WARRANTY).length,\r\n            totalAmount: contracts.reduce((sum, c) => sum + (Number(c.currentAmount) || 0), 0),\r\n            totalPaid: contracts.reduce((sum, c) => sum + (Number(c.paidAmount) || 0), 0),\r\n        };\r\n    }\r\n}\r\n\r\nexport const ContractService = new ContractServiceClass();\r\nexport default ContractService;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\xiang\\senteng-frontend\\src\\services\\GoogleService.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\xiang\\senteng-frontend\\src\\services\\MockData.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\xiang\\senteng-frontend\\src\\services\\PaymentService.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\xiang\\senteng-frontend\\src\\services\\ProfitAnalysisService.js","messages":[{"ruleId":"no-unused-vars","severity":2,"message":"'contractsApi' is defined but never used. Allowed unused vars must match /^[A-Z_]|^_/u.","line":8,"column":26,"nodeType":"Identifier","messageId":"unusedVar","endLine":8,"endColumn":38,"suggestions":[{"messageId":"removeVar","data":{"varName":"contractsApi"},"fix":{"range":[146,160],"text":""},"desc":"Remove unused variable 'contractsApi'."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * 利潤分析服務層 (ProfitAnalysisService)\r\n * 整合專案成本、合約收入、請款進度，提供利潤分析\r\n * \r\n * ⚠️ 已整合 Backend API - 資料儲存於 PostgreSQL\r\n */\r\n\r\nimport { costEntriesApi, contractsApi } from './api';\r\nimport ContractService, { CONTRACT_STATUS } from './ContractService';\r\nimport PaymentService, { PAYMENT_STATUS } from './PaymentService';\r\nimport ChangeOrderService from './ChangeOrderService';\r\n\r\n// ============================================\r\n// 常數定義\r\n// ============================================\r\n\r\n// 利潤狀態\r\nexport const PROFIT_STATUS = {\r\n    HEALTHY: 'HEALTHY',       // 健康 (毛利 > 20%)\r\n    WARNING: 'WARNING',       // 警示 (毛利 10-20%)\r\n    CRITICAL: 'CRITICAL',     // 危險 (毛利 < 10%)\r\n    LOSS: 'LOSS',            // 虧損 (毛利 < 0%)\r\n};\r\n\r\nexport const PROFIT_STATUS_LABELS = {\r\n    HEALTHY: '健康',\r\n    WARNING: '警示',\r\n    CRITICAL: '危險',\r\n    LOSS: '虧損',\r\n};\r\n\r\nexport const PROFIT_STATUS_COLORS = {\r\n    HEALTHY: 'bg-green-100 text-green-700',\r\n    WARNING: 'bg-yellow-100 text-yellow-700',\r\n    CRITICAL: 'bg-orange-100 text-orange-700',\r\n    LOSS: 'bg-red-100 text-red-700',\r\n};\r\n\r\n// 成本類別\r\nexport const COST_CATEGORIES = {\r\n    MATERIAL: 'MATERIAL',     // 材料費\r\n    LABOR: 'LABOR',           // 工資\r\n    EQUIPMENT: 'EQUIPMENT',   // 機具\r\n    SUBCONTRACT: 'SUBCONTRACT', // 外包\r\n    OVERHEAD: 'OVERHEAD',     // 管銷\r\n    OTHER: 'OTHER',           // 其他\r\n};\r\n\r\nexport const COST_CATEGORY_LABELS = {\r\n    MATERIAL: '材料費',\r\n    LABOR: '工資',\r\n    EQUIPMENT: '機具',\r\n    SUBCONTRACT: '外包',\r\n    OVERHEAD: '管銷',\r\n    OTHER: '其他',\r\n};\r\n\r\n// ============================================\r\n// 工具函數\r\n// ============================================\r\n\r\n/**\r\n * 計算利潤狀態\r\n */\r\nexport const calculateProfitStatus = (marginRate) => {\r\n    if (marginRate < 0) return PROFIT_STATUS.LOSS;\r\n    if (marginRate < 10) return PROFIT_STATUS.CRITICAL;\r\n    if (marginRate < 20) return PROFIT_STATUS.WARNING;\r\n    return PROFIT_STATUS.HEALTHY;\r\n};\r\n\r\n/**\r\n * 格式化趨勢\r\n */\r\nexport const formatTrend = (current, previous) => {\r\n    if (!previous) return { value: 0, direction: 'neutral' };\r\n    const change = ((current - previous) / previous) * 100;\r\n    return {\r\n        value: Math.abs(change).toFixed(1),\r\n        direction: change > 0 ? 'up' : change < 0 ? 'down' : 'neutral',\r\n    };\r\n};\r\n\r\n// ============================================\r\n// 利潤分析服務類\r\n// ============================================\r\n\r\nclass ProfitAnalysisServiceClass {\r\n    constructor() {\r\n        // No localStorage needed - using backend API\r\n    }\r\n\r\n    // ==================== 成本管理 ====================\r\n\r\n    // 取得專案成本\r\n    async getProjectCosts(projectId) {\r\n        try {\r\n            const params = projectId ? { projectId } : {};\r\n            return await costEntriesApi.getAll(params);\r\n        } catch (error) {\r\n            console.error('Failed to get costs:', error);\r\n            return [];\r\n        }\r\n    }\r\n\r\n    // 新增成本\r\n    async addCost(data) {\r\n        try {\r\n            return await costEntriesApi.create(data);\r\n        } catch (error) {\r\n            console.error('Failed to add cost:', error);\r\n            throw error;\r\n        }\r\n    }\r\n\r\n    // 取得成本摘要（按類別）\r\n    async getCostSummaryByCategory(projectId) {\r\n        const costs = await this.getProjectCosts(projectId);\r\n        const summary = {};\r\n\r\n        Object.keys(COST_CATEGORIES).forEach(cat => {\r\n            summary[cat] = {\r\n                category: cat,\r\n                label: COST_CATEGORY_LABELS[cat],\r\n                amount: 0,\r\n                count: 0,\r\n            };\r\n        });\r\n\r\n        costs.forEach(cost => {\r\n            const cat = cost.category || 'OTHER';\r\n            if (summary[cat]) {\r\n                summary[cat].amount += cost.amount || 0;\r\n                summary[cat].count += 1;\r\n            }\r\n        });\r\n\r\n        return Object.values(summary);\r\n    }\r\n\r\n    // ==================== 利潤分析 ====================\r\n\r\n    // 取得單一專案/合約利潤分析\r\n    async getProjectProfitAnalysis(contractId) {\r\n        const contract = await ContractService.getContract(contractId);\r\n        if (!contract) throw new Error('Contract not found');\r\n\r\n        const costs = await this.getProjectCosts(contract.projectId);\r\n        const totalCost = costs.reduce((sum, c) => sum + (c.amount || 0), 0);\r\n\r\n        // 收入 = 現行合約金額\r\n        const revenue = contract.currentAmount || 0;\r\n\r\n        // 毛利\r\n        const grossProfit = revenue - totalCost;\r\n        const marginRate = revenue > 0 ? (grossProfit / revenue) * 100 : 0;\r\n\r\n        // 請款進度\r\n        const paidAmount = contract.paidAmount || 0;\r\n        const paymentProgress = revenue > 0 ? (paidAmount / revenue) * 100 : 0;\r\n\r\n        // 成本比例\r\n        const costRatio = revenue > 0 ? (totalCost / revenue) * 100 : 0;\r\n\r\n        return {\r\n            contractId,\r\n            contractNo: contract.contractNo,\r\n            projectName: contract.projectName,\r\n\r\n            // 金額\r\n            revenue,\r\n            totalCost,\r\n            grossProfit,\r\n\r\n            // 比率\r\n            marginRate: marginRate.toFixed(1),\r\n            costRatio: costRatio.toFixed(1),\r\n            paymentProgress: paymentProgress.toFixed(1),\r\n\r\n            // 狀態\r\n            status: calculateProfitStatus(marginRate),\r\n\r\n            // 請款\r\n            paidAmount,\r\n            unpaidAmount: revenue - paidAmount,\r\n\r\n            // 成本明細\r\n            costBreakdown: await this.getCostSummaryByCategory(contract.projectId),\r\n        };\r\n    }\r\n\r\n    // 取得整體利潤儀表板\r\n    async getDashboardMetrics() {\r\n        const contracts = await ContractService.getContracts();\r\n        const activeContracts = contracts.filter(c =>\r\n            c.status === CONTRACT_STATUS.ACTIVE ||\r\n            c.status === CONTRACT_STATUS.COMPLETED ||\r\n            c.status === CONTRACT_STATUS.WARRANTY\r\n        );\r\n\r\n        // 整體統計\r\n        let totalRevenue = 0;\r\n        let totalCost = 0;\r\n        let totalPaid = 0;\r\n        let totalUnpaid = 0;\r\n\r\n        const projectAnalyses = [];\r\n\r\n        for (const contract of activeContracts) {\r\n            try {\r\n                const analysis = await this.getProjectProfitAnalysis(contract.id);\r\n                projectAnalyses.push(analysis);\r\n\r\n                totalRevenue += analysis.revenue;\r\n                totalCost += analysis.totalCost;\r\n                totalPaid += analysis.paidAmount;\r\n                totalUnpaid += analysis.unpaidAmount;\r\n            } catch (e) {\r\n                console.error('Analysis error for contract:', contract.id, e);\r\n            }\r\n        }\r\n\r\n        const totalProfit = totalRevenue - totalCost;\r\n        const overallMargin = totalRevenue > 0 ? (totalProfit / totalRevenue) * 100 : 0;\r\n\r\n        // 專案狀態分佈\r\n        const statusDistribution = {\r\n            healthy: projectAnalyses.filter(p => p.status === PROFIT_STATUS.HEALTHY).length,\r\n            warning: projectAnalyses.filter(p => p.status === PROFIT_STATUS.WARNING).length,\r\n            critical: projectAnalyses.filter(p => p.status === PROFIT_STATUS.CRITICAL).length,\r\n            loss: projectAnalyses.filter(p => p.status === PROFIT_STATUS.LOSS).length,\r\n        };\r\n\r\n        // 月度趨勢（模擬資料）\r\n        const monthlyTrend = this.generateMonthlyTrend(6);\r\n\r\n        return {\r\n            // 總覽\r\n            totalRevenue,\r\n            totalCost,\r\n            totalProfit,\r\n            overallMargin: overallMargin.toFixed(1),\r\n            overallStatus: calculateProfitStatus(overallMargin),\r\n\r\n            // 請款\r\n            totalPaid,\r\n            totalUnpaid,\r\n            collectionRate: totalRevenue > 0 ? ((totalPaid / totalRevenue) * 100).toFixed(1) : '0',\r\n\r\n            // 專案\r\n            totalProjects: activeContracts.length,\r\n            statusDistribution,\r\n            projectAnalyses: projectAnalyses.sort((a, b) => a.marginRate - b.marginRate), // 低毛利優先\r\n\r\n            // 趨勢\r\n            monthlyTrend,\r\n        };\r\n    }\r\n\r\n    // 生成月度趨勢（模擬）\r\n    generateMonthlyTrend(months) {\r\n        const trend = [];\r\n        const now = new Date();\r\n\r\n        for (let i = months - 1; i >= 0; i--) {\r\n            const date = new Date(now.getFullYear(), now.getMonth() - i, 1);\r\n            trend.push({\r\n                month: date.toLocaleDateString('zh-TW', { month: 'short' }),\r\n                year: date.getFullYear(),\r\n                revenue: Math.floor(Math.random() * 2000000) + 500000,\r\n                cost: Math.floor(Math.random() * 1500000) + 300000,\r\n                profit: 0, // 計算後填入\r\n            });\r\n        }\r\n\r\n        trend.forEach(t => {\r\n            t.profit = t.revenue - t.cost;\r\n            t.margin = ((t.profit / t.revenue) * 100).toFixed(1);\r\n        });\r\n\r\n        return trend;\r\n    }\r\n\r\n    // 取得警報（毛利過低的專案）\r\n    async getAlerts() {\r\n        const metrics = await this.getDashboardMetrics();\r\n        const alerts = [];\r\n\r\n        metrics.projectAnalyses.forEach(project => {\r\n            if (project.status === PROFIT_STATUS.LOSS) {\r\n                alerts.push({\r\n                    type: 'error',\r\n                    title: '專案虧損',\r\n                    message: `${project.projectName} 目前虧損 ${Math.abs(project.grossProfit).toLocaleString()}`,\r\n                    projectId: project.contractId,\r\n                });\r\n            } else if (project.status === PROFIT_STATUS.CRITICAL) {\r\n                alerts.push({\r\n                    type: 'warning',\r\n                    title: '毛利過低',\r\n                    message: `${project.projectName} 毛利率僅 ${project.marginRate}%`,\r\n                    projectId: project.contractId,\r\n                });\r\n            }\r\n        });\r\n\r\n        // 請款進度警報\r\n        metrics.projectAnalyses.forEach(project => {\r\n            if (parseFloat(project.paymentProgress) < 30 && project.revenue > 0) {\r\n                alerts.push({\r\n                    type: 'info',\r\n                    title: '請款進度落後',\r\n                    message: `${project.projectName} 請款進度僅 ${project.paymentProgress}%`,\r\n                    projectId: project.contractId,\r\n                });\r\n            }\r\n        });\r\n\r\n        return alerts;\r\n    }\r\n}\r\n\r\nexport const ProfitAnalysisService = new ProfitAnalysisServiceClass();\r\nexport default ProfitAnalysisService;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\xiang\\senteng-frontend\\src\\services\\QuotationService.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\xiang\\senteng-frontend\\src\\services\\api.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\xiang\\senteng-frontend\\src\\services\\config.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\xiang\\senteng-frontend\\src\\services\\contactsSyncApi.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\xiang\\senteng-frontend\\src\\services\\eventsSyncApi.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\xiang\\senteng-frontend\\src\\services\\firebase.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\xiang\\senteng-frontend\\src\\services\\integrationsApi.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\xiang\\senteng-frontend\\src\\services\\offlineQueue.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\xiang\\senteng-frontend\\src\\services\\reportExport.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\xiang\\senteng-frontend\\src\\services\\useApiData.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\xiang\\senteng-frontend\\tailwind.config.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\xiang\\senteng-frontend\\vite.config.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]}]